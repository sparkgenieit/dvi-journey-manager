<?php
/*
* JACKUS - An In-house Framework for TDS Apps
*
* Author: Touchmark Descience Private Limited. 
* https://touchmarkdes.com
* Version 4.0.1
* Copyright (c) 2018-2022 Touchmark De`Science
*
*/

include_once('../../jackus.php');
include_once('../../smtp_functions.php');

/* ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
 ini_set('log_errors', 1);
 ini_set('error_log', __DIR__ . '/php-error.log');
 error_reporting(E_ALL);*/

if (isset($_SERVER['HTTP_X_REQUESTED_WITH']) && ($_SERVER['HTTP_X_REQUESTED_WITH'] == 'XMLHttpRequest')) : //CHECK AJAX REQUEST

    if ($_GET['type'] == 'show_cancellation_modal') :

        $itinerary_plan_ID = $_GET['ITINERARY_ID'];
        //FETCH ITINERARY DETAILS
        $select_itinerary_plan_details_query = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_ID`,`arrival_location`, `departure_location`, `itinerary_quote_ID`, `trip_start_date_and_time`, `trip_end_date_and_time`, `arrival_type`, `departure_type`, `expecting_budget`, `itinerary_type`, `entry_ticket_required`, `no_of_routes`, `no_of_days`, `no_of_nights`, `total_adult`, `total_children`, `total_infants`, `nationality`, `itinerary_preference`, `meal_plan_breakfast`, `meal_plan_lunch`, `meal_plan_dinner`, `preferred_room_count`, `total_extra_bed`, `total_child_with_bed`, `total_child_without_bed`, `guide_for_itinerary`, `food_type`, `special_instructions`, `pick_up_date_and_time` FROM `dvi_confirmed_itinerary_plan_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());
        $total_itinerary_plan_details_count = sqlNUMOFROW_LABEL($select_itinerary_plan_details_query);
        if ($total_itinerary_plan_details_count > 0) :
            while ($fetch_itinerary_plan_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_details_query)) :
                $confirmed_itinerary_plan_ID = $fetch_itinerary_plan_data['confirmed_itinerary_plan_ID'];
                $arrival_location = $fetch_itinerary_plan_data['arrival_location'];
                $departure_location = $fetch_itinerary_plan_data['departure_location'];
                $itinerary_quote_ID = $fetch_itinerary_plan_data['itinerary_quote_ID'];
                $entry_ticket_required = $fetch_itinerary_plan_data['entry_ticket_required'];
                $itinerary_preference =  $fetch_itinerary_plan_data['itinerary_preference'];
            //1 - Hotel | 2 - Vehicle | 3 - Both | 4 - Flights
            endwhile;
        endif;

        //CHECK IF GUIDE IS ALLOTTED FOR THIS ITINERARY
        $itinerary_guide_details = sqlQUERY_LABEL("SELECT  `route_guide_ID` FROM `dvi_confirmed_itinerary_route_guide_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
        $check_itinerary_guide_allotted = sqlNUMOFROW_LABEL($itinerary_guide_details);

        //CHECK IF ACTIVITY IS ALLOTTED FOR THIS ITINERARY
        $itinerary_activity_details = sqlQUERY_LABEL("SELECT  `route_activity_ID` FROM `dvi_confirmed_itinerary_route_activity_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ACTIVITY_LIST:" . sqlERROR_LABEL());
        $check_itinerary_activity_allotted = sqlNUMOFROW_LABEL($itinerary_activity_details);
?>
        <form id="ajax_itinerary_cancellation_form" class="row g-3" action="" method="post" data-parsley-validate>
            <input type="hidden" name="itinerary_plan_ID" id="itinerary_plan_ID" value="<?= $itinerary_plan_ID; ?>" hidden />
            <div class="text-center">
                <h4 class="mb-2" id="">Confirm Itinerary Cancellation</h4>
            </div>
            <span id="response_modal"></span>
            <div class="col-12 mt-2">
                <label class="form-label w-100" for="modalAddCardCvv">Itinerary Booking ID</label>
                <div class="form-group">
                    <input type="text" readonly id="itinerary_quote_ID" name="itinerary_quote_ID" class="form-control" value="<?= $itinerary_quote_ID; ?>" />
                </div>
            </div>
            <div class="col-12 mt-2">
                <label class="form-label w-100" for="modalAddCardCvv">Guest Name</label>
                <div class="form-group">
                    <input type="text" id="guest_name" name="guest_name" required class="form-control" readonly value="<?= get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($itinerary_plan_ID, 'primary_customer_name') ?>" />

                </div>
            </div>

            <div class="col-12">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" id="selectAllCheckbox" class="form-check-input me-2">
                        <label class="form-label w-100" for="selectAllCheckbox">
                            Select All
                        </label>
                    </div>
                    <?php
                    if ($itinerary_preference == 2 || $itinerary_preference == 3):
                        if ($check_itinerary_guide_allotted > 0): ?>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="cancelGuideCheckbox" name="cancel_guide" class="form-check-input select_checkbox me-2" value="1">
                                <label class="form-label w-100" for="cancelGuideCheckbox">
                                    Modify Guide
                                </label>
                            </div>
                        <?php endif; ?>
                        <div class="d-flex align-items-center mb-2">
                            <input type="checkbox" id="cancelHotspotCheckbox" name="cancel_hotspot" class="form-check-input select_checkbox me-2" value="1" <?= ($entry_ticket_required == 0) ? 'disabled style="cursor: not-allowed;" ' : '' ?>>
                            <label class="form-label w-100" for="cancelHotspotCheckbox" <?= ($entry_ticket_required == 0) ? 'style="cursor: not-allowed;" title="Hotsopt Entry ticket Cost is not required for this itinerary"' : '' ?>>
                                Modify Hotspot
                            </label>
                        </div>
                        <?php if ($check_itinerary_activity_allotted > 0): ?>
                            <div class=" d-flex align-items-center mb-2">
                                <input type="checkbox" id="cancelActivityCheckbox" name="cancel_activity" class="form-check-input select_checkbox me-2" value="1">
                                <label class="form-label w-100" for="cancelActivityCheckbox">
                                    Modify Activity
                                </label>
                            </div>
                        <?php endif;
                    endif;
                    if ($itinerary_preference == 1 || $itinerary_preference == 3): ?>
                        <div class="d-flex align-items-center mb-2">
                            <input type="checkbox" id="cancelHotelCheckbox" name="cancel_hotel" class="form-check-input select_checkbox me-2" value="1">
                            <label class="form-label w-100" for="cancelHotelCheckbox">
                                Modify Hotel
                            </label>
                        </div>
                    <?php endif;
                    if ($itinerary_preference == 2 || $itinerary_preference == 3):  ?>
                        <div class="d-flex align-items-center mb-2">
                            <input type="checkbox" id="cancelVehicleCheckbox" name="cancel_vehicle" class="form-check-input select_checkbox me-2" value="1">
                            <label class="form-label w-100" for="cancelVehicleCheckbox">
                                Modify Vehicle
                            </label>
                        </div>
                    <?php endif; ?>
                </div>
                <div id="error_container"></div>
            </div>

            <div id="div_cancellation_percentage" class="col-12" style="display: none;">
                <label class="form-label w-100" for="itinerary_cancellation_percentage">Cancellation Percentage</label>
                <div class="form-group">
                    <input type="text" id="itinerary_cancellation_percentage" name="itinerary_cancellation_percentage"
                        class="form-control" placeholder="Enter the %" value="0" autocomplete="off"
                        data-parsley-trigger="keyup"
                        data-parsley-type="number"
                        data-parsley-min="0"
                        data-parsley-max="100" />
                </div>
            </div>

            <div class="col-12 d-flex justify-content-between text-center pt-4">
                <button type="reset" class=" btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                <button type="submit" class="btn btn-primary" id="cancel_form_submit_btn">Confirm</button>
            </div>
        </form>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                const selectAllCheckbox = $("#selectAllCheckbox");
                const checkboxes = $(".select_checkbox");
                const cancellationDiv = $("#div_cancellation_percentage");
                const cancellationInput = $("#itinerary_cancellation_percentage");
                const errorContainer = $("#error_container");

                function toggleCancellationPercentage() {
                    const isAnyChecked = selectAllCheckbox.is(":checked");
                    cancellationDiv.toggle(isAnyChecked);
                    if (isAnyChecked) {
                        cancellationInput.attr("required", "required");
                    } else {
                        cancellationInput.removeAttr("required");
                    }
                }

                // Select All Checkbox Functionality
                selectAllCheckbox.on("change", function() {
                    checkboxes.prop("checked", this.checked);
                    toggleCancellationPercentage();
                });

                // Individual Checkbox Change Event
                checkboxes.on("change", function() {
                    selectAllCheckbox.prop("checked", checkboxes.length === checkboxes.filter(":checked").length);
                    toggleCancellationPercentage();
                });

                // AJAX Form Submission
                $("#ajax_itinerary_cancellation_form").on("submit", function(e) {
                    e.preventDefault();

                    const isAnyChecked = checkboxes.is(":checked");

                    if (!isAnyChecked) {
                        errorContainer.html('<span class="text-danger">Please select at least one option to proceed.</span>');
                        return;
                    }

                    let formData = new FormData(this);
                    $("#cancel_form_submit_btn").prop("disabled", true);

                    $.ajax({
                        url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=process_itinerary_component_cancellation",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 80000,
                        dataType: "json",
                        encode: true,
                        success: function(response) {
                            if (!response.success) {
                                if (response.errors.itinerary_cancellation_percentage_required) {
                                    TOAST_NOTIFICATION("warning", "Cancellation percentage Required", "Warning !!!");
                                }
                                if (response.errors.itinerary_cancellation_checkbox_required) {
                                    TOAST_NOTIFICATION("warning", "Choose Any one Component to Proceed.", "Warning !!!");
                                }
                            } else {
                                if (response.i_result) {
                                    TOAST_NOTIFICATION("success", "Confirmed Cancellation Successfully", "Success !!!");
                                    $("#showITINERARYCANCELLATIONMODAL").modal("hide");
                                    setTimeout(() => {
                                        location.assign(response.redirectURL);
                                    }, 2000);
                                } else {
                                    TOAST_NOTIFICATION("error", "Unable to Proceed. Something went Wrong !!!", "Error !!!");
                                }
                            }
                        },
                        error: function() {
                            TOAST_NOTIFICATION("error", "Server Error. Please try again later!", "Error !!!");
                        },
                    });
                });
            });
        </script>
    <?php
    elseif ($_GET['type'] == 'process_itinerary_component_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['itinerary_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if (empty($_POST['cancel_guide']) && empty($_POST['cancel_hotspot']) && empty($_POST['cancel_activity']) && empty($_POST['cancel_hotel']) && empty($_POST['cancel_vehicle'])) :
            $errors['itinerary_cancellation_checkbox_required'] = true;
        endif;

        $itinerary_plan_ID = $_POST['itinerary_plan_ID'];
        $cancel_guide = $_POST['cancel_guide'];
        $cancel_hotspot = $_POST['cancel_hotspot'];
        $cancel_activity = $_POST['cancel_activity'];
        $cancel_hotel = $_POST['cancel_hotel'];
        $cancel_vehicle = $_POST['cancel_vehicle'];
        $itinerary_cancellation_percentage = $_POST['itinerary_cancellation_percentage'];

        $_SESSION['_sesITINEARY_PLAN_ID'] = $itinerary_plan_ID;
        $_SESSION['_sesCANCEL_GUIDE'] = $cancel_guide;
        $_SESSION['_sesCANCEL_HOTSPOT'] = $cancel_hotspot;
        $_SESSION['_sesCANCEL_ACTIVITY'] = $cancel_activity;
        $_SESSION['_sesCANCEL_HOTEL'] = $cancel_hotel;
        $_SESSION['_sesCANCEL_VEHICLE'] = $cancel_vehicle;
        $_SESSION['_sesCANCEL_PERCENTAGE'] = $itinerary_cancellation_percentage;

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCLEL GUIDE DETAILS
            if ($cancel_guide == 1):

                //INSERT ITINEARY GUIDE DETAILS
                $select_itinerary_route_guide_details = sqlQUERY_LABEL("SELECT `confirmed_route_guide_ID`,`route_guide_ID`, `itinerary_plan_ID`, `itinerary_route_ID`, `guide_id`,`guide_status`,`guide_not_visited_description`,`driver_guide_status`, `driver_not_visited_description`,`guide_type`, `guide_language`, `guide_slot`, `guide_cost` FROM `dvi_confirmed_itinerary_route_guide_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                if (sqlNUMOFROW_LABEL($select_itinerary_route_guide_details) > 0) :

                    while ($fetch_guide_details = sqlFETCHARRAY_LABEL($select_itinerary_route_guide_details)) :
                        $confirmed_route_guide_ID = $fetch_guide_details['confirmed_route_guide_ID'];
                        $route_guide_ID = $fetch_guide_details['route_guide_ID'];
                        $itinerary_plan_ID = $fetch_guide_details['itinerary_plan_ID'];
                        $itinerary_route_ID = $fetch_guide_details['itinerary_route_ID'];
                        $guide_id = $fetch_guide_details['guide_id'];
                        $guide_status = $fetch_guide_details['guide_status'];
                        $guide_not_visited_description = $fetch_guide_details['guide_not_visited_description'];
                        $driver_guide_status = $fetch_guide_details['driver_guide_status'];
                        $driver_not_visited_description = $fetch_guide_details['driver_not_visited_description'];

                        $guide_type = $fetch_guide_details['guide_type'];
                        $guide_language = $fetch_guide_details['guide_language'];
                        $guide_slot = $fetch_guide_details['guide_slot'];
                        $guide_cost = $fetch_guide_details['guide_cost'];

                        $check_itinerary_route_guide_details = sqlQUERY_LABEL("SELECT `cancelled_route_guide_ID` FROM `dvi_cancelled_itinerary_route_guide_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' and `route_guide_ID`='$route_guide_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                        if (sqlNUMOFROW_LABEL($check_itinerary_route_guide_details) == 0) :

                            $arrFields_guide_details = array('`confirmed_route_guide_ID`', '`route_guide_ID`', '`itinerary_plan_ID`', '`itinerary_route_ID`', '`guide_id`', '`guide_status`', '`guide_not_visited_description`', '`driver_guide_status`', '`driver_not_visited_description`', '`guide_type`', '`guide_language`', '`guide_slot`', '`guide_cost`', '`createdby`', '`status`');

                            $arrValues_guide_details = array("$confirmed_route_guide_ID", "$route_guide_ID", "$itinerary_plan_ID", "$itinerary_route_ID", "$guide_id", "$guide_status", "$guide_not_visited_description", "$driver_guide_status", "$driver_not_visited_description", "$guide_type", "$guide_language", "$guide_slot", "$guide_cost", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_guide_details", $arrFields_guide_details, $arrValues_guide_details, '')) :
                            endif;
                        endif;

                    endwhile;

                    //INSERT ITINEARY GUIDE SLOT COST DETAILS
                    $select_itinerary_route_guide_slot_cost_details = sqlQUERY_LABEL("SELECT `cnf_itinerary_guide_slot_cost_details_ID`,`guide_slot_cost_details_id`, `route_guide_id`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `guide_id`, `guide_type`, `guide_slot`, `guide_slot_cost` FROM `dvi_confirmed_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_itinerary_route_guide_slot_cost_details) > 0) :
                        while ($fetch_guide_slot_details = sqlFETCHARRAY_LABEL($select_itinerary_route_guide_slot_cost_details)) :
                            $cnf_itinerary_guide_slot_cost_details_ID = $fetch_guide_slot_details['cnf_itinerary_guide_slot_cost_details_ID'];
                            $guide_slot_cost_details_id = $fetch_guide_slot_details['guide_slot_cost_details_id'];
                            $route_guide_id = $fetch_guide_slot_details['route_guide_id'];
                            $itinerary_plan_id = $fetch_guide_slot_details['itinerary_plan_id'];
                            $itinerary_route_id = $fetch_guide_slot_details['itinerary_route_id'];
                            $itinerary_route_date = $fetch_guide_slot_details['itinerary_route_date'];
                            $guide_id = $fetch_guide_slot_details['guide_id'];
                            $guide_type = $fetch_guide_slot_details['guide_type'];
                            $guide_slot = $fetch_guide_slot_details['guide_slot'];
                            $guide_slot_cost = $fetch_guide_slot_details['guide_slot_cost'];


                            $check_itinerary_route_guide_slot_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_guide_slot_cost_details_ID` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' and `guide_slot_cost_details_id`='$guide_slot_cost_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                            if (sqlNUMOFROW_LABEL($check_itinerary_route_guide_slot_cost_details) == 0) :

                                $arrFields_guide_slot_details = array('`cnf_itinerary_guide_slot_cost_details_ID`', '`guide_slot_cost_details_id`', '`route_guide_id`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`guide_id`', '`guide_type`', '`guide_slot`', '`guide_slot_cost`', '`createdby`', '`status`');

                                $arrValues_guide_slot_details = array("$cnf_itinerary_guide_slot_cost_details_ID", "$guide_slot_cost_details_id", "$route_guide_id", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$guide_id", "$guide_type", "$guide_slot", "$guide_slot_cost", "$logged_user_id", "1");

                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_guide_slot_cost_details", $arrFields_guide_slot_details, $arrValues_guide_slot_details, '')) :
                                endif;
                            endif;
                        endwhile;
                    endif;

                    //SUCCESS
                    $response['i_result'] = true;
                else:
                    $response['i_result'] = false;
                endif;

            endif;

            //CANCLEL HOTSPOT DETAILS
            if ($cancel_hotspot == 1):
                $check_itinerary_route_hotspot_details = sqlQUERY_LABEL("SELECT `cancelled_route_hotspot_ID` FROM `dvi_cancelled_itinerary_route_hotspot_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTSPOT_LIST:" . sqlERROR_LABEL());
                if (sqlNUMOFROW_LABEL($check_itinerary_route_hotspot_details) == 0) :

                    //INSERT ITINEARY HOTSPOT DETAILS
                    $select_itinerary_route_hotspot_details = sqlQUERY_LABEL("SELECT `confirmed_route_hotspot_ID`, `route_hotspot_ID`, `itinerary_plan_ID`, `itinerary_route_ID`, `item_type`, `hotspot_order`, `hotspot_ID`, `guide_hotspot_status`, `guide_not_visited_description`, `driver_hotspot_status`, `driver_not_visited_description`, `hotspot_adult_entry_cost`, `hotspot_child_entry_cost`, `hotspot_infant_entry_cost`, `hotspot_foreign_adult_entry_cost`, `hotspot_foreign_child_entry_cost`, `hotspot_foreign_infant_entry_cost`, `hotspot_amout`, `hotspot_traveling_time`, `itinerary_travel_type_buffer_time`, `hotspot_travelling_distance`, `hotspot_start_time`, `hotspot_end_time`, `allow_break_hours`, `allow_via_route`, `via_location_name`, `hotspot_plan_own_way` FROM `dvi_confirmed_itinerary_route_hotspot_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `item_type`='4' AND (`hotspot_amout`>'0')") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_itinerary_route_hotspot_details) > 0) :

                        while ($fetch_hotspot_details = sqlFETCHARRAY_LABEL($select_itinerary_route_hotspot_details)) :
                            $confirmed_route_hotspot_ID = $fetch_hotspot_details['confirmed_route_hotspot_ID'];
                            $route_hotspot_ID = $fetch_hotspot_details['route_hotspot_ID'];
                            $itinerary_plan_ID = $fetch_hotspot_details['itinerary_plan_ID'];
                            $itinerary_route_ID = $fetch_hotspot_details['itinerary_route_ID'];
                            $item_type = $fetch_hotspot_details['item_type'];
                            $hotspot_order = $fetch_hotspot_details['hotspot_order'];
                            $hotspot_ID = $fetch_hotspot_details['hotspot_ID'];
                            $guide_hotspot_status = $fetch_hotspot_details['guide_hotspot_status'];
                            $guide_not_visited_description = $fetch_hotspot_details['guide_not_visited_description'];
                            $driver_hotspot_status = $fetch_hotspot_details['driver_hotspot_status'];
                            $driver_not_visited_description = $fetch_hotspot_details['driver_not_visited_description'];
                            $hotspot_adult_entry_cost = $fetch_hotspot_details['hotspot_adult_entry_cost'];
                            $hotspot_child_entry_cost = $fetch_hotspot_details['hotspot_child_entry_cost'];
                            $hotspot_infant_entry_cost = $fetch_hotspot_details['hotspot_infant_entry_cost'];
                            $hotspot_foreign_adult_entry_cost = $fetch_hotspot_details['hotspot_foreign_adult_entry_cost'];
                            $hotspot_foreign_child_entry_cost = $fetch_hotspot_details['hotspot_foreign_child_entry_cost'];
                            $hotspot_foreign_infant_entry_cost = $fetch_hotspot_details['hotspot_foreign_infant_entry_cost'];
                            $hotspot_amout = $fetch_hotspot_details['hotspot_amout'];
                            $hotspot_traveling_time = $fetch_hotspot_details['hotspot_traveling_time'];
                            $itinerary_travel_type_buffer_time = $fetch_hotspot_details['itinerary_travel_type_buffer_time'];
                            $hotspot_travelling_distance = $fetch_hotspot_details['hotspot_travelling_distance'];
                            $hotspot_start_time = $fetch_hotspot_details['hotspot_start_time'];
                            $hotspot_end_time = $fetch_hotspot_details['hotspot_end_time'];
                            $allow_break_hours = $fetch_hotspot_details['allow_break_hours'];
                            $allow_via_route = $fetch_hotspot_details['allow_via_route'];
                            $via_location_name = $fetch_hotspot_details['via_location_name'];
                            $hotspot_plan_own_way = $fetch_hotspot_details['hotspot_plan_own_way'];

                            $arrFields_hotspot_details = array('`confirmed_route_hotspot_ID`', '`route_hotspot_ID`', '`itinerary_plan_ID`', '`itinerary_route_ID`', '`item_type`',  '`hotspot_order`', '`hotspot_ID`', '`guide_hotspot_status`', '`guide_not_visited_description`', '`driver_hotspot_status`', '`driver_not_visited_description`', '`hotspot_adult_entry_cost`', '`hotspot_child_entry_cost`', '`hotspot_infant_entry_cost`', '`hotspot_foreign_adult_entry_cost`', '`hotspot_foreign_child_entry_cost`', '`hotspot_foreign_infant_entry_cost`', '`hotspot_amout`', '`hotspot_traveling_time`', '`itinerary_travel_type_buffer_time`', '`hotspot_travelling_distance`', '`hotspot_start_time`', '`hotspot_end_time`', '`allow_break_hours`', '`allow_via_route`', '`via_location_name`', '`hotspot_plan_own_way`', '`createdby`', '`status`');

                            $arrValues_hotspot_details = array(
                                "$confirmed_route_hotspot_ID",
                                "$route_hotspot_ID",
                                "$itinerary_plan_ID",
                                "$itinerary_route_ID",
                                "$item_type",
                                "$hotspot_order",
                                "$hotspot_ID",
                                "$guide_hotspot_status",
                                "$guide_not_visited_description",
                                "$driver_hotspot_status",
                                "$driver_not_visited_description",
                                "$hotspot_adult_entry_cost",
                                "$hotspot_child_entry_cost",
                                "$hotspot_infant_entry_cost",
                                "$hotspot_foreign_adult_entry_cost",
                                "$hotspot_foreign_child_entry_cost",
                                "$hotspot_foreign_infant_entry_cost",
                                "$hotspot_amout",
                                "$hotspot_traveling_time",
                                "$itinerary_travel_type_buffer_time",
                                "$hotspot_travelling_distance",
                                "$hotspot_start_time",
                                "$hotspot_end_time",
                                "$allow_break_hours",
                                "$allow_via_route",
                                "$via_location_name",
                                "$hotspot_plan_own_way",
                                "$logged_user_id",
                                "1"
                            );

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_hotspot_details", $arrFields_hotspot_details, $arrValues_hotspot_details, '')) :
                            endif;

                            //INSERT ITINEARY HOTSPOT ENTRY COST DETAILS

                            // $check_itinerary_route_hotspot_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_hotspot_cost_detail_ID` FROM `dvi_cancelled_itinerary_route_hotspot_entry_cost_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID'  AND `route_hotspot_id`='$route_hotspot_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTSPOT_ENTRY_COST:" . sqlERROR_LABEL());
                            // if (sqlNUMOFROW_LABEL($check_itinerary_route_hotspot_cost_details) == 0) :

                            $select_itinerary_route_hotspot_cost_details = sqlQUERY_LABEL("SELECT `cnf_itinerary_hotspot_cost_detail_ID`, `hotspot_cost_detail_id`, `route_hotspot_id`, `hotspot_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost` FROM `dvi_confirmed_itinerary_route_hotspot_entry_cost_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `route_hotspot_id`='$route_hotspot_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                            if (sqlNUMOFROW_LABEL($select_itinerary_route_hotspot_cost_details) > 0) :
                                while ($fetch_hotspot_cost_details = sqlFETCHARRAY_LABEL($select_itinerary_route_hotspot_cost_details)) :
                                    $cnf_itinerary_hotspot_cost_detail_ID = $fetch_hotspot_cost_details['cnf_itinerary_hotspot_cost_detail_ID'];
                                    $hotspot_cost_detail_id = $fetch_hotspot_cost_details['hotspot_cost_detail_id'];
                                    $route_hotspot_id = $fetch_hotspot_cost_details['route_hotspot_id'];
                                    $hotspot_ID = $fetch_hotspot_cost_details['hotspot_ID'];
                                    $itinerary_plan_id = $fetch_hotspot_cost_details['itinerary_plan_id'];
                                    $itinerary_route_id = $fetch_hotspot_cost_details['itinerary_route_id'];
                                    $traveller_type = $fetch_hotspot_cost_details['traveller_type'];
                                    $traveller_name = $fetch_hotspot_cost_details['traveller_name'];
                                    $entry_ticket_cost = $fetch_hotspot_cost_details['entry_ticket_cost'];

                                    $arrFields_hotspot_cost_details = array('`cnf_itinerary_hotspot_cost_detail_ID`', '`hotspot_cost_detail_id`', '`route_hotspot_id`', '`hotspot_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`traveller_type`', '`traveller_name`', '`entry_ticket_cost`',  '`createdby`', '`status`');

                                    $arrValues_hotspot_cost_details = array("$cnf_itinerary_hotspot_cost_detail_ID", "$hotspot_cost_detail_id", "$route_hotspot_id", "$hotspot_ID", "$itinerary_plan_id", "$itinerary_route_id", "$traveller_type", "$traveller_name", "$entry_ticket_cost",  "$logged_user_id", "1");

                                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_hotspot_entry_cost_details", $arrFields_hotspot_cost_details, $arrValues_hotspot_cost_details, '')) :
                                    endif;
                                endwhile;
                            endif;
                        //endif;
                        endwhile;
                    endif;

                endif;
                $response['i_result'] = true;
            endif;

            //CANCLEL ACTIVITY DETAILS
            if ($cancel_activity == 1):
                $check_itinerary_route_activity_details = sqlQUERY_LABEL("SELECT `cancelled_route_activity_ID` FROM `dvi_cancelled_itinerary_route_activity_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINERARY_ACTIVITY_LIST:" . sqlERROR_LABEL());
                if (sqlNUMOFROW_LABEL($check_itinerary_route_activity_details) == 0) :

                    //INSERT ITINEARY ACTIVITY DETAILS
                    $select_itinerary_route_activity_details = sqlQUERY_LABEL("SELECT `confirmed_route_activity_ID`, `route_activity_ID`, `itinerary_plan_ID`, `itinerary_route_ID`, `route_hotspot_ID`, `hotspot_ID`, `activity_ID`, `guide_activity_status`, `guide_not_visited_description`, `activity_statys`, `driver_activity_status`, `driver_not_visited_description`, `activity_order`, `activity_charges_for_foreign_adult`, `activity_charges_for_foreign_children`, `activity_charges_for_foreign_infant`, `activity_charges_for_adult`, `activity_charges_for_children`, `activity_charges_for_infant`, `activity_amout`, `activity_traveling_time`, `activity_start_time`, `activity_end_time` FROM `dvi_confirmed_itinerary_route_activity_details` WHERE `deleted` = '0' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND (`activity_amout`>'0')") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_itinerary_route_activity_details) > 0) :

                        while ($fetch_activity_details = sqlFETCHARRAY_LABEL($select_itinerary_route_activity_details)) :
                            $confirmed_route_activity_ID = $fetch_activity_details['confirmed_route_activity_ID'];
                            $route_activity_ID = $fetch_activity_details['route_activity_ID'];
                            $itinerary_plan_ID = $fetch_activity_details['itinerary_plan_ID'];
                            $itinerary_route_ID = $fetch_activity_details['itinerary_route_ID'];
                            $route_hotspot_ID = $fetch_activity_details['route_hotspot_ID'];
                            $hotspot_ID = $fetch_activity_details['hotspot_ID'];
                            $activity_ID = $fetch_activity_details['activity_ID'];
                            $guide_activity_status = $fetch_activity_details['guide_activity_status'];
                            $guide_not_visited_description = $fetch_activity_details['guide_not_visited_description'];
                            $activity_statys = $fetch_activity_details['activity_statys'];
                            $driver_activity_status = $fetch_activity_details['driver_activity_status'];
                            $driver_not_visited_description = $fetch_activity_details['driver_not_visited_description'];
                            $activity_order = $fetch_activity_details['activity_order'];
                            $activity_charges_for_foreign_adult = $fetch_activity_details['activity_charges_for_foreign_adult'];
                            $activity_charges_for_foreign_children = $fetch_activity_details['activity_charges_for_foreign_children'];
                            $activity_charges_for_foreign_infant = $fetch_activity_details['activity_charges_for_foreign_infant'];
                            $activity_charges_for_adult = $fetch_activity_details['activity_charges_for_adult'];
                            $activity_charges_for_children = $fetch_activity_details['activity_charges_for_children'];
                            $activity_charges_for_infant = $fetch_activity_details['activity_charges_for_infant'];
                            $activity_amout = $fetch_activity_details['activity_amout'];
                            $activity_traveling_time = $fetch_activity_details['activity_traveling_time'];
                            $activity_start_time = $fetch_activity_details['activity_start_time'];
                            $activity_end_time = $fetch_activity_details['activity_end_time'];


                            $arrFields_activity_details = array('`confirmed_route_activity_ID`', '`route_activity_ID`', '`itinerary_plan_ID`', '`itinerary_route_ID`', '`route_hotspot_ID`', '`hotspot_ID`', '`activity_ID`', '`guide_activity_status`', '`guide_not_visited_description`', '`activity_statys`', '`driver_activity_status`', '`driver_not_visited_description`', '`activity_order`', '`activity_charges_for_foreign_adult`', '`activity_charges_for_foreign_children`', '`activity_charges_for_foreign_infant`', '`activity_charges_for_adult`', '`activity_charges_for_children`', '`activity_charges_for_infant`', '`activity_amout`', '`activity_traveling_time`', '`activity_start_time`', '`activity_end_time`', '`createdby`', '`status`');

                            $arrValues_activity_details = array(
                                "$confirmed_route_activity_ID",
                                "$route_activity_ID",
                                "$itinerary_plan_ID",
                                "$itinerary_route_ID",
                                "$route_hotspot_ID",
                                "$hotspot_ID",
                                "$activity_ID",
                                "$guide_activity_status",
                                "$guide_not_visited_description",
                                "$activity_statys",
                                "$driver_activity_status",
                                "$driver_not_visited_description",
                                "$activity_order",
                                "$activity_charges_for_foreign_adult",
                                "$activity_charges_for_foreign_children",
                                "$activity_charges_for_foreign_infant",
                                "$activity_charges_for_adult",
                                "$activity_charges_for_children",
                                "$activity_charges_for_infant",
                                "$activity_amout",
                                "$activity_traveling_time",
                                "$activity_start_time",
                                "$activity_end_time",
                                "$logged_user_id",
                                "1"
                            );

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_activity_details", $arrFields_activity_details, $arrValues_activity_details, '')) :
                                $cancelled_route_activity_ID  = sqlINSERTID_LABEL();
                            endif;

                            //INSERT ITINEARY ACTIVITY ENTRY COST DETAILS
                            $select_itinerary_route_activity_cost_details = sqlQUERY_LABEL("SELECT  `cnf_itinerary_activity_cost_detail_ID`, `activity_cost_detail_id`, `route_activity_id`, `hotspot_ID`, `activity_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost` FROM `dvi_confirmed_itinerary_route_activity_entry_cost_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `route_activity_id`='$route_activity_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                            if (sqlNUMOFROW_LABEL($select_itinerary_route_activity_cost_details) > 0) :
                                while ($fetch_activity_cost_details = sqlFETCHARRAY_LABEL($select_itinerary_route_activity_cost_details)) :
                                    $cnf_itinerary_activity_cost_detail_ID = $fetch_activity_cost_details['cnf_itinerary_activity_cost_detail_ID'];
                                    $activity_cost_detail_id = $fetch_activity_cost_details['activity_cost_detail_id'];
                                    $route_activity_id = $fetch_activity_cost_details['route_activity_id'];
                                    $hotspot_ID = $fetch_activity_cost_details['hotspot_ID'];
                                    $activity_ID = $fetch_activity_cost_details['activity_ID'];
                                    $itinerary_plan_id = $fetch_activity_cost_details['itinerary_plan_id'];
                                    $itinerary_route_id = $fetch_activity_cost_details['itinerary_route_id'];
                                    $traveller_type = $fetch_activity_cost_details['traveller_type'];
                                    $traveller_name = $fetch_activity_cost_details['traveller_name'];
                                    $entry_ticket_cost = $fetch_activity_cost_details['entry_ticket_cost'];

                                    $arrFields_activity_cost_details = array('`cancelled_route_activity_ID`', '`cnf_itinerary_activity_cost_detail_ID`', '`activity_cost_detail_id`', '`route_activity_id`', '`hotspot_ID`', '`activity_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`traveller_type`', '`traveller_name`', '`entry_ticket_cost`',  '`createdby`', '`status`');

                                    $arrValues_activity_cost_details = array("$cancelled_route_activity_ID", "$cnf_itinerary_activity_cost_detail_ID", "$activity_cost_detail_id", "$route_activity_id", "$hotspot_ID", "$activity_ID", "$itinerary_plan_id", "$itinerary_route_id", "$traveller_type", "$traveller_name", "$entry_ticket_cost",  "$logged_user_id", "1");

                                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_route_activity_entry_cost_details", $arrFields_activity_cost_details, $arrValues_activity_cost_details, '')) :
                                    endif;
                                endwhile;
                            endif;

                        endwhile;
                    endif;

                endif;
                $response['i_result'] = true;
            endif;

            //CANCLEL HOTEL DETAILS
            if ($cancel_hotel == 1):
                # HOTEL CANCELLATION CLONING DATA FROM CONFIRMED ITINEARY DETAILS
                $check_itinerary_confirmed_hotel_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($check_itinerary_confirmed_hotel_details) == 0) :
                    //COLLECT CONFIRMED ITINEARY PLAN HOTEL DETAILS
                    $select_confirmed_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_hotel_details_ID`, `itinerary_plan_hotel_details_ID`, `group_type`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `itinerary_route_location`, `hotel_required`, `hotel_category_id`, `hotel_id`, `hotel_margin_percentage`, `hotel_margin_gst_type`, `hotel_margin_gst_percentage`, `hotel_margin_rate`, `hotel_margin_rate_tax_amt`, `hotel_breakfast_cost`, `hotel_breakfast_cost_gst_amount`, `hotel_lunch_cost`, `hotel_lunch_cost_gst_amount`, `hotel_dinner_cost`, `hotel_dinner_cost_gst_amount`, `total_no_of_persons`, `total_hotel_meal_plan_cost`, `total_hotel_meal_plan_cost_gst_amount`, `total_extra_bed_cost`, `total_extra_bed_cost_gst_amount`, `total_childwith_bed_cost`, `total_childwith_bed_cost_gst_amount`, `total_childwithout_bed_cost`, `total_childwithout_bed_cost_gst_amount`, `total_no_of_rooms`, `total_room_cost`, `total_room_gst_amount`, `total_hotel_cost`, `total_amenities_cost`, `total_amenities_gst_amount`, `total_hotel_tax_amount`, `hotel_cancellation_status` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_plan_hotel_details) > 0) :
                        while ($fetch_hotel_details = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_hotel_details)) :
                            $confirmed_itinerary_plan_hotel_details_ID = $fetch_hotel_details['confirmed_itinerary_plan_hotel_details_ID'];
                            $itinerary_plan_hotel_details_ID = $fetch_hotel_details['itinerary_plan_hotel_details_ID'];
                            $group_type = $fetch_hotel_details['group_type'];
                            $itinerary_plan_id = $fetch_hotel_details['itinerary_plan_id'];
                            $itinerary_route_id = $fetch_hotel_details['itinerary_route_id'];
                            $itinerary_route_date = $fetch_hotel_details['itinerary_route_date'];
                            $itinerary_route_location = $fetch_hotel_details['itinerary_route_location'];
                            $hotel_required = $fetch_hotel_details['hotel_required'];
                            $hotel_category_id = $fetch_hotel_details['hotel_category_id'];
                            $hotel_id = $fetch_hotel_details['hotel_id'];
                            $hotel_margin_percentage = $fetch_hotel_details['hotel_margin_percentage'];
                            $hotel_margin_gst_type = $fetch_hotel_details['hotel_margin_gst_type'];
                            $hotel_margin_gst_percentage = $fetch_hotel_details['hotel_margin_gst_percentage'];
                            $hotel_margin_rate = $fetch_hotel_details['hotel_margin_rate'];
                            $hotel_margin_rate_tax_amt = $fetch_hotel_details['hotel_margin_rate_tax_amt'];
                            $hotel_breakfast_cost = $fetch_hotel_details['hotel_breakfast_cost'];
                            $hotel_breakfast_cost_gst_amount = $fetch_hotel_details['hotel_breakfast_cost_gst_amount'];
                            $hotel_lunch_cost = $fetch_hotel_details['hotel_lunch_cost'];
                            $hotel_lunch_cost_gst_amount = $fetch_hotel_details['hotel_lunch_cost_gst_amount'];
                            $hotel_dinner_cost = $fetch_hotel_details['hotel_dinner_cost'];
                            $hotel_dinner_cost_gst_amount = $fetch_hotel_details['hotel_dinner_cost_gst_amount'];
                            $total_no_of_persons = $fetch_hotel_details['total_no_of_persons'];
                            $total_hotel_meal_plan_cost = $fetch_hotel_details['total_hotel_meal_plan_cost'];
                            $total_hotel_meal_plan_cost_gst_amount = $fetch_hotel_details['total_hotel_meal_plan_cost_gst_amount'];
                            $total_extra_bed_cost = $fetch_hotel_details['total_extra_bed_cost'];
                            $total_extra_bed_cost_gst_amount = $fetch_hotel_details['total_extra_bed_cost_gst_amount'];
                            $total_childwith_bed_cost = $fetch_hotel_details['total_childwith_bed_cost'];
                            $total_childwith_bed_cost_gst_amount = $fetch_hotel_details['total_childwith_bed_cost_gst_amount'];
                            $total_childwithout_bed_cost = $fetch_hotel_details['total_childwithout_bed_cost'];
                            $total_no_of_rooms = $fetch_hotel_details['total_no_of_rooms'];
                            $total_room_cost = $fetch_hotel_details['total_room_cost'];
                            $total_room_gst_amount = $fetch_hotel_details['total_room_gst_amount'];
                            $total_hotel_cost = $fetch_hotel_details['total_hotel_cost'];
                            $total_amenities_cost = $fetch_hotel_details['total_amenities_cost'];
                            $total_amenities_gst_amount = $fetch_hotel_details['total_amenities_gst_amount'];
                            $total_hotel_tax_amount = $fetch_hotel_details['total_hotel_tax_amount'];
                            $hotel_cancellation_status = $fetch_hotel_details['hotel_cancellation_status'];

                            $arrFields_hotel_details = array(
                                '`confirmed_itinerary_plan_hotel_details_ID`',
                                '`itinerary_plan_hotel_details_ID`',
                                '`group_type`',
                                '`itinerary_plan_id`',
                                '`itinerary_route_id`',
                                '`itinerary_route_date`',
                                '`itinerary_route_location`',
                                '`hotel_required`',
                                '`hotel_category_id`',
                                '`hotel_id`',
                                '`hotel_margin_percentage`',
                                '`hotel_margin_gst_type`',
                                '`hotel_margin_gst_percentage`',
                                '`hotel_margin_rate`',
                                '`hotel_margin_rate_tax_amt`',
                                '`hotel_breakfast_cost`',
                                '`hotel_breakfast_cost_gst_amount`',
                                '`hotel_lunch_cost`',
                                '`hotel_lunch_cost_gst_amount`',
                                '`hotel_dinner_cost`',
                                '`hotel_dinner_cost_gst_amount`',
                                '`total_no_of_persons`',
                                '`hotspot_start_time`',
                                '`total_hotel_meal_plan_cost_gst_amount`',
                                '`total_extra_bed_cost`',
                                '`total_extra_bed_cost_gst_amount`',
                                '`total_childwith_bed_cost`',
                                '`total_childwith_bed_cost_gst_amount`',
                                '`total_childwithout_bed_cost`',
                                '`total_childwithout_bed_cost_gst_amount`',
                                '`total_no_of_rooms`',
                                '`total_room_cost`',
                                '`total_room_gst_amount`',
                                '`total_hotel_cost`',
                                '`total_amenities_cost`',
                                '`total_amenities_gst_amount`',
                                '`total_hotel_tax_amount`',
                                '`hotel_cancellation_status`',
                                '`cancelled_on`',
                                '`total_hotel_cancelled_service_amount`',
                                '`total_hotel_cancellation_charge`',
                                '`total_hotel_refund_amount`',
                                '`createdby`',
                                '`status`'
                            );

                            $arrValues_hotel_details = array(
                                "$confirmed_itinerary_plan_hotel_details_ID",
                                "$itinerary_plan_hotel_details_ID",
                                "$group_type",
                                "$itinerary_plan_id",
                                "$itinerary_route_id",
                                "$itinerary_route_date",
                                "$itinerary_route_location",
                                "$hotel_required",
                                "$hotel_category_id",
                                "$hotel_id",
                                "$hotel_margin_percentage",
                                "$hotel_margin_gst_type",
                                "$hotel_margin_gst_percentage",
                                "$hotel_margin_rate",
                                "$hotel_margin_rate_tax_amt",
                                "$hotel_breakfast_cost",
                                "$hotel_breakfast_cost_gst_amount",
                                "$hotel_lunch_cost",
                                "$hotel_lunch_cost_gst_amount",
                                "$hotel_dinner_cost",
                                "$hotel_dinner_cost_gst_amount",
                                "$total_no_of_persons",
                                "$hotspot_start_time",
                                "$total_hotel_meal_plan_cost_gst_amount",
                                "$total_extra_bed_cost",
                                "$total_extra_bed_cost_gst_amount",
                                "$total_childwith_bed_cost",
                                "$total_childwith_bed_cost_gst_amount",
                                "$total_childwithout_bed_cost",
                                "$total_childwithout_bed_cost_gst_amount",
                                "$total_no_of_rooms",
                                "$total_room_cost",
                                "$total_room_gst_amount",
                                "$total_hotel_cost",
                                "$total_amenities_cost",
                                "$total_amenities_gst_amount",
                                "$total_hotel_tax_amount",
                                "$hotel_cancellation_status",
                                "$cancelled_on",
                                "$total_hotel_cancelled_service_amount",
                                "$total_hotel_cancellation_charge",
                                "$total_hotel_refund_amount",
                                "$logged_user_id",
                                "1"
                            );

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel_details, $arrValues_hotel_details, '')) :
                            endif;
                        endwhile;
                    endif;

                    //COLLECT CONFIRMED ITINEARY HOTEL ROOM DETAILS
                    $select_confirmed_itinerary_hotel_room_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_hotel_room_details_ID`, `itinerary_plan_hotel_room_details_ID`,  `itinerary_plan_hotel_details_id`,`confirmed_itinerary_plan_hotel_details_id`, `group_type`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `hotel_id`, `room_type_id`, `room_id`, `room_qty`, `room_rate`, `gst_type`, `gst_percentage`, `extra_bed_count`, `extra_bed_rate`, `child_without_bed_count`, `child_without_bed_charges`, `child_with_bed_count`, `child_with_bed_charges`, `breakfast_required`, `lunch_required`, `dinner_required`, `breakfast_cost_per_person`, `lunch_cost_per_person`, `dinner_cost_per_person`, `total_breafast_cost`, `total_lunch_cost`, `total_dinner_cost`, `total_room_cost`, `total_room_gst_amount`, `room_cancellation_status`, `extra_bed_cancellation_status`, `child_without_bed_cancellation_status`, `child_with_bed_cancellation_status`, `breakfast_cancellation_status`, `lunch_cancellation_status`, `dinner_cancellation_status`, `room_defect_type` FROM `dvi_confirmed_itinerary_plan_hotel_room_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `status`='1'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTEL_ROOM_DETAILS:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_hotel_room_details) > 0) :
                        while ($fetch_hotel_room_cost_details = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_hotel_room_details)) :
                            $confirmed_itinerary_plan_hotel_room_details_ID = $fetch_hotel_room_cost_details['confirmed_itinerary_plan_hotel_room_details_ID'];
                            $itinerary_plan_hotel_room_details_ID = $fetch_hotel_room_cost_details['itinerary_plan_hotel_room_details_ID'];
                            $itinerary_plan_hotel_details_id = $fetch_hotel_room_cost_details['itinerary_plan_hotel_details_id'];
                            $confirmed_itinerary_plan_hotel_details_id = $fetch_hotel_room_cost_details['confirmed_itinerary_plan_hotel_details_id'];
                            $group_type = $fetch_hotel_room_cost_details['group_type'];
                            $itinerary_plan_id = $fetch_hotel_room_cost_details['itinerary_plan_id'];
                            $itinerary_route_id = $fetch_hotel_room_cost_details['itinerary_route_id'];
                            $itinerary_route_date = $fetch_hotel_room_cost_details['itinerary_route_date'];
                            $hotel_id = $fetch_hotel_room_cost_details['hotel_id'];
                            $room_type_id = $fetch_hotel_room_cost_details['room_type_id'];
                            $room_id = $fetch_hotel_room_cost_details['room_id'];
                            $room_qty = $fetch_hotel_room_cost_details['room_qty'];
                            $room_rate = $fetch_hotel_room_cost_details['room_rate'];
                            $gst_type = $fetch_hotel_room_cost_details['gst_type'];
                            $gst_percentage = $fetch_hotel_room_cost_details['gst_percentage'];
                            $extra_bed_count = $fetch_hotel_room_cost_details['extra_bed_count'];
                            $extra_bed_rate = $fetch_hotel_room_cost_details['extra_bed_rate'];
                            $child_without_bed_count = $fetch_hotel_room_cost_details['child_without_bed_count'];
                            $child_without_bed_charges = $fetch_hotel_room_cost_details['child_without_bed_charges'];
                            $child_with_bed_count = $fetch_hotel_room_cost_details['child_with_bed_count'];
                            $child_with_bed_charges = $fetch_hotel_room_cost_details['child_with_bed_charges'];
                            $breakfast_required = $fetch_hotel_room_cost_details['breakfast_required'];
                            $lunch_required = $fetch_hotel_room_cost_details['lunch_required'];
                            $dinner_required = $fetch_hotel_room_cost_details['dinner_required'];
                            $breakfast_cost_per_person = $fetch_hotel_room_cost_details['breakfast_cost_per_person'];
                            $lunch_cost_per_person = $fetch_hotel_room_cost_details['lunch_cost_per_person'];
                            $dinner_cost_per_person = $fetch_hotel_room_cost_details['dinner_cost_per_person'];
                            $total_breafast_cost = $fetch_hotel_room_cost_details['total_breafast_cost'];
                            $total_lunch_cost = $fetch_hotel_room_cost_details['total_lunch_cost'];
                            $total_dinner_cost = $fetch_hotel_room_cost_details['total_dinner_cost'];
                            $total_room_cost = $fetch_hotel_room_cost_details['total_room_cost'];
                            $total_room_gst_amount = $fetch_hotel_room_cost_details['total_room_gst_amount'];
                            $room_cancellation_status = $fetch_hotel_room_cost_details['room_cancellation_status'];
                            $extra_bed_cancellation_status = $fetch_hotel_room_cost_details['extra_bed_cancellation_status'];
                            $child_without_bed_cancellation_status = $fetch_hotel_room_cost_details['child_without_bed_cancellation_status'];
                            $child_with_bed_cancellation_status = $fetch_hotel_room_cost_details['child_with_bed_cancellation_status'];
                            $breakfast_cancellation_status = $fetch_hotel_room_cost_details['breakfast_cancellation_status'];
                            $lunch_cancellation_status = $fetch_hotel_room_cost_details['lunch_cancellation_status'];
                            $dinner_cancellation_status = $fetch_hotel_room_cost_details['dinner_cancellation_status'];
                            $room_defect_type = $fetch_hotel_room_cost_details['room_defect_type'];

                            $arrFields_hotel_room_details = array('`confirmed_itinerary_plan_hotel_room_details_ID`', '`itinerary_plan_hotel_room_details_ID`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`group_type`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_qty`', '`room_rate`', '`gst_type`', '`gst_percentage`', '`extra_bed_count`', '`extra_bed_rate`', '`child_without_bed_count`', '`child_without_bed_charges`', '`child_with_bed_count`', '`child_with_bed_charges`', '`breakfast_required`', '`lunch_required`', '`dinner_required`', '`breakfast_cost_per_person`', '`lunch_cost_per_person`', '`dinner_cost_per_person`', '`total_breafast_cost`', '`total_lunch_cost`', '`total_dinner_cost`', '`total_room_cost`', '`total_room_gst_amount`', '`room_cancellation_status`', '`extra_bed_cancellation_status`', '`child_without_bed_cancellation_status`', '`child_with_bed_cancellation_status`', '`breakfast_cancellation_status`', '`lunch_cancellation_status`', '`dinner_cancellation_status`', '`room_defect_type`', '`createdby`', '`status`');

                            $arrValues_hotel_room_details = array("$confirmed_itinerary_plan_hotel_room_details_ID", "$itinerary_plan_hotel_room_details_ID", "$itinerary_plan_hotel_details_id", "$confirmed_itinerary_plan_hotel_details_id", "$group_type", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$room_type_id", "$room_id", "$room_qty", "$room_rate", "$gst_type", "$gst_percentage", "$extra_bed_count", "$extra_bed_rate", "$child_without_bed_count", "$child_without_bed_charges", "$child_with_bed_count", "$child_with_bed_charges", "$breakfast_required", "$lunch_required", "$dinner_required", "$breakfast_cost_per_person", "$lunch_cost_per_person", "$dinner_cost_per_person", "$total_breafast_cost", "$total_lunch_cost", "$total_dinner_cost", "$total_room_cost", "$total_room_gst_amount", "$room_cancellation_status", "$extra_bed_cancellation_status", "$child_without_bed_cancellation_status", "$child_with_bed_cancellation_status", "$breakfast_cancellation_status", "$lunch_cancellation_status", "$dinner_cancellation_status", "$room_defect_type", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_details", $arrFields_hotel_room_details, $arrValues_hotel_room_details, '')) :
                                $cancelled_itinerary_plan_hotel_room_details_ID = sqlINSERTID_LABEL();
                            endif;
                        endwhile;
                    endif;

                    //COLLECT CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS
                    $select_confirmed_itinerary_hotel_room_service_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_hotel_room_service_details_ID`, `confirmed_itinerary_plan_hotel_room_details_ID`, `itinerary_plan_hotel_room_details_ID`, `confirmed_itinerary_plan_hotel_details_id`,`itinerary_plan_hotel_details_id`, `group_type`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `hotel_id`, `room_type_id`, `room_id`, `room_service_type`, `room_service_count`, `service_cost_per_person`, `total_room_service_rate`, `service_cancellation_status`, `room_service_defect_type` FROM `dvi_confirmed_itinerary_plan_hotel_room_service_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `status`='1'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTEL_AMENITIES_DETAILS:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_hotel_room_service_details) > 0) :
                        while ($fetch_hotel_room_service_details = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_hotel_room_service_details)) :
                            $confirmed_itinerary_plan_hotel_room_service_details_ID = $fetch_hotel_room_service_details['confirmed_itinerary_plan_hotel_room_service_details_ID'];
                            $confirmed_itinerary_plan_hotel_room_details_ID = $fetch_hotel_room_service_details['confirmed_itinerary_plan_hotel_room_details_ID'];
                            $itinerary_plan_hotel_room_details_ID = $fetch_hotel_room_service_details['itinerary_plan_hotel_room_details_ID'];
                            $itinerary_plan_hotel_details_id = $fetch_hotel_room_service_details['itinerary_plan_hotel_details_id'];
                            $confirmed_itinerary_plan_hotel_details_id = $fetch_hotel_room_service_details['confirmed_itinerary_plan_hotel_details_id'];
                            $group_type = $fetch_hotel_room_service_details['group_type'];
                            $itinerary_plan_id = $fetch_hotel_room_service_details['itinerary_plan_id'];
                            $itinerary_route_id = $fetch_hotel_room_service_details['itinerary_route_id'];
                            $itinerary_route_date = $fetch_hotel_room_service_details['itinerary_route_date'];
                            $hotel_id = $fetch_hotel_room_service_details['hotel_id'];
                            $room_type_id = $fetch_hotel_room_service_details['room_type_id'];
                            $room_id = $fetch_hotel_room_service_details['room_id'];
                            $room_service_type = $fetch_hotel_room_service_details['room_service_type'];
                            $room_service_count = $fetch_hotel_room_service_details['room_service_count'];
                            $service_cost_per_person = $fetch_hotel_room_service_details['service_cost_per_person'];
                            $total_room_service_rate = $fetch_hotel_room_service_details['total_room_service_rate'];
                            $service_cancellation_status = $fetch_hotel_room_service_details['service_cancellation_status'];
                            $room_service_defect_type = $fetch_hotel_room_service_details['room_service_defect_type'];

                            $arrFields_hotel_room_service_details = array('`confirmed_itinerary_plan_hotel_room_service_details_ID`', '`cancelled_itinerary_plan_hotel_room_details_ID`', '`confirmed_itinerary_plan_hotel_room_details_ID`', '`itinerary_plan_hotel_room_details_ID`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`group_type`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_service_type`', '`room_service_count`', '`service_cost_per_person`', '`total_room_service_rate`', '`service_cancellation_status`', '`room_service_defect_type`', '`createdby`', '`status`');

                            $arrValues_hotel_room_service_details = array("$confirmed_itinerary_plan_hotel_room_service_details_ID", "$cancelled_itinerary_plan_hotel_room_details_ID", "$confirmed_itinerary_plan_hotel_room_details_ID", "$itinerary_plan_hotel_room_details_ID", "$itinerary_plan_hotel_details_id", "$confirmed_itinerary_plan_hotel_details_id", "$group_type", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$room_type_id", "$room_id", "$room_service_type", "$room_service_count", "$service_cost_per_person", "$total_room_service_rate", "$service_cancellation_status", "$room_service_defect_type", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $arrFields_hotel_room_service_details, $arrValues_hotel_room_service_details, '')) :
                            endif;
                        endwhile;
                    endif;

                    //COLLECT CONFIRMED ITINEARY HOTEL AMENITIES DETAILS
                    $select_confirmed_itinerary_hotel_amenities_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_hotel_room_amenities_details_ID`, `itinerary_plan_hotel_room_amenities_details_ID`, `itinerary_plan_hotel_details_id`,`confirmed_itinerary_plan_hotel_details_id`, `group_type`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `hotel_id`, `hotel_amenities_id`, `total_qty`, `amenitie_rate`, `total_amenitie_cost`, `total_amenitie_gst_amount`, `amenitie_cancellation_status`, `amenitie_defect_type` FROM `dvi_confirmed_itinerary_plan_hotel_room_amenities` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `status`='1'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_HOTEL_AMENITIES_DETAILS:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_hotel_amenities_details) > 0) :
                        while ($fetch_hotel_amenities_details = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_hotel_amenities_details)) :
                            $confirmed_itinerary_plan_hotel_room_amenities_details_ID = $fetch_hotel_amenities_details['confirmed_itinerary_plan_hotel_room_amenities_details_ID'];
                            $itinerary_plan_hotel_room_amenities_details_ID = $fetch_hotel_amenities_details['itinerary_plan_hotel_room_amenities_details_ID'];
                            $itinerary_plan_hotel_details_id = $fetch_hotel_amenities_details['itinerary_plan_hotel_details_id'];
                            $confirmed_itinerary_plan_hotel_details_id = $fetch_hotel_amenities_details['confirmed_itinerary_plan_hotel_details_id'];
                            $group_type = $fetch_hotel_amenities_details['group_type'];
                            $itinerary_plan_id = $fetch_hotel_amenities_details['itinerary_plan_id'];
                            $itinerary_route_id = $fetch_hotel_amenities_details['itinerary_route_id'];
                            $itinerary_route_date = $fetch_hotel_amenities_details['itinerary_route_date'];
                            $hotel_id = $fetch_hotel_amenities_details['hotel_id'];
                            $hotel_amenities_id = $fetch_hotel_amenities_details['hotel_amenities_id'];
                            $total_qty = $fetch_hotel_amenities_details['total_qty'];
                            $amenitie_rate = $fetch_hotel_amenities_details['amenitie_rate'];
                            $total_amenitie_cost = $fetch_hotel_amenities_details['total_amenitie_cost'];
                            $total_amenitie_gst_amount = $fetch_hotel_amenities_details['total_amenitie_gst_amount'];
                            $amenitie_cancellation_status = $fetch_hotel_amenities_details['amenitie_cancellation_status'];
                            $amenitie_defect_type = $fetch_hotel_amenities_details['amenitie_defect_type'];

                            $arrFields_hotel_amenities_details = array('`confirmed_itinerary_plan_hotel_room_amenities_details_ID`', '`itinerary_plan_hotel_room_amenities_details_ID`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`group_type`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`hotel_amenities_id`', '`total_qty`', '`amenitie_rate`', '`total_amenitie_cost`', '`total_amenitie_gst_amount`', '`amenitie_cancellation_status`', '`amenitie_defect_type`', '`createdby`', '`status`');

                            $arrValues_hotel_amenities_details = array("$confirmed_itinerary_plan_hotel_room_amenities_details_ID", "$itinerary_plan_hotel_room_amenities_details_ID", "$itinerary_plan_hotel_details_id", "$confirmed_itinerary_plan_hotel_details_id", "$group_type", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$hotel_amenities_id", "$total_qty", "$amenitie_rate", "$total_amenitie_cost", "$total_amenitie_gst_amount", "$amenitie_cancellation_status", "$amenitie_defect_type", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $arrFields_hotel_amenities_details, $arrValues_hotel_amenities_details, '')) :
                            endif;
                        endwhile;
                    endif;

                endif;
                $response['i_result'] = true;
            endif;

            //CANCLEL VEHICLE DETAILS
            if ($cancel_vehicle == 1):
                # VEHICLE CANCELLATION CLONING DATA FROM CONFIRMED ITINEARY DETAILS
                $check_itinerary_confirmed_vehicle_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_VEHICLE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($check_itinerary_confirmed_vehicle_details) == 0) :
                    //COLLECT CONFIRMED ITINEARY PLAN VEHICLE DETAILS
                    $select_confirmed_itinerary_plan_vehicle_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_vendor_eligible_ID`, `itinerary_plan_vendor_eligible_ID`, `itineary_plan_assigned_status`, `itinerary_plan_id`, `vehicle_type_id`, `total_vehicle_qty`, `vendor_id`, `outstation_allowed_km_per_day`, `vendor_vehicle_type_id`, `vehicle_id`, `vendor_branch_id`, `vehicle_orign`, `vehicle_count`, `total_kms`, `total_outstation_km`, `total_time`, `total_rental_charges`, `total_toll_charges`, `total_parking_charges`, `total_driver_charges`, `total_permit_charges`, `total_before_6_am_extra_time`, `total_after_8_pm_extra_time`, `total_before_6_am_charges_for_driver`, `total_before_6_am_charges_for_vehicle`, `total_after_8_pm_charges_for_driver`, `total_after_8_pm_charges_for_vehicle`, `extra_km_rate`, `total_allowed_kms`, `total_extra_kms`, `total_extra_kms_charge`, `total_allowed_local_kms`, `total_extra_local_kms`, `total_extra_local_kms_charge`, `vehicle_gst_type`, `vehicle_gst_percentage`, `vehicle_gst_amount`, `vehicle_total_amount`, `vendor_margin_percentage`, `vendor_margin_gst_type`, `vendor_margin_gst_percentage`, `vendor_margin_amount`, `vendor_margin_gst_amount`, `vehicle_grand_total` FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                    if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_plan_vehicle_details) > 0) :
                        while ($fetch_vendor_details = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_vehicle_details)) :
                            $confirmed_itinerary_plan_vendor_eligible_ID = $fetch_vendor_details['confirmed_itinerary_plan_vendor_eligible_ID'];
                            $itinerary_plan_vendor_eligible_ID = $fetch_vendor_details['itinerary_plan_vendor_eligible_ID'];
                            $itineary_plan_assigned_status = $fetch_vendor_details['itineary_plan_assigned_status'];
                            $itinerary_plan_id = $fetch_vendor_details['itinerary_plan_id'];
                            $vehicle_type_id = $fetch_vendor_details['vehicle_type_id'];
                            $total_vehicle_qty = $fetch_vendor_details['total_vehicle_qty'];
                            $vendor_id = $fetch_vendor_details['vendor_id'];
                            $outstation_allowed_km_per_day = $fetch_vendor_details['outstation_allowed_km_per_day'];
                            $vendor_vehicle_type_id = $fetch_vendor_details['vendor_vehicle_type_id'];
                            $vehicle_id = $fetch_vendor_details['vehicle_id'];
                            $vendor_branch_id = $fetch_vendor_details['vendor_branch_id'];
                            $vehicle_orign = $fetch_vendor_details['vehicle_orign'];
                            $vehicle_count = $fetch_vendor_details['vehicle_count'];
                            $total_kms = $fetch_vendor_details['total_kms'];
                            $total_outstation_km = $fetch_vendor_details['total_outstation_km'];
                            $total_time = $fetch_vendor_details['total_time'];
                            $total_rental_charges = $fetch_vendor_details['total_rental_charges'];
                            $total_toll_charges = $fetch_vendor_details['total_toll_charges'];
                            $total_after_8_pm_extra_time = $fetch_vendor_details['total_after_8_pm_extra_time'];
                            $total_before_6_am_charges_for_driver = $fetch_vendor_details['total_before_6_am_charges_for_driver'];
                            $total_parking_charges = $fetch_vendor_details['total_parking_charges'];
                            $total_driver_charges = $fetch_vendor_details['total_driver_charges'];
                            $total_permit_charges = $fetch_vendor_details['total_permit_charges'];
                            $total_before_6_am_charges_for_vehicle = $fetch_vendor_details['total_before_6_am_charges_for_vehicle'];
                            $total_after_8_pm_charges_for_driver = $fetch_vendor_details['total_after_8_pm_charges_for_driver'];
                            $total_after_8_pm_charges_for_vehicle = $fetch_vendor_details['total_after_8_pm_charges_for_vehicle'];
                            $extra_km_rate = $fetch_vendor_details['extra_km_rate'];
                            $total_allowed_kms = $fetch_vendor_details['total_allowed_kms'];
                            $total_extra_kms = $fetch_vendor_details['total_extra_kms'];

                            $total_extra_kms_charge = $fetch_vendor_details['total_extra_kms_charge'];
                            $total_allowed_local_kms = $fetch_vendor_details['total_allowed_local_kms'];
                            $total_extra_local_kms_charge = $fetch_vendor_details['total_extra_local_kms_charge'];
                            $vehicle_gst_type = $fetch_vendor_details['vehicle_gst_type'];
                            $vehicle_gst_percentage = $fetch_vendor_details['vehicle_gst_percentage'];
                            $vehicle_gst_amount = $fetch_vendor_details['vehicle_gst_amount'];
                            $vehicle_total_amount = $fetch_vendor_details['vehicle_total_amount'];
                            $vendor_margin_percentage = $fetch_vendor_details['vendor_margin_percentage'];
                            $vendor_margin_gst_type = $fetch_vendor_details['vendor_margin_gst_type'];
                            $vendor_margin_gst_percentage = $fetch_vendor_details['vendor_margin_gst_percentage'];
                            $vendor_margin_amount = $fetch_vendor_details['vendor_margin_amount'];
                            $vendor_margin_gst_amount = $fetch_vendor_details['vendor_margin_gst_amount'];
                            $vehicle_grand_total = $fetch_vendor_details['vehicle_grand_total'];

                            $arrFields_vehicle_details = array('`itinerary_plan_vendor_eligible_ID`', '`confirmed_itinerary_plan_vendor_eligible_ID`', '`itineary_plan_assigned_status`', '`itinerary_plan_id`', '`vehicle_type_id`', '`total_vehicle_qty`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`', '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`', '`createdby`', '`status`');

                            $arrValues_vehicle_details = array("$itinerary_plan_vendor_eligible_ID", "$confirmed_itinerary_plan_vendor_eligible_ID", "$itineary_plan_assigned_status", "$itinerary_plan_id", "$vehicle_type_id", "$total_vehicle_qty", "$vendor_id", "$outstation_allowed_km_per_day", "$vendor_vehicle_type_id", "$vehicle_id", "$vendor_branch_id", "$vehicle_orign", "$vehicle_count", "$total_kms", "$total_outstation_km", "$total_time", "$total_rental_charges", "$total_toll_charges", "$total_parking_charges", "$total_driver_charges", "$total_permit_charges", "$total_before_6_am_extra_time", "$total_after_8_pm_extra_time", "$total_before_6_am_charges_for_driver", "$total_before_6_am_charges_for_vehicle", "$total_after_8_pm_charges_for_driver", "$total_after_8_pm_charges_for_vehicle", "$extra_km_rate", "$total_allowed_kms", "$total_extra_kms", "$total_extra_kms_charge", "$total_allowed_local_kms", "$total_extra_local_kms", "$total_extra_local_kms_charge", "$vehicle_gst_type", "$vehicle_gst_percentage", "$vehicle_gst_amount", "$vehicle_total_amount", "$vendor_margin_percentage", "$vendor_margin_gst_type", "$vendor_margin_gst_percentage", "$vendor_margin_amount", "$vendor_margin_gst_amount", "$vehicle_grand_total", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $arrFields_vehicle_details, $arrValues_vehicle_details, '')) :
                                $cancelled_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();
                            endif;

                            //COLLECT CONFIRMED ITINEARY PLAN VEHICLE VENDOR DETAILS
                            $select_confirmed_itinerary_plan_vehicle_vendor_details = sqlQUERY_LABEL("SELECT  `confirmed_itinerary_plan_vendor_vehicle_details_ID`, `itinerary_plan_vendor_vehicle_details_ID`, `itinerary_plan_vendor_eligible_ID`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `vehicle_type_id`, `vehicle_qty`, `vendor_id`, `vendor_vehicle_type_id`, `vehicle_id`, `vendor_branch_id`, `time_limit_id`, `travel_type`, `itinerary_route_location_from`, `itinerary_route_location_to`, `total_running_km`, `total_running_time`, `total_siteseeing_km`, `total_siteseeing_time`, `total_pickup_km`, `total_pickup_duration`, `total_drop_km`, `total_drop_duration`, `total_extra_km`, `extra_km_rate`, `total_extra_km_charges`, `total_travelled_km`, `total_travelled_time`, `vehicle_rental_charges`, `vehicle_toll_charges`, `vehicle_parking_charges`, `vehicle_driver_charges`, `vehicle_permit_charges`, `before_6_am_extra_time`, `after_8_pm_extra_time`, `before_6_am_charges_for_driver`, `before_6_am_charges_for_vehicle`, `after_8_pm_charges_for_driver`, `after_8_pm_charges_for_vehicle`, `total_vehicle_amount`, `driver_opening_km`, `opening_speedmeter_image`, `driver_closing_km`, `closing_speedmeter_image` FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_plan_vendor_eligible_ID`='$itinerary_plan_vendor_eligible_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_GUIDE_LIST:" . sqlERROR_LABEL());
                            if (sqlNUMOFROW_LABEL($select_confirmed_itinerary_plan_vehicle_vendor_details) > 0) :
                                while ($fetch_vendor_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_vehicle_vendor_details)) :
                                    $confirmed_itinerary_plan_vendor_vehicle_details_ID = $fetch_vendor_data['confirmed_itinerary_plan_vendor_vehicle_details_ID'];
                                    $itinerary_plan_vendor_vehicle_details_ID = $fetch_vendor_data['itinerary_plan_vendor_vehicle_details_ID'];
                                    $itinerary_plan_vendor_eligible_ID = $fetch_vendor_data['itinerary_plan_vendor_eligible_ID'];
                                    $itinerary_plan_id = $fetch_vendor_data['itinerary_plan_id'];
                                    $itinerary_route_id = $fetch_vendor_data['itinerary_route_id'];
                                    $itinerary_route_date = $fetch_vendor_data['itinerary_route_date'];
                                    $vehicle_type_id = $fetch_vendor_data['vehicle_type_id'];
                                    $vehicle_qty = $fetch_vendor_data['vehicle_qty'];
                                    $vendor_id = $fetch_vendor_data['vendor_id'];
                                    $vendor_vehicle_type_id =  $fetch_vendor_data['vendor_vehicle_type_id'];
                                    $vehicle_id = $fetch_vendor_data['vehicle_id'];
                                    $vendor_branch_id = $fetch_vendor_data['vendor_branch_id'];
                                    $time_limit_id = $fetch_vendor_data['time_limit_id'];
                                    $travel_type = $fetch_vendor_data['travel_type'];
                                    $itinerary_route_location_from = $fetch_vendor_data['itinerary_route_location_from'];
                                    $itinerary_route_location_to = $fetch_vendor_data['itinerary_route_location_to'];
                                    $total_running_km = $fetch_vendor_data['total_running_km'];
                                    $total_running_time = $fetch_vendor_data['total_running_time'];
                                    $total_siteseeing_km = $fetch_vendor_data['total_siteseeing_km'];
                                    $total_siteseeing_time = $fetch_vendor_data['total_siteseeing_time'];
                                    $total_pickup_km = $fetch_vendor_data['total_pickup_km'];
                                    $total_pickup_duration = $fetch_vendor_data['total_pickup_duration'];
                                    $total_drop_km = $fetch_vendor_data['total_drop_km'];
                                    $total_drop_duration = $fetch_vendor_data['total_drop_duration'];
                                    $total_extra_km = $fetch_vendor_data['total_extra_km'];
                                    $extra_km_rate = $fetch_vendor_data['extra_km_rate'];
                                    $total_travelled_km = $fetch_vendor_data['total_travelled_km'];
                                    $total_travelled_time = $fetch_vendor_data['total_travelled_time'];
                                    $vehicle_rental_charges = $fetch_vendor_data['vehicle_rental_charges'];
                                    $vehicle_toll_charges = $fetch_vendor_data['vehicle_toll_charges'];
                                    $vehicle_parking_charges = $fetch_vendor_data['vehicle_parking_charges'];
                                    $vehicle_driver_charges = $fetch_vendor_data['vehicle_driver_charges'];
                                    $before_6_am_extra_time = $fetch_vendor_data['before_6_am_extra_time'];
                                    $after_8_pm_extra_time = $fetch_vendor_data['after_8_pm_extra_time'];
                                    $before_6_am_charges_for_driver = $fetch_vendor_data['before_6_am_charges_for_driver'];
                                    $before_6_am_charges_for_vehicle = $fetch_vendor_data['before_6_am_charges_for_vehicle'];
                                    $after_8_pm_charges_for_driver = $fetch_vendor_data['after_8_pm_charges_for_driver'];
                                    $after_8_pm_charges_for_vehicle = $fetch_vendor_data['after_8_pm_charges_for_vehicle'];
                                    $total_vehicle_amount = $fetch_vendor_data['total_vehicle_amount'];
                                    $driver_opening_km = $fetch_vendor_data['driver_opening_km'];
                                    $opening_speedmeter_image = $fetch_vendor_data['opening_speedmeter_image'];
                                    $driver_closing_km = $fetch_vendor_data['driver_closing_km'];
                                    $closing_speedmeter_image = $fetch_vendor_data['closing_speedmeter_image'];

                                    $arrFields_vehicle_vendor_details = array('`confirmed_itinerary_plan_vendor_vehicle_details_ID`', '`cancelled_itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_vendor_vehicle_details_ID`', '`itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`vehicle_type_id`', '`vehicle_qty`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`driver_opening_km`', '`opening_speedmeter_image`', '`driver_closing_km`', '`closing_speedmeter_image`', '`createdby`', '`status`');

                                    $arrValues_vehicle_vendor_details = array("$confirmed_itinerary_plan_vendor_vehicle_details_ID", "$cancelled_itinerary_plan_vendor_eligible_ID", "$itinerary_plan_vendor_vehicle_details_ID", "$itinerary_plan_vendor_eligible_ID", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$vehicle_type_id", "$vehicle_qty", "$vendor_id", "$vendor_vehicle_type_id", "$vehicle_id", "$vendor_branch_id", "$time_limit_id", "$travel_type", "$itinerary_route_location_from", "$itinerary_route_location_to", "$total_running_km", "$total_running_time", "$total_siteseeing_km", "$total_siteseeing_time", "$total_pickup_km", "$total_pickup_duration", "$total_drop_km", "$total_drop_duration", "$total_extra_km", "$extra_km_rate", "$total_extra_km_charges", "$total_travelled_km", "$total_travelled_time", "$vehicle_rental_charges", "$vehicle_toll_charges", "$vehicle_parking_charges", "$vehicle_driver_charges", "$vehicle_permit_charges", "$before_6_am_extra_time", "$after_8_pm_extra_time", "$before_6_am_charges_for_driver", "$before_6_am_charges_for_vehicle", "$after_8_pm_charges_for_driver", "$after_8_pm_charges_for_vehicle", "$total_vehicle_amount", "$driver_opening_km", "$opening_speedmeter_image", "$driver_closing_km", "$closing_speedmeter_image", "$logged_user_id", "1");

                                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_vehicle_details", $arrFields_vehicle_vendor_details, $arrValues_vehicle_vendor_details, '')) :
                                    endif;
                                endwhile;
                            endif;

                        endwhile;
                    endif;
                endif;
                $response['i_result'] = true;
            endif;

            $response['redirectURL'] = 'latestconfirmeditinerary_cancellation.php?cq=true';
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == "show_confirm_guide_cancellation_modal"):

        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $itinerary_route_ID = $_GET['itinerary_route_ID'];
        $guide_slot_cost_details_id = $_GET['guide_slot_cost_details_id'];
        $guide_defect_type = $_GET['guide_defect_type'];
        $guide_cancellation_percentage = $_GET['guide_cancellation_percentage'];
        $guide_slot_cost = $_GET['guide_slot_cost'];
        $guide_type = $_GET['guide_type'];

        $select_itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_guide_slot_cost_details_ID`, `cnf_itinerary_guide_slot_cost_details_ID`, `guide_slot_cost_details_id`, `route_guide_id`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `guide_id`, `guide_type`, `guide_slot`, `guide_slot_cost` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_guide_slot_details) > 0) :
            while ($fetch_itinerary_guide_slot_data = sqlFETCHARRAY_LABEL($select_itinerary_guide_slot_details)) :
                $cancelled_itinerary_guide_slot_cost_details_ID = $fetch_itinerary_guide_slot_data['cancelled_itinerary_guide_slot_cost_details_ID'];
                $guide_id = $fetch_itinerary_guide_slot_data['guide_id'];
                $guide_slot_cost = $fetch_itinerary_guide_slot_data['guide_slot_cost'];
                $slot_cancelled_service_amount = $general_currency_symbol . ' ' . number_format($guide_slot_cost, 2);
                $guide_slot = $fetch_itinerary_guide_slot_data['guide_slot'];
                $route_guide_id = $fetch_itinerary_guide_slot_data['route_guide_id'];
                $itinerary_route_date = $fetch_itinerary_guide_slot_data['itinerary_route_date'];
                $itinerary_route_date = date('d M,Y ', strtotime($itinerary_route_date));
                $guide_name = getGUIDEDETAILS($guide_id, 'label');
                $slot_name = getSLOTTYPE($guide_slot, 'label');
                if ($slot_name == ""):
                    $slot_name = "<strong>Slot 1:</strong> 8 AM to 1 PM | <strong>Slot 2:</strong> 1 AM to 6 PM | <strong>Slot 3:</strong> 6 AM to 9 PM";
                endif;
            endwhile;
        endif;

    ?>
        <div class="modal-body">
            <div class="row">
                <?php //if ($TOTAL_USED_COUNT == 0) : 
                ?>
                <div class="text-center">
                    <svg class="icon-44" width="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
                        <!-- Outer calendar shape -->
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"></rect>
                        <!-- Calendar header -->
                        <rect x="3" y="4" width="18" height="4" fill="currentColor"></rect>
                        <!-- Cross symbol -->
                        <line x1="8" y1="9" x2="16" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <line x1="16" y1="9" x2="8" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <!-- Optional day grid -->
                        <circle cx="7" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="11" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="15" cy="12" r="0.5" fill="currentColor"></circle>
                    </svg>
                </div>
                <h6 class="mt-4 mb-2 text-center">Are you sure?</h6>
                <p class="text-center">
                    <!--  Do you really want to cancel the Guide : <?= $guide_name ?>(<?= $slot_name ?>) on $itinerary_route_date ? <br /> This process cannot be undone.-->
                    Do you really want to cancel the Guide? <br />
                    <strong><?= $guide_name ?></strong> <br />
                    <strong><?= $slot_name ?></strong> <br />
                    Cost: <strong><?= $slot_cancelled_service_amount ?></strong> <br />
                    Date: <strong><?= $itinerary_route_date ?></strong> <br />
                    This process cannot be undone.
                </p>
                <div class="text-center pb-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" onclick="cancel_ITINERARY_GUIDE_DETAILS('<?= $itinerary_plan_ID; ?>','<?= $itinerary_route_ID ?>','<?= $guide_slot_cost_details_id; ?>','<?= $guide_defect_type; ?>','<?= $guide_cancellation_percentage; ?>','<?= $guide_slot_cost; ?>','<?= $guide_type ?>');" class="btn btn-danger">Confirm Cancellation</button>
                </div>

            </div>
        </div>
    <?php
    elseif ($_GET['type'] == "confirm_itinerary_guide_cancellation"):

        $response = [];
        $errors = [];

        // Validate required fields
        if (empty($_POST['_cancel_percentage'])) :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_guide_defect_type'] == "") :
            $errors['guide_defect_type_required'] = true;
        endif;

        $itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $guide_slot_cost_details_id = $_POST['_guide_slot_cost_details_id'];
        $guide_defect_type = $_POST['_guide_defect_type'];
        $guide_cancellation_percentage = $_POST['_cancel_percentage'];
        $guide_slot_cost = $_POST['_guide_slot_cost'];
        $guide_type = $_POST['_guide_type'];
        if ($guide_type == 1):
            $route_guide_id = $_POST['_itinerary_route_ID'];
        else:
            $itinerary_route_ID = $_POST['_itinerary_route_ID'];
        endif;

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');
            $total_route_cancelled_service_amount = 0;
            $total_route_cancellation_charge = 0;
            if ($guide_type == 1):
                //CANCEL GUIDE FOR EACH DAY
                $select_itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_guide_slot_cost_details_ID`, `cnf_itinerary_guide_slot_cost_details_ID`, `guide_slot_cost_details_id`, `route_guide_id`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `guide_id`, `guide_type`, `guide_slot`, `guide_slot_cost` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_guide_slot_details) > 0) :
                    while ($fetch_itinerary_guide_slot_data = sqlFETCHARRAY_LABEL($select_itinerary_guide_slot_details)) :
                        $cancelled_itinerary_guide_slot_cost_details_ID = $fetch_itinerary_guide_slot_data['cancelled_itinerary_guide_slot_cost_details_ID'];
                        $guide_id = $fetch_itinerary_guide_slot_data['guide_id'];
                        $guide_slot_cost = $fetch_itinerary_guide_slot_data['guide_slot_cost'];

                        $guide_name = getGUIDEDETAILS($guide_id, 'label');
                        $guide_language =  getITINERARY_GUIDELANGUAGES($route_guide_id);
                        $guide_languages = getGUIDE_LANGUAGE_DETAILS($guide_language, 'label');
                        $slot_cancellation_charge = $guide_slot_cost * ($guide_cancellation_percentage / 100);
                        $slot_refund_amount = $guide_slot_cost  - $slot_cancellation_charge;
                        $total_route_cancelled_service_amount =  $guide_slot_cost;
                        $total_route_cancellation_charge =  $slot_cancellation_charge;
                        $total_route_refund_amount = $total_route_cancelled_service_amount - $total_route_cancellation_charge;

                        //UPDATE CANCELLED ROUTE GUIDE SLOT DETAILS TABLE
                        $cancellation_guide_slot_details_arrFields = array('`slot_cancellation_status`', '`cancelled_on`', '`defect_type`', '`slot_cancellation_percentage`', '`total_slot_cancelled_service_amount`', '`total_slot_cancellation_charge`', '`total_slot_refund_amount`');

                        $cancellation_guide_slot_details_arrValues = array("1", "$cancelled_on", "$guide_defect_type", "$guide_cancellation_percentage", "$guide_slot_cost", "$slot_cancellation_charge", "$slot_refund_amount");

                        $guide_slot_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_slot_cost_details", $cancellation_guide_slot_details_arrFields, $cancellation_guide_slot_details_arrValues, $guide_slot_sqlWhere)) :
                        endif;

                        //UPDATE COMFIRMED ITINERARY GUIDE SLOT STATUS
                        $confirmed_guide_slot_arrFields = array('`cancellation_status`', '`cancellation_defect_type`');

                        $confirmed_guide_slot_arrValues = array("1", "$guide_defect_type");

                        $confirmed_guide_slot_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID'  AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_guide_slot_cost_details", $confirmed_guide_slot_arrFields, $confirmed_guide_slot_arrValues, $confirmed_guide_slot_sqlWhere)) :
                        endif;

                        //INSERT CANCELLATION LOG TABLE
                        $cancellation_log_arrFields = array('itinerary_plan_id', 'itinerary_guide_cancellation_status', 'cancellation_date', 'cancelled_by', 'total_cancelled_service_amount', 'total_cancellation_charge', 'total_refund_amount', 'createdby', 'status');
                        $cancellation_log_arrValues = array("$itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$guide_slot_cost", "$slot_cancellation_charge", "$slot_refund_amount", "$logged_user_id", "1");

                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellation_log_arrFields, $cancellation_log_arrValues, '')) :
                        endif;

                    endwhile;
                endif;

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $total_route_cancelled_service_amount + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_route_cancellation_charge + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_route_refund_amount + $existing_total_refund_amount;

                    $cancellation_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancellation_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancellation_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, $cancellation_sqlWhere)) :
                    endif;
                else:
                    //INSERT
                    $cancellation_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', 'createdby', 'status');

                    $cancellation_arrValues = array("$itinerary_plan_ID", "$total_route_cancelled_service_amount", "$total_route_cancellation_charge", "$total_route_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, '')) :
                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        //UPDATE TABLES WITH CANCELLATION ID
                        $cancellationID_arrFields = array('`cancelled_itinerary_id`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                        $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                        endif;

                        //UPDATE TABLES WITH CANCELLATION ID
                        $cancellationID_arrFields = array('`cancelled_itinerary_ID`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                        $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                        //GUIDE SLOT
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_slot_cost_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                        endif;

                        //GUIDE ROUTE
                        $cancellationID_guide_sqlWhere = " `itinerary_plan_ID`='$itinerary_plan_ID' ";

                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_guide_sqlWhere)) :
                        endif;
                    endif;

                endif;

                //CANCELLED ROUTE GUIDE DETAILS 
                $itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT  `cancelled_itinerary_guide_slot_cost_details_ID` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                $total_itinerary_guide_slot_count = sqlNUMOFROW_LABEL($itinerary_guide_slot_details);

                $itinerary_guide_slot_cancelled_details = sqlQUERY_LABEL("SELECT  `cancelled_itinerary_guide_slot_cost_details_ID` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `slot_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                $total_itinerary_guide_cancelled_slot_count = sqlNUMOFROW_LABEL($itinerary_guide_slot_cancelled_details);

                $select_itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT `route_guide_id`, SUM(`total_slot_cancelled_service_amount`) AS total_slot_cancelled_service_amount, SUM(`total_slot_cancellation_charge`) AS total_slot_cancellation_charge, SUM(`total_slot_refund_amount`) AS total_slot_refund_amount FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'  AND `slot_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_guide_slot_details) > 0) :
                    while ($fetch_slot_data = sqlFETCHARRAY_LABEL($select_itinerary_guide_slot_details)) :
                        $route_guide_id  =  $fetch_slot_data['route_guide_id'];
                        $total_slot_cancelled_service_amount  =  $fetch_slot_data['total_slot_cancelled_service_amount'];
                        $total_slot_cancellation_charge  =  $fetch_slot_data['total_slot_cancellation_charge'];
                        $total_slot_refund_amount  =  $fetch_slot_data['total_slot_refund_amount'];
                    endwhile;
                endif;

                if ($total_itinerary_guide_slot_count == $total_itinerary_guide_cancelled_slot_count):

                    //UPDATE CANCELLED ROUTE GUIDE TABLE
                    $cancellation_guide_arrFields = array('`route_cancellation_status`', '`cancelled_on`',  '`total_route_cancelled_service_amount`', '`total_route_cancellation_charge`', '`total_route_refund_amount`');

                    $cancellation_guide_arrValues = array(
                        "1",
                        "$cancelled_on",
                        "$guide_defect_type",
                        "$guide_cancellation_percentage",
                        "$total_slot_cancelled_service_amount",
                        "$total_slot_cancellation_charge",
                        "$total_slot_refund_amount"
                    );

                    $cancellation_guide_sqlWhere = " `route_guide_ID` = '$route_guide_id' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_details", $cancellation_guide_arrFields, $cancellation_guide_arrValues, $cancellation_guide_sqlWhere)) :
                    endif;

                    //UPDATE COMFIRMED ITINERARY ROUTE STATUS
                    $confirmed_guide_arrFields = array('`cancellation_status`');

                    $confirmed_guide_arrValues = array("$cancellation_status");

                    $confirmed_guide_sqlWhere = " `route_guide_ID` = '$route_guide_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_guide_details", $confirmed_guide_arrFields, $confirmed_guide_arrValues, $confirmed_guide_sqlWhere)) :
                    endif;

                endif;

                $slot_name = "<strong>Slot 1:</strong> 8 AM to 1 PM | <strong>Slot 2:</strong> 1 AM to 6 PM | <strong>Slot 3:</strong> 6 AM to 9 PM";

            else:
                //CANCEL GUIDE SLOT FOR EACH ROUTE DAY
                $select_itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_guide_slot_cost_details_ID`, `cnf_itinerary_guide_slot_cost_details_ID`, `guide_slot_cost_details_id`, `route_guide_id`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `guide_id`, `guide_type`, `guide_slot`, `guide_slot_cost` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' and  `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_guide_slot_details) > 0) :
                    while ($fetch_itinerary_guide_slot_data = sqlFETCHARRAY_LABEL($select_itinerary_guide_slot_details)) :
                        $cancelled_itinerary_guide_slot_cost_details_ID = $fetch_itinerary_guide_slot_data['cancelled_itinerary_guide_slot_cost_details_ID'];
                        $guide_id = $fetch_itinerary_guide_slot_data['guide_id'];
                        $guide_slot = $fetch_itinerary_guide_slot_data['guide_slot'];
                        $guide_slot_cost = $fetch_itinerary_guide_slot_data['guide_slot_cost'];
                        $route_guide_id = $fetch_itinerary_guide_slot_data['route_guide_id'];

                        $slot_name = getSLOTTYPE($guide_slot, 'label');
                        $guide_name = getGUIDEDETAILS($guide_id, 'label');
                        $guide_language =  getITINERARY_GUIDELANGUAGES($route_guide_id);
                        $guide_languages = getGUIDE_LANGUAGE_DETAILS($guide_language, 'label');

                        $slot_cancellation_charge = $guide_slot_cost * ($guide_cancellation_percentage / 100);
                        $slot_refund_amount = $guide_slot_cost  - $slot_cancellation_charge;

                        $total_route_cancelled_service_amount =  $guide_slot_cost;
                        $total_route_cancellation_charge =  $slot_cancellation_charge;

                    endwhile;

                    //UPDATE CANCELLED ROUTE GUIDE SLOT DETAILS TABLE
                    $cancellation_guide_slot_details_arrFields = array('`slot_cancellation_status`', '`cancelled_on`', '`defect_type`', '`slot_cancellation_percentage`', '`total_slot_cancelled_service_amount`', '`total_slot_cancellation_charge`', '`total_slot_refund_amount`');

                    $cancellation_guide_slot_details_arrValues = array("1", "$cancelled_on", "$guide_defect_type", "$guide_cancellation_percentage", "$guide_slot_cost", "$slot_cancellation_charge", "$slot_refund_amount");

                    $guide_slot_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_slot_cost_details", $cancellation_guide_slot_details_arrFields, $cancellation_guide_slot_details_arrValues, $guide_slot_sqlWhere)) :
                    endif;

                    //UPDATE COMFIRMED ITINERARY GUIDE SLOT STATUS
                    $confirmed_guide_slot_arrFields = array('`cancellation_status`', '`cancellation_defect_type`');

                    $confirmed_guide_slot_arrValues = array("1", "$guide_defect_type");

                    $confirmed_guide_slot_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `guide_slot_cost_details_id` = '$guide_slot_cost_details_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_guide_slot_cost_details", $confirmed_guide_slot_arrFields, $confirmed_guide_slot_arrValues, $confirmed_guide_slot_sqlWhere)) :
                    endif;

                    //INSERT CANCELLATION LOG TABLE
                    $cancellation_log_arrFields = array('itinerary_plan_id', 'itinerary_guide_cancellation_status', 'cancellation_date', 'cancelled_by', 'total_cancelled_service_amount', 'total_cancellation_charge', 'total_refund_amount', 'createdby', 'status');
                    $cancellation_log_arrValues = array("$itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$guide_slot_cost", "$slot_cancellation_charge", "$slot_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellation_log_arrFields, $cancellation_log_arrValues, '')) :
                    endif;

                endif;

                $total_route_refund_amount = $total_route_cancelled_service_amount - $total_route_cancellation_charge;

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $total_route_cancelled_service_amount + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_route_cancellation_charge + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_route_refund_amount + $existing_total_refund_amount;

                    $cancellation_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancellation_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancellation_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, $cancellation_sqlWhere)) :
                    endif;
                else:
                    //INSERT
                    $cancellation_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', 'createdby', 'status');

                    $cancellation_arrValues = array("$itinerary_plan_ID", "$total_route_cancelled_service_amount", "$total_route_cancellation_charge", "$total_route_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, '')) :
                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        //UPDATE TABLES WITH CANCELLATION ID
                        $cancellationID_arrFields = array('`cancelled_itinerary_id`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                        $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                        endif;


                        //UPDATE TABLES WITH CANCELLATION ID
                        $cancellationID_arrFields = array('`cancelled_itinerary_ID`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                        $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                        //GUIDE SLOT
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_slot_cost_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                        endif;

                        //GUIDE ROUTE
                        $cancellationID_guide_sqlWhere = " `itinerary_plan_ID`='$itinerary_plan_ID' ";

                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_guide_sqlWhere)) :
                        endif;
                    endif;

                endif;

                //CANCELLED ROUTE GUIDE DETAILS 
                $itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT  `cancelled_itinerary_guide_slot_cost_details_ID` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                $total_itinerary_guide_slot_count = sqlNUMOFROW_LABEL($itinerary_guide_slot_details);

                $itinerary_guide_slot_cancelled_details = sqlQUERY_LABEL("SELECT  `cancelled_itinerary_guide_slot_cost_details_ID` FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID' AND `slot_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                $total_itinerary_guide_cancelled_slot_count = sqlNUMOFROW_LABEL($itinerary_guide_slot_cancelled_details);

                $select_itinerary_guide_slot_details = sqlQUERY_LABEL("SELECT `route_guide_id`, SUM(`total_slot_cancelled_service_amount`) AS total_slot_cancelled_service_amount, SUM(`total_slot_cancellation_charge`) AS total_slot_cancellation_charge, SUM(`total_slot_refund_amount`) AS total_slot_refund_amount FROM `dvi_cancelled_itinerary_route_guide_slot_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_ID` = '$itinerary_plan_ID'  AND `slot_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_guide_slot_details) > 0) :
                    while ($fetch_slot_data = sqlFETCHARRAY_LABEL($select_itinerary_guide_slot_details)) :
                        $route_guide_id  =  $fetch_slot_data['route_guide_id'];
                        $total_slot_cancelled_service_amount  =  $fetch_slot_data['total_slot_cancelled_service_amount'];
                        $total_slot_cancellation_charge  =  $fetch_slot_data['total_slot_cancellation_charge'];
                        $total_slot_refund_amount  =  $fetch_slot_data['total_slot_refund_amount'];
                    endwhile;
                endif;

                if ($total_itinerary_guide_slot_count == $total_itinerary_guide_cancelled_slot_count):

                    //UPDATE CANCELLED ROUTE GUIDE TABLE
                    $cancellation_guide_arrFields = array('`route_cancellation_status`', '`cancelled_on`',  '`total_route_cancelled_service_amount`', '`total_route_cancellation_charge`', '`total_route_refund_amount`');

                    $cancellation_guide_arrValues = array("1", "$cancelled_on", "$guide_defect_type", "$guide_cancellation_percentage", "$total_slot_cancelled_service_amount", "$total_slot_cancellation_charge", "$total_slot_refund_amount");

                    $cancellation_guide_sqlWhere = " `itinerary_route_id` = '$itinerary_route_ID' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_guide_details", $cancellation_guide_arrFields, $cancellation_guide_arrValues, $cancellation_guide_sqlWhere)) :
                    endif;

                    //UPDATE COMFIRMED ITINERARY ROUTE STATUS
                    $confirmed_guide_arrFields = array('`cancellation_status`');

                    $confirmed_guide_arrValues = array("$cancellation_status");

                    $confirmed_guide_sqlWhere = " `route_guide_ID` = '$route_guide_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_guide_details", $confirmed_guide_arrFields, $confirmed_guide_arrValues, $confirmed_guide_sqlWhere)) :
                    endif;

                endif;
            endif;

            $guidedefecttype = getCNCELLATION_DEFECT_TYPE($guide_defect_type, 'label');
            $cancellation_date = date("d M, Y", strtotime($cancelled_on)) . ' at' . date("h:i A", strtotime($cancelled_on));
            $totalslot_cancelled_service_amount = $general_currency_symbol . ' ' . number_format($total_slot_cancelled_service_amount, 2);
            $totalslot_refund_amount = general_currency_symbol . ' ' . number_format($total_slot_refund_amount, 2) . " (" . $guide_cancellation_percentage . " % Deduction)";
            cancel_EntireItineraryPlan($itinerary_plan_ID);
            $response['i_result'] = true;
            $response['cancelled_response'] =
                '<div class="border rounded p-2 mb-2" style="background-color: #ffeaea !important; border-left: 5px solid #dc3545 !important;">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <!-- Cancellation Details (Left) -->
                                                        <div class="ms-2">
                                                            <h6 class="m-0" style="color: #dc3545; font-size: 1rem; font-weight: 600;">' . $slot_name . ' (Cancelled)
                                                            </h6>
                                                            <p class="mb-1 mt-1" style="color: #495057; font-size: 0.9rem;"> <strong>Name:</strong> <span style="font-weight: 500;">' . $guide_name . '</span> | <strong>Language:</strong> <span style="font-weight: 500;">' . $guide_languages . '</span> | <strong>Defect Type:</strong> <span style="font-weight: 500;"> ' . $guidedefecttype . '</span>
                                                            </p>
                                                            <p class="mb-1" style="color: #6c757d; font-size: 0.85rem;">
                                                            <strong>Cancelled On:</strong> ' . $cancellation_date . ' </p>
                                                            <p class="mb-1" style="color: #6c757d; font-size: 0.85rem;"><strong>Original Amount:</strong> ' . $totalslot_cancelled_service_amount . '
                                                            </p>
                                                            <p class="mb-0" style="color: #212529; font-size: 0.9rem; font-weight: bold;">
                                                            Refund Amount: ' . $totalslot_refund_amount . ' 
                                                            </p>
                                                        </div>

                                                        <!-- Refund Section (Right) -->
                                                        <div class="text-end me-2" style="align-self: center;">
                                                            <p class="mb-0" style="color: #dc3545; font-size: 0.85rem; font-weight: 500;">  Refund
                                                            </p>
                                                            <h6 class="m-0" style="color: #dc3545; font-size: 1rem; font-weight: 600;">
                                                            ' . general_currency_symbol . ' ' . number_format($total_slot_refund_amount, 2) . '
                                                            </h6>
                                                        </div>
                                                    </div>
                                                </div>';


        endif;
        echo json_encode($response);

    elseif ($_GET['type'] == "show_confirm_hotspot_cancellation_modal"):

        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $itinerary_route_ID = $_GET['itinerary_route_ID'];
        $route_hotspot_ID = $_GET['route_hotspot_ID'];
        $hotspot_cost_details_id = $_GET['hotspot_cost_details_id'];
        $hotspot_defect_type = $_GET['hotspot_defect_type'];
        $hotspot_cancellation_percentage = $_GET['hotspot_cancellation_percentage'];
        $hotspot_entry_cost = $_GET['hotspot_entry_cost'];
        $traveller_type = $_GET['traveller_type'];
        $cancelled_route_hotspot_ID = $_GET['cancelled_route_hotspot_ID'];

        $select_cancelled_itinerary_plan_route_hotspot_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_hotspot_cost_detail_ID`, `cancelled_itinerary_ID`, `cnf_itinerary_hotspot_cost_detail_ID`, `hotspot_cost_detail_id`, `route_hotspot_id`, `hotspot_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost`, `entry_cost_cancellation_status`, `cancelled_on`, `defect_type`, `entry_cost_cancellation_percentage`, `total_entry_cost_cancelled_service_amount`, `total_entry_cost_cancellation_charge`, `total_entry_cost_refund_amount` FROM `dvi_cancelled_itinerary_route_hotspot_entry_cost_details` WHERE `route_hotspot_id`='$route_hotspot_ID' AND `status`='1' AND `deleted`='0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `hotspot_cost_detail_id`='$hotspot_cost_details_id' AND `traveller_type`='$traveller_type'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details) > 0):
            while ($fetch_route_hotspot_cost_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details)) :
                $hotspot_ID = $fetch_route_hotspot_cost_data['hotspot_ID'];
                $hotspot_name = getHOTSPOTDETAILS($hotspot_ID, 'label');
                $hot_spot_traveller_name = $fetch_route_hotspot_cost_data['traveller_name'];
                $entry_ticket_cost = $fetch_route_hotspot_cost_data['entry_ticket_cost'];
                $itinerary_route_date = getITINEARY_CONFIRMED_ROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'get_route_date');
            endwhile;
        endif;

    ?>
        <div class="modal-body">
            <div class="row">
                <?php //if ($TOTAL_USED_COUNT == 0) : 
                ?>
                <div class="text-center">
                    <svg class="icon-44" width="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
                        <!-- Outer calendar shape -->
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"></rect>
                        <!-- Calendar header -->
                        <rect x="3" y="4" width="18" height="4" fill="currentColor"></rect>
                        <!-- Cross symbol -->
                        <line x1="8" y1="9" x2="16" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <line x1="16" y1="9" x2="8" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <!-- Optional day grid -->
                        <circle cx="7" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="11" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="15" cy="12" r="0.5" fill="currentColor"></circle>
                    </svg>
                </div>
                <h6 class="mt-4 mb-2 text-center">Are you sure?</h6>
                <p class="text-center">
                    <!--  Do you really want to cancel the Guide : <?= $guide_name ?>(<?= $slot_name ?>) on $itinerary_route_date ? <br /> This process cannot be undone.-->
                    Do you really want to cancel the Hotspot Entry Cost For this traveller? <br />
                    <strong><?= $hotspot_name ?></strong> <br />
                    <strong><?= $hot_spot_traveller_name ?></strong> <br />
                    Cost: <strong><?= $entry_ticket_cost ?></strong> <br />
                    Date: <strong><?= date('d M, Y D', strtotime($itinerary_route_date)) ?></strong> <br />

                    This process cannot be undone.
                </p>

                <div class="text-center pb-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" onclick="cancel_ITINERARY_HOTSPOT_DETAILS('<?= $cancelled_route_hotspot_ID ?>','<?= $itinerary_plan_ID; ?>','<?= $itinerary_route_ID ?>','<?= $route_hotspot_ID; ?>','<?= $hotspot_cost_details_id; ?>','<?= $hotspot_defect_type; ?>','<?= $hotspot_cancellation_percentage; ?>','<?= $hotspot_entry_cost; ?>','<?= $traveller_type ?>');" class="btn btn-danger">Confirm Cancellation</button>
                </div>
            </div>
        </div>
    <?php

    elseif ($_GET['type'] == "confirm_itinerary_hotspot_cancellation"):

        $response = [];
        $errors = [];

        // Validate required fields
        if (empty($_POST['_cancel_percentage'])) :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_hotspot_defect_type'] == "") :
            $errors['hotspot_defect_type_required'] = true;
        endif;

        $itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $itinerary_route_ID = $_POST['_itinerary_route_ID'];
        $route_hotspot_ID = $_POST['_route_hotspot_ID'];
        $hotspot_cost_detail_id = $_POST['_hotspot_cost_details_id'];
        $hotspot_defect_type = $_POST['_hotspot_defect_type'];
        $hotspot_cancellation_percentage = $_POST['_cancel_percentage'];
        $hotspot_entry_cost = $_POST['_hotspot_entry_cost'];
        $traveller_type = $_POST['_traveller_type'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS
            $cancelled_on = date('Y-m-d H:i:s');
            $total_route_cancelled_service_amount = 0;
            $total_route_cancellation_charge = 0;

            //CANCEL HOTSPOT ENTRY COST OF EACH TRAVELLER
            $select_cancelled_itinerary_plan_route_hotspot_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_hotspot_cost_detail_ID`, `cancelled_itinerary_ID`, `cnf_itinerary_hotspot_cost_detail_ID`, `hotspot_cost_detail_id`, `route_hotspot_id`, `hotspot_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost`, `entry_cost_cancellation_status`, `cancelled_on`, `defect_type`, `entry_cost_cancellation_percentage`, `total_entry_cost_cancelled_service_amount`, `total_entry_cost_cancellation_charge`, `total_entry_cost_refund_amount` FROM `dvi_cancelled_itinerary_route_hotspot_entry_cost_details` WHERE `route_hotspot_id`='$route_hotspot_ID' AND `status`='1' AND `deleted`='0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `hotspot_cost_detail_id`='$hotspot_cost_detail_id' AND `traveller_type`='$traveller_type'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details) > 0) :
                while ($fetch_itinerary_hotspot_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details)) :
                    $cancelled_itinerary_hotspot_cost_detail_ID = $fetch_itinerary_hotspot_data['cancelled_itinerary_hotspot_cost_detail_ID'];
                    $hotspot_ID = $fetch_itinerary_hotspot_data['hotspot_ID'];
                    $entry_ticket_cost = $fetch_itinerary_hotspot_data['entry_ticket_cost'];


                    $entry_cost_cancellation_charge = $entry_ticket_cost * ($hotspot_cancellation_percentage / 100);
                    $entry_cost_refund_amount = $entry_ticket_cost - $entry_cost_cancellation_charge;

                    $total_route_cancelled_service_amount = $entry_ticket_cost;
                    $total_route_cancellation_charge = $entry_cost_cancellation_charge;

                endwhile;

                //UPDATE CANCELLED HOTSPOT ENTRY COST DETAILS TABLE
                $cancellation_hotspot_entry_cost_details_arrFields = array('`entry_cost_cancellation_status`', '`cancelled_on`', '`defect_type`', '`entry_cost_cancellation_percentage`', '`total_entry_cost_cancelled_service_amount`', '`total_entry_cost_cancellation_charge`', '`total_entry_cost_refund_amount`');
                $cancellation_hotspot_entry_cost_details_arrValues = array("1", "$cancelled_on", "$hotspot_defect_type", "$hotspot_cancellation_percentage", "$entry_ticket_cost", "$entry_cost_cancellation_charge", "$entry_cost_refund_amount");
                $hotspot_entry_cost_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `hotspot_cost_detail_id` = '$hotspot_cost_detail_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_hotspot_entry_cost_details", $cancellation_hotspot_entry_cost_details_arrFields, $cancellation_hotspot_entry_cost_details_arrValues, $hotspot_entry_cost_sqlWhere)) :
                endif;

                //UPDATE COMFIRMED ITINERARY HOTSPOT ENTRY COST STATUS
                $confirmed_entry_cost_arrFields = array('`cancellation_status`', '`cancellation_defect_type`');
                $confirmed_entry_cost_arrValues = array("1", "$hotspot_defect_type");
                $confirmed_entry_cost_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `hotspot_cost_detail_id` = '$hotspot_cost_detail_id' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_hotspot_entry_cost_details", $confirmed_entry_cost_arrFields, $confirmed_entry_cost_arrValues, $confirmed_entry_cost_sqlWhere)) :
                endif;

                //INSERT CANCELLATION LOG TABLE
                $cancellation_log_arrFields = array('itinerary_plan_id', 'itinerary_hotspot_cancellation_status', 'cancellation_date', 'cancelled_by', 'total_cancelled_service_amount', 'total_cancellation_charge', 'total_refund_amount', 'createdby', 'status');
                $cancellation_log_arrValues = array("$itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$entry_ticket_cost", "$entry_cost_cancellation_charge", "$entry_cost_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellation_log_arrFields, $cancellation_log_arrValues, '')) :
                endif;

            endif;


            $total_route_refund_amount = $total_route_cancelled_service_amount - $total_route_cancellation_charge;

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID = $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $total_route_cancelled_service_amount + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_route_cancellation_charge + $existing_total_cancellation_charge;
                $total_refund_amount = $total_route_refund_amount + $existing_total_refund_amount;

                $cancellation_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancellation_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancellation_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, $cancellation_sqlWhere)) :
                endif;
            else:
                //INSERT
                $cancellation_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', 'createdby', 'status');

                $cancellation_arrValues = array("$itinerary_plan_ID", "$total_route_cancelled_service_amount", "$total_route_cancellation_charge", "$total_route_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, '')) :
                    $cancelled_itinerary_ID = sqlINSERTID_LABEL();

                    //UPDATE TABLES WITH CANCELLATION ID
                    $cancellationID_arrFields = array('`cancelled_itinerary_ID`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                    $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                    endif;

                    //HOTSPOT ENTRY COST
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_hotspot_entry_cost_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                    endif;

                    //HOTSPOT ROUTE DETAILS
                    $cancellationID_guide_sqlWhere = " `itinerary_plan_ID`='$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_hotspot_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_guide_sqlWhere)) :
                    endif;
                endif;

            endif;

            //COLLECT TOTAL RECORDS IN HOTSPOT ENTRY COST DETAILS
            $TOTAL_TRAVELLER_COUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_TRAVELLER_COUNT');

            //COLLECT TOTAL ACTIVE RECORDS IN HOTSPOT ENTRY COST DETAILS
            $TOTAL_ACTIVE_TRAVELLER_COUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_ACTIVE_TRAVELLER_COUNT');

            //COLLECT TOTAL CANCELLED RECORDS IN HOTSPOT ENTRY COST DETAILS
            $TOTAL_CANCELLED_TRAVELLER_COUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_CANCELLED_TRAVELLER_COUNT');


            $select_itinerary_hotspot_entry_cost_details = sqlQUERY_LABEL("SELECT SUM(`total_entry_cost_cancelled_service_amount`) AS total_entry_cost_cancelled_service_amount, SUM(`total_entry_cost_cancellation_charge`) AS total_entry_cost_cancellation_charge, SUM(`total_entry_cost_refund_amount`) AS total_entry_cost_refund_amount FROM `dvi_cancelled_itinerary_route_hotspot_entry_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `entry_cost_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_itinerary_hotspot_entry_cost_details) > 0) :
                while ($fetch_entry_cost_data = sqlFETCHARRAY_LABEL($select_itinerary_hotspot_entry_cost_details)) :
                    $total_entry_cost_cancelled_service_amount = $fetch_entry_cost_data['total_entry_cost_cancelled_service_amount'];
                    $total_entry_cost_cancellation_charge = $fetch_entry_cost_data['total_entry_cost_cancellation_charge'];
                    $total_entry_cost_refund_amount = $fetch_entry_cost_data['total_entry_cost_refund_amount'];
                endwhile;
            endif;

            $TOTAL_ROUTE_HOTSPOT_AMOUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, '', 'TOTAL_ROUTE_HOTSPOT_AMOUNT');

            if ($TOTAL_TRAVELLER_COUNT == $TOTAL_CANCELLED_TRAVELLER_COUNT):

                //UPDATE CANCELLED ROUTE HOTSPOT TABLE
                $cancellation_hotspot_arrFields = array('`route_cancellation_status`', '`cancelled_on`', '`total_route_cancelled_service_amount`', '`total_route_cancellation_charge`', '`total_route_refund_amount`', '`hotspot_amout`');

                $cancellation_hotspot_arrValues = array("1", "$cancelled_on", "$total_entry_cost_cancelled_service_amount", "$total_entry_cost_cancellation_charge", "$total_entry_cost_refund_amount", "$TOTAL_ROUTE_HOTSPOT_AMOUNT");

                $cancellation_hotspot_sqlWhere = " `route_hotspot_ID` = '$route_hotspot_ID' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_hotspot_details", $cancellation_hotspot_arrFields, $cancellation_hotspot_arrValues, $cancellation_hotspot_sqlWhere)) :
                endif;

                //UPDATE COMFIRMED ITINERARY ROUTE STATUS
                $confirmed_hotspot_arrFields = array('`cancellation_status`');

                $confirmed_hotspot_arrValues = array("$cancellation_status");

                $confirmed_hotspot_sqlWhere = " `route_hotspot_ID` = '$route_hotspot_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_hotspot_details", $confirmed_hotspot_arrFields, $confirmed_hotspot_arrValues, $confirmed_hotspot_sqlWhere)) :
                endif;
            else:
                //UPDATE CANCELLED ROUTE HOTSPOT TABLE
                $cancellation_hotspot_arrFields = array('`hotspot_amout`');

                $cancellation_hotspot_arrValues = array("$TOTAL_ROUTE_HOTSPOT_AMOUNT");

                $cancellation_hotspot_sqlWhere = " `route_hotspot_ID` = '$route_hotspot_ID' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_hotspot_details", $cancellation_hotspot_arrFields, $cancellation_hotspot_arrValues, $cancellation_hotspot_sqlWhere)) :
                endif;
            endif;
            cancel_EntireItineraryPlan($itinerary_plan_ID);
            $response['i_result'] = true;

            $response['TOTAL_ACTIVE_TRAVELLER_COUNT'] = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_ACTIVE_TRAVELLER_COUNT');;
            $response['TOTAL_CANCELLED_TRAVELLER_COUNT'] = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_CANCELLED_TRAVELLER_COUNT');

            $TOTAL_HOTSPOT_AMOUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_HOTSPOT_AMOUNT');
            $TOTAL_ACTIVE_HOTSPOT_AMOUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_ACTIVE_HOTSPOT_AMOUNT');
            $TOTAL_ADULT_CANCELLED_HOTSPOT_AMOUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, $traveller_type, 'TOTAL_CANCELLED_HOTSPOT_AMOUNT');

            $TOTAL_ROUTE_HOTSPOT_AMOUNT = getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, '', 'TOTAL_ROUTE_HOTSPOT_AMOUNT');
            $response['TOTAL_ROUTE_HOTSPOT_AMOUNT'] = general_currency_symbol . ' ' . number_format($TOTAL_ROUTE_HOTSPOT_AMOUNT, 2);

            $response['CHANGED_HOTSPOT_AMOUNT'] = '
        <b class="text-muted text-decoration-line-through me-2" style="font-size: 1rem;">' . general_currency_symbol . ' ' . number_format($TOTAL_HOTSPOT_AMOUNT, 2) . '</b>
        <b class="text-primary" style="font-size: 1rem;">' . general_currency_symbol . ' ' . number_format($TOTAL_ACTIVE_HOTSPOT_AMOUNT, 2) . '</b>';

            $response['cancelled_response'] = '';

            $select_cancelled_itinerary_plan_route_hotspot_cost_details = sqlQUERY_LABEL(" SELECT
        `cancelled_itinerary_hotspot_cost_detail_ID`,
        `cancelled_itinerary_ID`,
        `cnf_itinerary_hotspot_cost_detail_ID`,
        `hotspot_cost_detail_id`,
        `route_hotspot_id`,
        `hotspot_ID`,
        `itinerary_plan_id`,
        `itinerary_route_id`,
        `traveller_type`,
        `traveller_name`,
        `entry_ticket_cost`,
        `entry_cost_cancellation_status`,
        `cancelled_on`,
        `defect_type`,
        `entry_cost_cancellation_percentage`,
        `total_entry_cost_cancelled_service_amount`,
        `total_entry_cost_cancellation_charge`,
        `total_entry_cost_refund_amount`
        FROM
        `dvi_cancelled_itinerary_route_hotspot_entry_cost_details`
        WHERE
        `route_hotspot_id` = '$route_hotspot_ID'
        AND `status` = '1'
        AND `deleted` = '0'
        AND `itinerary_plan_id` = '$itinerary_plan_ID'
        AND `itinerary_route_id` = '$itinerary_route_ID'
        AND `entry_cost_cancellation_status` = '1'
        AND `traveller_type` = '$traveller_type'
        ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details) > 0):
                $response['cancelled_response'] .= '
        <hr class="my-4 mt-2 mb-3 border-bottom">
        <h6 class="text-danger mb-3 d-flex align-items-center">
            <i class="ti ti-ticket-off text-danger me-2" style="font-size: 1.2rem;"></i>
            <span>Cancelled Tickets</span>
        </h6>
        <div class="row g-3">';

                while ($fetch_route_hotspot_cost_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_hotspot_cost_details)) {
                    $traveller_type = $fetch_route_hotspot_cost_data['traveller_type'];
                    $hot_spot_traveller_name = $fetch_route_hotspot_cost_data['traveller_name'];
                    $entry_ticket_cost = $fetch_route_hotspot_cost_data['entry_ticket_cost'];
                    $hotspot_cost_detail_id = $fetch_route_hotspot_cost_data['hotspot_cost_detail_id'];
                    $cancelled_on = $fetch_route_hotspot_cost_data['cancelled_on'];
                    $defect_type = $fetch_route_hotspot_cost_data['defect_type'];
                    $entry_cost_cancellation_percentage = $fetch_route_hotspot_cost_data['entry_cost_cancellation_percentage'];
                    $total_entry_cost_cancelled_service_amount = $fetch_route_hotspot_cost_data['total_entry_cost_cancelled_service_amount'];
                    $total_entry_cost_refund_amount = $fetch_route_hotspot_cost_data['total_entry_cost_refund_amount'];

                    $response['cancelled_response'] .= '
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                    <div>
                        <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . htmlspecialchars($hot_spot_traveller_name) . ' (Cancelled)</p>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date('d M, Y', strtotime($cancelled_on)) . ' at ' . date('h:i A', strtotime($cancelled_on)) . '</small>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($defect_type, 'label') . '</small>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;"><strong>Original Amount:</strong> ' . general_currency_symbol . ' ' . number_format($total_entry_cost_cancelled_service_amount, 2) . ' </small>
                        <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_entry_cost_refund_amount, 2) . ' (' . $entry_cost_cancellation_percentage . '% Deduction)</p>
                    </div>
                    <div class="text-center">
                        <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                        <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_entry_cost_refund_amount, 2) . '</p>
                    </div>
                </div>
            </div>';
                }

                $response['cancelled_response'] .= '
        </div>
        <div class="text-end mt-4">
            <p class="m-0 fw-bold"><strong>Total Refund Processed:</strong> ' . general_currency_symbol . ' ' . number_format(getCANCELLED_ITINERARY_HOTSPOT_DETAILS($route_hotspot_ID, 1, 'TOTAL_HOTSPOT_REFUND_AMOUNT'), 2) . '</p>
        </div>';
            endif;
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == "show_confirm_activity_cancellation_modal"):

        $cancelled_route_activity_ID = $_GET['cancelled_route_activity_ID'];
        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $itinerary_route_ID = $_GET['itinerary_route_ID'];
        $route_activity_ID = $_GET['route_activity_ID'];
        $activity_cost_details_id = $_GET['activity_cost_details_id'];
        $activity_defect_type = $_GET['activity_defect_type'];
        $activity_cancellation_percentage = $_GET['activity_cancellation_percentage'];
        $activity_entry_cost = $_GET['activity_entry_cost'];
        $traveller_type = $_GET['traveller_type'];

        $select_cancelled_itinerary_plan_route_activity_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_activity_cost_detail_ID`, `cancelled_itinerary_ID`, `cancelled_route_activity_ID`, `cnf_itinerary_activity_cost_detail_ID`, `activity_cost_detail_id`, `route_activity_id`, `hotspot_ID`, `activity_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost`, `entry_cost_cancellation_status`, `cancelled_on`, `defect_type`, `entry_cost_cancellation_percentage`, `total_entry_cost_cancelled_service_amount`, `total_entry_cost_cancellation_charge`, `total_entry_cost_refund_amount` FROM `dvi_cancelled_itinerary_route_activity_entry_cost_details` WHERE `route_activity_id`='$route_activity_ID' AND `status`='1' AND `deleted`='0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `activity_cost_detail_id`='$activity_cost_details_id' AND `traveller_type`='$traveller_type'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details) > 0):
            while ($fetch_route_activity_cost_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details)) :
                $hotspot_ID = $fetch_route_activity_cost_data['hotspot_ID'];
                $hotspot_name = getHOTSPOTDETAILS($hotspot_ID, 'label');
                $activity_ID = $fetch_route_activity_cost_data['activity_ID'];
                $activity_name = getACTIVITYDETAILS($activity_ID, 'label', $hotspot_ID);
                $activity_traveller_name = $fetch_route_activity_cost_data['traveller_name'];
                $entry_ticket_cost = $fetch_route_activity_cost_data['entry_ticket_cost'];
                $itinerary_route_date = getITINEARY_CONFIRMED_ROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'get_route_date');
            endwhile;
        endif;

    ?>
        <div class="modal-body">
            <div class="row">
                <?php //if ($TOTAL_USED_COUNT == 0) : 
                ?>
                <div class="text-center">
                    <svg class="icon-44" width="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
                        <!-- Outer calendar shape -->
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"></rect>
                        <!-- Calendar header -->
                        <rect x="3" y="4" width="18" height="4" fill="currentColor"></rect>
                        <!-- Cross symbol -->
                        <line x1="8" y1="9" x2="16" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <line x1="16" y1="9" x2="8" y2="17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <!-- Optional day grid -->
                        <circle cx="7" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="11" cy="12" r="0.5" fill="currentColor"></circle>
                        <circle cx="15" cy="12" r="0.5" fill="currentColor"></circle>
                    </svg>
                </div>
                <h6 class="mt-4 mb-2 text-center">Are you sure?</h6>
                <p class="text-center">

                    Do you really want to cancel the Activity Entry Cost For this traveller (<?= $activity_traveller_name ?>)? <br />
                    <strong><?= $hotspot_name . " - " . $activity_name  ?></strong> <br />
                    Cost: Rs.<strong><?= $entry_ticket_cost ?></strong> <br />
                    Date: <strong><?= date('d M, Y D', strtotime($itinerary_route_date)) ?></strong> <br />

                    This process cannot be undone.
                </p>

                <div class="text-center pb-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" onclick="cancel_ITINERARY_ACTIVITY_DETAILS('<?= $cancelled_route_activity_ID ?>','<?= $itinerary_plan_ID; ?>','<?= $itinerary_route_ID ?>','<?= $route_activity_ID; ?>','<?= $activity_cost_details_id; ?>','<?= $activity_defect_type; ?>','<?= $activity_cancellation_percentage; ?>','<?= $activity_entry_cost; ?>','<?= $traveller_type ?>');" class="btn btn-danger">Confirm Cancellation</button>
                </div>

            </div>
        </div>

    <?php
    elseif ($_GET['type'] == "confirm_itinerary_activity_cancellation"):

        $response = [];
        $errors = [];

        // Validate required fields
        if (empty($_POST['_cancel_percentage'])) :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_activity_defect_type'] == "") :
            $errors['activity_defect_type_required'] = true;
        endif;

        $itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $itinerary_route_ID = $_POST['_itinerary_route_ID'];
        $route_activity_ID = $_POST['_route_activity_ID'];
        $activity_cost_detail_id = $_POST['_activity_cost_details_id'];
        $activity_defect_type = $_POST['_activity_defect_type'];
        $activity_cancellation_percentage = $_POST['_cancel_percentage'];
        $activity_entry_cost = $_POST['_activity_entry_cost'];
        $traveller_type = $_POST['_traveller_type'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;
            $cancelled_on = date('Y-m-d H:i:s');
            $total_route_cancelled_service_amount = 0;
            $total_route_cancellation_charge = 0;

            //CANCEL Activity ENTRY COST OF EACH TRAVELLER
            $select_cancelled_itinerary_plan_route_activity_cost_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_activity_cost_detail_ID`, `cancelled_itinerary_ID`, `cancelled_route_activity_ID`, `cnf_itinerary_activity_cost_detail_ID`, `activity_cost_detail_id`, `route_activity_id`, `hotspot_ID`, `activity_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost`, `entry_cost_cancellation_status`, `cancelled_on`, `defect_type`, `entry_cost_cancellation_percentage`, `total_entry_cost_cancelled_service_amount`, `total_entry_cost_cancellation_charge`, `total_entry_cost_refund_amount` FROM `dvi_cancelled_itinerary_route_activity_entry_cost_details` WHERE `route_activity_id`='$route_activity_ID' AND `status`='1' AND `deleted`='0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `activity_cost_detail_id`='$activity_cost_detail_id' AND `traveller_type`='$traveller_type'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTSPOT_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details) > 0) :
                while ($fetch_itinerary_activity_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details)) :
                    $cancelled_itinerary_activity_cost_detail_ID = $fetch_itinerary_activity_data['cancelled_itinerary_activity_cost_detail_ID'];
                    $hotspot_ID = $fetch_itinerary_activity_data['hotspot_ID'];
                    $activity_ID = $fetch_itinerary_activity_data['activity_ID'];
                    $entry_ticket_cost = $fetch_itinerary_activity_data['entry_ticket_cost'];
                    $entry_cost_cancellation_charge = ($entry_ticket_cost * ($activity_cancellation_percentage / 100));
                    $entry_cost_refund_amount = $entry_ticket_cost  - $entry_cost_cancellation_charge;

                    $total_route_cancelled_service_amount =  $entry_ticket_cost;
                    $total_route_cancellation_charge =  $entry_cost_cancellation_charge;

                endwhile;

                //UPDATE CANCELLED ACTIVITY ENTRY COST DETAILS TABLE
                $cancellation_activity_entry_cost_details_arrFields = array('`entry_cost_cancellation_status`', '`cancelled_on`', '`defect_type`', '`entry_cost_cancellation_percentage`', '`total_entry_cost_cancelled_service_amount`', '`total_entry_cost_cancellation_charge`', '`total_entry_cost_refund_amount`');
                $cancellation_activity_entry_cost_details_arrValues = array("1", "$cancelled_on", "$activity_defect_type", "$activity_cancellation_percentage", "$entry_ticket_cost", "$entry_cost_cancellation_charge", "$entry_cost_refund_amount");
                $activity_entry_cost_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `activity_cost_detail_id` = '$activity_cost_detail_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_activity_entry_cost_details", $cancellation_activity_entry_cost_details_arrFields, $cancellation_activity_entry_cost_details_arrValues, $activity_entry_cost_sqlWhere)) :
                endif;

                //UPDATE COMFIRMED ITINERARY ACTIVITY ENTRY COST STATUS
                $confirmed_entry_cost_arrFields = array('`cancellation_status`', '`cancellation_defect_type`');
                $confirmed_entry_cost_arrValues = array("1", "$activity_defect_type");
                $confirmed_entry_cost_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' AND `itinerary_route_ID`='$itinerary_route_ID' AND `activity_cost_detail_id` = '$activity_cost_detail_id' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_activity_entry_cost_details", $confirmed_entry_cost_arrFields, $confirmed_entry_cost_arrValues, $confirmed_entry_cost_sqlWhere)) :
                endif;

                //INSERT CANCELLATION LOG TABLE
                $cancellation_log_arrFields = array('itinerary_plan_id', 'itinerary_activity_cancellation_status', 'cancellation_date', 'cancelled_by', 'total_cancelled_service_amount', 'total_cancellation_charge', 'total_refund_amount', 'createdby', 'status');
                $cancellation_log_arrValues = array("$itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$entry_ticket_cost", "$entry_cost_cancellation_charge", "$entry_cost_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellation_log_arrFields, $cancellation_log_arrValues, '')) :
                endif;

            endif;


            $total_route_refund_amount = $total_route_cancelled_service_amount - $total_route_cancellation_charge;

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $total_route_cancelled_service_amount + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_route_cancellation_charge + $existing_total_cancellation_charge;
                $total_refund_amount = $total_route_refund_amount + $existing_total_refund_amount;

                $cancellation_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancellation_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancellation_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, $cancellation_sqlWhere)) :
                endif;
            else:
                //INSERT
                $cancellation_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', 'createdby', 'status');

                $cancellation_arrValues = array("$itinerary_plan_ID", "$total_route_cancelled_service_amount", "$total_route_cancellation_charge", "$total_route_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancellation_arrFields, $cancellation_arrValues, '')) :
                    $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                    //UPDATE TABLES WITH CANCELLATION ID
                    $cancellationID_arrFields = array('`cancelled_itinerary_ID`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID");
                    $cancellationID_sqlWhere = " `itinerary_plan_id`='$itinerary_plan_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                    endif;

                    //ACTIVITY ENTRY COST
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_activity_entry_cost_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_sqlWhere)) :
                    endif;

                    //ACTIVITY ROUTE DETAILS
                    $cancellationID_guide_sqlWhere = " `itinerary_plan_ID`='$itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_activity_details", $cancellationID_arrFields, $cancellationID_arrValues, $cancellationID_guide_sqlWhere)) :
                    endif;
                endif;

            endif;

            //COLLECT TOTAL RECORDS IN ACTIVITY ENTRY COST DETAILS
            $TOTAL_TRAVELLER_COUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_TRAVELLER_COUNT');

            //COLLECT TOTAL ACTIVE RECORDS IN ACTIVITY ENTRY COST DETAILS
            $TOTAL_ACTIVE_TRAVELLER_COUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_ACTIVE_TRAVELLER_COUNT');

            //COLLECT TOTAL CANCELLED RECORDS IN ACTIVITY ENTRY COST DETAILS
            $TOTAL_CANCELLED_TRAVELLER_COUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_CANCELLED_TRAVELLER_COUNT');


            $select_itinerary_activity_entry_cost_details = sqlQUERY_LABEL("SELECT  SUM(`total_entry_cost_cancelled_service_amount`) AS total_entry_cost_cancelled_service_amount, SUM(`total_entry_cost_cancellation_charge`) AS total_entry_cost_cancellation_charge, SUM(`total_entry_cost_refund_amount`) AS total_entry_cost_refund_amount FROM `dvi_cancelled_itinerary_route_activity_entry_cost_details` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_ID'  AND `entry_cost_cancellation_status`='1' ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_itinerary_activity_entry_cost_details) > 0) :
                while ($fetch_entry_cost_data = sqlFETCHARRAY_LABEL($select_itinerary_activity_entry_cost_details)) :
                    $total_entry_cost_cancelled_service_amount  =  $fetch_entry_cost_data['total_entry_cost_cancelled_service_amount'];
                    $total_entry_cost_cancellation_charge  =  $fetch_entry_cost_data['total_entry_cost_cancellation_charge'];
                    $total_entry_cost_refund_amount  =  $fetch_entry_cost_data['total_entry_cost_refund_amount'];
                endwhile;
            endif;

            $TOTAL_ROUTE_ACTIVE_ACTIVITY_AMOUNT = getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, '', 'TOTAL_ROUTE_ACTIVITY_AMOUNT');

            if ($TOTAL_TRAVELLER_COUNT == $TOTAL_CANCELLED_TRAVELLER_COUNT):

                //UPDATE CANCELLED ROUTE ACTIVITY TABLE
                $cancellation_activity_arrFields = array('`activity_amout`', '`route_cancellation_status`', '`cancelled_on`',  '`total_route_cancelled_service_amount`', '`total_route_cancellation_charge`', '`total_route_refund_amount`');

                $cancellation_activity_arrValues = array("$TOTAL_ROUTE_ACTIVE_ACTIVITY_AMOUNT", "1", "$cancelled_on",   "$total_entry_cost_cancelled_service_amount", "$total_entry_cost_cancellation_charge", "$total_entry_cost_refund_amount");

                $cancellation_activity_sqlWhere = " `route_activity_ID` = '$route_activity_ID' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_activity_details", $cancellation_activity_arrFields, $cancellation_activity_arrValues, $cancellation_activity_sqlWhere)) :
                endif;

                //UPDATE COMFIRMED ITINERARY ROUTE STATUS
                $confirmed_activity_arrFields = array('`cancellation_status`');
                $confirmed_activity_arrValues = array("$cancellation_status");
                $confirmed_activity_sqlWhere = " `route_activity_ID` = '$route_activity_ID' ";
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_route_activity_details", $confirmed_activity_arrFields, $confirmed_activity_arrValues, $confirmed_activity_sqlWhere)) :
                endif;

            else:

                //UPDATE CANCELLED ROUTE ACTIVITY TABLE TOTAL ACTIVITY AMOUNT
                $cancellation_activity_arrFields = array('`activity_amout`');
                $cancellation_activity_arrValues = array("$TOTAL_ROUTE_ACTIVE_ACTIVITY_AMOUNT");
                $cancellation_activity_sqlWhere = " `route_activity_ID` = '$route_activity_ID' and `itinerary_plan_ID`='$itinerary_plan_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_route_activity_details", $cancellation_activity_arrFields, $cancellation_activity_arrValues, $cancellation_activity_sqlWhere)) :
                endif;

            endif;

            $response['i_result'] = true;
            $response['TOTAL_ACTIVITY_AMOUNT'] = general_currency_symbol . ' ' . number_format($TOTAL_ROUTE_ACTIVE_ACTIVITY_AMOUNT, 2);
            $response['TOTAL_ACTIVE_TRAVELLER_COUNT'] = getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_ACTIVE_TRAVELLER_COUNT');
            $response['TOTAL_CANCELLED_TRAVELLER_COUNT'] = getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_CANCELLED_TRAVELLER_COUNT');

            $TOTAL_ACTIVITY_AMOUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_ACTIVITY_AMOUNT');
            $TOTAL_ACTIVE_ACTIVITY_AMOUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_ACTIVE_ACTIVITY_AMOUNT');
            $TOTAL_ADULT_CANCELLED_ACTIVITY_AMOUNT =  getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, $traveller_type, 'TOTAL_CANCELLED_ACTIVITY_AMOUNT');

            $response['CHANGED_ACTIVITY_AMOUNT'] = '<b class="text-muted text-decoration-line-through me-2" style="font-size: 1rem;">' . general_currency_symbol . ' ' . number_format($TOTAL_ACTIVITY_AMOUNT, 2) . '</b><b class="text-primary" style="font-size: 1rem;">' . general_currency_symbol . ' ' . number_format($TOTAL_ACTIVE_ACTIVITY_AMOUNT, 2) . '</b>';

            $response['cancelled_response'] = '';
            cancel_EntireItineraryPlan($itinerary_plan_ID);

            $select_cancelled_itinerary_plan_route_activity_cost_details = sqlQUERY_LABEL(" SELECT 
            `cancelled_itinerary_activity_cost_detail_ID`, `cancelled_itinerary_ID`, `cancelled_route_activity_ID`, `cnf_itinerary_activity_cost_detail_ID`, `activity_cost_detail_id`, `route_activity_id`, `hotspot_ID`, `activity_ID`, `itinerary_plan_id`, `itinerary_route_id`, `traveller_type`, `traveller_name`, `entry_ticket_cost`, `entry_cost_cancellation_status`, `cancelled_on`, `defect_type`, `entry_cost_cancellation_percentage`, `total_entry_cost_cancelled_service_amount`, `total_entry_cost_cancellation_charge`, `total_entry_cost_refund_amount` FROM  `dvi_cancelled_itinerary_route_activity_entry_cost_details`  WHERE `route_activity_id` = '$route_activity_ID'  AND `status` = '1'  AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `entry_cost_cancellation_status` = '1' AND `traveller_type` = '$traveller_type'  ") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ACTIVITY_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details) > 0):
                $response['cancelled_response'] .= '
                        <hr class="my-4 mt-2 mb-3 border-bottom">
                        <h6 class="text-danger mb-3 d-flex align-items-center">
                            <i class="ti ti-ticket-off text-danger me-2" style="font-size: 1.2rem;"></i>
                            <span>Cancelled Tickets</span>
                        </h6>
                        <div class="row g-3">';

                while ($fetch_route_activity_cost_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_route_activity_cost_details)) :
                    $traveller_type = $fetch_route_activity_cost_data['traveller_type'];
                    $activity_traveller_name = $fetch_route_activity_cost_data['traveller_name'];
                    $entry_ticket_cost = $fetch_route_activity_cost_data['entry_ticket_cost'];
                    $activity_cost_detail_id = $fetch_route_activity_cost_data['activity_cost_detail_id'];
                    $cancelled_on = $fetch_route_activity_cost_data['cancelled_on'];
                    $defect_type = $fetch_route_activity_cost_data['defect_type'];
                    $entry_cost_cancellation_percentage = $fetch_route_activity_cost_data['entry_cost_cancellation_percentage'];
                    $total_entry_cost_cancelled_service_amount = $fetch_route_activity_cost_data['total_entry_cost_cancelled_service_amount'];
                    $total_entry_cost_refund_amount = $fetch_route_activity_cost_data['total_entry_cost_refund_amount'];

                    $response['cancelled_response'] .= '
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                            <div>
                                <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . htmlspecialchars($activity_traveller_name) . ' (Cancelled)</p>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date('d M, Y', strtotime($cancelled_on)) . ' at ' . date('h:i A', strtotime($cancelled_on)) . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($defect_type, 'label') . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;"><strong>Original Amount:</strong> ' . general_currency_symbol . ' ' . number_format($total_entry_cost_cancelled_service_amount, 2) . ' </small>
                                <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_entry_cost_refund_amount, 2) . ' (' . $entry_cost_cancellation_percentage . '% Deduction)</p>
                            </div>
                            <div class="text-center">
                                <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                                <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_entry_cost_refund_amount, 2) . '</p>
                            </div>
                        </div>
                    </div>';
                endwhile;

                $response['cancelled_response'] .= '
                </div>
                <div class="text-end mt-4">
                    <p class="m-0 fw-bold"><strong>Total Refund Processed:</strong> ' . general_currency_symbol . ' ' . number_format(getCANCELLED_ITINERARY_ACTIVITY_DETAILS($route_activity_ID, 1, 'TOTAL_ACTIVITY_REFUND_AMOUNT'), 2) . '</p>
                </div>';
            endif;
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_room_service_cancel_form'):

        $cancelled_itinerary_plan_hotel_room_service_details_ID = $_GET['cancelled_itinerary_plan_hotel_room_service_details_ID'];
        $cancellation_percentage = $_GET['cancellation_percentage'];
        $defect_type = $_GET['defect_type'];

        $select_itinerary_room_service_cancellation_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, PLAN_HOTEL_DETAILS.`itinerary_route_location`, HOTEL_ROOMS.`room_title`, HOTEL_ROOM_SERVICE_DETAILS.`itinerary_route_date`, HOTEL_ROOM_SERVICE_DETAILS.`hotel_id`, HOTEL_ROOM_SERVICE_DETAILS.`itinerary_plan_id`, HOTEL_ROOM_SERVICE_DETAILS.`room_service_type`, HOTEL_ROOM_SERVICE_DETAILS.`total_room_service_rate` FROM `dvi_cancelled_itinerary_plan_hotel_room_service_details` HOTEL_ROOM_SERVICE_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = HOTEL_ROOM_SERVICE_DETAILS.`hotel_id` LEFT JOIN `dvi_hotel_rooms` HOTEL_ROOMS ON HOTEL_ROOMS.`hotel_id` = HOTEL_ROOM_SERVICE_DETAILS.`hotel_id` AND HOTEL_ROOMS.`room_ID` = HOTEL_ROOM_SERVICE_DETAILS.`room_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID` = HOTEL_ROOM_SERVICE_DETAILS.`itinerary_plan_hotel_details_id` WHERE HOTEL_ROOM_SERVICE_DETAILS.`cancelled_itinerary_plan_hotel_room_service_details_ID` = '$cancelled_itinerary_plan_hotel_room_service_details_ID' AND HOTEL_ROOM_SERVICE_DETAILS.`deleted` = '0' AND HOTEL_ROOM_SERVICE_DETAILS.`status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_room_service_cancellation_details) > 0) :
            while ($fetch_itinerary_room_service_details_data = sqlFETCHARRAY_LABEL($select_itinerary_room_service_cancellation_details)) :
                $hotel_name = $fetch_itinerary_room_service_details_data['hotel_name'];
                $itinerary_route_location = $fetch_itinerary_room_service_details_data['itinerary_route_location'];
                $room_title = $fetch_itinerary_room_service_details_data['room_title'];
                $itinerary_route_date = $fetch_itinerary_room_service_details_data['itinerary_route_date'];
                $hotel_id = $fetch_itinerary_room_service_details_data['hotel_id'];
                $itinerary_plan_id = $fetch_itinerary_room_service_details_data['itinerary_plan_id'];
                $room_service_type = $fetch_itinerary_room_service_details_data['room_service_type'];
                $total_room_service_rate = $fetch_itinerary_room_service_details_data['total_room_service_rate'];

                $total_room_service_rate_amt = general_currency_symbol . ' ' . number_format($total_room_service_rate, 2);
            endwhile;
        endif;

        $room_service_types = [
            1 => ['label' => 'Extra Bed'],
            2 => ['label' => 'Child Without Bed'],
            3 => ['label' => 'Child With Bed'],
            4 => ['label' => 'Breakfast'],
            5 => ['label' => 'Lunch'],
            6 => ['label' => 'Dinner']
        ];

        $room_service_type_label = $room_service_types[$room_service_type]['label'] ?? 'N/A';
    ?>
        <div class="modal-body">
            <div class="text-center">
                <!-- Title with Primary Color for Emphasis -->
                <h5 class="mt-4 mb-3 text-primary">
                    <span class="text-primary"><strong>Cancel "<?= $room_service_type_label; ?>"?</strong></span>
                </h5>
                <p class="mb-4">You are about to cancel the <?= $room_service_type_label; ?> from the booking.<br> This action cannot be undone.</p>
            </div>

            <!-- Step 1: Booking Details (Clear and Focused) -->
            <div class="row">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Room:</strong>
                    <span class="fw-bold"><?= $room_title; ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Date:</strong>
                    <span class="fw-bold"><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-0 d-flex justify-content-between">
                    <strong class="text-dark">Location:</strong>
                    <span class="fw-bold"><?= $hotel_name; ?>, <?= $itinerary_route_location; ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 2: Cancellation Summary (Grouped Breakdown) -->
            <div class="row">
                <div class="col-6 mb-3">
                    <strong>Original Cost :</strong> <?= $total_room_service_rate_amt; ?>
                </div>
                <div class="col-6 mb-3">
                    <strong>Cancellation Percentage :</strong> <?= $cancellation_percentage; ?>%
                </div>
                <div class="col-6 mb-0">
                    <strong>Defect Type :</strong> <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'label'); ?>
                </div>
                <div class="col-6 mb-0">
                    <strong>Cancellation Charges :</strong> <?= general_currency_symbol . ' ' . number_format(($total_room_service_rate * $cancellation_percentage) / 100, 2); ?>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 3: Action Confirmation (Focus on the Decision) -->
            <div class="text-center">
                <p class="fw-bold text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the "<?= $room_service_type_label; ?>"? <br> This will incur a <?= general_currency_symbol . ' ' . number_format(($total_room_service_rate * $cancellation_percentage) / 100, 2); ?> cancellation fee.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="row text-center mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal" aria-label="Close">Close</button>
                    <button type="submit" onclick="confirmCANCELROOMSERVICES('<?= $cancelled_itinerary_plan_hotel_room_service_details_ID; ?>','<?= $cancellation_percentage; ?>','<?= $defect_type; ?>');" class="btn btn-danger" aria-label="Confirm Cancellation">Confirm Cancellation</button>
                </div>
            </div>
        </div>
        <script>
            function confirmCANCELROOMSERVICES(cancelled_itinerary_plan_hotel_room_service_details_ID, cancellation_percentage, defect_type) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_room_service_cancellation",
                    data: {
                        _cancelled_itinerary_plan_hotel_room_service_details_ID: cancelled_itinerary_plan_hotel_room_service_details_ID,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showROOMSERVICECANCELFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');
                            $('#response_' + cancelled_itinerary_plan_hotel_room_service_details_ID).html(response.html_response);
                            showCANCELLATION_SUMMARY(response.itinerary_plan_id, response.itinerary_route_id, response.hotel_id);
                        }
                    }
                });
            }

            function showCANCELLATION_SUMMARY(itinerary_plan_ID, itinerary_route_ID, hotel_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_hotel_cancellation_hotel_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _itinerary_route_ID: itinerary_route_ID,
                        _hotel_ID: hotel_ID
                    },
                    success: function(response) {
                        $('.show_cancellation_summary').html('');
                        $('.show_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php
    elseif ($_GET['type'] == 'confirm_room_service_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_cancelled_itinerary_plan_hotel_room_service_details_ID = $_POST['_cancelled_itinerary_plan_hotel_room_service_details_ID'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        $select_itinerary_room_service_cancellation_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_hotel_room_service_details_ID`, `itinerary_plan_id`, `itinerary_route_id`, `hotel_id`, `room_service_type`, `total_room_service_rate` FROM `dvi_cancelled_itinerary_plan_hotel_room_service_details` WHERE `cancelled_itinerary_plan_hotel_room_service_details_ID` = '$_cancelled_itinerary_plan_hotel_room_service_details_ID' AND `deleted` = '0' AND `status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_room_service_cancellation_details) > 0) :
            while ($fetch_itinerary_room_service_details_data = sqlFETCHARRAY_LABEL($select_itinerary_room_service_cancellation_details)) :
                $confirmed_itinerary_plan_hotel_room_service_details_ID = $fetch_itinerary_room_service_details_data['confirmed_itinerary_plan_hotel_room_service_details_ID'];
                $itinerary_plan_id = $fetch_itinerary_room_service_details_data['itinerary_plan_id'];
                $itinerary_route_id = $fetch_itinerary_room_service_details_data['itinerary_route_id'];
                $hotel_id = $fetch_itinerary_room_service_details_data['hotel_id'];
                $total_room_service_rate = $fetch_itinerary_room_service_details_data['total_room_service_rate'];
                $room_service_type = $fetch_itinerary_room_service_details_data['room_service_type'];
            endwhile;
        endif;

        $total_room_service_cancellation_charge = (($total_room_service_rate * $_cancellation_percentage) / 100);
        $total_room_service_refund_amount = ($total_room_service_rate - $total_room_service_cancellation_charge);

        $room_service_types = [
            1 => ['label' => 'Extra Bed', 'field_name' => 'itinerary_room_extrabed_cancellation_status'],
            2 => ['label' => 'Child Without Bed', 'field_name' => 'itinerary_room_childwithoutbed_cancellation_status'],
            3 => ['label' => 'Child With Bed', 'field_name' => 'itinerary_room_childwithbed_cancellation_status'],
            4 => ['label' => 'Breakfast', 'field_name' => 'itinerary_room_breakfast_cancellation_status'],
            5 => ['label' => 'Lunch', 'field_name' => 'itinerary_room_lunch_cancellation_status'],
            6 => ['label' => 'Dinner', 'field_name' => 'itinerary_room_dinner_cancellation_status']
        ];

        $room_service_type_field = $room_service_types[$room_service_type]['field_name'];
        $room_service_type_label = $room_service_types[$room_service_type]['label'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $total_room_service_rate + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_room_service_cancellation_charge + $existing_total_cancellation_charge;
                $total_refund_amount = $total_room_service_refund_amount + $existing_total_refund_amount;

                $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                endif;

                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                //CANCELLATION LOG
                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                endif;

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_hotel_room_service_details_ID` = '$_cancelled_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type'";

                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                endif;

                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                $confirmed_room_service_arrValues = array("1", "$_defect_type");

                $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type' ";
                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                endif;

            else:

                $total_cancelled_service_amount = $total_room_service_rate;
                $total_cancellation_charge = $total_room_service_cancellation_charge;
                $total_refund_amount = $total_room_service_refund_amount;

                //INSERT
                $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                    $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                    $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                    $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                    $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_hotel_room_service_details_ID` = '$_cancelled_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type'";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                    $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                    $confirmed_room_service_arrValues = array("1", "$_defect_type");

                    $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type'";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                    endif;

                endif;
            endif;

            $response['itinerary_plan_id'] = $itinerary_plan_id;
            $response['itinerary_route_id'] = $itinerary_route_id;
            $response['hotel_id'] = $hotel_id;
            cancel_EntireItineraryPlan($itinerary_plan_id);
            $response['html_response'] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                <div>
                    <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $room_service_type_label . ' (Cancelled)</p>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_rate, 2) . '</small>
                    <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                </div>
                <!-- Right Side: Refunded Amount -->
                <div class="text-center">
                    <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                    <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . '</p>
                </div>
            </div>';

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_hotel_amenities_form'):

        $cancelled_itinerary_plan_hotel_room_amenities_details_ID = $_GET['cancelled_itinerary_plan_hotel_room_amenities_details_ID'];
        $cancellation_percentage = $_GET['cancellation_percentage'];
        $defect_type = $_GET['defect_type'];

        $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, PLAN_HOTEL_DETAILS.`itinerary_route_location`, HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_route_date`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_hotel_details_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTEL_AMENITIES_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
            while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                $hotel_name = $fetch_itinerary_hotel_amenities_details_data['hotel_name'];
                $itinerary_route_location = $fetch_itinerary_hotel_amenities_details_data['itinerary_route_location'];
                $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                $confirmed_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['confirmed_itinerary_plan_hotel_room_amenities_details_ID'];
                $itinerary_route_date = $fetch_itinerary_hotel_amenities_details_data['itinerary_route_date'];
                $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];
                $itinerary_plan_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_plan_id'];

                $total_amenitie_rate_amt = general_currency_symbol . ' ' . number_format($amenitie_rate, 2);
            endwhile;
        endif;
    ?>
        <div class="modal-body">
            <div class="text-center">
                <!-- Title with Primary Color for Emphasis -->
                <h5 class="mt-4 mb-3 text-primary">
                    <span class="text-primary"><strong>Cancel "<?= $amenities_title; ?>"?</strong></span>
                </h5>
                <p class="mb-4">You are about to cancel the "<?= $amenities_title; ?>" from the booking.<br> This action cannot be undone.</p>
            </div>

            <!-- Step 1: Booking Details (Clear and Focused) -->
            <div class="row">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Amenities:</strong>
                    <span class="fw-bold"><?= $amenities_title; ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Date:</strong>
                    <span class="fw-bold"><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-0 d-flex justify-content-between">
                    <strong class="text-dark">Location:</strong>
                    <span class="fw-bold"><?= $hotel_name; ?>, <?= $itinerary_route_location; ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 2: Cancellation Summary (Grouped Breakdown) -->
            <div class="row">
                <div class="col-6 mb-3">
                    <strong>Original Cost :</strong> <?= $amenitie_rate; ?>
                </div>
                <div class="col-6 mb-3">
                    <strong>Cancellation Percentage :</strong> <?= $cancellation_percentage; ?>%
                </div>
                <div class="col-6 mb-0">
                    <strong>Defect Type :</strong> <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'label'); ?>
                </div>
                <div class="col-6 mb-0">
                    <strong>Cancellation Charges :</strong> <?= general_currency_symbol . ' ' . number_format(($amenitie_rate * $cancellation_percentage) / 100, 2); ?>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 3: Action Confirmation (Focus on the Decision) -->
            <div class="text-center">
                <p class="fw-bold text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the <?= $amenities_title; ?>? <br> This will incur a <?= general_currency_symbol . ' ' . number_format(($amenitie_rate * $cancellation_percentage) / 100, 2); ?> cancellation fee.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="row text-center mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal" aria-label="Close">Close</button>
                    <button type="submit" onclick="confirmCANCELAMENITIES('<?= $cancelled_itinerary_plan_hotel_room_amenities_details_ID; ?>','<?= $cancellation_percentage; ?>','<?= $defect_type; ?>');" class="btn btn-danger" aria-label="Confirm Cancellation">Confirm Cancellation</button>
                </div>
            </div>
        </div>
        <script>
            function confirmCANCELAMENITIES(cancelled_itinerary_plan_hotel_room_amenities_details_ID, cancellation_percentage, defect_type) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_hotel_amenities_cancellation",
                    data: {
                        _cancelled_itinerary_plan_hotel_room_amenities_details_ID: cancelled_itinerary_plan_hotel_room_amenities_details_ID,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showHOTELAMENITIESFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');
                            $('#response_' + cancelled_itinerary_plan_hotel_room_amenities_details_ID).html(response.html_response);
                            showCANCELLATION_SUMMARY(response.itinerary_plan_id, response.itinerary_route_id, response.hotel_id);
                        }
                    }
                });
            }

            function showCANCELLATION_SUMMARY(itinerary_plan_ID, itinerary_route_ID, hotel_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_hotel_cancellation_hotel_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _itinerary_route_ID: itinerary_route_ID,
                        _hotel_ID: hotel_ID
                    },
                    success: function(response) {
                        $('.show_cancellation_summary').html('');
                        $('.show_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php

    elseif ($_GET['type'] == 'confirm_hotel_amenities_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_cancelled_itinerary_plan_hotel_room_amenities_details_ID = $_POST['_cancelled_itinerary_plan_hotel_room_amenities_details_ID'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_route_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_hotel_details_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$_cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
            while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];
                $confirmed_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['confirmed_itinerary_plan_hotel_room_amenities_details_ID'];
                $itinerary_plan_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_plan_id'];
                $hotel_amenities_id = $fetch_itinerary_hotel_amenities_details_data['hotel_amenities_id'];
                $itinerary_route_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_route_id'];
                $hotel_id = $fetch_itinerary_hotel_amenities_details_data['hotel_id'];
            endwhile;
        endif;

        $total_amenities_cancellation_charge = (($amenitie_rate * $_cancellation_percentage) / 100);
        $total_amenities_refund_amount = ($amenitie_rate - $total_amenities_cancellation_charge);

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $amenitie_rate + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_amenities_cancellation_charge + $existing_total_cancellation_charge;
                $total_refund_amount = $total_amenities_refund_amount + $existing_total_refund_amount;

                $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                endif;

                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                //CANCELLATION LOG
                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                endif;

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$_cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                endif;

                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                $confirmed_amenities_arrValues = array("1", "$_defect_type");

                $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";
                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                endif;

            else:

                $total_cancelled_service_amount = $amenitie_rate;
                $total_cancellation_charge = $total_amenities_cancellation_charge;
                $total_refund_amount = $total_amenities_refund_amount;

                //INSERT
                $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                    $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                    $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                    $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                    $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$_cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                    $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                    $confirmed_amenities_arrValues = array("1", "$_defect_type");

                    $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                    endif;

                endif;
            endif;

            $response['itinerary_plan_id'] = $itinerary_plan_id;
            $response['itinerary_route_id'] = $itinerary_route_id;
            $response['hotel_id'] = $hotel_id;
            cancel_EntireItineraryPlan($itinerary_plan_id);
            $response['html_response'] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                <div>
                    <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $amenities_title . ' (Cancelled)</p>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($amenitie_rate, 2) . '</small>
                    <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                </div>
                <!-- Right Side: Refunded Amount -->
                <div class="text-center">
                    <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                    <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . '</p>
                </div>
            </div>';

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_entire_room_cancel_form'):

        $confirmed_itinerary_plan_hotel_room_details_ID = $_GET['confirmed_itinerary_plan_hotel_room_details_ID'];
        $confirmed_itinerary_plan_hotel_details_id = $_GET['itinerary_plan_hotel_details_id'];
        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $hotel_id = $_GET['hotel_id'];
        $room_id = $_GET['room_id'];
        $room_title = getROOM_DETAILS($room_id, 'room_title');

        $select_no_of_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_rooms_confirmed = sqlNUMOFROW_LABEL($select_no_of_confirmed_itinerary_room_details);

        $select_no_of_remaining_non_cancelled_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `room_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_non_cancelled_rooms_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_room_details);

        $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`,ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID` ,ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_location`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cost`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_gst_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_date` FROM `dvi_confirmed_itinerary_plan_hotel_room_details` ITINEARY_HOTEL_ROOM_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` LEFT JOIN `dvi_confirmed_itinerary_plan_hotel_details` ITINEARY_PLAN_HOTEL_DETAILS ON ITINEARY_PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` WHERE ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' AND ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_id` = '$itinerary_route_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
            $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
            $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
            $itinerary_route_date = $fetch_confirmed_itinerary_data['itinerary_route_date'];
            $total_room_cost = $fetch_confirmed_itinerary_data['total_room_cost'];
            $total_room_gst_amount = $fetch_confirmed_itinerary_data['total_room_gst_amount'];
        endwhile;

        $get_cancellation_percentage_value = $_GET['cancellation_percentage'];
    ?>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Cancel Room "<?= htmlspecialchars($room_title); ?>"?</strong>
                </h5>
                <p class="mb-4 text-muted">
                    You are about to cancel the entire room and associated services. This action cannot be undone.
                </p>
            </div>

            <!-- Room Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel / Room:</strong>
                    <span><?= htmlspecialchars($hotel_name); ?> / <?= htmlspecialchars($room_title); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Room Cost and Added Services -->
            <div class="row mb-3">
                <div class="col-12">
                    <ul class="list-group rounded-lg border-0"> <!-- shadow-sm -->
                        <!-- Room Cost -->
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3 text-dark list-group-item-light border rounded-top">
                            <span class="fw-semibold">Room Cost:</span>
                            <span class="btn btn-xs rounded-pill btn-label-danger waves-effect">
                                <?= general_currency_symbol . ' ' . number_format($total_room_cost + $total_room_gst_amount, 2); ?>
                            </span>
                        </li>

                        <!-- Added Services -->
                        <li class="list-group-item p-3 bg-white rounded-bottom">
                            <?php
                            // Fetch hotel room services details
                            $query = "SELECT `room_service_type`, `total_room_service_rate` FROM `dvi_confirmed_itinerary_plan_hotel_room_service_details` WHERE `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `hotel_id` = '$hotel_id' AND `service_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'";
                            $result = sqlQUERY_LABEL($query) or die("#1-UNABLE_TO_FETCH_HOTEL_ROOM_SERVICES:" . sqlERROR_LABEL());
                            $total_services = sqlNUMOFROW_LABEL($result);
                            // Display hotel services if available
                            if ($total_services > 0):
                                $room_service_types = [
                                    1 => 'Extra Bed',
                                    2 => 'Child Without Bed',
                                    3 => 'Child With Bed',
                                    4 => 'Breakfast',
                                    5 => 'Lunch',
                                    6 => 'Dinner'
                                ];
                            ?>
                                <ul class="list-group">
                                    <?php
                                    $overall_room_service_rate = 0; // Initialize the total for room services
                                    while ($service = sqlFETCHARRAY_LABEL($result)) :
                                        $room_service_type = $service['room_service_type'];
                                        $total_room_service_rate = $service['total_room_service_rate'];
                                        $room_service_label = $room_service_types[$room_service_type] ?? 'Unknown Service';

                                        // Display the service with an icon and rate
                                        echo '
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>' . htmlspecialchars($room_service_label) . '</span>
                                        </div>
                                        <span class="btn btn-xs rounded-pill btn-label-danger waves-effect">
                                            ' . general_currency_symbol . ' ' . number_format($total_room_service_rate, 2) . '
                                        </span>
                                    </li>';
                                        $overall_room_service_rate += $total_room_service_rate;
                                    endwhile;
                                    ?>
                                </ul>
                            <?php else: ?>
                                <div class="text-center text-muted mt-3">
                                    <i class="bi bi-emoji-frown"></i> No added services.
                                </div>
                            <?php endif; ?>
                        </li>

                        <?php
                        if ($total_no_of_non_cancelled_rooms_count == 1):
                            $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_hotel_details_id`,HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1' AND ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_status` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                            // Display hotel services if available
                            if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
                        ?>
                                <li class="mt-3 list-group-item d-flex justify-content-between align-items-center p-3 text-dark list-group-item-light border rounded-top">
                                    <span class="fw-semibold">Amenities</span>
                                </li>
                                <li class="list-group-item p-3 bg-white rounded-bottom">
                                    <ul class="list-group">
                                        <?php
                                        $overall_amenities_rate = 0; // Initialize the total for room services
                                        while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                                            $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                                            $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];

                                            // Display the service with an icon and rate
                                            echo '
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-check-circle text-success me-2"></i>
                                            <span>' . htmlspecialchars($amenities_title) . '</span>
                                        </div>
                                        <span class="btn btn-xs rounded-pill btn-label-danger waves-effect">
                                            ' . general_currency_symbol . ' ' . number_format($amenitie_rate, 2) . '
                                        </span>
                                    </li>';
                                            $overall_amenities_rate += $amenitie_rate;
                                        endwhile;
                                        ?>
                                    </ul>
                                </li>
                        <?php endif;
                        endif; ?>
                    </ul>
                </div>
            </div>

            <hr class="my-3">
            <form action="" data-parsley-validate method="post">
                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">
                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <strong><?= general_currency_symbol . ' ' . number_format($total_room_cost + $total_room_gst_amount + $overall_room_service_rate + $overall_amenities_rate, 2); ?></strong>
                        <input type="hidden" id="total_cancellation_services_amount_1" value="<?= ($total_room_cost + $total_room_gst_amount + $overall_room_service_rate + $overall_amenities_rate); ?>">
                    </div>

                    <!-- Cancellation Percentage and Defect Type -->
                    <div class="col-md-4 mt-3">
                        <label for="cancellation_percentage_1" class="form-label"><strong>Cancellation Percentage:</strong></label>
                        <input type="number" placeholder="Enter Percentage %" id="cancellation_percentage_1" class="form-control" value="<?= $get_cancellation_percentage_value ?>" required min="0" max="100" oninput="updateCancellationCharges_1()">
                    </div>
                    <div class="col-md-4 mt-3">
                        <label for="defect_type" class="form-label"><strong>Defect Type:</strong></label>
                        <select id="defect_type" required class="form-select" onchange="updateCancellationCharges_1">
                            <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'select'); ?>
                        </select>
                    </div>
                    <div class="col-md-4 mt-3 text-end">
                        <label for="total_refund_1" class="form-label"><strong>Total Refund:</strong></label>
                        <div>
                            <h3 id="total_refund_1"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></h3>
                        </div>
                    </div>
                    <!-- Display Calculated Cancellation Charges -->
                    <?php /* <div class="col-12 mb-0">
                        <strong>Cancellation Charges:</strong>
                        <span id="calculated_cancellation_charges_1"><?= general_currency_symbol . ' ' . number_format(($room_rate * $default_cancellation_percentage) / 100, 2); ?></span>
                    </div> */ ?>
                </div>

                <hr class="my-3">

                <!-- Final Confirmation Alert -->
                <div class="text-center">
                    <p class="fw-bold text-danger">
                        <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the room "<?= htmlspecialchars($room_title); ?>"? <br> This will incur a <span id="calculated_cancellation_charges_1"><?= general_currency_symbol . ' ' . number_format(($room_rate * $default_cancellation_percentage) / 100, 2); ?></span> cancellation fee.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="confirmCANCELROOM('<?= $confirmed_itinerary_plan_hotel_room_details_ID; ?>')" class="btn btn-danger">Confirm Cancellation</button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                updateCancellationCharges_1();
            });

            function updateCancellationCharges_1() {
                // Get the total cost (including room cost, GST, and service charges)
                const totalCost = parseFloat(document.getElementById('total_cancellation_services_amount_1').value) || 0;

                // Get the cancellation percentage input value
                let cancellationPercentage = parseFloat(document.getElementById('cancellation_percentage_1').value) || 0;

                // Ensure the cancellation percentage doesn't exceed 100%
                if (cancellationPercentage > 100) {
                    cancellationPercentage = 100; // Set to 100 if greater than 100
                    document.getElementById('cancellation_percentage_1').value = 100; // Update the input field
                }

                // Calculate the cancellation charges based on the percentage
                const cancellationCharges = (totalCost * cancellationPercentage) / 100;

                // Define a valid currency code (e.g., 'USD', 'INR', 'EUR')
                const currencyCode = "INR"; // Change this dynamically if needed

                // Use Intl.NumberFormat to format the price
                const formattedCancellationCharges = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(cancellationCharges);

                // Update the cancellation charges display
                document.getElementById('calculated_cancellation_charges_1').innerText = formattedCancellationCharges;

                // Calculate the total refund (total cost minus cancellation charges)
                const totalRefund = totalCost - cancellationCharges;

                // Format the total refund
                const formattedTotalRefund = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(totalRefund);

                // Update the total cancellation charges display
                document.getElementById('total_refund_1').innerText = formattedTotalRefund;
            }


            $('#cancellation_percentage_1').on('click', function() {
                $(this).select();
            });

            // Keyup validation for percentage field to limit input between 0 and 100
            $('#cancellation_percentage_1').on('keyup', function() {
                var value = $(this).val();
                // Ensure value is between 0 and 100
                if (value < 0) {
                    $(this).val(0);
                } else if (value > 100) {
                    $(this).val(100);
                }
            });

            function confirmCANCELROOM(confirmed_itinerary_plan_hotel_room_details_ID) {
                var cancellation_percentage = document.getElementById('cancellation_percentage_1').value;
                var defect_type = document.getElementById('defect_type').value;

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_hotel_room_cancellation",
                    data: {
                        _confirmed_itinerary_plan_hotel_room_details_ID: confirmed_itinerary_plan_hotel_room_details_ID,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showHOTELENTIREROOMCANCELFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');

                            showCANCELLATION_SUMMARY(response.itinerary_plan_id, response.itinerary_route_id, response.hotel_id);

                            if (response.response_entire_room_cancel_check) {
                                $('#response_entire_room_cancel_check_' + response.itinerary_plan_hotel_details_id).html('');
                                $('#response_add_room_cancel_check_' + response.itinerary_plan_hotel_details_id).html('');
                                $('#hotel_heading_' + response.itinerary_plan_hotel_details_id).html(response.response_according_header);
                                $('#response_entire_hotel_with_room_cancel_check_' + response.itinerary_plan_hotel_details_id).removeClass('d-none');
                                $('#individual_hotel_add_heading_' + response.itinerary_plan_hotel_details_id).removeClass('d-none');
                                $('#individual_hotel_remove_heading_' + response.itinerary_plan_hotel_details_id).addClass('d-none');
                            }

                            if (response.response_amenities_details) {
                                $('#response_amenities_details_' + response.itinerary_plan_hotel_details_id).html(response.response_amenities_details);
                            }

                            var htmlResponseKey = 'html_room_response_' + confirmed_itinerary_plan_hotel_room_details_ID;
                            if (response[htmlResponseKey]) {
                                $('#response_room_' + confirmed_itinerary_plan_hotel_room_details_ID).html(response[htmlResponseKey]);
                            }

                            // Loop through each cancelled room service ID and update the respective HTML content
                            response.cancl_room_serv_ID.forEach(function(cancelServID) {
                                var htmlResponseKey = 'html_response_' + cancelServID;
                                if (response[htmlResponseKey]) {
                                    $('#response_' + cancelServID).html(response[htmlResponseKey]);
                                }
                            });

                            // Loop through each cancelled room service ID and update the respective HTML content
                            response.cancl_room_amenities_details_ID.forEach(function(cancelROOMAMENITIES_DTLID) {
                                var htmlResponseKey = 'html_response_' + cancelROOMAMENITIES_DTLID;
                                if (response[htmlResponseKey]) {
                                    $('#response_' + cancelROOMAMENITIES_DTLID).html(response[htmlResponseKey]);
                                }
                            });

                        }
                    }
                });
            }

            function showCANCELLATION_SUMMARY(itinerary_plan_ID, itinerary_route_ID, hotel_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_hotel_cancellation_hotel_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _itinerary_route_ID: itinerary_route_ID,
                        _hotel_ID: hotel_ID
                    },
                    success: function(response) {
                        $('.show_cancellation_summary').html('');
                        $('.show_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php
    elseif ($_GET['type'] == 'confirm_hotel_room_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_confirmed_itinerary_plan_hotel_room_details_ID = $_POST['_confirmed_itinerary_plan_hotel_room_details_ID'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, HOTEL.`hotel_place`, HOTEL_CATEGORY.`hotel_category_title`, PLAN_HOTEL_DETAILS.`itinerary_route_location`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_id`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cost`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_gst_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_date`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_id`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_hotel_details_id`,ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id`,ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` FROM `dvi_confirmed_itinerary_plan_hotel_room_details` ITINEARY_HOTEL_ROOM_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` LEFT JOIN `dvi_hotel_category` HOTEL_CATEGORY ON HOTEL_CATEGORY.`hotel_category_id` = HOTEL.`hotel_category` WHERE ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' AND ITINEARY_HOTEL_ROOM_DETAILS.`status` = '1' AND ITINEARY_HOTEL_ROOM_DETAILS.`deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
                $itinerary_plan_id = $fetch_confirmed_itinerary_data['itinerary_plan_id'];
                $itinerary_route_id = $fetch_confirmed_itinerary_data['itinerary_route_id'];
                $itinerary_route_date = $fetch_confirmed_itinerary_data['itinerary_route_date'];
                $itinerary_plan_hotel_details_id = $fetch_confirmed_itinerary_data['itinerary_plan_hotel_details_id'];
                $confirmed_itinerary_plan_hotel_details_id = $fetch_confirmed_itinerary_data['confirmed_itinerary_plan_hotel_details_id'];
                $total_room_cost = $fetch_confirmed_itinerary_data['total_room_cost'];
                $total_room_gst_amount = $fetch_confirmed_itinerary_data['total_room_gst_amount'];
                $hotel_id = $fetch_confirmed_itinerary_data['hotel_id'];
                $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
                $hotel_place = $fetch_confirmed_itinerary_data['hotel_place'];
                $hotel_category_title = $fetch_confirmed_itinerary_data['hotel_category_title'];
                $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
            endwhile;

            $select_no_of_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            $total_no_of_rooms_confirmed = sqlNUMOFROW_LABEL($select_no_of_confirmed_itinerary_room_details);

            $select_no_of_remaining_non_cancelled_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `room_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            $total_no_of_non_cancelled_rooms_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_room_details);

            $total_room_cancellation_service_cost = ($total_room_cost + $total_room_gst_amount);
            $total_room_cancellation_charges = (($total_room_cancellation_service_cost * $_cancellation_percentage) / 100);
            $total_room_refund_amt = ($total_room_cancellation_service_cost - $total_room_cancellation_charges);

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $total_room_cancellation_service_cost + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_room_cancellation_charges + $existing_total_cancellation_charge;
                $total_refund_amount = $total_room_refund_amt + $existing_total_refund_amount;

                $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                endif;

                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_room_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                //CANCELLATION LOG
                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                endif;

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
                $cancelled_room_arrFields = array('`cancelled_itinerary_ID`', '`room_cancellation_status`', '`cancelled_on`', '`room_defect_type`', '`room_cancellation_percentage`', '`total_room_cancelled_service_amount`', '`total_room_cancellation_charge`', '`total_room_refund_amount`', '`createdby`', '`status`');
                $cancelled_room_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                $cancelled_room_sqlWhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' ";

                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $cancelled_room_arrFields, $cancelled_room_arrValues, $cancelled_room_sqlWhere)) :
                endif;

                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
                $confirmed_room_arrFields = array('`room_cancellation_status`', '`room_defect_type`');
                $confirmed_room_arrValues = array("1", "$_defect_type");

                $confirmed_room_sqlwhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' ";
                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $confirmed_room_arrFields, $confirmed_room_arrValues, $confirmed_room_sqlwhere)) :
                endif;

            else:

                $total_cancelled_service_amount = $total_room_cancellation_service_cost;
                $total_cancellation_charge = $total_room_cancellation_charges;
                $total_refund_amount = $total_room_refund_amt;

                //INSERT
                $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                    $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_room_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
                    $cancelled_room_arrFields = array('`cancelled_itinerary_ID`', '`room_cancellation_status`', '`cancelled_on`', '`room_defect_type`', '`room_cancellation_percentage`', '`total_room_cancelled_service_amount`', '`total_room_cancellation_charge`', '`total_room_refund_amount`', '`createdby`', '`status`');
                    $cancelled_room_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                    $cancelled_room_sqlWhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $cancelled_room_arrFields, $cancelled_room_arrValues, $cancelled_room_sqlWhere)) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
                    $confirmed_room_arrFields = array('`room_cancellation_status`', '`room_defect_type`');
                    $confirmed_room_arrValues = array("1", "$_defect_type");

                    $confirmed_room_sqlwhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' ";
                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $confirmed_room_arrFields, $confirmed_room_arrValues, $confirmed_room_sqlwhere)) :
                    endif;
                endif;
            endif;

            if ($total_no_of_non_cancelled_rooms_count == 1):
                $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`cancelled_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1' AND ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_status` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
                    while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                        $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                        $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];
                        $confirmed_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['confirmed_itinerary_plan_hotel_room_amenities_details_ID'];
                        $cancelled_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['cancelled_itinerary_plan_hotel_room_amenities_details_ID'];
                        $itinerary_plan_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_plan_id'];
                        $hotel_amenities_id = $fetch_itinerary_hotel_amenities_details_data['hotel_amenities_id'];

                        $total_amenities_cancellation_charge = (($amenitie_rate * $_cancellation_percentage) / 100);
                        $total_amenities_refund_amount = ($amenitie_rate - $total_amenities_cancellation_charge);

                        //CANCELLED ROUTE GUIDE SLOT DETAILS 
                        $cancelled_on = date('Y-m-d H:i:s');

                        //CANCELLATION MAIN TABLE
                        $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                        if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                            //UPDATE
                            while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                                $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                                $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                                $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                                $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                            endwhile;

                            $total_cancelled_service_amount = $amenitie_rate + $existing_total_cancelled_service_amount;
                            $total_cancellation_charge = $total_amenities_cancellation_charge + $existing_total_cancellation_charge;
                            $total_refund_amount = $total_amenities_refund_amount + $existing_total_refund_amount;

                            $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                            $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                            $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                            endif;

                            $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                            $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                            //CANCELLATION LOG
                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                            $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                            $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                            $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                            $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                            $confirmed_amenities_arrValues = array("1", "$_defect_type");

                            $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";
                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                            endif;

                        else:

                            $total_cancelled_service_amount = $amenitie_rate;
                            $total_cancellation_charge = $total_amenities_cancellation_charge;
                            $total_refund_amount = $total_amenities_refund_amount;

                            //INSERT
                            $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                            $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                                $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                                //CANCELLATION LOG
                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                                endif;

                                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                                $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                                $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                                $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                                //CANCELLATION LOG
                                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                                endif;

                                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                                $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                                $confirmed_amenities_arrValues = array("1", "$_defect_type");

                                $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                                //CANCELLATION LOG
                                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                                endif;

                            endif;
                        endif;

                        $response['cancl_room_amenities_details_ID'][] = $cancelled_itinerary_plan_hotel_room_amenities_details_ID;
                        $response['response_amenities_details_' . $confirmed_itinerary_plan_hotel_details_id] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Amenities Cancelled</span><button type="button" onclick="amenitiesCANCELLATIONDETAILS(' . $confirmed_itinerary_plan_hotel_details_id . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';

                        $response['html_response_' . $cancelled_itinerary_plan_hotel_room_amenities_details_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                            <!-- Left Side: Ticket Details -->
                            <div>
                                <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $amenities_title . ' (Cancelled)</p>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($amenitie_rate, 2) . '</small>
                                <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                            </div>
                            <!-- Right Side: Refunded Amount -->
                            <div class="text-center">
                                <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                                <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . '</p>
                            </div>
                        </div>';

                    endwhile;
                endif;
            endif;

            $response['itinerary_plan_id'] = $itinerary_plan_id;
            $response['itinerary_route_id'] = $itinerary_route_id;
            $response['hotel_id'] = $hotel_id;

            $response['html_room_response_' . $_confirmed_itinerary_plan_hotel_room_details_ID] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Room Cancelled</span><button type="button" onclick="roomCANCELLATIONDETAILS(' . $_confirmed_itinerary_plan_hotel_room_details_ID . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';

            $select_itinerary_room_service_cancellation_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_service_details_ID`, `confirmed_itinerary_plan_hotel_room_service_details_ID`, `room_service_type`, `total_room_service_rate` FROM `dvi_cancelled_itinerary_plan_hotel_room_service_details` WHERE `confirmed_itinerary_plan_hotel_room_details_ID` = '$_confirmed_itinerary_plan_hotel_room_details_ID' AND `service_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            $total_itineary_room_service_count = sqlNUMOFROW_LABEL($select_itinerary_room_service_cancellation_details);
            if ($total_itineary_room_service_count > 0):
                while ($fetch_confirmed_itinerary_room_service_data = sqlFETCHARRAY_LABEL($select_itinerary_room_service_cancellation_details)) :
                    $cancelled_itinerary_plan_hotel_room_service_details_ID = $fetch_confirmed_itinerary_room_service_data['cancelled_itinerary_plan_hotel_room_service_details_ID'];
                    $confirmed_itinerary_plan_hotel_room_service_details_ID = $fetch_confirmed_itinerary_room_service_data['confirmed_itinerary_plan_hotel_room_service_details_ID'];
                    $room_service_type = $fetch_confirmed_itinerary_room_service_data['room_service_type'];
                    $total_room_service_rate = $fetch_confirmed_itinerary_room_service_data['total_room_service_rate'];
                    $total_room_service_cancellation_charge = (($total_room_service_rate * $_cancellation_percentage) / 100);
                    $total_room_service_refund_amount = ($total_room_service_rate - $total_room_service_cancellation_charge);

                    $room_service_types = [
                        1 => ['label' => 'Extra Bed', 'field_name' => 'itinerary_room_extrabed_cancellation_status'],
                        2 => ['label' => 'Child Without Bed', 'field_name' => 'itinerary_room_childwithoutbed_cancellation_status'],
                        3 => ['label' => 'Child With Bed', 'field_name' => 'itinerary_room_childwithbed_cancellation_status'],
                        4 => ['label' => 'Breakfast', 'field_name' => 'itinerary_room_breakfast_cancellation_status'],
                        5 => ['label' => 'Lunch', 'field_name' => 'itinerary_room_lunch_cancellation_status'],
                        6 => ['label' => 'Dinner', 'field_name' => 'itinerary_room_dinner_cancellation_status']
                    ];

                    $room_service_type_field = $room_service_types[$room_service_type]['field_name'];
                    $room_service_type_label = $room_service_types[$room_service_type]['label'];

                    //CANCELLED ROUTE GUIDE SLOT DETAILS 
                    $cancelled_on = date('Y-m-d H:i:s');

                    //CANCELLATION MAIN TABLE
                    $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                    if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                        //UPDATE
                        while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                            $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                            $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                            $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                            $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                        endwhile;

                        $total_cancelled_service_amount = $total_room_service_rate + $existing_total_cancelled_service_amount;
                        $total_cancellation_charge = $total_room_service_cancellation_charge + $existing_total_cancellation_charge;
                        $total_refund_amount = $total_room_service_refund_amount + $existing_total_refund_amount;

                        $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                        $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                        $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                        endif;

                        $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                        //CANCELLATION LOG
                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                        $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                        $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                        $cancelled_room_service_sqlWhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type'  AND `service_cancellation_status` = '0'";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                        $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                        $confirmed_room_service_arrValues = array("1", "$_defect_type");

                        $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type' AND `service_cancellation_status` = '0'";
                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                        endif;

                    else:

                        $total_cancelled_service_amount = $total_room_service_rate;
                        $total_cancellation_charge = $total_room_service_cancellation_charge;
                        $total_refund_amount = $total_room_service_refund_amount;

                        //INSERT
                        $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                        $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                        if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                            $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                            $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                            $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                            //CANCELLATION LOG
                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                            $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                            $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                            $cancelled_room_service_sqlWhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type' AND `service_cancellation_status` = '0'";

                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                            $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                            $confirmed_room_service_arrValues = array("1", "$_defect_type");

                            $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `room_service_type` = '$room_service_type' AND `service_cancellation_status` = '0'";

                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                            endif;

                        endif;
                    endif;

                    $response['cancl_room_serv_ID'][] = $cancelled_itinerary_plan_hotel_room_service_details_ID;
                    $response['html_response_' . $cancelled_itinerary_plan_hotel_room_service_details_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                        <!-- Left Side: Ticket Details -->
                        <div>
                            <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $room_service_type_label . ' (Cancelled)</p>
                            <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                            <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                            <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_rate, 2) . '</small>
                            <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                        </div>
                        <!-- Right Side: Refunded Amount -->
                        <div class="text-center">
                            <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                            <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . '</p>
                        </div>
                    </div>';
                endwhile;
            endif;

            if ($total_no_of_non_cancelled_rooms_count == 1):
                $TOTAL_CANCELLATION_SERVICE_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_SERVICE_COST');
                $TOTAL_CANCELLATION_CHARGES_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_CHARGES_COST');
                $TOTAL_CANCELLATION_REFUND_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_REFUND_COST');

                $response['response_entire_room_cancel_check'] = true;
                $response['itinerary_plan_hotel_details_id'] = $confirmed_itinerary_plan_hotel_details_id;
                $response['response_according_header'] = '<button class="accordion-button bg-label-danger text-black collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hotel_details_' . $confirmed_itinerary_plan_hotel_details_id . '" aria-expanded="false" aria-controls="hotel_details_' . $confirmed_itinerary_plan_hotel_details_id . '" style="background-color: #ffffff;">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span><strong>' . date('D, M d, Y', strtotime($itinerary_route_date)) . '</strong> ' . '</span>
                                                    <div class="text-end">
                                                       <strong class="text-black">Refund Amount - ' . general_currency_symbol . ' ' . number_format(round($TOTAL_CANCELLATION_REFUND_COST), 2) . '</strong>
                                                    </div>
                                                </div>
                                            </button>';

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
                $cancelled_hotel_arrFields = array('`cancelled_itinerary_ID`', '`hotel_cancellation_status`', '`cancelled_on`', '`total_hotel_cancelled_service_amount`', '`total_hotel_cancellation_charge`', '`total_hotel_refund_amount`');
                $cancelled_hotel_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$TOTAL_CANCELLATION_SERVICE_COST", "$TOTAL_CANCELLATION_CHARGES_COST", "$TOTAL_CANCELLATION_REFUND_COST");

                $cancelled_hotel_sqlwhere = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";
                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $cancelled_hotel_arrFields, $cancelled_hotel_arrValues, $cancelled_hotel_sqlwhere)) :
                endif;

                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
                $confirmed_hotel_arrFields = array('`hotel_cancellation_status`');
                $confirmed_hotel_arrValues = array("1");

                $confirmed_hotel_sqlwhere = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";
                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $confirmed_hotel_arrFields, $confirmed_hotel_arrValues, $confirmed_hotel_sqlwhere)) :
                endif;
            endif;
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_room_cancellation_details_form'):

        $confirmed_itinerary_plan_hotel_room_details_ID = $_GET['confirmed_itinerary_plan_hotel_room_details_ID'];

        $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, HOTEL_ROOMS.`room_title`, ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_location`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cost`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_gst_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_date`, ITINEARY_HOTEL_ROOM_DETAILS.`cancelled_on`, ITINEARY_HOTEL_ROOM_DETAILS.`room_defect_type`, ITINEARY_HOTEL_ROOM_DETAILS.`room_cancellation_percentage`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cancelled_service_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cancellation_charge`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_refund_amount` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` ITINEARY_HOTEL_ROOM_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` LEFT JOIN `dvi_confirmed_itinerary_plan_hotel_details` ITINEARY_PLAN_HOTEL_DETAILS ON ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_hotel_details_id` LEFT JOIN `dvi_hotel_rooms` HOTEL_ROOMS ON HOTEL_ROOMS.`room_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`room_id` WHERE ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
            $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
            $room_title = $fetch_confirmed_itinerary_data['room_title'];
            $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
            $itinerary_route_date = $fetch_confirmed_itinerary_data['itinerary_route_date'];
            $total_room_cost = $fetch_confirmed_itinerary_data['total_room_cost'];
            $total_room_gst_amount = $fetch_confirmed_itinerary_data['total_room_gst_amount'];
            $cancelled_on = $fetch_confirmed_itinerary_data['cancelled_on'];
            $room_defect_type = $fetch_confirmed_itinerary_data['room_defect_type'];
            $room_cancellation_percentage = $fetch_confirmed_itinerary_data['room_cancellation_percentage'];
            $total_room_cancelled_service_amount = $fetch_confirmed_itinerary_data['total_room_cancelled_service_amount'];
            $total_room_cancellation_charge = $fetch_confirmed_itinerary_data['total_room_cancellation_charge'];
            $total_room_refund_amount = $fetch_confirmed_itinerary_data['total_room_refund_amount'];
        endwhile;
    ?>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Room Cancellation Summary</strong>
                </h5>
                <p class="mb-4 text-muted">
                    A detailed breakdown of the room cancellation charges, including services, <br> rates, cancellation fees, and total refunds.
                </p>
            </div>

            <!-- Room Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel / Room:</strong>
                    <span><?= htmlspecialchars($hotel_name); ?> / <?= htmlspecialchars($room_title); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Cancellation Details Table -->
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-responsive">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th class="text-start">Service</th>
                            <th class="text-end">Rate</th>
                            <th class="text-end">Cancellation Fee (%)</th>
                            <th class="text-end">Total Refund</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <span><?= $room_title; ?></span><br>
                                <span style="font-size: 0.8em; line-height: 1.2;">
                                    <span style="display: block; font-size: 0.9em;">Defect Type: <?= getCNCELLATION_DEFECT_TYPE($room_defect_type, 'label'); ?></span>
                                    <span style="display: block; font-size: 0.9em;">Cancl. On: <?= date('D M, Y \a\t h:i A', strtotime($cancelled_on)); ?></span>
                                </span>
                            </td>
                            <td class="text-end">
                                <?= general_currency_symbol . ' ' . number_format(($total_room_cost + $total_room_gst_amount), 2); ?>
                            </td>
                            <td class="text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($total_room_cancellation_charge, 2); ?></span><br>
                                <span style="font-size: 0.8em; line-height: 1.2;">
                                    <span style="display: block; font-size: 0.9em;">(Cancl.Perctange: <?= $room_cancellation_percentage; ?>%)</span>
                                </span>
                            </td>
                            <td class="text-end"><?= general_currency_symbol . ' ' . number_format($total_room_refund_amount, 2); ?></td>
                        </tr>
                        <?php
                        $select_cancelled_itinerary_room_service_details = sqlQUERY_LABEL("SELECT `room_service_type`, `total_room_service_rate`, `cancelled_on`, `room_service_defect_type`, `room_service_cancellation_percentage`, `total_cancelled_room_service_amount`, `total_room_service_cancellation_charge`, `total_room_service_refund_amount` FROM `dvi_cancelled_itinerary_plan_hotel_room_service_details` WHERE `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' AND `service_cancellation_status` = '1' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                        while ($fetch_cancelled_itinerary_room_service_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_room_service_details)) :
                            $room_service_type = $fetch_cancelled_itinerary_room_service_data['room_service_type'];
                            $total_room_service_rate = $fetch_cancelled_itinerary_room_service_data['total_room_service_rate'];
                            $room_service_defect_type = $fetch_cancelled_itinerary_room_service_data['room_service_defect_type'];
                            $room_service_cancellation_percentage = $fetch_cancelled_itinerary_room_service_data['room_service_cancellation_percentage'];
                            $total_cancelled_room_service_amount = $fetch_cancelled_itinerary_room_service_data['total_cancelled_room_service_amount'];
                            $total_room_service_cancellation_charge = $fetch_cancelled_itinerary_room_service_data['total_room_service_cancellation_charge'];
                            $total_room_service_refund_amount = $fetch_cancelled_itinerary_room_service_data['total_room_service_refund_amount'];
                            $overall_total_room_service_rate += $total_room_service_rate;
                            $overall_total_room_service_cancellation_charge += $total_room_service_cancellation_charge;
                            $overall_total_room_service_refund_amount += $total_room_service_refund_amount;

                            $room_service_types = [
                                1 => 'Extra Bed',
                                2 => 'Child Without Bed',
                                3 => 'Child With Bed',
                                4 => 'Breakfast',
                                5 => 'Lunch',
                                6 => 'Dinner'
                            ];
                        ?>
                            <tr>
                                <td>
                                    <span><?= $room_service_types[$room_service_type]; ?></span><br>
                                    <span style="font-size: 0.8em; line-height: 1.2;">
                                        <span style="display: block; font-size: 0.9em;">Defect Type: <?= getCNCELLATION_DEFECT_TYPE($room_service_defect_type, 'label'); ?></span>
                                        <span style="display: block; font-size: 0.9em;">Cancl. On: <?= date('D M, Y \a\t h:i A', strtotime($cancelled_on)); ?></span>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <?= general_currency_symbol . ' ' . number_format(($total_room_service_rate), 2); ?>
                                </td>
                                <td class="text-end">
                                    <span><?= general_currency_symbol . ' ' . number_format($total_room_service_cancellation_charge, 2); ?></span><br>
                                    <span style="font-size: 0.8em; line-height: 1.2;">
                                        <span style="display: block; font-size: 0.9em;">(Cancl.Perctange: <?= $room_service_cancellation_percentage; ?>%)</span>
                                    </span>
                                </td>
                                <td class="text-end"><?= general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2); ?></td>
                            </tr>
                        <?php endwhile; ?>
                    </tbody>
                </table>
            </div>

            <!-- Total Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="border p-3 rounded shadow-sm">
                        <h5 class="text-center">Total Cancellation Summary</h5>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Cancelled Service Cost:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($overall_total_room_service_rate + $total_room_cost + $total_room_gst_amount, 2); ?></span> <!-- Replace with total calculated amount -->
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Total Cancellation Fee:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($total_room_cancellation_charge + $overall_total_room_service_cancellation_charge, 2); ?></span> <!-- Replace with total calculated fee -->
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Total Refund:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span class="text-success"><strong><?= general_currency_symbol . ' ' . number_format($total_room_refund_amount + $overall_total_room_service_refund_amount, 2); ?></strong></span> <!-- Replace with final refund -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <?php
    elseif ($_GET['type'] == 'show_amenities_cancellation_details_form'):

        $confirmed_itinerary_plan_hotel_details_id = $_GET['itinerary_plan_hotel_details_id'];

        $select_itinerary_hotel_cancellation_data = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, PLAN_HOTEL_DETAILS.`itinerary_route_location`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_route_date` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_hotel_details_id` LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1' AND ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTEL_LIST:" . sqlERROR_LABEL());
        while ($fetch_itinerary_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_cancellation_data)) :
            $hotel_name = $fetch_itinerary_hotel_details_data['hotel_name'];
            $itinerary_route_date = $fetch_itinerary_hotel_details_data['itinerary_route_date'];
            $itinerary_route_location = $fetch_itinerary_hotel_details_data['itinerary_route_location'];
        endwhile;
    ?>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Amenities Cancellation Summary</strong>
                </h5>
                <p class="mb-4 text-muted">
                    A detailed breakdown of the amenities cancellation charges, including services, <br> rates, cancellation fees, and total refunds.
                </p>
            </div>

            <!-- Hotel Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel:</strong>
                    <span><?= htmlspecialchars($hotel_name); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Cancellation Details Table -->
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-responsive">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th class="text-start">Service</th>
                            <th class="text-end">Rate</th>
                            <th class="text-end">Cancellation Fee (%)</th>
                            <th class="text-end">Total Refund</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`cancelled_on`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_defect_type`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_percentage`, ITINEARY_PLAN_HOTEL_AMENITIES.`total_cancelled_amenitie_service_amount`, ITINEARY_PLAN_HOTEL_AMENITIES.`total_amenitie_cancellation_charge`, ITINEARY_PLAN_HOTEL_AMENITIES.`total_amenitie_refund_amount` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1' AND ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());
                        if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
                            while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                                $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                                $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];
                                $cancelled_on = $fetch_itinerary_hotel_amenities_details_data['cancelled_on'];
                                $amenitie_defect_type = $fetch_itinerary_hotel_amenities_details_data['amenitie_defect_type'];
                                $amenitie_cancellation_percentage = $fetch_itinerary_hotel_amenities_details_data['amenitie_cancellation_percentage'];
                                $total_cancelled_amenitie_service_amount = $fetch_itinerary_hotel_amenities_details_data['total_cancelled_amenitie_service_amount'];
                                $total_amenitie_cancellation_charge = $fetch_itinerary_hotel_amenities_details_data['total_amenitie_cancellation_charge'];
                                $total_amenitie_refund_amount = $fetch_itinerary_hotel_amenities_details_data['total_amenitie_refund_amount'];

                                $overall_total_cancelled_amenitie_service_amount += $total_cancelled_amenitie_service_amount;
                                $overall_total_amenitie_cancellation_charge += $total_amenitie_cancellation_charge;
                                $overall_total_amenitie_refund_amount += $total_amenitie_refund_amount;
                        ?>
                                <tr>
                                    <td>
                                        <span><?= $amenities_title; ?></span><br>
                                        <span style="font-size: 0.8em; line-height: 1.2;">
                                            <span style="display: block; font-size: 0.9em;">Defect Type: <?= getCNCELLATION_DEFECT_TYPE($amenitie_defect_type, 'label'); ?></span>
                                            <span style="display: block; font-size: 0.9em;">Cancl. On: <?= date('D M, Y \a\t h:i A', strtotime($cancelled_on)); ?></span>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <?= general_currency_symbol . ' ' . number_format(($total_cancelled_amenitie_service_amount), 2); ?>
                                    </td>
                                    <td class="text-end">
                                        <span><?= general_currency_symbol . ' ' . number_format($total_amenitie_cancellation_charge, 2); ?></span><br>
                                        <span style="font-size: 0.8em; line-height: 1.2;">
                                            <span style="display: block; font-size: 0.9em;">(Cancl.Perctange: <?= $amenitie_cancellation_percentage; ?>%)</span>
                                        </span>
                                    </td>
                                    <td class="text-end"><?= general_currency_symbol . ' ' . number_format($total_amenitie_refund_amount, 2); ?></td>
                                </tr>
                            <?php endwhile;
                        else: ?>
                            <tr>
                                <td>No more amenities found.</td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>

            <!-- Total Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="border p-3 rounded shadow-sm">
                        <h5 class="text-center">Total Cancellation Summary</h5>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Cancelled Service Cost:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($overall_total_cancelled_amenitie_service_amount, 2); ?></span> <!-- Replace with total calculated amount -->
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Total Cancellation Fee:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($overall_total_amenitie_cancellation_charge, 2); ?></span> <!-- Replace with total calculated fee -->
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Total Refund:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span class="text-success"><strong><?= general_currency_symbol . ' ' . number_format($overall_total_amenitie_refund_amount, 2); ?></strong></span> <!-- Replace with final refund -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <?php
    elseif ($_GET['type'] == 'show_entire_hotel_cancel_form'):

        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $itinerary_route_date = $_GET['itinerary_route_date'];
        $hotel_id = $_GET['hotel_id'];

        $select_itinerary_hotel_cancellation_data = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_location`, ROOM_DETAILS.`room_id`,ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_date`, ITINEARY_PLAN_HOTEL_DETAILS.`total_hotel_cost`, ITINEARY_PLAN_HOTEL_DETAILS.`total_hotel_tax_amount` FROM `dvi_confirmed_itinerary_plan_hotel_details` ITINEARY_PLAN_HOTEL_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_PLAN_HOTEL_DETAILS.`hotel_id` LEFT JOIN `dvi_confirmed_itinerary_plan_hotel_room_details` ROOM_DETAILS ON ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` WHERE ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_id` = '$itinerary_route_id' AND ITINEARY_PLAN_HOTEL_DETAILS.`hotel_id` = '$hotel_id' AND ITINEARY_PLAN_HOTEL_DETAILS.`status` = '1' AND ITINEARY_PLAN_HOTEL_DETAILS.`deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_HOTEL_LIST:" . sqlERROR_LABEL());
        while ($fetch_itinerary_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_cancellation_data)) :
            $hotel_name = $fetch_itinerary_hotel_details_data['hotel_name'];
            $room_id = $fetch_itinerary_hotel_details_data['room_id'];
            $itinerary_route_date = $fetch_itinerary_hotel_details_data['itinerary_route_date'];
            $itinerary_route_location = $fetch_itinerary_hotel_details_data['itinerary_route_location'];
            $total_hotel_cost = $fetch_itinerary_hotel_details_data['total_hotel_cost'];
            $total_hotel_tax_amount = $fetch_itinerary_hotel_details_data['total_hotel_tax_amount'];
        endwhile;

        $cancellation_percentage_value = $_GET['cancellation_percentage'];

    ?>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Hotel Cancellation Summary</strong>
                </h5>
                <p class="mb-4 text-muted">
                    A detailed breakdown of the Hotel cancellation charges, including all the services, <br> rates, cancellation fees, and total refunds.
                </p>
            </div>

            <!-- Hotel Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel:</strong>
                    <span><?= htmlspecialchars($hotel_name); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <form action="" data-parsley-validate method="post">
                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">
                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <strong><?= general_currency_symbol . ' ' . number_format(round($total_hotel_cost + $total_hotel_tax_amount), 2); ?></strong>
                        <input type="hidden" id="total_cancellation_services_amount_2" value="<?= round($total_hotel_cost + $total_hotel_tax_amount); ?>">
                    </div>

                    <!-- Cancellation Percentage and Defect Type -->
                    <div class="col-md-4 mt-3">
                        <label for="cancellation_percentage_2" class="form-label"><strong>Cancellation Percentage:</strong></label>
                        <input type="number" placeholder="Enter Percentage %" id="cancellation_percentage_2" class="form-control" value="<?= $cancellation_percentage_value; ?>" required min="0" max="100" oninput="updateCancellationCharges_2()">
                    </div>
                    <div class="col-md-4 mt-3">
                        <label for="defect_type" class="form-label"><strong>Defect Type:</strong></label>
                        <select id="defect_type" required class="form-select" onchange="updateCancellationCharges_2">
                            <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'select'); ?>
                        </select>
                    </div>
                    <div class="col-md-4 mt-3 text-end">
                        <label for="total_refund_2" class="form-label"><strong>Total Refund:</strong></label>
                        <div>
                            <h3 id="total_refund_2"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></h3>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- Cancellation Confirmation and Detailed Message -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-warning p-4 rounded">
                            <p class="mb-2">Please review all the details of your cancellation carefully before proceeding. This cancellation covers rooms, amenities, meal plans, extra beds, and child accommodations. A cancellation fee will apply, and any changes made will be reflected in the final charge. Ensure all listed items are accurate before confirming the cancellation.</p>
                        </div>
                    </div>
                </div>

                <!-- Final Confirmation Alert -->
                <div class="text-center">
                    <p class="fw-bold text-danger">
                        <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the hotel "<?= htmlspecialchars($hotel_name); ?>"? <br> This will incur a <span id="calculated_cancellation_charges_2"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></span> cancellation fee.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="confirm_ENTIREDAY_CANCEL_ROOMS('<?= $itinerary_plan_id; ?>','<?= $itinerary_route_id; ?>','<?= $itinerary_route_date; ?>','<?= $hotel_id; ?>','<?= $room_id; ?>')" class="btn btn-danger">Confirm Cancellation</button>
                    </div>
                </div>
            </form>
        </div>
        <script>
            $(document).ready(function() {
                updateCancellationCharges_2();
            });

            function updateCancellationCharges_2() {

                // Get the total cost (including room cost, GST, and service charges)
                const totalCost = parseFloat(document.getElementById('total_cancellation_services_amount_2').value) || 0;

                // Get the cancellation percentage input value
                let cancellationPercentage = parseFloat(document.getElementById('cancellation_percentage_2').value) || 0;

                // Ensure the cancellation percentage doesn't exceed 100%
                if (cancellationPercentage > 100) {
                    cancellationPercentage = 100; // Set to 100 if greater than 100
                    document.getElementById('cancellation_percentage_2').value = 100; // Update the input field
                }

                // Calculate the cancellation charges based on the percentage
                const cancellationCharges = (totalCost * cancellationPercentage) / 100;

                // Define a valid currency code (e.g., 'USD', 'INR', 'EUR')
                const currencyCode = "INR"; // Change this dynamically if needed

                // Use Intl.NumberFormat to format the price
                const formattedCancellationCharges = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(cancellationCharges);

                // Update the cancellation charges display
                document.getElementById('calculated_cancellation_charges_2').innerText = formattedCancellationCharges;

                // Calculate the total refund (total cost minus cancellation charges)
                const totalRefund = totalCost - cancellationCharges;

                // Format the total refund
                const formattedTotalRefund = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(totalRefund);

                // Update the total cancellation charges display
                document.getElementById('total_refund_2').innerText = formattedTotalRefund;
            }


            $('#cancellation_percentage_2').on('click', function() {
                $(this).select();
            });

            // Keyup validation for percentage field to limit input between 0 and 100
            $('#cancellation_percentage_2').on('keyup', function() {
                var value = $(this).val();
                // Ensure value is between 0 and 100
                if (value < 0) {
                    $(this).val(0);
                } else if (value > 100) {
                    $(this).val(100);
                }
            });

            function confirm_ENTIREDAY_CANCEL_ROOMS(itinerary_plan_id, itinerary_route_id, itinerary_route_date, hotel_id, room_id) {
                var cancellation_percentage = document.getElementById('cancellation_percentage_2').value;
                var defect_type = document.getElementById('defect_type').value;

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_hotel_entire_room_cancellation",
                    data: {
                        _itinerary_plan_id: itinerary_plan_id,
                        _itinerary_route_id: itinerary_route_id,
                        _itinerary_route_date: itinerary_route_date,
                        _hotel_id: hotel_id,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                        _room_id: room_id,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showHOTELENTIREDAYCANCELFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');

                            setTimeout(() => {
                                    location.reload();
                                }, 2000);

                            // showCANCELLATION_SUMMARY(response.itinerary_plan_id, response.itinerary_route_id, response.hotel_id);

                            // if (response.response_entire_room_cancel_check) {
                            //     $('#response_entire_room_cancel_check_' + response.itinerary_plan_hotel_details_id).html('');
                            //     $('#response_add_room_cancel_check_' + response.itinerary_plan_hotel_details_id).html('');
                            //     $('#hotel_heading_' + response.itinerary_plan_hotel_details_id).html(response.response_according_header);
                            //     $('#response_entire_hotel_with_room_cancel_check_' + response.itinerary_plan_hotel_details_id).removeClass('d-none');
                            //     $('#individual_hotel_add_heading_' + response.itinerary_plan_hotel_details_id).removeClass('d-none');
                            //     $('#individual_hotel_remove_heading_' + response.itinerary_plan_hotel_details_id).addClass('d-none');
                            // }

                            // if (response.response_amenities_details) {
                            //     $('#response_amenities_details_' + response.itinerary_plan_hotel_details_id).html(response.response_amenities_details);
                            // }

                            // // Loop through each cancelled room service ID and update the respective HTML content
                            // response.cnf_room_detail_ID.forEach(function(cnfROOMDTLID) {
                            //     var htmlResponseKey = 'html_room_response_' + cnfROOMDTLID;
                            //     if (response[htmlResponseKey]) {
                            //         $('#response_room_' + cnfROOMDTLID).html(response[htmlResponseKey]);
                            //     }
                            // });

                            // // Loop through each cancelled room service ID and update the respective HTML content
                            // response.cancl_room_serv_ID.forEach(function(cancelServID) {
                            //     var htmlResponseKey = 'html_response_' + cancelServID;
                            //     if (response[htmlResponseKey]) {
                            //         $('#response_' + cancelServID).html(response[htmlResponseKey]);
                            //     }
                            // });

                            // // Loop through each cancelled room service ID and update the respective HTML content
                            // response.cancl_room_amenities_details_ID.forEach(function(cancelAMENITIES_DTLID) {
                            //     var htmlResponseKey = 'html_amenities_response_' + cancelAMENITIES_DTLID;
                            //     if (response[htmlResponseKey]) {
                            //         $('#response_' + cancelAMENITIES_DTLID).html(response[htmlResponseKey]);
                            //     }
                            // });

                            $('.modal-backdrop').remove();

                        }
                    }
                });
            }

            function showCANCELLATION_SUMMARY(itinerary_plan_ID, itinerary_route_ID, hotel_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_hotel_cancellation_hotel_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _itinerary_route_ID: itinerary_route_ID,
                        _hotel_ID: hotel_ID
                    },
                    success: function(response) {
                        $('.show_cancellation_summary').html('');
                        $('.show_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php
    elseif ($_GET['type'] == 'confirm_hotel_entire_room_cancellation'):
        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_itinerary_plan_id = $_POST['_itinerary_plan_id'];
        $_itinerary_route_id = $_POST['_itinerary_route_id'];
        $_itinerary_route_date = $_POST['_itinerary_route_date'];
        $_hotel_id = $_POST['_hotel_id'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];
        $_room_id = $_POST['_room_id'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROOM SERVICES DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            //ROOM SERVICES CANCELLATION
            $select_itinerary_room_service_cancellation_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_service_details_ID`, `confirmed_itinerary_plan_hotel_room_service_details_ID`, `itinerary_plan_id`, `itinerary_route_id`, `hotel_id`, `room_service_type`, `total_room_service_rate` FROM `dvi_cancelled_itinerary_plan_hotel_room_service_details` WHERE `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND `service_cancellation_status` = '0' AND `deleted` = '0' AND `status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_itinerary_room_service_cancellation_details) > 0) :
                while ($fetch_itinerary_room_service_details_data = sqlFETCHARRAY_LABEL($select_itinerary_room_service_cancellation_details)) :
                    $cancelled_itinerary_plan_hotel_room_service_details_ID = $fetch_itinerary_room_service_details_data['cancelled_itinerary_plan_hotel_room_service_details_ID'];
                    $confirmed_itinerary_plan_hotel_room_service_details_ID = $fetch_itinerary_room_service_details_data['confirmed_itinerary_plan_hotel_room_service_details_ID'];
                    $itinerary_plan_id = $fetch_itinerary_room_service_details_data['itinerary_plan_id'];
                    $itinerary_route_id = $fetch_itinerary_room_service_details_data['itinerary_route_id'];
                    $hotel_id = $fetch_itinerary_room_service_details_data['hotel_id'];
                    $total_room_service_rate = $fetch_itinerary_room_service_details_data['total_room_service_rate'];
                    $room_service_type = $fetch_itinerary_room_service_details_data['room_service_type'];

                    $total_room_service_cancellation_charge = (($total_room_service_rate * $_cancellation_percentage) / 100);
                    $total_room_service_refund_amount = ($total_room_service_rate - $total_room_service_cancellation_charge);

                    $room_service_types = [
                        1 => ['label' => 'Extra Bed', 'field_name' => 'itinerary_room_extrabed_cancellation_status'],
                        2 => ['label' => 'Child Without Bed', 'field_name' => 'itinerary_room_childwithoutbed_cancellation_status'],
                        3 => ['label' => 'Child With Bed', 'field_name' => 'itinerary_room_childwithbed_cancellation_status'],
                        4 => ['label' => 'Breakfast', 'field_name' => 'itinerary_room_breakfast_cancellation_status'],
                        5 => ['label' => 'Lunch', 'field_name' => 'itinerary_room_lunch_cancellation_status'],
                        6 => ['label' => 'Dinner', 'field_name' => 'itinerary_room_dinner_cancellation_status']
                    ];

                    $room_service_type_field = $room_service_types[$room_service_type]['field_name'];
                    $room_service_type_label = $room_service_types[$room_service_type]['label'];

                    if (!empty($errors)) : // If there are validation errors
                        $response['success'] = false;
                        $response['errors'] = $errors;
                    else : // If validation is successful
                        $response['success'] = true;

                        //CANCELLATION MAIN TABLE
                        $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                        if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                            //UPDATE
                            while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                                $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                                $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                                $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                                $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                            endwhile;

                            $total_cancelled_service_amount = $total_room_service_rate + $existing_total_cancelled_service_amount;
                            $total_cancellation_charge = $total_room_service_cancellation_charge + $existing_total_cancellation_charge;
                            $total_refund_amount = $total_room_service_refund_amount + $existing_total_refund_amount;

                            $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                            $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                            $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                            endif;

                            $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                            $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                            //CANCELLATION LOG
                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                            $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                            $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                            $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_hotel_room_service_details_ID` = '$cancelled_itinerary_plan_hotel_room_service_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND  `room_service_type` = '$room_service_type' ";

                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                            endif;

                            //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                            $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                            $confirmed_room_service_arrValues = array("1", "$_defect_type");

                            $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND `room_service_type` = '$room_service_type' ";
                            //CANCELLATION LOG
                            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                            endif;

                        else:

                            $total_cancelled_service_amount = $total_room_service_rate;
                            $total_cancellation_charge = $total_room_service_cancellation_charge;
                            $total_refund_amount = $total_room_service_refund_amount;

                            //INSERT
                            $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                            $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                                $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', "`$room_service_type_field`", '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                                //CANCELLATION LOG
                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                                endif;

                                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                                $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`service_cancellation_status`', '`cancelled_on`', '`room_service_defect_type`', '`room_service_cancellation_percentage`', '`total_cancelled_room_service_amount`', '`total_room_service_cancellation_charge`', '`total_room_service_refund_amount`', '`createdby`', '`status`');
                                $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$total_room_service_rate", "$total_room_service_cancellation_charge", "$total_room_service_refund_amount", "$logged_user_id", "1");

                                $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_hotel_room_service_details_ID` = '$cancelled_itinerary_plan_hotel_room_service_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND  `room_service_type` = '$room_service_type' ";

                                //CANCELLATION LOG
                                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                                endif;

                                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                                $confirmed_room_service_arrFields = array('`service_cancellation_status`', '`room_service_defect_type`');
                                $confirmed_room_service_arrValues = array("1", "$_defect_type");

                                $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_hotel_room_service_details_ID` = '$confirmed_itinerary_plan_hotel_room_service_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND  `room_service_type` = '$room_service_type' ";

                                //CANCELLATION LOG
                                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                                endif;

                            endif;
                        endif;

                        $response['itinerary_plan_id'] = $_itinerary_plan_id;
                        $response['itinerary_route_id'] = $_itinerary_route_id;
                        $response['hotel_id'] = $_hotel_id;

                        $response['cancl_room_serv_ID'][] = $cancelled_itinerary_plan_hotel_room_service_details_ID;
                        $response['html_response_' . $cancelled_itinerary_plan_hotel_room_service_details_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                            <!-- Left Side: Ticket Details -->
                            <div>
                                <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $room_service_type_label . ' (Cancelled)</p>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                                <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_rate, 2) . '</small>
                                <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                            </div>
                            <!-- Right Side: Refunded Amount -->
                            <div class="text-center">
                                <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                                <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_room_service_refund_amount, 2) . '</p>
                            </div>
                        </div>';

                    endif;
                endwhile;
            endif;
        endif;

        //AMENITIES CANCELLATION DETAILS
        $select_itinerary_hotel_amenities_cancellation_details = sqlQUERY_LABEL("SELECT ITINEARY_PLAN_HOTEL_AMENITIES.`cancelled_itinerary_plan_hotel_room_amenities_details_ID`, HOTEL_AMENITIES.`amenities_title`, ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_rate`, ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_room_amenities_details_ID`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_route_id`,ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_id`, ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` FROM `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_PLAN_HOTEL_AMENITIES LEFT JOIN `dvi_hotel_amenities` HOTEL_AMENITIES ON HOTEL_AMENITIES.`hotel_amenities_id` = ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_amenities_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_PLAN_HOTEL_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` WHERE ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_plan_id` = '$_itinerary_plan_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`itinerary_route_id` = '$_itinerary_route_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`hotel_id` = '$_hotel_id' AND ITINEARY_PLAN_HOTEL_AMENITIES.`amenitie_cancellation_status` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`deleted` = '0' AND ITINEARY_PLAN_HOTEL_AMENITIES.`status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_AMENITIES_LIST:" . sqlERROR_LABEL());
        if (sqlNUMOFROW_LABEL($select_itinerary_hotel_amenities_cancellation_details) > 0) :
            while ($fetch_itinerary_hotel_amenities_details_data = sqlFETCHARRAY_LABEL($select_itinerary_hotel_amenities_cancellation_details)) :
                $cancelled_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['cancelled_itinerary_plan_hotel_room_amenities_details_ID'];
                $amenities_title = $fetch_itinerary_hotel_amenities_details_data['amenities_title'];
                $amenitie_rate = $fetch_itinerary_hotel_amenities_details_data['amenitie_rate'];
                $confirmed_itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_hotel_amenities_details_data['confirmed_itinerary_plan_hotel_room_amenities_details_ID'];
                $confirmed_itinerary_plan_hotel_details_id = $fetch_itinerary_hotel_amenities_details_data['confirmed_itinerary_plan_hotel_details_id'];
                $itinerary_plan_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_plan_id'];
                $hotel_amenities_id = $fetch_itinerary_hotel_amenities_details_data['hotel_amenities_id'];
                $itinerary_route_id = $fetch_itinerary_hotel_amenities_details_data['itinerary_route_id'];
                $hotel_id = $fetch_itinerary_hotel_amenities_details_data['hotel_id'];

                $total_amenities_cancellation_charge = (($amenitie_rate * $_cancellation_percentage) / 100);
                $total_amenities_refund_amount = ($amenitie_rate - $total_amenities_cancellation_charge);

                //CANCELLED ROUTE GUIDE SLOT DETAILS 
                $cancelled_on = date('Y-m-d H:i:s');

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $amenitie_rate + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_amenities_cancellation_charge + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_amenities_refund_amount + $existing_total_refund_amount;

                    $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                    endif;

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                    $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                    $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                    $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                    $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                    $confirmed_amenities_arrValues = array("1", "$_defect_type");

                    $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";
                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                    endif;

                else:

                    $total_cancelled_service_amount = $amenitie_rate;
                    $total_cancellation_charge = $total_amenities_cancellation_charge;
                    $total_refund_amount = $total_amenities_refund_amount;

                    //INSERT
                    $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                    $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_hotel_amenities_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                        //CANCELLATION LOG
                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL AMENITIES DETAILS TABLE
                        $cancelled_amenities_arrFields = array('`cancelled_itinerary_ID`', '`amenitie_cancellation_status`', '`cancelled_on`', '`amenitie_defect_type`', '`amenitie_cancellation_percentage`', '`total_cancelled_amenitie_service_amount`', '`total_amenitie_cancellation_charge`', '`total_amenitie_refund_amount`', '`createdby`', '`status`');
                        $cancelled_amenities_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$amenitie_rate", "$total_amenities_cancellation_charge", "$total_amenities_refund_amount", "$logged_user_id", "1");

                        $cancelled_amenities_sqlWhere = " `cancelled_itinerary_plan_hotel_room_amenities_details_ID` = '$cancelled_itinerary_plan_hotel_room_amenities_details_ID' AND `itinerary_plan_id` = '$_itinerary_plan_id' AND `itinerary_route_id` = '$_itinerary_route_id' AND `hotel_id` = '$_hotel_id' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, $cancelled_amenities_sqlWhere)) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL AMENITIES DETAILS TABLE
                        $confirmed_amenities_arrFields = array('`amenitie_cancellation_status`', '`amenitie_defect_type`');
                        $confirmed_amenities_arrValues = array("1", "$_defect_type");

                        $confirmed_amenities_sqlwhere = " `confirmed_itinerary_plan_hotel_room_amenities_details_ID` = '$confirmed_itinerary_plan_hotel_room_amenities_details_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $confirmed_amenities_arrFields, $confirmed_amenities_arrValues, $confirmed_amenities_sqlwhere)) :
                        endif;

                    endif;
                endif;

                $response['itinerary_plan_id'] = $_itinerary_plan_id;
                $response['itinerary_route_id'] = $_itinerary_route_id;
                $response['hotel_id'] = $_hotel_id;

                $response['response_amenities_details_' . $confirmed_itinerary_plan_hotel_details_id] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Amenities Cancelled</span><button type="button" onclick="amenitiesCANCELLATIONDETAILS(' . $confirmed_itinerary_plan_hotel_details_id . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';

                $response['cancl_room_amenities_details_ID'][] = $cancelled_itinerary_plan_hotel_room_amenities_details_ID;
                $response['html_amenities_response_' . $cancelled_itinerary_plan_hotel_room_amenities_details_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                    <div>
                        <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $amenities_title . ' (Cancelled)</p>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                        <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($amenitie_rate, 2) . '</small>
                        <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                    </div>
                    <!-- Right Side: Refunded Amount -->
                    <div class="text-center">
                        <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                        <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_amenities_refund_amount, 2) . '</p>
                    </div>
                </div>';

            endwhile;
        endif;

        $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, HOTEL.`hotel_place`, HOTEL_CATEGORY.`hotel_category_title`, PLAN_HOTEL_DETAILS.`itinerary_route_location`,PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID`, ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_room_details_ID`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_id`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cost`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_gst_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_date`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_id`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_hotel_details_id`, ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id`, ROOM_TYPE.`room_type_title`, ITINEARY_HOTEL_ROOM_DETAILS.`room_qty` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` ITINEARY_HOTEL_ROOM_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_details` PLAN_HOTEL_DETAILS ON PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` LEFT JOIN `dvi_hotel_category` HOTEL_CATEGORY ON HOTEL_CATEGORY.`hotel_category_id` = HOTEL.`hotel_category` LEFT JOIN `dvi_hotel_roomtype` ROOM_TYPE ON ITINEARY_HOTEL_ROOM_DETAILS.`room_type_id` = ROOM_TYPE.`room_type_id` WHERE ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_id` = '$_itinerary_plan_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_id` = '$_itinerary_route_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` = '$_hotel_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`room_cancellation_status` = '0' AND ITINEARY_HOTEL_ROOM_DETAILS.`status` = '1' AND ITINEARY_HOTEL_ROOM_DETAILS.`deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_rooms = sqlNUMOFROW_LABEL($select_confirmed_itinerary_room_details);
        if ($total_no_of_rooms > 0):
            while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
                $confirmed_itinerary_plan_hotel_room_details_ID = $fetch_confirmed_itinerary_data['confirmed_itinerary_plan_hotel_room_details_ID'];
                $itinerary_plan_id = $fetch_confirmed_itinerary_data['itinerary_plan_id'];
                $itinerary_route_id = $fetch_confirmed_itinerary_data['itinerary_route_id'];
                $itinerary_route_date = $fetch_confirmed_itinerary_data['itinerary_route_date'];
                $itinerary_plan_hotel_details_id = $fetch_confirmed_itinerary_data['itinerary_plan_hotel_details_id'];
                $confirmed_itinerary_plan_hotel_details_ID = $fetch_confirmed_itinerary_data['confirmed_itinerary_plan_hotel_details_ID'];
                $total_room_cost = $fetch_confirmed_itinerary_data['total_room_cost'];
                $total_room_gst_amount = $fetch_confirmed_itinerary_data['total_room_gst_amount'];
                $hotel_id = $fetch_confirmed_itinerary_data['hotel_id'];
                $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
                $hotel_place = $fetch_confirmed_itinerary_data['hotel_place'];
                $hotel_category_title = $fetch_confirmed_itinerary_data['hotel_category_title'];
                $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
                $room_type_title = $fetch_confirmed_itinerary_data['room_type_title'];
                $room_qty = $fetch_confirmed_itinerary_data['room_qty'];

                $select_no_of_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                $total_no_of_rooms_confirmed = sqlNUMOFROW_LABEL($select_no_of_confirmed_itinerary_room_details);

                $select_no_of_remaining_non_cancelled_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `room_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                $total_no_of_non_cancelled_rooms_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_room_details);

                $total_room_cancellation_service_cost = ($total_room_cost + $total_room_gst_amount);
                $total_room_cancellation_charges = (($total_room_cancellation_service_cost * $_cancellation_percentage) / 100);
                $total_room_refund_amt = ($total_room_cancellation_service_cost - $total_room_cancellation_charges);

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $total_room_cancellation_service_cost + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_room_cancellation_charges + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_room_refund_amt + $existing_total_refund_amount;

                    $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                    endif;

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_room_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
                    $cancelled_room_arrFields = array('`cancelled_itinerary_ID`', '`room_cancellation_status`', '`cancelled_on`', '`room_defect_type`', '`room_cancellation_percentage`', '`total_room_cancelled_service_amount`', '`total_room_cancellation_charge`', '`total_room_refund_amount`', '`createdby`', '`status`');
                    $cancelled_room_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                    $cancelled_room_sqlWhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $cancelled_room_arrFields, $cancelled_room_arrValues, $cancelled_room_sqlWhere)) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
                    $confirmed_room_arrFields = array('`room_cancellation_status`', '`room_defect_type`');
                    $confirmed_room_arrValues = array("1", "$_defect_type");

                    $confirmed_room_sqlwhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";
                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $confirmed_room_arrFields, $confirmed_room_arrValues, $confirmed_room_sqlwhere)) :
                    endif;

                else:

                    $total_cancelled_service_amount = $total_room_cancellation_service_cost;
                    $total_cancellation_charge = $total_room_cancellation_charges;
                    $total_refund_amount = $total_room_refund_amt;

                    //INSERT
                    $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                    $cancelled_itineraries_arrValues = array("$itinerary_plan_id", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_room_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                        //CANCELLATION LOG
                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
                        $cancelled_room_arrFields = array('`cancelled_itinerary_ID`', '`room_cancellation_status`', '`cancelled_on`', '`room_defect_type`', '`room_cancellation_percentage`', '`total_room_cancelled_service_amount`', '`total_room_cancellation_charge`', '`total_room_refund_amount`', '`createdby`', '`status`');
                        $cancelled_room_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_room_cancellation_service_cost", "$total_room_cancellation_charges", "$total_room_refund_amt", "$logged_user_id", "1");

                        $cancelled_room_sqlWhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $cancelled_room_arrFields, $cancelled_room_arrValues, $cancelled_room_sqlWhere)) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
                        $confirmed_room_arrFields = array('`room_cancellation_status`', '`room_defect_type`');
                        $confirmed_room_arrValues = array("1", "$_defect_type");

                        $confirmed_room_sqlwhere = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";
                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $confirmed_room_arrFields, $confirmed_room_arrValues, $confirmed_room_sqlwhere)) :
                        endif;
                    endif;
                endif;
                $response['cnf_room_detail_ID'][] = $confirmed_itinerary_plan_hotel_room_details_ID;
                $response['html_room_response_' . $confirmed_itinerary_plan_hotel_room_details_ID] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Room Cancelled</span><button type="button" onclick="roomCANCELLATIONDETAILS(' . $confirmed_itinerary_plan_hotel_room_details_ID . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';
            endwhile;

            $TOTAL_CANCELLATION_SERVICE_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_SERVICE_COST');
            $TOTAL_CANCELLATION_CHARGES_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_CHARGES_COST');
            $TOTAL_CANCELLATION_REFUND_COST = get_ITINEARY_HOTEL_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_id, 'TOTAL_CANCELLATION_REFUND_COST');

            $confirmed_itinerary_plan_hotel_details_id = getCONFIRMED_ITINERARY_PLAN_DETAILS($_itinerary_plan_id, $_itinerary_route_id, 'get_confirmed_itinerary_hotel_details_id');

            $response['response_entire_room_cancel_check'] = true;
            $response['itinerary_plan_hotel_details_id'] = $confirmed_itinerary_plan_hotel_details_id;
            $response['response_according_header'] = '<button class="accordion-button bg-label-danger text-black collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hotel_details_' . $confirmed_itinerary_plan_hotel_details_id . '" aria-expanded="false" aria-controls="hotel_details_' . $confirmed_itinerary_plan_hotel_details_id . '" style="background-color: #ffffff;">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span><strong>' . date('D, M d, Y', strtotime($itinerary_route_date)) . '</strong> ' . '</span>
                                                    <div class="text-end">
                                                        <strong class="text-black">Refund Amount - ' . general_currency_symbol . ' ' . number_format(round($TOTAL_CANCELLATION_REFUND_COST), 2) . '</strong>
                                                    </div>
                                                </div>
                                            </button>';

            //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM DETAILS TABLE
            $cancelled_hotel_arrFields = array('`cancelled_itinerary_ID`', '`hotel_cancellation_status`', '`cancelled_on`', '`total_hotel_cancelled_service_amount`', '`total_hotel_cancellation_charge`', '`total_hotel_refund_amount`');
            $cancelled_hotel_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$TOTAL_CANCELLATION_SERVICE_COST", "$TOTAL_CANCELLATION_CHARGES_COST", "$TOTAL_CANCELLATION_REFUND_COST");

            $cancelled_hotel_sqlwhere = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";
            //CANCELLATION LOG
            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $cancelled_hotel_arrFields, $cancelled_hotel_arrValues, $cancelled_hotel_sqlwhere)) :
            endif;

            //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY HOTEL ROOM DETAILS TABLE
            $confirmed_hotel_arrFields = array('`hotel_cancellation_status`');
            $confirmed_hotel_arrValues = array("1");

            $confirmed_hotel_sqlwhere = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";
            //CANCELLATION LOG
            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $confirmed_hotel_arrFields, $confirmed_hotel_arrValues, $confirmed_hotel_sqlwhere)) :
            endif;

        endif;
        //CALL ITINERARY PLAN CANCELLATION FUNCTION
        cancel_EntireItineraryPlan($_itinerary_plan_id);

        // Assign values to global variables
        $_SESSION['global_itinerary_plan_ID'] = $_itinerary_plan_id;
        $_SESSION['global_itinerary_route_id'] = $_itinerary_route_id;
        $_SESSION['global_itinerary_route_date'] = $_itinerary_route_date;
        $_SESSION['global_hotel_id'] = $hotel_id;
        $_SESSION['global_room_id'] = $_room_id;
        $_SESSION['global_room_type_title'] = $room_type_title;
        $_SESSION['global_room_qty'] = $room_qty;

        // Include the email notification script
        include('ajax_itinerary_hotel_cancellation_email_notification.php');

        // Unset the global variables
        unset($_SESSION['global_itinerary_plan_ID']);
        unset($_SESSION['global_itinerary_route_id']);
        unset($_SESSION['global_itinerary_route_date']);
        unset($_SESSION['global_hotel_id']);
        unset($_SESSION['global_room_id']);
        unset($_SESSION['global_room_type_title']);
        unset($_SESSION['global_room_qty']);

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_vehicle_cancel_form'):

        $confirmed_itinerary_plan_vendor_eligible_ID = $_GET['confirmed_itinerary_plan_vendor_eligible_ID'];
        $cancellation_percentage = $_GET['cancellation_percentage'];
        $defect_type = $_GET['defect_type'];

        $select_itinerary_vendor_vehicle_cancellation_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id`,ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_vehicle_type_id`,ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id`, VEHICLE_TYPE.`vehicle_type_title`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total` FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_VENDOR_VEHICLE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_vendor_vehicle_cancellation_details) > 0) :
            while ($fetch_itinerary_vendor_vehicle_details_data = sqlFETCHARRAY_LABEL($select_itinerary_vendor_vehicle_cancellation_details)) :
                $vendor_name = $fetch_itinerary_vendor_vehicle_details_data['vendor_name'];
                $vendor_branch_name = $fetch_itinerary_vendor_vehicle_details_data['vendor_branch_name'];
                $itinerary_plan_id = $fetch_itinerary_vendor_vehicle_details_data['itinerary_plan_id'];
                $vendor_vehicle_type_id = $fetch_itinerary_vendor_vehicle_details_data['vendor_vehicle_type_id'];
                $vendor_id = $fetch_itinerary_vendor_vehicle_details_data['vendor_id'];
                $vehicle_type_id = $fetch_itinerary_vendor_vehicle_details_data['vehicle_type_id'];
                $vehicle_type_title = $fetch_itinerary_vendor_vehicle_details_data['vehicle_type_title'];
                $total_vehicle_qty = $fetch_itinerary_vendor_vehicle_details_data['total_vehicle_qty'];
                $vehicle_grand_total = round($fetch_itinerary_vendor_vehicle_details_data['vehicle_grand_total']);
                $total_vehicle_rate_amt = general_currency_symbol . ' ' . number_format($vehicle_grand_total, 2);
            endwhile;
        endif;
    ?>
        <div class="modal-body">
            <div class="text-center">
                <!-- Title with Primary Color for Emphasis -->
                <h5 class="mt-4 mb-3 text-primary">
                    <span class="text-primary"><strong>Cancel "<?= $vehicle_type_title; ?>"?</strong></span>
                </h5>
                <p class="mb-4">You are about to cancel the <?= $vehicle_type_title; ?> from the booking.<br> This action cannot be undone.</p>
            </div>

            <!-- Step 1: Booking Details (Clear and Focused) -->
            <div class="row">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Vendor Name / Branch Name :</strong>
                    <span class="fw-bold"><?= $vendor_name . ' / ' . $vendor_branch_name; ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Vehicle Type:</strong>
                    <span class="fw-bold"><?= $vehicle_type_title; ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong class="text-dark">Vehicle Qty:</strong>
                    <span class="fw-bold"><?= $total_vehicle_qty; ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 2: Cancellation Summary (Grouped Breakdown) -->
            <div class="row">
                <div class="col-6 mb-3">
                    <strong>Original Cost :</strong> <?= $total_vehicle_rate_amt; ?>
                </div>
                <div class="col-6 mb-3">
                    <strong>Cancellation Percentage :</strong> <?= $cancellation_percentage; ?>%
                </div>
                <div class="col-6 mb-0">
                    <strong>Defect Type :</strong> <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'label'); ?>
                </div>
                <div class="col-6 mb-0">
                    <strong>Cancellation Fee :</strong> <?= general_currency_symbol . ' ' . number_format(($vehicle_grand_total * $cancellation_percentage) / 100, 2); ?>
                </div>
            </div>

            <hr class="my-3">

            <!-- Step 3: Action Confirmation (Focus on the Decision) -->
            <div class="text-center">
                <p class="fw-bold text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the "<?= $vehicle_type_title; ?>"? <br> This will incur a <?= general_currency_symbol . ' ' . number_format(($vehicle_grand_total * $cancellation_percentage) / 100, 2); ?> cancellation fee.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="row text-center mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal" aria-label="Close">Close</button>
                    <button type="submit" onclick="confirmCANCELVEHICLE('<?= $confirmed_itinerary_plan_vendor_eligible_ID; ?>','<?= $cancellation_percentage; ?>','<?= $defect_type; ?>');" class="btn btn-danger" aria-label="Confirm Cancellation">Confirm Cancellation</button>
                </div>
            </div>
        </div>
        <script>
            function confirmCANCELVEHICLE(confirmed_itinerary_plan_vendor_eligible_ID, cancellation_percentage, defect_type) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_vehicle_cancellation",
                    data: {
                        _confirmed_itinerary_plan_vendor_eligible_ID: confirmed_itinerary_plan_vendor_eligible_ID,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showVEHICLECANCELMODAL').modal('hide');
                         window.location.reload();
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');
                            $('#response_' + confirmed_itinerary_plan_vendor_eligible_ID).html(response.html_response);
                            $('#response_vehicle_' + response.itinerary_plan_id + '_' + response.vendor_id + '_' + response.vehicle_type_id).html(response['html_vehicle_response_' + response.itinerary_plan_id + '_' + response.vendor_id + '_' + response.vehicle_type_id]);
                            show_VEHICLE_CANCELLATION_SUMMARY(response.itinerary_plan_id, response.vendor_id);

                            if (response.response_all_vendor_vehicle_cancel_check) {
                                $('#response_all_vendor_vehicle_cancel_check_' + response.vendor_id).html('');
                                $('#vendor_heading_' + response.vendor_id).html(response.response_according_header);
                            }
                        }
                    }
                });
            }

            function show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_ID, vendor_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_vehicle_cancellation_vehicle_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_ID: vendor_ID
                    },
                    success: function(response) {
                        $('.show_vehicle_cancellation_summary').html('');
                        $('.show_vehicle_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php
    elseif ($_GET['type'] == 'confirm_vehicle_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_confirmed_itinerary_plan_vendor_eligible_ID = $_POST['_confirmed_itinerary_plan_vendor_eligible_ID'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        $select_itinerary_vehicle_cancellation_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`, ITINEARY_PLAN_VEHICLE_DETAILS.`cancelled_itinerary_plan_vendor_eligible_ID`, ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id`, ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id`, ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_vendor_eligible_ID`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`confirmed_itinerary_plan_vendor_eligible_ID` = '$_confirmed_itinerary_plan_vendor_eligible_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_VEHICLE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_vehicle_cancellation_details) > 0) :
            while ($fetch_itinerary_vehicle_details_data = sqlFETCHARRAY_LABEL($select_itinerary_vehicle_cancellation_details)) :
                $vendor_name = $fetch_itinerary_vehicle_details_data['vendor_name'];
                $vendor_branch_name = $fetch_itinerary_vehicle_details_data['vendor_branch_name'];
                $vehicle_type_title = $fetch_itinerary_vehicle_details_data['vehicle_type_title'];
                $total_vehicle_qty = $fetch_itinerary_vehicle_details_data['total_vehicle_qty'];
                $cancelled_itinerary_plan_vendor_eligible_ID = $fetch_itinerary_vehicle_details_data['cancelled_itinerary_plan_vendor_eligible_ID'];
                $itinerary_plan_vendor_eligible_ID = $fetch_itinerary_vehicle_details_data['itinerary_plan_vendor_eligible_ID'];
                $itinerary_plan_id = $fetch_itinerary_vehicle_details_data['itinerary_plan_id'];
                $vendor_id = $fetch_itinerary_vehicle_details_data['vendor_id'];
                $vehicle_type_id = $fetch_itinerary_vehicle_details_data['vehicle_type_id'];
                $vehicle_grand_total = $fetch_itinerary_vehicle_details_data['vehicle_grand_total'];
            endwhile;
        endif;
    
        $total_vehicle_cancellation_charge = (($vehicle_grand_total * $_cancellation_percentage) / 100);
        $total_vehicle_refund_amount = ($vehicle_grand_total - $total_vehicle_cancellation_charge);

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vehicle_details` SET `cancellation_status` = '1' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `cancellation_status` = '0' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY  confirmed_vehicle_details_ID  DESC LIMIT 1") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

            //CANCELLATION MAIN TABLE
            $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$itinerary_plan_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

            if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                //UPDATE
                while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                    $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                    $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                    $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                    $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                endwhile;

                $total_cancelled_service_amount = $vehicle_grand_total + $existing_total_cancelled_service_amount;
                $total_cancellation_charge = $total_vehicle_cancellation_charge + $existing_total_cancellation_charge;
                $total_refund_amount = $total_vehicle_refund_amount + $existing_total_refund_amount;

                $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                endif;

                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$vehicle_grand_total", "$total_vehicle_cancellation_charge", "$total_vehicle_refund_amount", "$logged_user_id", "1");

                //CANCELLATION LOG
                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                endif;

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`');
                $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$vehicle_grand_total", "$total_vehicle_cancellation_charge", "$total_vehicle_refund_amount", "$logged_user_id", "1");

                $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_vendor_eligible_ID` = '$cancelled_itinerary_plan_vendor_eligible_ID'";

                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                endif;

            else:

                $total_cancelled_service_amount = $vehicle_grand_total;
                $total_cancellation_charge = $total_vehicle_cancellation_charge;
                $total_refund_amount = $total_vehicle_refund_amount;

                //INSERT
                $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_id' ";

                if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                endif;

                $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$itinerary_plan_id", "1", "$cancelled_on", "$logged_user_id", "$vehicle_grand_total", "$total_vehicle_cancellation_charge", "$total_vehicle_refund_amount", "$logged_user_id", "1");

                //CANCELLATION LOG
                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                endif;

                //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY HOTEL ROOM SERVICE DETAILS TABLE
                $cancelled_room_service_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`');
                $cancelled_room_service_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on", "$_defect_type", "$_cancellation_percentage", "$vehicle_grand_total", "$total_vehicle_cancellation_charge", "$total_vehicle_refund_amount", "$logged_user_id", "1");

                $cancelled_room_service_sqlWhere = " `cancelled_itinerary_plan_vendor_eligible_ID` = '$cancelled_itinerary_plan_vendor_eligible_ID'";

                //CANCELLATION LOG
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_room_service_arrFields, $cancelled_room_service_arrValues, $cancelled_room_service_sqlWhere)) :
                endif;
            endif;

            //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY VENDOR ELIGIBLE TABLE
            $confirmed_room_service_arrFields = array('`cancellation_status`', '`vehicle_defect_type`');
            $confirmed_room_service_arrValues = array("1", "$_defect_type");
            $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_vendor_eligible_ID` = '$_confirmed_itinerary_plan_vendor_eligible_ID' ";
            
            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                
                //UPDATE CANCELLATION STATUS IN ITINEARY PLAN VEHICLE DETAILS TABLE
                $vendor_vehicle_type_id = getVENDOR_VEHICLE_TYPES($vendor_id, $vehicle_type_id, 'get_vehicle_type_id');
                $itineary_vehicle_arrFields = array('`cancellation_status`','`defect_type`');
                $itineary_vehicle_arrValues = array("1", "$_defect_type");
                $itineary_vehicle_sqlwhere = "  `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vehicle_type_id' AND `itinerary_plan_id` ='$itinerary_plan_id' ";   
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $itineary_vehicle_arrFields, $itineary_vehicle_arrValues, $itineary_vehicle_sqlwhere)) :

                    $voucher_created_query = sqlQUERY_LABEL("SELECT `cnf_itinerary_plan_vehicle_voucher_details_ID`, `itinerary_plan_vendor_eligible_ID`, `itinerary_plan_id`, `vehicle_type_id`, `vendor_id`, `vehicle_id`, `vendor_branch_id`, `vehicle_confirmed_by`, `vehicle_confirmed_email_id`, `vehicle_confirmed_mobile_no`, `invoice_to`, `vehicle_booking_status`, `vehicle_voucher_terms_condition`, `vehicle_confirmed_reservation`, `vehicle_confirmation_verified_by`, `vehicle_confirmation_verified_mobile_no`, `vehicle_confirmation_verified_email_id`, `vehicle_confirmation_status_remarks` FROM dvi_confirmed_itinerary_plan_vehicle_voucher_details WHERE `status` = '1' AND `deleted` = '0' AND `vendor_id` = '$vendor_id' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `confirmed_itinerary_plan_vendor_eligible_ID` ='$_confirmed_itinerary_plan_vendor_eligible_ID' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                    // If the Voucher is already created
                    if (sqlNUMOFROW_LABEL($voucher_created_query) > 0):
                        while ($voucher_created = sqlFETCHARRAY_LABEL($voucher_created_query)) :
                            $cnf_itinerary_plan_vehicle_voucher_details_ID = $voucher_created['cnf_itinerary_plan_vehicle_voucher_details_ID'];
                            $vendor_id_val = $voucher_created['vendor_id'];
                            $vehicle_id = $voucher_created['vehicle_id'];
                            $vendor_branch_id_val = $voucher_created['vendor_branch_id'];
                            $vehicle_type_id_val = $voucher_created['vehicle_type_id'];

                            $confirmed_by_val = $voucher_created['vehicle_confirmed_by'];
                            $email_id_val = $voucher_created['vehicle_confirmed_email_id'];
                            $mobile_number_val = $voucher_created['vehicle_confirmed_mobile_no'];
                            $invoice_to = $voucher_created['invoice_to'];
                            $vehicle_voucher_terms_condition_val = $voucher_created['vehicle_voucher_terms_condition'];
                            
                            $total_vehicle_qty_val = $total_vehicle_qty;
                            $vehicle_grand_total_val = $vehicle_grand_total;
                            $cancellation_percentage_val = $_cancellation_percentage;
                            $cancellation_charge_val = $total_vehicle_cancellation_charge;
                            $GRAND_TOTAL_val = $total_vehicle_refund_amount;

                            $vehicle_type_title = getVENDOR_VEHICLE_TYPES($vendor_id_val, $vehicle_type_id_val, 'label');
                            $vendor_name = getVENDOR_DETAILS($vendor_id_val, 'label');
                            $vendor_branch = getBranchLIST($vendor_branch_id_val, 'branch_label');
                            $vendor_address = getVENDORNAMEDETAIL($vendor_id_val, 'get_vendor_address');
                            $vendor_email = $email_id_val;

                            $primary_customer_name = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($itinerary_plan_id, 'primary_customer_name');
                            $agent_id = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($itinerary_plan_id, 'agent_id');
                            $travel_expert_id = getAGENT_details($agent_id, '', 'travel_expert_id');
                            $travel_expert_name = getTRAVEL_EXPERT($travel_expert_id, 'label');
                            $travel_expert_staff_email = getTRAVEL_EXPERT($travel_expert_id, 'staff_email');
                            $agent_email = getAGENT_details($agent_id, '', 'get_agent_email_address');
                            $agent_company_name = get_AGENT_CONFIG_DETAILS($agent_id, 'company_name');
                            $agent_invoice_address = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_address');
                            $agent_invoice_gstin_no = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_gstin_no');

                            $total_adult = get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id, 'total_adult');
                            $total_children = get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id, 'total_children');
                            $total_infants = get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id, 'total_infants');
                            $vehicle_status = getHOTEL_CONFIRM_STATUS('6', 'label');
                            $confirmed_itinerary_quote_ID = get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id, 'itinerary_quote_ID');
                            $billing_type = $invoice_to;
                            $defect_type_label =getCNCELLATION_DEFECT_TYPE($_defect_type, 'label');

                            // Set global variables      
                            global $confirmed_by_val, $confirmed_itinerary_quote_ID, $primary_customer_name, $vendor_name, $vendor_address, $vehicle_type_title, $vendor_branch, $total_adult, $total_children, $total_infants, $travel_expert_name, $travel_expert_staff_email,  $billing_type, $vehicle_status, $agent_company_name, $agent_invoice_address, $agent_invoice_gstin_no, $itinerary_plan_id, $itinerary_plan_vendor_eligible_ID_val, $vendor_email, $agent_email, $status_val, $total_vehicle_qty_val, $vehicle_grand_total_val, $GRAND_TOTAL_val,$cancellation_percentage_val,$cancellation_charge_val, $defect_type_label;
    

                            // Assign values to global variables
                            $_SESSION['global_defect_type_label'] = $defect_type_label;
                            $_SESSION['global_total_vehicle_qty_val'] = $total_vehicle_qty_val;
                            $_SESSION['global_vehicle_grand_total_val'] = $total_vehicle_qty_val . ' X ' . general_currency_symbol . ' ' . number_format($vehicle_grand_total_val, 2);
                            $_SESSION['global_cancellation_percentage_val'] = $cancellation_percentage_val.'%';
                            $_SESSION['global_cancellation_charge_val'] = $cancellation_charge_val;
                            $_SESSION['global_GRAND_TOTAL_val'] = general_currency_symbol . ' ' . number_format($GRAND_TOTAL_val, 2);
                            $_SESSION['global_hidden_itinerary_plan_id'] = $itinerary_plan_id;
                            $_SESSION['global_confirmed_by_val'] = $confirmed_by_val;
                            $_SESSION['global_confirmed_itinerary_quote_ID'] = $confirmed_itinerary_quote_ID;
                            $_SESSION['global_primary_customer_name'] = $primary_customer_name;
                            $_SESSION['global_vendor_name'] = $vendor_name;
                            $_SESSION['global_vehicle_status'] = $vehicle_status;
                            $_SESSION['global_status_val'] = $status_val;
                            $_SESSION['global_vendor_address'] = $vendor_address;
                            $_SESSION['global_vendor_email'] = $vendor_email;
                            $_SESSION['global_vehicle_type_title'] = $vehicle_type_title;
                            $_SESSION['global_vendor_branch'] = $vendor_branch;
                            $_SESSION['global_total_adult'] = $total_adult;
                            $_SESSION['global_total_children'] = $total_children;
                            $_SESSION['global_total_infants'] = $total_infants;
                            $_SESSION['global_travel_expert_name'] = $travel_expert_name;
                            $_SESSION['global_travel_expert_staff_email'] = $travel_expert_staff_email;
                            $_SESSION['global_billing_type'] = $billing_type;
                            $_SESSION['global_agent_company_name'] = $agent_company_name;
                            $_SESSION['global_agent_invoice_address'] = $agent_invoice_address;
                            $_SESSION['global_agent_invoice_gstin_no'] = $agent_invoice_gstin_no;
                            $_SESSION['global_itinerary_plan_vendor_eligible_ID_val'] = $itinerary_plan_vendor_eligible_ID_val;
                            $_SESSION['global_agent_email'] = $agent_email;

                            // Include the email notification script
                            include('ajax_vehicle_voucher_cancellation_email_notification.php');

                            // Assign values to global variables
                            unset($_SESSION['global_defect_type_label']);
                            unset($_SESSION['global_vehicle_grand_total_val']);
                            unset($_SESSION['global_vehicle_status']);
                            unset($_SESSION['global_confirmed_by_val']);
                            unset($_SESSION['global_confirmed_itinerary_quote_ID']);
                            unset($_SESSION['global_primary_customer_name']);
                            unset($_SESSION['global_vendor_name']);
                            unset($_SESSION['global_vendor_address']);
                            unset($_SESSION['global_total_adult']);
                            unset($_SESSION['global_total_children']);
                            unset($_SESSION['global_total_infants']);
                            unset($_SESSION['global_travel_expert_name']);
                            unset($_SESSION['global_travel_expert_staff_email']);
                            unset($_SESSION['global_billing_type']);
                            unset($_SESSION['global_hidden_itinerary_plan_id']);
                            unset($_SESSION['global_itinerary_plan_vendor_eligible_ID_val']);
                            unset($_SESSION['global_vendor_email']);
                            unset($_SESSION['global_status_val']);
                            unset($_SESSION['global_total_vehicle_qty_val']);
                            unset($_SESSION['global_GRAND_TOTAL_val']);
                            unset($_SESSION['global_total_vehicle_qty_val']);
                            unset($_SESSION['global_vehicle_status']);
                            unset($_SESSION['global_status_val']);
                            unset($_SESSION['global_vehicle_type_title']);
                            unset($_SESSION['global_vendor_branch']);
                            unset($_SESSION['global_agent_email']);
                            unset($_SESSION['global_cancellation_percentage_val']);
                            unset($_SESSION['global_cancellation_charge_val']);
                            
                            //CANCEL VOUCHER CREATED
                            $itineary_vehicle_voucher_arrFields = array('`vehicle_booking_status`','`status`');
                            $itineary_vehicle_voucher_arrValues = array("6","2");//cancelled
                            $itineary_vehicle_voucher_sqlwhere = " `cnf_itinerary_plan_vehicle_voucher_details_ID` = '$cnf_itinerary_plan_vehicle_voucher_details_ID' ";   
                            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vehicle_voucher_details", $itineary_vehicle_voucher_arrFields, $itineary_vehicle_voucher_arrValues, $itineary_vehicle_voucher_sqlwhere)) :
                            endif;
                        endwhile;
                    endif;

                    //CHECK IF VEHICLE IS ASSIGNED OR NOT FOR THIS ITINEARY PLAN
                    $assigned_vehicle_query = sqlQUERY_LABEL("SELECT vendor_vehicle_assigned_ID, vehicle_id FROM dvi_confirmed_itinerary_vendor_vehicle_assigned WHERE `status` = '1' AND `deleted` = '0' 
                    AND `vendor_id` = '$vendor_id' AND `itinerary_plan_id` = '$itinerary_plan_id'
                    ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                    // If the vehicle is assigned
                    if (sqlNUMOFROW_LABEL($assigned_vehicle_query) > 0) {
                        while ($assigned_vehicle = sqlFETCHARRAY_LABEL($assigned_vehicle_query)) {
                            $assigned_vehicle_id = $assigned_vehicle['vendor_vehicle_assigned_ID'];
                            // Update the vehicle assignment status to inactive (0)
                            $update_assignment_fields = array('`assigned_vehicle_status`','`status`');
                            $update_assignment_values = array("0","2");
                            $update_assignment_where = " `vendor_vehicle_assigned_ID` = '$assigned_vehicle_id' ";
                            sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_vehicle_assigned", $update_assignment_fields, $update_assignment_values, $update_assignment_where);

                            //check if driver is assigned, if yes then release the driver
                            $check_driver_assignment = sqlQUERY_LABEL("SELECT driver_assigned_ID, driver_id FROM dvi_confirmed_itinerary_vendor_driver_assigned WHERE `status` = '1' AND `deleted` = '0' 
                            AND `vendor_id` = '$vendor_id' AND `itinerary_plan_id` ='$itinerary_plan_id' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                            if (sqlNUMOFROW_LABEL($check_driver_assignment) > 0) {
                                while ($assigned_driver = sqlFETCHARRAY_LABEL($check_driver_assignment)) {
                                    $assigned_driver_id = $assigned_driver['driver_assigned_ID'];
                                    // Update the driver assignment status to inactive (0)
                                    $update_driver_assignment_fields = array('`assigned_driver_status`','`status`');
                                    $update_driver_assignment_values = array("0","2");
                                    $update_driver_assignment_where = " `driver_assigned_ID` = '$assigned_driver_id' ";
                                    sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_driver_assigned", $update_driver_assignment_fields, $update_driver_assignment_values, $update_driver_assignment_where);
                                }
                            }
                        }
                    }

                endif;

            endif;

            //CHECK IF ALL VENDOR SERVICES ARE CANCELLED THEN CANCEL THE ITINEARY PLAN
            cancel_EntireItineraryPlan($itinerary_plan_id);

            $select_no_of_remaining_non_cancelled_vehicle_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `vendor_id` = '$vendor_id' AND `itineary_plan_assigned_status` = '1' AND `vehicle_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            $total_no_of_non_cancelled_vehicle_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_vehicle_details);

            $select_no_of_remaining_non_cancelled_vehicle_type_wise_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vehicle_type_id' AND `itineary_plan_assigned_status` = '1' AND `vehicle_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            $total_no_of_non_cancelled_vehicletype_wise_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_vehicle_type_wise_details);

            $response['itinerary_plan_vendor_eligible_ID'] = $itinerary_plan_vendor_eligible_ID;
            $response['itinerary_plan_id'] = $itinerary_plan_id;
            $response['vendor_id'] = $vendor_id;
            $response['vehicle_type_id'] = $vehicle_type_id;

            if ($total_no_of_non_cancelled_vehicletype_wise_count == 0):
                $response['html_vehicle_response_' . $itinerary_plan_id . '_' . $vendor_id . '_' . $vehicle_type_id] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Vehicle Cancelled</span><button type="button" onclick="vehicletypeCANCELLATIONDETAILS(' . $itinerary_plan_id . ',' . $vendor_id . ',' . $vehicle_type_id . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';
            endif;

            if ($total_no_of_non_cancelled_vehicle_count == 0):
                $response['response_all_vendor_vehicle_cancel_check'] = true;
                $response['response_according_header'] = '<button class="accordion-button bg-label-danger text-black collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendor_details_' . $vendor_id . '" aria-expanded="false" aria-controls="vendor_details_' . $vendor_id . '" style="background-color: #ffffff;">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span><strong>' . $vendor_name . '</strong> | ' . $vendor_branch_name . '</span>
                                                    <div class="text-end"><strong class="text-black"> Refund Amount ' . general_currency_symbol . ' ' . number_format(get_ITINEARY_VEHICLE_CANCELLED_SUMMARY_DETAILS($itinerary_plan_id, $vendor_id, 'TOTAL_CANCELLATION_REFUND_COST'), 2) . '</strong>
                                                    </div>
                                                </div>
                                            </button>';
            endif;

            $response['html_response'] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                <div>
                    <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $vehicle_type_title . ' (Cancelled)</p>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format($vehicle_grand_total, 2) . '</small>
                    <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format($total_vehicle_refund_amount, 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                </div>
                <!-- Right Side: Refunded Amount -->
                <div class="text-center">
                    <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                    <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format($total_vehicle_refund_amount, 2) . '</p>
                </div>
            </div>';

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_vehicletype_wise_cancel_form'):

        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $vendor_id = $_GET['vendor_id'];
        $vehicle_type_id = $_GET['vehicle_type_id'];

        $select_no_of_remaining_non_cancelled_vehicle_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vehicle_type_id' AND `itineary_plan_assigned_status` = '1' AND `vehicle_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_non_cancelled_vehicle_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_vehicle_details);

        $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`) AS TOTAL_VEHICLE_QTY,  SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`) AS VEHICLE_GRAND_TOTAL FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` = '$vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
            $vendor_name = $fetch_confirmed_itinerary_vehicle_data['vendor_name'];
            $vendor_branch_name = $fetch_confirmed_itinerary_vehicle_data['vendor_branch_name'];
            $vehicle_type_title = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_title'];
            $TOTAL_VEHICLE_QTY = $fetch_confirmed_itinerary_vehicle_data['TOTAL_VEHICLE_QTY'];
            $VEHICLE_GRAND_TOTAL = round($fetch_confirmed_itinerary_vehicle_data['VEHICLE_GRAND_TOTAL']);
        endwhile;

        $cancellation_percentage_value = $_GET['cancellation_percentage'];
    ?>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Cancel Vehicle Type "<?= htmlspecialchars($vehicle_type_title); ?>"?</strong>
                </h5>
                <p class="mb-4 text-muted">
                    You are about to cancel all vehicles under "<?= $vendor_name; ?>" and the vehicle type "<?= $vehicle_type_title; ?>". <br> Please note that this action cannot be undone.
                </p>
            </div>

            <!-- Vehicle Type Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Vendor / Vehicle Type:</strong>
                    <span><?= htmlspecialchars($vendor_name); ?> / <?= htmlspecialchars($vehicle_type_title); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Total Qty:</strong>
                    <span><?= $TOTAL_VEHICLE_QTY; ?></span>
                </div>
            </div>

            <hr class="my-3">
            <form action="" data-parsley-validate method="post">
                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">
                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <strong><?= general_currency_symbol . ' ' . number_format($VEHICLE_GRAND_TOTAL, 2); ?></strong>
                        <input type="hidden" id="total_cancellation_services_amount_3" value="<?= ($VEHICLE_GRAND_TOTAL); ?>">
                    </div>

                    <!-- Cancellation Percentage and Defect Type -->
                    <div class="col-md-4 mt-3">
                        <label for="cancellation_percentage_3" class="form-label"><strong>Cancellation Percentage:</strong></label>
                        <input type="number" placeholder="Enter Percentage %" id="cancellation_percentage_3" class="form-control" value="<?= $cancellation_percentage_value; ?>" required min="0" max="100" oninput="updateCancellationCharges_3()">
                    </div>
                    <div class="col-md-4 mt-3">
                        <label for="defect_type" class="form-label"><strong>Defect Type:</strong></label>
                        <select id="defect_type" required class="form-select" onchange="updateCancellationCharges_3">
                            <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'select'); ?>
                        </select>
                    </div>
                    <div class="col-md-4 mt-3 text-end">
                        <label for="total_refund_3" class="form-label"><strong>Total Refund:</strong></label>
                        <div>
                            <h3 id="total_refund_3"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></h3>
                        </div>
                    </div>
                    <!-- Display Calculated Cancellation Charges -->
                    <?php /* <div class="col-12 mb-0">
                        <strong>Cancellation Charges:</strong>
                        <span id="calculated_cancellation_charges_3"><?= general_currency_symbol . ' ' . number_format(($room_rate * $default_cancellation_percentage) / 100, 2); ?></span>
                    </div> */ ?>
                </div>

                <hr class="my-3">

                <!-- Final Confirmation Alert -->
                <div class="text-center">
                    <p class="fw-bold text-danger">
                        <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel the vehicle type "<?= htmlspecialchars($vehicle_type_title); ?>" under this <?= htmlspecialchars($vendor_name); ?>? <br> This will incur a <span id="calculated_cancellation_charges_3"><?= general_currency_symbol . ' ' . number_format(($VEHICLE_GRAND_TOTAL * $default_cancellation_percentage) / 100, 2); ?></span> cancellation fee.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="confirmCANCELVEHICLETYPE('<?= $itinerary_plan_ID; ?>','<?= $vendor_id; ?>','<?= $vehicle_type_id; ?>')" class="btn btn-danger">Confirm Cancellation</button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                updateCancellationCharges_3();
            });

            function updateCancellationCharges_3() {
                // Get the total cost (including room cost, GST, and service charges)
                const totalCost = parseFloat(document.getElementById('total_cancellation_services_amount_3').value) || 0;

                // Get the cancellation percentage input value
                let cancellationPercentage = parseFloat(document.getElementById('cancellation_percentage_3').value) || 0;

                // Ensure the cancellation percentage doesn't exceed 100%
                if (cancellationPercentage > 100) {
                    cancellationPercentage = 100; // Set to 100 if greater than 100
                    document.getElementById('cancellation_percentage_3').value = 100; // Update the input field
                }

                // Calculate the cancellation charges based on the percentage
                const cancellationCharges = (totalCost * cancellationPercentage) / 100;

                // Define a valid currency code (e.g., 'USD', 'INR', 'EUR')
                const currencyCode = "INR"; // Change this dynamically if needed

                // Use Intl.NumberFormat to format the price
                const formattedCancellationCharges = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(cancellationCharges);

                // Update the cancellation charges display
                document.getElementById('calculated_cancellation_charges_3').innerText = formattedCancellationCharges;

                // Calculate the total refund (total cost minus cancellation charges)
                const totalRefund = totalCost - cancellationCharges;

                // Format the total refund
                const formattedTotalRefund = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(totalRefund);

                // Update the total cancellation charges display
                document.getElementById('total_refund_3').innerText = formattedTotalRefund;
            }


            $('#cancellation_percentage_3').on('click', function() {
                $(this).select();
            });

            // Keyup validation for percentage field to limit input between 0 and 100
            $('#cancellation_percentage_3').on('keyup', function() {
                var value = $(this).val();
                // Ensure value is between 0 and 100
                if (value < 0) {
                    $(this).val(0);
                } else if (value > 100) {
                    $(this).val(100);
                }
            });

            function confirmCANCELVEHICLETYPE(itinerary_plan_ID, vendor_id, vehicle_type_id) {
                var cancellation_percentage = document.getElementById('cancellation_percentage_3').value;
                var defect_type = document.getElementById('defect_type').value;

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_vehicletype_wise_cancellation",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_id: vendor_id,
                        _vehicle_type_id: vehicle_type_id,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showcancelVEHICLETYPESFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');

                            show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_ID, vendor_id);

                            $('#response_vehicle_' + itinerary_plan_ID + '_' + vendor_id + '_' + vehicle_type_id).html(response['html_vehicle_response_' + itinerary_plan_ID + '_' + vendor_id + '_' + vehicle_type_id]);

                            response.confirmed_itinerary_plan_vendor_eligible_ID.forEach(function(cnf_Itineary_plan_eligible_ID) {
                                var htmlResponseKey = 'html_response_' + cnf_Itineary_plan_eligible_ID;
                                if (response[htmlResponseKey]) {
                                    $('#response_' + cnf_Itineary_plan_eligible_ID).html(response[htmlResponseKey]);
                                }
                            });

                            if (response.response_all_vendor_vehicle_cancel_check) {
                                $('#response_all_vendor_vehicle_cancel_check_' + vendor_id).html('');
                                $('#vendor_heading_' + vendor_id).html(response.response_according_header);
                            }
                        }
                    }
                });
            }

            function show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_ID, vendor_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_vehicle_cancellation_vehicle_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_ID: vendor_ID
                    },
                    success: function(response) {
                        $('.show_vehicle_cancellation_summary').html('');
                        $('.show_vehicle_cancellation_summary').html(response);
                    }
                });
            }
        </script>

        <!-- vehicle qty sedan -->
    <?php
    elseif ($_GET['type'] == 'show_vehicletype_wise_add_form'):

        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $vendor_id = $_GET['vendor_id'];
        $vehicle_type_id = $_GET['vehicle_type_id'];

        $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`) AS TOTAL_VEHICLE_QTY,  SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`) AS VEHICLE_GRAND_TOTAL FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` = '$vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
            $vendor_name = $fetch_confirmed_itinerary_vehicle_data['vendor_name'];
            $vendor_branch_name = $fetch_confirmed_itinerary_vehicle_data['vendor_branch_name'];
            $vehicle_type_title = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_title'];
            $TOTAL_VEHICLE_QTY = $fetch_confirmed_itinerary_vehicle_data['TOTAL_VEHICLE_QTY'];
            $VEHICLE_GRAND_TOTAL = round($fetch_confirmed_itinerary_vehicle_data['VEHICLE_GRAND_TOTAL']);
            $single_vehicle_price = $VEHICLE_GRAND_TOTAL / $TOTAL_VEHICLE_QTY;
        endwhile;

    ?>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Add Vehicle Type "<?= htmlspecialchars($vehicle_type_title); ?>"</strong>
                </h5>
            </div>

            <!-- Vehicle Type Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Vendor / Vehicle Type:</strong>
                    <span><?= htmlspecialchars($vendor_name); ?> / <?= htmlspecialchars($vehicle_type_title); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Total Qty:</strong>
                    <span><?= $TOTAL_VEHICLE_QTY; ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Total Cost:</strong>
                    <span><?= general_currency_symbol . ' ' . number_format($VEHICLE_GRAND_TOTAL, 2); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Add Qty:</strong>
                    <span>
                        <div class="col-4 d-flex justify-content-start">
                            <div class="itinerary_quantity itinerary_quantityAdult d-flex align-items-center">
                                <a class="itinerary_quantity__minus"><span>-</span></a>
                                <input name="itinerary_adult" id="itinerary_adult"
                                    readonly
                                    type="text"
                                    class="itinerary_quantity__input itinerary_quantityadult"
                                    style="cursor:not-allowed; width: 40px; text-align: center;"
                                    value="0">
                                <a class="itinerary_quantity__plus"><span>+</span></a>
                            </div>
                        </div>

                    </span>
                </div>
            </div>

            <hr class="my-3">
            <form action="" data-parsley-validate method="post">
                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">
                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Overall Cost:</strong>
                        <div id="overallCharge">
                            <strong><?= general_currency_symbol . ' ' . number_format($VEHICLE_GRAND_TOTAL, 2); ?></strong>
                        </div>
                        <input type="hidden" id="total_cancellation_services_amount" value="<?= ($VEHICLE_GRAND_TOTAL); ?>">
                    </div>
                </div>

                <hr class="my-3">

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="confirmADDVEHICLETYPE('<?= $itinerary_plan_ID; ?>','<?= $vendor_id; ?>','<?= $vehicle_type_id; ?>')" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            // Function to update overall charges
            function updateOverallCharges() {
                // Get the initial vehicle grand total from PHP
                let baseTotal = parseFloat(<?= json_encode($VEHICLE_GRAND_TOTAL); ?>) || 0;

                // Get the single vehicle price
                const singleVehiclePrice = parseFloat(<?= json_encode($single_vehicle_price); ?>) || 0;

                // Get the updated quantity (sum of all quantity inputs)
                let totalQty = 0;
                document.querySelectorAll('.itinerary_quantity__input').forEach(input => {
                    totalQty += parseInt(input.value) || 0;
                });

                // Calculate the new total
                const updatedTotal = baseTotal + (singleVehiclePrice * totalQty);

                // Format the updated total
                const formattedUpdatedTotal = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: '<?= $general_currency_symbol; ?>'
                }).format(updatedTotal);

                // Update the displayed charge
                document.getElementById('overallCharge').innerHTML = `<strong><?= $general_currency_symbol; ?> ${formattedUpdatedTotal}</strong>`;
            }
            // Handle quantity increment and decrement
            $(document).off('click', '.itinerary_quantity__plus, .itinerary_quantity__minus').on('click', '.itinerary_quantity__plus, .itinerary_quantity__minus', function(e) {
                e.preventDefault();

                // Get the closest input field
                var inputField = $(this).closest('.itinerary_quantity').find('.itinerary_quantity__input');

                // Get the current value as an integer
                var currentValue = parseInt(inputField.val()) || 0;

                // Check if plus or minus button was clicked
                if ($(this).hasClass('itinerary_quantity__plus')) {
                    currentValue += 1; // Increment by 1
                } else if ($(this).hasClass('itinerary_quantity__minus') && currentValue > 0) {
                    currentValue -= 1; // Decrement by 1
                }

                // Set the new value
                inputField.val(currentValue);

                // Update overall charges
                updateOverallCharges();
            });



            function confirmADDVEHICLETYPE(itinerary_plan_ID, vendor_id, vehicle_type_id) {
                var vehicle_count = document.getElementById('itinerary_adult').value;

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_vehicletype_wise_add",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_id: vendor_id,
                        _vehicle_type_id: vehicle_type_id,
                        _vehicle_count: vehicle_count
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.vehicle_count_required) {
                                TOAST_NOTIFICATION('warning', 'Vehicle Count Required', 'Warning !!!');
                            }
                        } else {
                            if (response.success == true) {
                                $('#showVEHICLEADDFORMDATA').modal('hide');
                                TOAST_NOTIFICATION('success', 'Successfully Added', 'Success !!!');

                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            }

                        }
                    }
                });
            }

            function show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_ID, vendor_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_vehicle_cancellation_vehicle_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_ID: vendor_ID
                    },
                    success: function(response) {
                        $('.show_vehicle_cancellation_summary').html('');
                        $('.show_vehicle_cancellation_summary').html(response);
                    }
                });
            }
        </script>
    <?php
    elseif ($_GET['type'] == 'confirm_vehicletype_wise_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $_vendor_id = $_POST['_vendor_id'];
        $_vehicle_type_id = $_POST['_vehicle_type_id'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED ROUTE GUIDE SLOT DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vehicle_details` SET `cancellation_status` = '1' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$_itinerary_plan_ID' AND `cancellation_status` = '0' AND `vehicle_type_id` = '$_vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

            $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`, ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_vendor_eligible_ID`, ITINEARY_PLAN_VEHICLE_DETAILS.`confirmed_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$_itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$_vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` = '$_vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            while ($fetch_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
                $vendor_name = $fetch_confirmed_itinerary_vehicle_data['vendor_name'];
                $vendor_branch_name = $fetch_confirmed_itinerary_vehicle_data['vendor_branch_name'];
                $vehicle_type_title = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_title'];
                $total_vehicle_qty = $fetch_confirmed_itinerary_vehicle_data['total_vehicle_qty'];
                $vehicle_grand_total = round($fetch_confirmed_itinerary_vehicle_data['vehicle_grand_total']);
                $itinerary_plan_vendor_eligible_ID = $fetch_confirmed_itinerary_vehicle_data['itinerary_plan_vendor_eligible_ID'];
                $confirmed_itinerary_plan_vendor_eligible_ID = $fetch_confirmed_itinerary_vehicle_data['confirmed_itinerary_plan_vendor_eligible_ID'];

                $select_no_of_remaining_non_cancelled_vehicle_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$_itinerary_plan_ID' AND `vendor_id` = '$_vendor_id' AND `itineary_plan_assigned_status` = '1' AND `vehicle_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                $total_no_of_non_cancelled_vehicle_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_vehicle_details);

                $select_no_of_remaining_non_cancelled_vehicle_type_wise_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$_itinerary_plan_ID' AND `vendor_id` = '$_vendor_id' AND `vehicle_type_id` = '$_vehicle_type_id' AND `itineary_plan_assigned_status` = '1' AND `vehicle_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                $total_no_of_non_cancelled_vehicle_type_wise_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_vehicle_type_wise_details);

                $total_vehicle_type_cancellation_service_cost = ($vehicle_grand_total);
                $total_vehicle_type_cancellation_charges = (($total_vehicle_type_cancellation_service_cost * $_cancellation_percentage) / 100);
                $total_vehicle_type_refund_amt = ($total_vehicle_type_cancellation_service_cost - $total_vehicle_type_cancellation_charges);

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$_itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $total_vehicle_type_cancellation_service_cost + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_vehicle_type_cancellation_charges + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_vehicle_type_refund_amt + $existing_total_refund_amount;

                    $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$_itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                    endif;

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$_itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY VEHICLE TYPE IN VENDOR VEHICLE ELIGIBILITY DETAILS TABLE
                    $cancelled_vehicle_type_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`');
                    $cancelled_vehicle_type_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                    $cancelled_vehicle_type_sqlWhere = " `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_vehicle_type_arrFields, $cancelled_vehicle_type_arrValues, $cancelled_vehicle_type_sqlWhere)) :
                    endif;

                else:

                    $total_cancelled_service_amount = $total_vehicle_type_cancellation_service_cost;
                    $total_cancellation_charge = $total_vehicle_type_cancellation_charges;
                    $total_refund_amount = $total_vehicle_type_refund_amt;

                    //INSERT
                    $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                    $cancelled_itineraries_arrValues = array("$_itinerary_plan_ID", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$_itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                        //CANCELLATION LOG
                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY VEHICLE TYPE IN VENDOR VEHICLE ELIGIBILITY DETAILS TABLE
                        $cancelled_vehicle_type_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`');
                        $cancelled_vehicle_type_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                        $cancelled_vehicle_type_sqlWhere = " `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_vehicle_type_arrFields, $cancelled_vehicle_type_arrValues, $cancelled_vehicle_type_sqlWhere)) :
                        endif;

                    endif;
                endif;

                //UPDATE CANCELLATION LOG FOR CONFIRMED ITINEARY VENDOR ELIGIBLE TABLE
                $confirmed_room_service_arrFields = array('`cancellation_status`', '`vehicle_defect_type`');
                $confirmed_room_service_arrValues = array("1", "$_defect_type");
                $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' ";
                
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                    
                    //UPDATE CANCELLATION STATUS IN ITINEARY PLAN VEHICLE DETAILS TABLE
                    $vendor_vehicle_type_id = getVENDOR_VEHICLE_TYPES($_vendor_id, $_vehicle_type_id, 'get_vehicle_type_id');
                    $itineary_vehicle_arrFields = array('`cancellation_status`','`defect_type`');
                    $itineary_vehicle_arrValues = array("1", "$_defect_type");
                    $itineary_vehicle_sqlwhere = "  `vendor_id` = '$_vendor_id' AND `vehicle_type_id` = '$_vehicle_type_id' AND `itinerary_plan_id` ='$_itinerary_plan_ID' ";   
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $itineary_vehicle_arrFields, $itineary_vehicle_arrValues, $itineary_vehicle_sqlwhere)) :

                    $voucher_created_query = sqlQUERY_LABEL("SELECT `cnf_itinerary_plan_vehicle_voucher_details_ID`, `itinerary_plan_vendor_eligible_ID`, `itinerary_plan_id`, `vehicle_type_id`, `vendor_id`, `vehicle_id`, `vendor_branch_id`, `vehicle_confirmed_by`, `vehicle_confirmed_email_id`, `vehicle_confirmed_mobile_no`, `invoice_to`, `vehicle_booking_status`, `vehicle_voucher_terms_condition`, `vehicle_confirmed_reservation`, `vehicle_confirmation_verified_by`, `vehicle_confirmation_verified_mobile_no`, `vehicle_confirmation_verified_email_id`, `vehicle_confirmation_status_remarks` FROM dvi_confirmed_itinerary_plan_vehicle_voucher_details WHERE `status` = '1' AND `deleted` = '0'  AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` = '$_itinerary_plan_ID' AND `confirmed_itinerary_plan_vendor_eligible_ID` ='$confirmed_itinerary_plan_vendor_eligible_ID' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                        // If the Voucher is already created
                        if (sqlNUMOFROW_LABEL($voucher_created_query) > 0):
                            while ($voucher_created = sqlFETCHARRAY_LABEL($voucher_created_query)) :
                                $cnf_itinerary_plan_vehicle_voucher_details_ID = $voucher_created['cnf_itinerary_plan_vehicle_voucher_details_ID'];
                                $vendor_id_val = $voucher_created['vendor_id'];
                                $vehicle_id = $voucher_created['vehicle_id'];
                                $vendor_branch_id_val = $voucher_created['vendor_branch_id'];
                                $vehicle_type_id_val = $voucher_created['vehicle_type_id'];

                                $confirmed_by_val = $voucher_created['vehicle_confirmed_by'];
                                $email_id_val = $voucher_created['vehicle_confirmed_email_id'];
                                $mobile_number_val = $voucher_created['vehicle_confirmed_mobile_no'];
                                $invoice_to = $voucher_created['invoice_to'];
                                $vehicle_voucher_terms_condition_val = $voucher_created['vehicle_voucher_terms_condition'];
                                
                                $total_vehicle_qty_val = $total_vehicle_qty;
                                $vehicle_grand_total_val = $vehicle_grand_total;
                                $cancellation_percentage_val = $_cancellation_percentage;
                                $cancellation_charge_val = $total_vehicle_type_cancellation_charges;
                                $GRAND_TOTAL_val = $total_vehicle_type_refund_amt;

                                $vehicle_type_title = getVENDOR_VEHICLE_TYPES($vendor_id_val, $vehicle_type_id_val, 'label');
                                $vendor_name = getVENDOR_DETAILS($vendor_id_val, 'label');
                                $vendor_branch = getBranchLIST($vendor_branch_id_val, 'branch_label');
                                $vendor_address = getVENDORNAMEDETAIL($vendor_id_val, 'get_vendor_address');
                                $vendor_email = $email_id_val;

                                $primary_customer_name = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($_itinerary_plan_ID, 'primary_customer_name');
                                $agent_id = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($_itinerary_plan_ID, 'agent_id');
                                $travel_expert_id = getAGENT_details($agent_id, '', 'travel_expert_id');
                                $travel_expert_name = getTRAVEL_EXPERT($travel_expert_id, 'label');
                                $travel_expert_staff_email = getTRAVEL_EXPERT($travel_expert_id, 'staff_email');
                                $agent_email = getAGENT_details($agent_id, '', 'get_agent_email_address');
                                $agent_company_name = get_AGENT_CONFIG_DETAILS($agent_id, 'company_name');
                                $agent_invoice_address = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_address');
                                $agent_invoice_gstin_no = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_gstin_no');

                                $total_adult = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_adult');
                                $total_children = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_children');
                                $total_infants = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_infants');
                                $vehicle_status = getHOTEL_CONFIRM_STATUS('6', 'label');
                                $confirmed_itinerary_quote_ID = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'itinerary_quote_ID');
                                $billing_type = $invoice_to;
                                $defect_type_label =getCNCELLATION_DEFECT_TYPE($_defect_type, 'label');

                                // Set global variables      
                                global $confirmed_by_val, $confirmed_itinerary_quote_ID, $primary_customer_name, $vendor_name, $vendor_address, $vehicle_type_title, $vendor_branch, $total_adult, $total_children, $total_infants, $travel_expert_name, $travel_expert_staff_email,  $billing_type, $vehicle_status, $agent_company_name, $agent_invoice_address, $agent_invoice_gstin_no, $_itinerary_plan_ID, $itinerary_plan_vendor_eligible_ID_val, $vendor_email, $agent_email, $status_val, $total_vehicle_qty_val, $vehicle_grand_total_val, $GRAND_TOTAL_val,$cancellation_percentage_val,$cancellation_charge_val, $defect_type_label;
       

                                // Assign values to global variables
                                $_SESSION['global_defect_type_label'] = $defect_type_label;
                                $_SESSION['global_total_vehicle_qty_val'] = $total_vehicle_qty_val;
                                $_SESSION['global_vehicle_grand_total_val'] = $total_vehicle_qty_val . ' X ' . general_currency_symbol . ' ' . number_format($vehicle_grand_total_val, 2);
                                $_SESSION['global_cancellation_percentage_val'] = $cancellation_percentage_val;
                                $_SESSION['global_cancellation_charge_val'] = $cancellation_charge_val;
                                $_SESSION['global_GRAND_TOTAL_val'] = general_currency_symbol . ' ' . number_format($GRAND_TOTAL_val, 2);
                                $_SESSION['global_hidden_itinerary_plan_id'] = $_itinerary_plan_ID;
                                $_SESSION['global_confirmed_by_val'] = $confirmed_by_val;
                                $_SESSION['global_confirmed_itinerary_quote_ID'] = $confirmed_itinerary_quote_ID;
                                $_SESSION['global_primary_customer_name'] = $primary_customer_name;
                                $_SESSION['global_vendor_name'] = $vendor_name;
                                $_SESSION['global_vehicle_status'] = $vehicle_status;
                                $_SESSION['global_status_val'] = $status_val;
                                $_SESSION['global_vendor_address'] = $vendor_address;
                                $_SESSION['global_vendor_email'] = $vendor_email;
                                $_SESSION['global_vehicle_type_title'] = $vehicle_type_title;
                                $_SESSION['global_vendor_branch'] = $vendor_branch;
                                $_SESSION['global_total_adult'] = $total_adult;
                                $_SESSION['global_total_children'] = $total_children;
                                $_SESSION['global_total_infants'] = $total_infants;
                                $_SESSION['global_travel_expert_name'] = $travel_expert_name;
                                $_SESSION['global_travel_expert_staff_email'] = $travel_expert_staff_email;
                                $_SESSION['global_billing_type'] = $billing_type;
                                $_SESSION['global_agent_company_name'] = $agent_company_name;
                                $_SESSION['global_agent_invoice_address'] = $agent_invoice_address;
                                $_SESSION['global_agent_invoice_gstin_no'] = $agent_invoice_gstin_no;
                                $_SESSION['global_itinerary_plan_vendor_eligible_ID_val'] = $itinerary_plan_vendor_eligible_ID_val;
                                $_SESSION['global_agent_email'] = $agent_email;

                                // Include the email notification script
                                include('ajax_vehicle_voucher_cancellation_email_notification.php');

                                // Assign values to global variables
                                unset($_SESSION['global_defect_type_label']);
                                unset($_SESSION['global_vehicle_grand_total_val']);
                                unset($_SESSION['global_vehicle_status']);
                                unset($_SESSION['global_confirmed_by_val']);
                                unset($_SESSION['global_confirmed_itinerary_quote_ID']);
                                unset($_SESSION['global_primary_customer_name']);
                                unset($_SESSION['global_vendor_name']);
                                unset($_SESSION['global_vendor_address']);
                                unset($_SESSION['global_total_adult']);
                                unset($_SESSION['global_total_children']);
                                unset($_SESSION['global_total_infants']);
                                unset($_SESSION['global_travel_expert_name']);
                                unset($_SESSION['global_travel_expert_staff_email']);
                                unset($_SESSION['global_billing_type']);
                                unset($_SESSION['global_hidden_itinerary_plan_id']);
                                unset($_SESSION['global_itinerary_plan_vendor_eligible_ID_val']);
                                unset($_SESSION['global_vendor_email']);
                                unset($_SESSION['global_status_val']);
                                unset($_SESSION['global_total_vehicle_qty_val']);
                                unset($_SESSION['global_GRAND_TOTAL_val']);
                                unset($_SESSION['global_total_vehicle_qty_val']);
                                unset($_SESSION['global_vehicle_status']);
                                unset($_SESSION['global_status_val']);
                                unset($_SESSION['global_vehicle_type_title']);
                                unset($_SESSION['global_vendor_branch']);
                                unset($_SESSION['global_agent_email']);
                                unset($_SESSION['global_cancellation_percentage_val']);
                                unset($_SESSION['global_cancellation_charge_val']);
                               
                                //CANCEL VOUCHER CREATED
                                $itineary_vehicle_voucher_arrFields = array('`vehicle_booking_status`','`status`');
                                $itineary_vehicle_voucher_arrValues = array("6","2");//cancelled
                                $itineary_vehicle_voucher_sqlwhere = " `cnf_itinerary_plan_vehicle_voucher_details_ID` = '$cnf_itinerary_plan_vehicle_voucher_details_ID' ";   
                                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vehicle_voucher_details", $itineary_vehicle_voucher_arrFields, $itineary_vehicle_voucher_arrValues, $itineary_vehicle_voucher_sqlwhere)) :
                                endif;
                            endwhile;
                        endif;

                        //CHECK IF VEHICLE IS ASSIGNED OR NOT FOR THIS ITINEARY PLAN
                        $assigned_vehicle_query = sqlQUERY_LABEL("SELECT vendor_vehicle_assigned_ID, vehicle_id FROM dvi_confirmed_itinerary_vendor_vehicle_assigned WHERE `status` = '1' AND `deleted` = '0' 
                        AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` = '$_itinerary_plan_ID'
                        ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                        // If the vehicle is assigned
                        if (sqlNUMOFROW_LABEL($assigned_vehicle_query) > 0) {
                            while ($assigned_vehicle = sqlFETCHARRAY_LABEL($assigned_vehicle_query)) {
                                $assigned_vehicle_id = $assigned_vehicle['vendor_vehicle_assigned_ID'];
                                // Update the vehicle assignment status to inactive (0)
                                $update_assignment_fields = array('`assigned_vehicle_status`','`status`');
                                $update_assignment_values = array("0","2");
                                $update_assignment_where = " `vendor_vehicle_assigned_ID` = '$assigned_vehicle_id' ";
                                sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_vehicle_assigned", $update_assignment_fields, $update_assignment_values, $update_assignment_where);

                                //check if driver is assigned, if yes then release the driver
                                $check_driver_assignment = sqlQUERY_LABEL("SELECT driver_assigned_ID, driver_id FROM dvi_confirmed_itinerary_vendor_driver_assigned WHERE `status` = '1' AND `deleted` = '0' 
                                AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` ='$_itinerary_plan_ID' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                                if (sqlNUMOFROW_LABEL($check_driver_assignment) > 0) {
                                    while ($assigned_driver = sqlFETCHARRAY_LABEL($check_driver_assignment)) {
                                        $assigned_driver_id = $assigned_driver['driver_assigned_ID'];
                                        // Update the driver assignment status to inactive (0)
                                        $update_driver_assignment_fields = array('`assigned_driver_status`','`status`');
                                        $update_driver_assignment_values = array("0","2");
                                        $update_driver_assignment_where = " `driver_assigned_ID` = '$assigned_driver_id' ";
                                        sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_driver_assigned", $update_driver_assignment_fields, $update_driver_assignment_values, $update_driver_assignment_where);
                                    }
                                }
                            }
                        }

                    endif;

                endif;

                $response['confirmed_itinerary_plan_vendor_eligible_ID'][] = $confirmed_itinerary_plan_vendor_eligible_ID;
                $response['itinerary_plan_vendor_eligible_ID'] = $confirmed_itinerary_plan_vendor_eligible_ID;

                if ($total_vehicle_qty == 1):
                    $response['html_vehicle_response_' . $_itinerary_plan_ID . '_' . $_vendor_id . '_' . $_vehicle_type_id] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Vehicle Cancelled</span><button type="button" onclick="vehicletypeCANCELLATIONDETAILS(' . $_itinerary_plan_ID . ',' . $_vendor_id . ',' . $_vehicle_type_id . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';
                endif;

                $response['html_response_' . $confirmed_itinerary_plan_vendor_eligible_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                <div>
                    <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $vehicle_type_title . ' (Cancelled)</p>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_cancellation_service_cost), 2) . '</small>
                    <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_refund_amt), 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                </div>
                <!-- Right Side: Refunded Amount -->
                <div class="text-center">
                    <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                    <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_refund_amt), 2) . '</p>
                </div>
            </div>';
            endwhile;

            cancel_EntireItineraryPlan($_itinerary_plan_ID);

            if ($total_no_of_non_cancelled_vehicle_count == 1):
                $TOTAL_CANCELLATION_REFUND_COST = get_ITINEARY_VEHICLE_CANCELLED_SUMMARY_DETAILS($_itinerary_plan_ID, $_vendor_id, 'TOTAL_CANCELLATION_REFUND_COST');

                $response['response_all_vendor_vehicle_cancel_check'] = true;
                $response['response_according_header'] = '<button class="accordion-button bg-label-danger text-black collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendor_details_' . $_vendor_id . '" aria-expanded="false" aria-controls="vendor_details_' . $_vendor_id . '" style="background-color: #ffffff;">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span><strong>' . $vendor_name . '</strong> | ' . $vendor_branch_name . '</span>
                                                    <div class="text-end"><strong class="text-black"> Refund Amount - ' . general_currency_symbol . ' ' . number_format($TOTAL_CANCELLATION_REFUND_COST, 2) . '</strong>
                                                    </div>
                                                </div>
                                            </button>';
            endif;
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'confirm_vehicletype_wise_add'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_vehicle_count'] == '') :
            $errors['vehicle_count_required'] = true;
        endif;

        $_itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $_itinerary_route_id = $_POST['_itinerary_route_id'];
        $_vendor_id = $_POST['_vendor_id'];
        $_vehicle_type_id = $_POST['_vehicle_type_id'];
        $_vehicle_type_qty = $_POST['_vehicle_count'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            $select_confirmed_itinerary_plan_vendor_eligible_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_vendor_eligible_ID`, `itinerary_plan_vendor_eligible_ID`, `itineary_plan_assigned_status`, `itinerary_plan_id`, `vehicle_type_id`, `total_vehicle_qty`, `vendor_id`, `outstation_allowed_km_per_day`, `vendor_vehicle_type_id`, `vehicle_id`, `vendor_branch_id`, `vehicle_orign`, `vehicle_count`, `total_kms`, `total_outstation_km`, `total_time`, `total_rental_charges`, `total_toll_charges`, `total_parking_charges`, `total_driver_charges`, `total_permit_charges`, `total_before_6_am_extra_time`, `total_after_8_pm_extra_time`, `total_before_6_am_charges_for_driver`, `total_before_6_am_charges_for_vehicle`, `total_after_8_pm_charges_for_driver`, `total_after_8_pm_charges_for_vehicle`, `extra_km_rate`, `total_allowed_kms`, `total_extra_kms`, `total_extra_kms_charge`, `total_allowed_local_kms`, `total_extra_local_kms`, `total_extra_local_kms_charge`, `vehicle_gst_type`, `vehicle_gst_percentage`, `vehicle_gst_amount`, `vehicle_total_amount`, `vendor_margin_percentage`, `vendor_margin_gst_type`, `vendor_margin_gst_percentage`, `vendor_margin_amount`, `vendor_margin_gst_amount`, `vehicle_grand_total`, `cancellation_status`, `vehicle_defect_type` FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$_itinerary_plan_ID' AND `vendor_id` = '$_vendor_id' AND `vehicle_type_id` = '$_vehicle_type_id' ORDER BY `confirmed_itinerary_plan_vendor_eligible_ID` ASC LIMIT 1") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());

            $select_itineary_route_plan_details = sqlQUERY_LABEL("SELECT `itinerary_route_ID`, `location_id`, `location_name`, `itinerary_route_date`, `no_of_km`, `next_visiting_location`, `direct_to_next_visiting_place`, `route_start_time`, `route_end_time` FROM `dvi_confirmed_itinerary_route_details` WHERE `itinerary_plan_ID` = '$_itinerary_plan_ID' and `status` = '1' and `deleted` = '0' ORDER BY `itinerary_route_ID` ASC") or die("#1-UNABLE_TO_COLLECT_ROUTE_LIST:" . sqlERROR_LABEL());
            $total_no_of_itineary_plan_route_details = sqlNUMOFROW_LABEL($select_itineary_route_plan_details);

            $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT `confirmed_itinerary_plan_vendor_vehicle_details_ID`, `itinerary_plan_vendor_vehicle_details_ID`, `itinerary_plan_vendor_eligible_ID`,`confirmed_itinerary_plan_vendor_eligible_ID`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `vehicle_type_id`, `vehicle_qty`, `vendor_id`, `vendor_vehicle_type_id`, `vehicle_id`, `vendor_branch_id`, `time_limit_id`, `travel_type`, `itinerary_route_location_from`, `itinerary_route_location_to`, `total_running_km`, `total_running_time`, `total_siteseeing_km`, `total_siteseeing_time`, `total_pickup_km`, `total_pickup_duration`, `total_drop_km`, `total_drop_duration`, `total_extra_km`, `extra_km_rate`, `total_extra_km_charges`, `total_travelled_km`, `total_travelled_time`, `vehicle_rental_charges`, `vehicle_toll_charges`, `vehicle_parking_charges`, `vehicle_driver_charges`, `vehicle_permit_charges`, `before_6_am_extra_time`, `after_8_pm_extra_time`, `before_6_am_charges_for_driver`, `before_6_am_charges_for_vehicle`, `after_8_pm_charges_for_driver`, `after_8_pm_charges_for_vehicle`, `total_vehicle_amount`, `driver_start_km`, `driver_end_km`, `driver_opening_km`, `opening_speedmeter_image`, `driver_closing_km`, `closing_speedmeter_image`, `cancellation_status`, `defect_type` FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `itinerary_plan_id` = '$_itinerary_plan_ID' AND `vendor_id` = '$_vendor_id' AND `vehicle_type_id` = '$_vehicle_type_id' ORDER BY `confirmed_itinerary_plan_vendor_vehicle_details_ID` ASC LIMIT $total_no_of_itineary_plan_route_details") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());

            while ($fetch_select_confirmed_itinerary_plan_vendor_eligible_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_vendor_eligible_details)) :
                $_itineary_plan_assigned_status = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['itineary_plan_assigned_status'];
                $_itinerary_plan_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['itinerary_plan_id'];
                $_vehicle_type_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_type_id'];
                $_total_vehicle_qty = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_vehicle_qty'];
                $_vendor_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_id'];
                $_outstation_allowed_km_per_day = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['outstation_allowed_km_per_day'];
                $_vendor_vehicle_type_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_vehicle_type_id'];
                $_vehicle_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_id'];
                $_vendor_branch_id = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_branch_id'];
                $_vehicle_orign = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_orign'];
                $_vehicle_count = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_count'];
                $_total_kms = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_kms'];
                $_total_outstation_km = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_outstation_km'];
                $_total_time = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_time'];
                $_total_rental_charges = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_rental_charges'];
                $_total_toll_charges = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_toll_charges'];
                $_total_parking_charges = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_parking_charges'];
                $_total_driver_charges = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_driver_charges'];
                $_total_permit_charges = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_permit_charges'];
                $_total_before_6_am_extra_time = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_before_6_am_extra_time'];
                $_total_after_8_pm_extra_time = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_after_8_pm_extra_time'];
                $_total_before_6_am_charges_for_driver = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_before_6_am_charges_for_driver'];
                $_total_before_6_am_charges_for_vehicle = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_before_6_am_charges_for_vehicle'];
                $_total_after_8_pm_charges_for_driver = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_after_8_pm_charges_for_driver'];
                $_total_after_8_pm_charges_for_vehicle = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_after_8_pm_charges_for_vehicle'];
                $_extra_km_rate = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['extra_km_rate'];
                $_total_allowed_kms = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_allowed_kms'];
                $_total_extra_kms = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_extra_kms'];
                $_total_extra_kms_charge = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_extra_kms_charge'];
                $_total_allowed_local_kms = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_allowed_local_kms'];
                $_total_extra_local_kms = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_extra_local_kms'];
                $_total_extra_local_kms_charge = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['total_extra_local_kms_charge'];
                $_vehicle_gst_type = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_gst_type'];
                $_vehicle_gst_percentage = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_gst_percentage'];
                $_vehicle_gst_amount = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_gst_amount'];
                $_vehicle_total_amount = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_total_amount'];
                $_vendor_margin_percentage = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_margin_percentage'];
                $_vendor_margin_gst_type = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_margin_gst_type'];
                $_vendor_margin_gst_percentage = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_margin_gst_percentage'];
                $_vendor_margin_amount = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_margin_amount'];
                $_vendor_margin_gst_amount = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vendor_margin_gst_amount'];
                $_vehicle_grand_total = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_grand_total'];
                $_cancellation_status = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['cancellation_status'];
                $_vehicle_defect_type = $fetch_select_confirmed_itinerary_plan_vendor_eligible_data['vehicle_defect_type'];
            endwhile;
            for ($i = 1; $i <= $_vehicle_type_qty; $i++) :

                //INSERT INTO ITINEARY PLAN VEHICLE DETAILS TABLE
                $confirmed_itinerary_plan_vehicle_details_arrFields = array( '`itinerary_plan_id`', '`vehicle_type_id`', '`vehicle_count`',  '`added_via_amendment`', '`createdby`', '`status`');
                $confirmed_itinerary_plan_vehicle_details_arrValues = array("$_itinerary_plan_id", "$_vehicle_type_id","$_total_vehicle_qty", "1", "$logged_user_id", "1");
                if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vehicle_details", $confirmed_itinerary_plan_vehicle_details_arrFields, $confirmed_itinerary_plan_vehicle_details_arrValues, '')) :
                endif;


                $confirmed_vehicle_arrFields = array('`itineary_plan_assigned_status`', '`itinerary_plan_id`', '`vehicle_type_id`', '`total_vehicle_qty`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`', '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`', '`cancellation_status`', '`added_via_amendment`','`vehicle_defect_type`', '`status`');

                $confirmed_vehicle_arrValues = array("$_itineary_plan_assigned_status", "$_itinerary_plan_id", "$_vehicle_type_id", "$_total_vehicle_qty", "$_vendor_id", "$_outstation_allowed_km_per_day", "$_vendor_vehicle_type_id", "$_vehicle_id", "$_vendor_branch_id", "$_vehicle_orign", "$_vehicle_count", "$_total_kms", "$_total_outstation_km", "$_total_time", "$_total_rental_charges", "$_total_toll_charges", "$_total_parking_charges", "$_total_driver_charges", "$_total_permit_charges", "$_total_before_6_am_extra_time", "$_total_after_8_pm_extra_time", "$_total_before_6_am_charges_for_driver", "$_total_before_6_am_charges_for_vehicle", "$_total_after_8_pm_charges_for_driver", "$_total_after_8_pm_charges_for_vehicle", "$_extra_km_rate", "$_total_allowed_kms", "$_total_extra_kms", "$_total_extra_kms_charge", "$_total_allowed_local_kms", "$_total_extra_local_kms", "$_total_extra_local_kms_charge", "$_vehicle_gst_type", "$_vehicle_gst_percentage", "$_vehicle_gst_amount", "$_vehicle_total_amount", "$_vendor_margin_percentage", "$_vendor_margin_gst_type", "$_vendor_margin_gst_percentage", "$_vendor_margin_amount", "$_vendor_margin_gst_amount", "$_vehicle_grand_total", "$_cancellation_status", "1","$_vehicle_defect_type", "1");

                if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $confirmed_vehicle_arrFields, $confirmed_vehicle_arrValues, '')) :
                    $confirmed_itinerary_plan_vendor_eligible_list_itinerary_ID  = sqlINSERTID_LABEL();

                    $arrFields_vehicle_details = array('`confirmed_itinerary_plan_vendor_eligible_ID`', '`itineary_plan_assigned_status`', '`itinerary_plan_id`', '`vehicle_type_id`', '`total_vehicle_qty`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`', '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`','`added_via_amendment`', '`createdby`', '`status`');

                    $arrValues_vehicle_details = array("$confirmed_itinerary_plan_vendor_eligible_list_itinerary_ID", "$_itineary_plan_assigned_status", "$_itinerary_plan_id", "$_vehicle_type_id", "$_total_vehicle_qty", "$_vendor_id", "$_outstation_allowed_km_per_day", "$_vendor_vehicle_type_id", "$_vehicle_id", "$_vendor_branch_id", "$_vehicle_orign", "$_vehicle_count",  "$_total_kms", "$_total_outstation_km", "$_total_time", "$_total_rental_charges", "$_total_toll_charges", "$_total_parking_charges", "$_total_driver_charges", "$_total_permit_charges", "$_total_before_6_am_extra_time", "$_total_after_8_pm_extra_time", "$_total_before_6_am_charges_for_driver", "$_total_before_6_am_charges_for_vehicle", "$_total_after_8_pm_charges_for_driver", "$_total_after_8_pm_charges_for_vehicle", "$_extra_km_rate", "$_total_allowed_kms", "$_total_extra_kms", "$_total_extra_kms_charge", "$_total_allowed_local_kms", "$_total_extra_local_kms", "$_total_extra_local_kms_charge", "$_vehicle_gst_type", "$_vehicle_gst_percentage", "$_vehicle_gst_amount", "$_vehicle_total_amount", "$_vendor_margin_percentage", "$_vendor_margin_gst_type", "$_vendor_margin_gst_percentage", "$_vendor_margin_amount", "$_vendor_margin_gst_amount", "$_vehicle_grand_total","1", "$logged_user_id", "1");
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $arrFields_vehicle_details, $arrValues_vehicle_details, '')) :
                        $cancelled_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();
                    endif;


                endif;

                while ($fetch_select_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
                    $_itinerary_plan_id = $fetch_select_confirmed_itinerary_vehicle_data['itinerary_plan_id'];
                    $_itinerary_route_id = $fetch_select_confirmed_itinerary_vehicle_data['itinerary_route_id'];
                    $_itinerary_route_date = $fetch_select_confirmed_itinerary_vehicle_data['itinerary_route_date'];
                    $_vehicle_type_id = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_type_id'];
                    $_vehicle_qty = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_qty'];
                    $_vendor_id = $fetch_select_confirmed_itinerary_vehicle_data['vendor_id'];
                    $_vendor_vehicle_type_id = $fetch_select_confirmed_itinerary_vehicle_data['vendor_vehicle_type_id'];
                    $_vehicle_id = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_id'];
                    $_vendor_branch_id = $fetch_select_confirmed_itinerary_vehicle_data['vendor_branch_id'];
                    $_time_limit_id = $fetch_select_confirmed_itinerary_vehicle_data['time_limit_id'];
                    $_travel_type = $fetch_select_confirmed_itinerary_vehicle_data['travel_type'];
                    $_itinerary_route_location_from = $fetch_select_confirmed_itinerary_vehicle_data['itinerary_route_location_from'];
                    $_itinerary_route_location_to = $fetch_select_confirmed_itinerary_vehicle_data['itinerary_route_location_to'];
                    $_total_running_km = $fetch_select_confirmed_itinerary_vehicle_data['total_running_km'];
                    $_total_running_time = $fetch_select_confirmed_itinerary_vehicle_data['total_running_time'];
                    $_total_siteseeing_km = $fetch_select_confirmed_itinerary_vehicle_data['total_siteseeing_km'];
                    $_total_siteseeing_time = $fetch_select_confirmed_itinerary_vehicle_data['total_siteseeing_time'];
                    $_total_pickup_km = $fetch_select_confirmed_itinerary_vehicle_data['total_pickup_km'];
                    $_total_pickup_duration = $fetch_select_confirmed_itinerary_vehicle_data['total_pickup_duration'];
                    $_total_drop_km = $fetch_select_confirmed_itinerary_vehicle_data['total_drop_km'];
                    $_total_drop_duration = $fetch_select_confirmed_itinerary_vehicle_data['total_drop_duration'];
                    $_total_extra_km = $fetch_select_confirmed_itinerary_vehicle_data['total_extra_km'];
                    $_extra_km_rate = $fetch_select_confirmed_itinerary_vehicle_data['extra_km_rate'];
                    $_total_extra_km_charges = $fetch_select_confirmed_itinerary_vehicle_data['total_extra_km_charges'];
                    $_total_travelled_km = $fetch_select_confirmed_itinerary_vehicle_data['total_travelled_km'];
                    $_total_travelled_time = $fetch_select_confirmed_itinerary_vehicle_data['total_travelled_time'];
                    $_vehicle_rental_charges = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_rental_charges'];
                    $_vehicle_toll_charges = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_toll_charges'];
                    $_vehicle_parking_charges = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_parking_charges'];
                    $_vehicle_driver_charges = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_driver_charges'];
                    $_vehicle_permit_charges = $fetch_select_confirmed_itinerary_vehicle_data['vehicle_permit_charges'];
                    $_before_6_am_extra_time = $fetch_select_confirmed_itinerary_vehicle_data['before_6_am_extra_time'];
                    $_after_8_pm_extra_time = $fetch_select_confirmed_itinerary_vehicle_data['after_8_pm_extra_time'];
                    $_before_6_am_charges_for_driver = $fetch_select_confirmed_itinerary_vehicle_data['before_6_am_charges_for_driver'];
                    $_before_6_am_charges_for_vehicle = $fetch_select_confirmed_itinerary_vehicle_data['before_6_am_charges_for_vehicle'];
                    $_after_8_pm_charges_for_driver = $fetch_select_confirmed_itinerary_vehicle_data['after_8_pm_charges_for_driver'];
                    $_after_8_pm_charges_for_vehicle = $fetch_select_confirmed_itinerary_vehicle_data['after_8_pm_charges_for_vehicle'];
                    $_total_vehicle_amount = $fetch_select_confirmed_itinerary_vehicle_data['total_vehicle_amount'];
                    $_driver_start_km = $fetch_select_confirmed_itinerary_vehicle_data['driver_start_km'];
                    $_driver_end_km = $fetch_select_confirmed_itinerary_vehicle_data['driver_end_km'];
                    $_driver_opening_km = $fetch_select_confirmed_itinerary_vehicle_data['driver_opening_km'];
                    $_opening_speedmeter_image = $fetch_select_confirmed_itinerary_vehicle_data['opening_speedmeter_image'];
                    $_driver_closing_km = $fetch_select_confirmed_itinerary_vehicle_data['driver_closing_km'];
                    $_closing_speedmeter_image = $fetch_select_confirmed_itinerary_vehicle_data['closing_speedmeter_image'];
                    $_cancellation_status = $fetch_select_confirmed_itinerary_vehicle_data['cancellation_status'];
                    $_defect_type = $fetch_select_confirmed_itinerary_vehicle_data['defect_type'];

                    $confirmed_vehicle_arrFields_data = array('`confirmed_itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`vehicle_type_id`', '`vehicle_qty`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`driver_start_km`', '`driver_end_km`', '`driver_opening_km`', '`opening_speedmeter_image`', '`driver_closing_km`', '`closing_speedmeter_image`', '`cancellation_status`', '`added_via_amendment`','`defect_type`');

                    $confirmed_vehicle_arrValues_data = array("$confirmed_itinerary_plan_vendor_eligible_list_itinerary_ID", "$_itinerary_plan_id", "$_itinerary_route_id", "$_itinerary_route_date", "$_vehicle_type_id", "$_vehicle_qty", "$_vendor_id", "$_vendor_vehicle_type_id", "$_vehicle_id", "$_vendor_branch_id", "$_time_limit_id", "$_travel_type", "$_itinerary_route_location_from", "$_itinerary_route_location_to", "$_total_running_km", "$_total_running_time", "$_total_siteseeing_km", "$_total_siteseeing_time", "$_total_pickup_km", "$_total_pickup_duration", "$_total_drop_km", "$_total_drop_duration", "$_total_extra_km", "$_extra_km_rate", "$_total_extra_km_charges", "$_total_travelled_km", "$_total_travelled_time", "$_vehicle_rental_charges", "$_vehicle_toll_charges", "$_vehicle_parking_charges", "$_vehicle_driver_charges", "$_vehicle_permit_charges", "$_before_6_am_extra_time", "$_after_8_pm_extra_time", "$_before_6_am_charges_for_driver", "$_before_6_am_charges_for_vehicle", "$_after_8_pm_charges_for_driver", "$_after_8_pm_charges_for_vehicle", "$_total_vehicle_amount", "$_driver_start_km", "$_driver_end_km", "$_driver_opening_km", "$_opening_speedmeter_image", "$_driver_closing_km", "$_closing_speedmeter_image", "$_cancellation_status","1", "$_defect_type");

                    // Insert into database
                    if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $confirmed_vehicle_arrFields_data, $confirmed_vehicle_arrValues_data, '')) :
                        $confirmed_itinerary_plan_vendor_vehicle_details_ID = sqlINSERTID_LABEL();
                        $arrFields_vehicle_vendor_details = array('`confirmed_itinerary_plan_vendor_vehicle_details_ID`', '`cancelled_itinerary_plan_vendor_eligible_ID`',  '`confirmed_itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`vehicle_type_id`', '`vehicle_qty`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`driver_opening_km`', '`opening_speedmeter_image`', '`added_via_amendment`','`driver_closing_km`', '`closing_speedmeter_image`', '`createdby`', '`status`');

                        $arrValues_vehicle_vendor_details = array("$confirmed_itinerary_plan_vendor_vehicle_details_ID", "$cancelled_itinerary_plan_vendor_eligible_ID", "$confirmed_itinerary_plan_vendor_eligible_list_itinerary_ID", "$_itinerary_plan_id", "$_itinerary_route_id", "$_itinerary_route_date", "$_vehicle_type_id", "$_vehicle_qty", "$_vendor_id", "$_vendor_vehicle_type_id", "$_vehicle_id", "$_vendor_branch_id", "$_time_limit_id", "$_travel_type", "$_itinerary_route_location_from", "$_itinerary_route_location_to", "$_total_running_km", "$_total_running_time", "$_total_siteseeing_km", "$_total_siteseeing_time", "$_total_pickup_km", "$_total_pickup_duration", "$_total_drop_km", "$_total_drop_duration", "$_total_extra_km", "$_extra_km_rate", "$_total_extra_km_charges", "$_total_travelled_km", "$_total_travelled_time", "$_vehicle_rental_charges", "$_vehicle_toll_charges", "$_vehicle_parking_charges", "$_vehicle_driver_charges", "$_vehicle_permit_charges", "$_before_6_am_extra_time", "$_after_8_pm_extra_time", "$_before_6_am_charges_for_driver", "$_before_6_am_charges_for_vehicle", "$_after_8_pm_charges_for_driver", "$_after_8_pm_charges_for_vehicle", "$_total_vehicle_amount", "$_driver_opening_km", "$_opening_speedmeter_image", "1", "$_driver_closing_km", "$_closing_speedmeter_image", "$logged_user_id", "1");

                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_vehicle_details", $arrFields_vehicle_vendor_details, $arrValues_vehicle_vendor_details, '')) :
                        endif;
                    endif;

                endwhile;
            endfor;

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_vehicle_type_cancellation_details_form'):

        $itinerary_plan_ID = $_GET['itinerary_plan_ID'];
        $vendor_id = $_GET['vendor_id'];
        $vehicle_type_id = $_GET['vehicle_type_id'];

        $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`) AS TOTAL_VEHICLE_QTY,  SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`) AS VEHICLE_GRAND_TOTAL FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` = '$vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
            $vendor_name = $fetch_confirmed_itinerary_vehicle_data['vendor_name'];
            $vendor_branch_name = $fetch_confirmed_itinerary_vehicle_data['vendor_branch_name'];
            $vehicle_type_title = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_title'];
            $TOTAL_VEHICLE_QTY = $fetch_confirmed_itinerary_vehicle_data['TOTAL_VEHICLE_QTY'];
            $VEHICLE_GRAND_TOTAL = round($fetch_confirmed_itinerary_vehicle_data['VEHICLE_GRAND_TOTAL']);
        endwhile;
    ?>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Vehicle Type "<?= $vehicle_type_title; ?>" Cancellation Summary</strong>
                </h5>
                <p class="mb-4 text-muted">
                    A detailed breakdown of the vehicle type <?= $vehicle_type_title; ?> cancellation charges, including services, <br> rates, cancellation fees, and total refunds.
                </p>
            </div>

            <!-- Room Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Vendor Name / Branch Name :</strong>
                    <span><?= htmlspecialchars($vendor_name); ?> / <?= htmlspecialchars($vendor_branch_name); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Total Qty:</strong>
                    <span><?= htmlspecialchars($TOTAL_VEHICLE_QTY); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <!-- Cancellation Details Table -->
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-responsive">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th class="text-start">Service</th>
                            <th class="text-end">Rate</th>
                            <th class="text-end">Cancellation Fee (%)</th>
                            <th class="text-end">Total Refund</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $select_cancelled_itinerary_vehicle_type_details = sqlQUERY_LABEL("SELECT VEHICLE_TYPE.`vehicle_type_title`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`, ITINEARY_PLAN_VEHICLE_DETAILS.`cancelled_on`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_defect_type`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_percentage`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_cancelled_service_amount`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_cancellation_charge`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_refund_amount` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` = '$vehicle_type_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
                        while ($fetch_cancelled_itinerary_vehicle_type_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_vehicle_type_details)) :
                            $vehicle_type_title = $fetch_cancelled_itinerary_vehicle_type_data['vehicle_type_title'];
                            $total_vehicle_qty = $fetch_cancelled_itinerary_vehicle_type_data['total_vehicle_qty'];
                            $vehicle_grand_total = $fetch_cancelled_itinerary_vehicle_type_data['vehicle_grand_total'];
                            $cancelled_on = $fetch_cancelled_itinerary_vehicle_type_data['cancelled_on'];
                            $vehicle_defect_type = $fetch_cancelled_itinerary_vehicle_type_data['vehicle_defect_type'];
                            $vehicle_cancellation_percentage = $fetch_cancelled_itinerary_vehicle_type_data['vehicle_cancellation_percentage'];
                            $total_vehicle_cancelled_service_amount = $fetch_cancelled_itinerary_vehicle_type_data['total_vehicle_cancelled_service_amount'];
                            $total_vehicle_cancellation_charge = $fetch_cancelled_itinerary_vehicle_type_data['total_vehicle_cancellation_charge'];
                            $total_vehicle_refund_amount = $fetch_cancelled_itinerary_vehicle_type_data['total_vehicle_refund_amount'];
                            $overall_total_vehicle_type_rate += $total_vehicle_cancelled_service_amount;
                            $overall_total_vehicle_type_cancellation_charge += $total_vehicle_cancellation_charge;
                            $overall_total_vehicle_type_refund_amount += $total_vehicle_refund_amount;
                        ?>
                            <tr>
                                <td>
                                    <span><?= $vehicle_type_title; ?> * <?= $total_vehicle_qty; ?></span><br>
                                    <span style="font-size: 0.8em; line-height: 1.2;">
                                        <span style="display: block; font-size: 0.9em;">Defect Type: <?= getCNCELLATION_DEFECT_TYPE($vehicle_defect_type, 'label'); ?></span>
                                        <span style="display: block; font-size: 0.9em;">Cancl. On: <?= date('D M, Y \a\t h:i A', strtotime($cancelled_on)); ?></span>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <?= general_currency_symbol . ' ' . number_format(($total_vehicle_cancelled_service_amount), 2); ?>
                                </td>
                                <td class="text-end">
                                    <span><?= general_currency_symbol . ' ' . number_format($total_vehicle_cancellation_charge, 2); ?></span><br>
                                    <span style="font-size: 0.8em; line-height: 1.2;">
                                        <span style="display: block; font-size: 0.9em;">(Cancl.Perctange: <?= $vehicle_cancellation_percentage; ?>%)</span>
                                    </span>
                                </td>
                                <td class="text-end"><?= general_currency_symbol . ' ' . number_format($total_vehicle_refund_amount, 2); ?></td>
                            </tr>
                        <?php endwhile; ?>
                    </tbody>
                </table>
            </div>

            <!-- Total Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="border p-3 rounded shadow-sm">
                        <h5 class="text-center">Total Cancellation Summary</h5>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Cancelled Service Cost:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($overall_total_vehicle_type_rate, 2); ?></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Total Cancellation Fee:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span><?= general_currency_symbol . ' ' . number_format($overall_total_vehicle_type_cancellation_charge, 2); ?></span>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Total Refund:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span class="text-success"><strong><?= general_currency_symbol . ' ' . number_format($overall_total_vehicle_type_refund_amount, 2); ?></strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <?php
    elseif ($_GET['type'] == 'show_vendor_vehicles_cancel_form'):

        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $vendor_id = $_GET['vendor_id'];

        $select_itinerary_vendor_vehicle_cancellation_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`) AS TOTAL_VEHICLE_QTY, SUM(ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`) AS VEHICLE_GRAND_TOTAL FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$vendor_id' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_VENDOR_VEHICLE_LIST:" . sqlERROR_LABEL());

        if (sqlNUMOFROW_LABEL($select_itinerary_vendor_vehicle_cancellation_details) > 0) :
            while ($fetch_itinerary_vendor_vehicle_details_data = sqlFETCHARRAY_LABEL($select_itinerary_vendor_vehicle_cancellation_details)) :
                $vendor_name = $fetch_itinerary_vendor_vehicle_details_data['vendor_name'];
                $vendor_branch_name = $fetch_itinerary_vendor_vehicle_details_data['vendor_branch_name'];
                $TOTAL_VEHICLE_QTY = $fetch_itinerary_vendor_vehicle_details_data['TOTAL_VEHICLE_QTY'];
                $VEHICLE_GRAND_TOTAL = round($fetch_itinerary_vendor_vehicle_details_data['VEHICLE_GRAND_TOTAL']);
            endwhile;
        endif;

        $get_cancellation_percentage_value = $_GET['cancellation_percentage'];

        if ($get_cancellation_percentage_value == '' || $get_cancellation_percentage_value == '0'):
            $select_itinerary_vehicle_voucher_cancellation_data = sqlQUERY_LABEL("SELECT MAX(`cancellation_percentage`) AS cancellation_percentage FROM `dvi_confirmed_itinerary_plan_vehicle_cancellation_policy` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `vendor_id` = '$vendor_id' AND `status` = '1' AND `deleted` = '0' AND `cancellation_date` <= CURRENT_DATE ORDER BY `cancellation_date` DESC LIMIT 1") or die("#1-UNABLE_TO_COLLECT_ITINERARY_VEHICLE_LIST:" . sqlERROR_LABEL());

            $total_vehicle_voucher_details_count = sqlNUMOFROW_LABEL($select_itinerary_vehicle_voucher_cancellation_data);
            if ($total_vehicle_voucher_details_count > 0) :
                while ($fetch_itinerary_vehicle_voucher_details_data = sqlFETCHARRAY_LABEL($select_itinerary_vehicle_voucher_cancellation_data)) :
                    $cancellation_percentage_value = $fetch_itinerary_vehicle_voucher_details_data['cancellation_percentage'];
                endwhile;
            else:
                $cancellation_percentage_value = 0;
            endif;
        else:
            $cancellation_percentage_value = $get_cancellation_percentage_value;
        endif;


    ?>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Vendor Vehicle Cancellation Summary</strong>
                </h5>
                <p class="mb-4 text-muted">
                    A detailed breakdown of the vendor vehicle cancellation charges, including all the services, <br> rates, cancellation fees, and total refunds.
                </p>
            </div>

            <!-- Vendor Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Vendor / Branch:</strong>
                    <span><?= htmlspecialchars($vendor_name); ?> / <?= htmlspecialchars($vendor_branch_name); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Total Vehicles:</strong>
                    <span><?= $TOTAL_VEHICLE_QTY; ?></span>
                </div>
            </div>

            <hr class="my-3">
            <form action="" data-parsley-validate method="post">
                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">
                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <strong><?= general_currency_symbol . ' ' . number_format($VEHICLE_GRAND_TOTAL, 2); ?></strong>
                        <input type="hidden" id="total_cancellation_services_amount_4" value="<?= ($VEHICLE_GRAND_TOTAL); ?>">
                    </div>

                    <!-- Cancellation Percentage and Defect Type -->
                    <div class="col-md-4 mt-3">
                        <label for="cancellation_percentage_4" class="form-label"><strong>Cancellation Percentage:</strong></label>
                        <input type="number" placeholder="Enter Percentage %" id="cancellation_percentage_4" class="form-control" value="<?= $cancellation_percentage_value; ?>" required min="0" max="100" oninput="updateCancellationCharges_4()">
                    </div>
                    <div class="col-md-4 mt-3">
                        <label for="defect_type" class="form-label"><strong>Defect Type:</strong></label>
                        <select id="defect_type" required class="form-select" onchange="updateCancellationCharges_4()">
                            <?= getCNCELLATION_DEFECT_TYPE($defect_type, 'select'); ?>
                        </select>
                    </div>
                    <div class="col-md-4 mt-3 text-end">
                        <label for="total_refund_4" class="form-label"><strong>Total Refund:</strong></label>
                        <div>
                            <h3 id="total_refund_4"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></h3>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- Cancellation Confirmation and Detailed Message -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-warning p-4 rounded">
                            <p class="mb-2">Please review all the details carefully before proceeding with the cancellation. This cancellation applies to all vehicle types under this vendor. A cancellation fee will be incurred, and any changes made will affect the final charge. Kindly verify all listed items before confirming the cancellation.</p>
                        </div>
                    </div>
                </div>

                <!-- Final Confirmation Alert -->
                <div class="text-center">
                    <p class="fw-bold text-danger">
                        <i class="bi bi-exclamation-circle-fill"></i> Are you sure you want to cancel all vehicles under "<?= htmlspecialchars($vendor_name); ?>"? <br> This will incur a <span id="calculated_cancellation_charges_4"><?= general_currency_symbol . ' ' . number_format(0, 2); ?></span> cancellation fee.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="button" onclick="confirmCANCELVENDORVEHICLES('<?= $itinerary_plan_id; ?>','<?= $vendor_id; ?>')" class="btn btn-danger">Confirm Cancellation</button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                updateCancellationCharges_4();
            });

            function updateCancellationCharges_4() {
                // Get the total cost (including room cost, GST, and service charges)
                const totalCost = parseFloat(document.getElementById('total_cancellation_services_amount_4').value) || 0;

                // Get the cancellation percentage input value
                let cancellationPercentage = parseFloat(document.getElementById('cancellation_percentage_4').value) || 0;

                // Ensure the cancellation percentage doesn't exceed 100%
                if (cancellationPercentage > 100) {
                    cancellationPercentage = 100; // Set to 100 if greater than 100
                    document.getElementById('cancellation_percentage_4').value = 100; // Update the input field
                }

                // Calculate the cancellation charges based on the percentage
                const cancellationCharges = (totalCost * cancellationPercentage) / 100;

                // Define a valid currency code (e.g., 'USD', 'INR', 'EUR')
                const currencyCode = "INR"; // Change this dynamically if needed

                // Use Intl.NumberFormat to format the price
                const formattedCancellationCharges = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(cancellationCharges);

                // Update the cancellation charges display
                document.getElementById('calculated_cancellation_charges_4').innerText = formattedCancellationCharges;

                // Calculate the total refund (total cost minus cancellation charges)
                const totalRefund = totalCost - cancellationCharges;

                // Format the total refund
                const formattedTotalRefund = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currencyCode, // Ensure a valid currency code is used
                }).format(totalRefund);

                console.log("Total Cost:", totalCost);
                console.log("Cancellation Charges:", cancellationCharges);
                console.log("Total Refund:", totalRefund);

                // Update the total cancellation charges display
                document.getElementById('total_refund_4').innerText = formattedTotalRefund;
            }


            $('#cancellation_percentage_4').on('click', function() {
                $(this).select();
            });

            // Keyup validation for percentage field to limit input between 0 and 100
            $('#cancellation_percentage_4').on('keyup', function() {
                var value = $(this).val();
                // Ensure value is between 0 and 100
                if (value < 0) {
                    $(this).val(0);
                } else if (value > 100) {
                    $(this).val(100);
                }
            });

            function confirmCANCELVENDORVEHICLES(itinerary_plan_id, vendor_id) {
                var cancellation_percentage = document.getElementById('cancellation_percentage_4').value;
                var defect_type = document.getElementById('defect_type').value;

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=confirm_vendor_vehicles_cancellation",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_id,
                        _vendor_id: vendor_id,
                        _cancellation_percentage: cancellation_percentage,
                        _defect_type: defect_type,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.itinerary_cancellation_percentage_required) {
                                TOAST_NOTIFICATION('warning', 'Cancellation percentage Required', 'Warning !!!');
                            }
                            if (response.errors.defect_type_required) {
                                TOAST_NOTIFICATION('warning', 'Defect Type is Required', 'Warning !!!');
                            }
                        } else {
                            $('#showCANCELALLVENDORVEHICLESFORMDATA').modal('hide');
                            TOAST_NOTIFICATION('success', 'Successfully Cancelled', 'Success !!!');

                            show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_id, vendor_id);

                            response.confirmed_itinerary_plan_vendor_eligible_ID.forEach(function(cnf_Itineary_plan_eligible_ID) {
                                var htmlResponseKey = 'html_response_' + cnf_Itineary_plan_eligible_ID;
                                if (response[htmlResponseKey]) {
                                    $('#response_' + cnf_Itineary_plan_eligible_ID).html(response[htmlResponseKey]);
                                }
                            });

                            response.vehicle_type_id.forEach(function(vehicle_type_ID) {
                                var htmlResponseKey = 'html_vehicle_response_' + itinerary_plan_id + '_' + vendor_id + '_' + vehicle_type_ID;
                                if (response[htmlResponseKey]) {
                                    $('#response_vehicle_' + itinerary_plan_id + '_' + vendor_id + '_' + vehicle_type_ID).html(response[htmlResponseKey]);
                                }
                            });

                            if (response.response_all_vendor_vehicle_cancel_check) {
                                $('#response_all_vendor_vehicle_cancel_check_' + response.vendor_id).html('');
                                $('#vendor_heading_' + response.vendor_id).html(response.response_according_header);
                            }
                              setTimeout(() => {
                                    location.reload();
                                }, 2000);
                        }
                    }
                });
            }

            function show_VEHICLE_CANCELLATION_SUMMARY(itinerary_plan_ID, vendor_ID) {
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_itinerary_vehicle_cancellation_vehicle_summary.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                        _vendor_ID: vendor_ID
                    },
                    success: function(response) {
                        $('.show_vehicle_cancellation_summary').html('');
                        $('.show_vehicle_cancellation_summary').html(response);
                    }
                });
            }
        </script>

        <!-- add vehicle type -->
    <?php
    elseif ($_GET['type'] == 'show_vendor_vehicles_add_form'):

        $itinerary_plan_ID = $_GET['itinerary_plan_id'];
        $vendor_id = $_GET['vendor_id'];
        $selected_vendor_name = getVENDORANDVEHICLEDETAILS($vendor_id, 'get_vendorname_from_vendorid', '');

        $array_of_location_name = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_location_name', '');
        $array_of_next_visiting_location = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_next_visiting_location', '');

        $eligible_vehicle_location = array_merge($array_of_location_name, $array_of_next_visiting_location);

        $get_eligible_location_citys = getSTOREDLOCATIONDETAILS($eligible_vehicle_location, 'get_location_city_from_location_name');

        $get_implode_eligible_location_CITYS = implode("','", $get_eligible_location_citys);

        $select_itineary_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id`, SUM(`vehicle_count`) AS vehicle_count FROM `dvi_confirmed_itinerary_plan_vehicle_details`  WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
        $total_no_of_vehicle_count = sqlNUMOFROW_LABEL($select_itineary_vehicle_details);
        if ($total_no_of_vehicle_count > 0) :
            while ($fetch_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_vehicle_details)) :
                $selected_vehicle_type_id[] = $fetch_vehicle_data['vehicle_type_id'];
                $selected_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
                $selected_vehicle_count[] = $fetch_vehicle_data['vehicle_count'];
            endwhile;
        endif;

        $select_itineary_route_plan_locations_wise_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_margin`, VENDOR_DETAILS.`vendor_margin_gst_type`, VENDOR_DETAILS.`vendor_margin_gst_percentage`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst_type`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst`, VENDOR_DETAILS.`vendor_name`, VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID`, VENDOR_VEHICLE_TYPES.`vehicle_type_id`, VENDOR_VEHICLE_TYPES.`driver_batta`, VENDOR_VEHICLE_TYPES.`food_cost`, VENDOR_VEHICLE_TYPES.`accomodation_cost`, VENDOR_VEHICLE_TYPES.`extra_cost`, VENDOR_VEHICLE_TYPES.`driver_early_morning_charges`, VENDOR_VEHICLE_TYPES.`driver_evening_charges`, VEHICLE.`vehicle_location_id`, VEHICLE.`registration_number`, VEHICLE.`vendor_id`, VEHICLE.`vehicle_id`, VEHICLE.`vendor_branch_id`, VEHICLE.`vehicle_fc_expiry_date`, VEHICLE.`insurance_end_date`, VEHICLE.`owner_city`,VEHICLE.`extra_km_charge`, STORED_LOCATION.`source_location_lattitude`, STORED_LOCATION.`source_location_longitude`, STORED_LOCATION.`destination_location_lattitude`, STORED_LOCATION.`destination_location_longitude`, VEHICLE.`early_morning_charges`, VEHICLE.`evening_charges` FROM `dvi_stored_locations` AS STORED_LOCATION LEFT JOIN `dvi_vehicle` AS VEHICLE ON VEHICLE.`vehicle_location_id` = STORED_LOCATION.`location_ID` LEFT JOIN `dvi_stored_locations` AS VEHICLE_LOCATION ON VEHICLE_LOCATION.`location_ID` = VEHICLE.`vehicle_location_id` LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id`= VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VEHICLE.`status` = '1' AND VEHICLE.`deleted` = '0' AND VENDOR_DETAILS.`vendor_id` = '$vendor_id' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` NOT IN (" . implode(",", $selected_vehicle_type_id) . ") GROUP BY VEHICLE.`vehicle_type_id` ORDER BY VENDOR_DETAILS.`vendor_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
        $total_no_of_available_vehicle_count_for_itineary_route_plan = sqlNUMOFROW_LABEL($select_itineary_route_plan_locations_wise_vehicle_details);

        if ($total_no_of_available_vehicle_count_for_itineary_route_plan > 0) :
            while ($fetch_available_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_locations_wise_vehicle_details)) :

                $vendor_name = $fetch_available_vehicle_data['vendor_name'];
                $vendor_margin = $fetch_available_vehicle_data['vendor_margin'];
                $vendor_margin_gst_type = $fetch_available_vehicle_data['vendor_margin_gst_type'];
                $vendor_margin_gst_percentage = $fetch_available_vehicle_data['vendor_margin_gst_percentage'];
                $vendor_branch_gst_type = $fetch_available_vehicle_data['vendor_branch_gst_type'];
                $vendor_branch_gst = $fetch_available_vehicle_data['vendor_branch_gst'];
                $vendor_branch_name = $fetch_available_vehicle_data['vendor_branch_name'];
                $vendor_vehicle_type_ID = $fetch_available_vehicle_data['vendor_vehicle_type_ID'];
                $vehicle_type_id = $fetch_available_vehicle_data['vehicle_type_id'];
                $driver_batta = $fetch_available_vehicle_data['driver_batta'];
                $food_cost = $fetch_available_vehicle_data['food_cost'];
                $accomodation_cost = $fetch_available_vehicle_data['accomodation_cost'];
                $extra_cost = $fetch_available_vehicle_data['extra_cost'];
                $driver_early_morning_charges = $fetch_available_vehicle_data['driver_early_morning_charges'];
                $driver_evening_charges = $fetch_available_vehicle_data['driver_evening_charges'];
                $early_morning_charges = $fetch_available_vehicle_data['early_morning_charges'];
                $evening_charges = $fetch_available_vehicle_data['evening_charges'];
                $vehicle_location_id = $fetch_available_vehicle_data['vehicle_location_id'];
                $registration_number = $fetch_available_vehicle_data['registration_number'];
                $state_code = substr($registration_number, 0, 2);
                $vendor_id = $fetch_available_vehicle_data['vendor_id'];
                $vehicle_id = $fetch_available_vehicle_data['vehicle_id'];
                $vendor_branch_id = $fetch_available_vehicle_data['vendor_branch_id'];
                $vehicle_fc_expiry_date = $fetch_available_vehicle_data['vehicle_fc_expiry_date'];
                $insurance_end_date = $fetch_available_vehicle_data['insurance_end_date'];
                $owner_city = $fetch_available_vehicle_data['owner_city'];
                $extra_km_charge = $fetch_available_vehicle_data['extra_km_charge'];
                $location_id = $fetch_available_vehicle_data['location_id'];
                $source_location_lattitude = $fetch_available_vehicle_data['source_location_lattitude'];
                $source_location_longitude = $fetch_available_vehicle_data['source_location_longitude'];
                $destination_location_lattitude = $fetch_available_vehicle_data['destination_location_lattitude'];
                $destination_location_longitude = $fetch_available_vehicle_data['destination_location_longitude'];
                $via_route_location_lattitude = $fetch_available_vehicle_data['via_route_location_lattitude'];
                $via_route_location_longitude = $fetch_available_vehicle_data['via_route_location_longitude'];
                $distance_from_source = $fetch_available_vehicle_data['distance_from_source'];
                $distance_from_destination = $fetch_available_vehicle_data['distance_from_destination'];
                $distance_from_via_route = $fetch_available_vehicle_data['distance_from_via_route'];
                $get_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
                $get_vehicle_type_count = getITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');

               $collect_vendor_vehicle_type_date .= '<div class="d-flex flex-column mt-3">
                    <div class="d-flex align-items-center mb-2">
                        <input type="hidden" name="vehicle_type[]" value="' . $vehicle_type_id . '">

                        <div class="w-100">
                            <div class="row align-items-center">
                                <div class="col-6 d-flex align-items-center">
                                    <label class="form-label mb-0 d-flex align-items-center" for="vehicle_type_' . $vehicle_type_id . '" style="cursor: pointer;">
                                        <input type="checkbox"
                                            id="vehicle_type_' . $vehicle_type_id . '"
                                            class="form-check-input p-2 me-2 vehicle_checkbox"
                                            data-vehicle-id="' . $vehicle_type_id . '">
                                        <span class="h6 m-0">' . htmlspecialchars($get_vehicle_type_title, ENT_QUOTES, 'UTF-8') . '</span>
                                    </label>
                                </div>

                                <div class="col-6 d-flex justify-content-end">
                                    <div class="vehicle_quantity d-flex align-items-center">
                                        <a class="vehicle_quantity__minus disabled"
                                        data-vehicle-id="' . $vehicle_type_id . '">
                                            <span>-</span>
                                        </a>
                                        <input name="vehicle_quantity[]"
                                            type="text"
                                            class="vehicle_quantity__input"
                                            data-vehicle-id="' . $vehicle_type_id . '"
                                            disabled
                                            style="width: 40px; text-align: center;"
                                            value="0">
                                        <a class="vehicle_quantity__plus disabled"
                                        data-vehicle-id="' . $vehicle_type_id . '">
                                            <span>+</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="error_container"></div>';


            endwhile;
            $btn_attr = '';
        else:
            $collect_vendor_vehicle_type_date .= ' 
                    <div class="d-flex flex-column">
                    <div class="col-12 d-flex justify-content-center">
                    No Vehicle Type Found
                    </div>
                </div>';
            $btn_attr = 'disabled';

        endif;
    ?>
        <style>
            .vehicle-basic_info_input_group_plus_minus {
                border: 1px solid #dbdade;
                padding-bottom: 3px !important;
                padding-top: 3px !important;
            }

            .vehicle-basic_info_input_plus_minus,
            .vehicle-basic_info_input_minus_button,
            .vehicle-basic_info_input_plus_button {
                border: none !important;
                background-color: transparent !important;
                -moz-appearance: none !important;
                /* Firefox */
                appearance: none !important;
                /* Other browsers */
                -webkit-appearance: none !important;
            }

            .vehicle-basic_info_input_plus_minus:focus {
                border: none;
                outline: none;
            }

            .vehicle-basic-info-input-field-button {
                background-color: #fff !important;
                /* padding-bottom: 8px !important;
                    padding-top: 8px !important; */
                border-radius: 30.375rem !important;
            }

            input.parsley-error .vehicle-basic_info_input_group_plus_minus:focus {
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
                border-color: #dc3545;
                padding-right: calc(1.5em + 0.9375rem);
                background-repeat: no-repeat;
                background-position: right calc(0.375em + 0.23438rem) center;
                background-size: calc(0.75em + 0.46875rem) calc(0.75em + 0.46875rem);
            }

            .vehicle_quantity {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding: 0;
            }

            .vehicle_quantity__minus,
            .vehicle_quantity__plus {
                display: block;
                width: 30px;
                height: 30px;
                margin: 0;
                background: #dee0ee;
                text-decoration: none;
                text-align: center;
                line-height: 30px;
                font-size: 23px;
                cursor: pointer;
            }

            .vehicle_quantity__minus {
                border-radius: 3px 0 0 3px;
            }

            .vehicle_quantity__plus {
                border-radius: 0 3px 3px 0;
            }

            .vehicle_quantity__input {
                /* width: 48px;
                height: 26px; */
                width: 35px;
                height: 30px;
                margin: 0;
                padding: 0;
                text-align: center;
                border-top: 2px solid #dee0ee;
                border-bottom: 2px solid #dee0ee;
                border-left: 1px solid #dee0ee;
                border-right: 2px solid #dee0ee;
                background: #fff;
                color: #8184a1;
            }

            .vehicle_quantity__minus:link,
            .vehicle_quantity__plus:link {
                color: #8184a1;
            }
        </style>
        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <span class="fw-bold h6">Add Vehicle Types</span>
                </h5>
            </div>

            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <span class="fw-bold h6">Vendor :</span>
                     <span class="fw-bold h6"><?= htmlspecialchars($selected_vendor_name); ?></span>
                </div>
            </div>

            <form id="ajax_add_new_vehicle_type_form" action="" data-parsley-validate method="post">

                <input type="hidden" name="itinerary_plan_id" value="<?= $itinerary_plan_ID ?>">
                <input type="hidden" name="vendor_id" value="<?= $vendor_id ?>">

                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">

                    <div id="room_details" class="col-12 mb-2">
                        <?= $collect_vendor_vehicle_type_date; ?>
                    </div>

                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button id="vehicle_type_form_submit_btn" type="submit" class="btn btn-success" <?= $btn_attr; ?>>Confirm </button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                // Prevent double binding by unbinding first (safety)
                $(document).off('click', '.vehicle_quantity__plus');
                $(document).off('click', '.vehicle_quantity__minus');
                $(document).off('click', '.vehicle_quantity__input');
                $(document).off('change', '.vehicle_checkbox');

                // Stop propagation for internal clicks
                $(document).on('click', '.vehicle_quantity__plus, .vehicle_quantity__minus, .vehicle_quantity__input', function (e) {
                    e.stopPropagation();
                });

                // Checkbox change logic
                $(document).on('change', '.vehicle_checkbox', function () {
                    var vehicleId = $(this).data('vehicle-id');
                    var $input = $('.vehicle_quantity__input[data-vehicle-id="' + vehicleId + '"]');
                    var $minus = $('.vehicle_quantity__minus[data-vehicle-id="' + vehicleId + '"]');
                    var $plus = $('.vehicle_quantity__plus[data-vehicle-id="' + vehicleId + '"]');

                    if ($(this).is(':checked')) {
                        if (parseInt($input.val(), 10) === 0 || isNaN($input.val())) {
                            $input.val(1);
                        }
                        $input.prop('disabled', false);
                        $minus.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                        $plus.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                    } else {
                        $input.val(0).prop('disabled', true);
                        $minus.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                        $plus.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                    }
                });

                // Increment
                $(document).on('click', '.vehicle_quantity__plus', function (e) {
                    e.preventDefault();
                    var vehicleId = $(this).data('vehicle-id');
                    var $input = $('.vehicle_quantity__input[data-vehicle-id="' + vehicleId + '"]');
                    var $checkbox = $('.vehicle_checkbox[data-vehicle-id="' + vehicleId + '"]');

                    if ($checkbox.is(':checked')) {
                        var currentVal = parseInt($input.val(), 10) || 0;
                        $input.val(currentVal + 1);
                        console.log("Incremented to: " + (currentVal + 1));
                    } else {
                        console.log("Checkbox not checked. Ignoring increment.");
                    }
                });

                // Decrement
                $(document).on('click', '.vehicle_quantity__minus', function (e) {
                    e.preventDefault();
                    var vehicleId = $(this).data('vehicle-id');
                    var $input = $('.vehicle_quantity__input[data-vehicle-id="' + vehicleId + '"]');
                    var $checkbox = $('.vehicle_checkbox[data-vehicle-id="' + vehicleId + '"]');

                    var currentVal = parseInt($input.val(), 10) || 0;
                    if ($checkbox.is(':checked') && currentVal > 0) {
                        var newVal = currentVal - 1;
                        $input.val(newVal);
                        console.log("Decremented to: " + newVal);

                        if (newVal === 0) {
                            $checkbox.prop('checked', false).trigger('change');
                        }
                    } else {
                        console.log("Cannot decrement further or checkbox not checked.");
                    }
                });


                // Handle direct clicks on the vehicle checkbox only
                // $(document).on('click', '.vehicle_checkbox', function(e) {
                //     var vehicleId = $(this).data('vehicle-id');
                //     var $quantityInput = $('input.vehicle_quantity__input[data-vehicle-id="' + vehicleId + '"]');
                //     var $minusBtn = $('a.vehicle_quantity__minus[data-vehicle-id="' + vehicleId + '"]');
                //     var $plusBtn = $('a.vehicle_quantity__plus[data-vehicle-id="' + vehicleId + '"]');

                //     if ($(this).is(':checked')) {
                //         // If the quantity is 0, set it to 1 (only if not already updated)
                //         if (parseInt($quantityInput.val(), 10) === 0) {
                //             $quantityInput.val(1);
                //         }
                //         // Enable the plus and minus buttons
                //         $minusBtn.removeClass('disabled').css({
                //             'cursor': 'pointer',
                //             'pointer-events': 'auto',
                //             'opacity': '1'
                //         });
                //         $plusBtn.removeClass('disabled').css({
                //             'cursor': 'pointer',
                //             'pointer-events': 'auto',
                //             'opacity': '1'
                //         });
                //         $quantityInput.css('cursor', 'default');
                //     } else {
                //         // If unchecked, reset the quantity and disable the controls
                //         $quantityInput.val(0).css('cursor', 'not-allowed');
                //         $minusBtn.addClass('disabled').css({
                //             'cursor': 'not-allowed',
                //             'pointer-events': 'none',
                //             'opacity': '0.5'
                //         });
                //         $plusBtn.addClass('disabled').css({
                //             'cursor': 'not-allowed',
                //             'pointer-events': 'none',
                //             'opacity': '0.5'
                //         });
                //     }
                // });

                $('#ajax_add_new_vehicle_type_form').on('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission

                    var form = $('#ajax_add_new_vehicle_type_form')[0];
                    var formData = new FormData(form);
                    //$(this).find("button[id='vehicle_type_form_submit_btn']").prop('disabled', true);
                    //let formData = $(this).serialize();
                    $.ajax({
                        url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_new_vehicle_type',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 80000,
                        dataType: 'json',
                        encode: true,
                    }).done(function(response) {
                        if (!response.success) {
                            if (response.errors.choosen_room_type_required) {
                                TOAST_NOTIFICATION('warning', 'Room Type is Required', 'Warning !!!');
                            } else if (response.errors.choosen_hotel_required) {
                                TOAST_NOTIFICATION('warning', 'Hotel is Required', 'Warning !!!');
                            }
                             else if (response.errors.vehicle_type_with_qty_required) {
                                TOAST_NOTIFICATION('warning', 'Atleast One Vehicle Type with Qty Required', 'Warning !!!');
                            }
                        } else {
                            if (response.i_result == true) {
                                //SUCCESS
                                TOAST_NOTIFICATION('success', 'Added Vehicle Type Successfully', 'Success !!!');
                                $("#showVEHICLETYPEADDFORMDATA").modal('hide'); // For Bootstrap
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            } else if (response.i_result == false) {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            } else {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            }
                        }
                        if (response == "OK") {
                            return true;
                        } else {
                            return false;
                        }
                    });



                });
            });
        </script>
    <?php
    elseif ($_GET['type'] == 'show_new_vendor_add_form'):

        $itinerary_plan_ID = $_GET['itinerary_plan_id'];
        // $vendor_id = $_GET['vendor_id'];
        // $selected_vendor_name = getVENDORANDVEHICLEDETAILS($vendor_id, 'get_vendorname_from_vendorid', '');

        $array_of_location_name = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_location_name', '');
        $array_of_next_visiting_location = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_next_visiting_location', '');

        $eligible_vehicle_location = array_merge($array_of_location_name, $array_of_next_visiting_location);

        $get_eligible_location_citys = getSTOREDLOCATIONDETAILS($eligible_vehicle_location, 'get_location_city_from_location_name');

        $get_implode_eligible_location_CITYS = implode("','", $get_eligible_location_citys);

        // $select_itineary_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id`, SUM(`vehicle_count`) AS vehicle_count FROM `dvi_confirmed_itinerary_plan_vehicle_details`  WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
        // $total_no_of_vehicle_count = sqlNUMOFROW_LABEL($select_itineary_vehicle_details);
        // if ($total_no_of_vehicle_count > 0) :
        //     while ($fetch_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_vehicle_details)) :
        //         $selected_vehicle_type_id[] = $fetch_vehicle_data['vehicle_type_id'];
        //         $selected_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
        //         $selected_vehicle_count[] = $fetch_vehicle_data['vehicle_count'];
        //     endwhile;
        // endif;
        // NOT IN (" . implode(",", $selected_vehicle_type_id) . ")

        $select_itineary_route_plan_locations_wise_vehicle_details = sqlQUERY_LABEL("SELECT DISTINCT VENDOR_VEHICLE_TYPES.`vehicle_type_id` FROM `dvi_stored_locations` AS STORED_LOCATION LEFT JOIN `dvi_vehicle` AS VEHICLE ON VEHICLE.`vehicle_location_id` = STORED_LOCATION.`location_ID` LEFT JOIN `dvi_stored_locations` AS VEHICLE_LOCATION ON VEHICLE_LOCATION.`location_ID` = VEHICLE.`vehicle_location_id` LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id`= VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VEHICLE.`status` = '1' AND VEHICLE.`deleted` = '0' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` GROUP BY VEHICLE.`vehicle_type_id` ORDER BY VENDOR_DETAILS.`vendor_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
        $total_no_of_available_vehicle_count_for_itineary_route_plan = sqlNUMOFROW_LABEL($select_itineary_route_plan_locations_wise_vehicle_details);

        if ($total_no_of_available_vehicle_count_for_itineary_route_plan > 0) :
            while ($fetch_available_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_locations_wise_vehicle_details)) :

                $vendor_name = $fetch_available_vehicle_data['vendor_name'];
                $vendor_margin = $fetch_available_vehicle_data['vendor_margin'];
                $vendor_margin_gst_type = $fetch_available_vehicle_data['vendor_margin_gst_type'];
                $vendor_margin_gst_percentage = $fetch_available_vehicle_data['vendor_margin_gst_percentage'];
                $vendor_branch_gst_type = $fetch_available_vehicle_data['vendor_branch_gst_type'];
                $vendor_branch_gst = $fetch_available_vehicle_data['vendor_branch_gst'];
                $vendor_branch_name = $fetch_available_vehicle_data['vendor_branch_name'];
                $vendor_vehicle_type_ID = $fetch_available_vehicle_data['vendor_vehicle_type_ID'];
                $vehicle_type_id = $fetch_available_vehicle_data['vehicle_type_id'];
                $driver_batta = $fetch_available_vehicle_data['driver_batta'];
                $food_cost = $fetch_available_vehicle_data['food_cost'];
                $accomodation_cost = $fetch_available_vehicle_data['accomodation_cost'];
                $extra_cost = $fetch_available_vehicle_data['extra_cost'];
                $driver_early_morning_charges = $fetch_available_vehicle_data['driver_early_morning_charges'];
                $driver_evening_charges = $fetch_available_vehicle_data['driver_evening_charges'];
                $early_morning_charges = $fetch_available_vehicle_data['early_morning_charges'];
                $evening_charges = $fetch_available_vehicle_data['evening_charges'];
                $vehicle_location_id = $fetch_available_vehicle_data['vehicle_location_id'];
                $registration_number = $fetch_available_vehicle_data['registration_number'];
                $state_code = substr($registration_number, 0, 2);
                $vendor_id = $fetch_available_vehicle_data['vendor_id'];
                $vehicle_id = $fetch_available_vehicle_data['vehicle_id'];
                $vendor_branch_id = $fetch_available_vehicle_data['vendor_branch_id'];
                $vehicle_fc_expiry_date = $fetch_available_vehicle_data['vehicle_fc_expiry_date'];
                $insurance_end_date = $fetch_available_vehicle_data['insurance_end_date'];
                $owner_city = $fetch_available_vehicle_data['owner_city'];
                $extra_km_charge = $fetch_available_vehicle_data['extra_km_charge'];
                $location_id = $fetch_available_vehicle_data['location_id'];
                $source_location_lattitude = $fetch_available_vehicle_data['source_location_lattitude'];
                $source_location_longitude = $fetch_available_vehicle_data['source_location_longitude'];
                $destination_location_lattitude = $fetch_available_vehicle_data['destination_location_lattitude'];
                $destination_location_longitude = $fetch_available_vehicle_data['destination_location_longitude'];
                $via_route_location_lattitude = $fetch_available_vehicle_data['via_route_location_lattitude'];
                $via_route_location_longitude = $fetch_available_vehicle_data['via_route_location_longitude'];
                $distance_from_source = $fetch_available_vehicle_data['distance_from_source'];
                $distance_from_destination = $fetch_available_vehicle_data['distance_from_destination'];
                $distance_from_via_route = $fetch_available_vehicle_data['distance_from_via_route'];
                $get_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
                $get_vehicle_type_count = getITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');

                $collect_vendor_vehicle_type_date .= '
                <div class="d-flex flex-column vehicle-type-container">
                    <br>
                    <div class="d-flex align-items-center mb-2">
                        <!-- Hidden input to always pass the vehicle type ID -->
                        <input type="hidden" name="vendor_vehicle_type[]" value="' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '">

                        <input type="checkbox" id="vendor_vehicle_type_' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '"
                            class="form-check-input me-2 vendor_vehicle_checkbox"
                            data-vendor-vehicle-id="' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '">

                        <label class="pt-2 form-label w-100 d-flex align-items-center" for="vendor_vehicle_type_' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '">
                            <div class="row w-100 align-items-center">
                                <div class="col-6">
                                    <span>' . htmlspecialchars($get_vehicle_type_title, ENT_QUOTES, 'UTF-8') . '</span>
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                    <div class="vendor_vehicle_quantity d-flex align-items-center vendor-vehicle-basic_info_input_group_plus_minus">
                                        <button class="vendor_vehicle_quantity__minus disabled btn btn-sm vendor-vehicle-basic_info_input_minus_button"
                                                data-vendor-vehicle-id="' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '"
                                                aria-label="Decrease quantity">
                                            <span>-</span>
                                        </button>
                                        <input name="vendor_vehicle_quantity[]"
                                            readonly
                                            type="text"
                                            class="vendor_vehicle_quantity__input form-control text-center vendor-vehicle-basic_info_input_plus_minus"
                                            data-vendor-vehicle-id="' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '"
                                            style="width: 40px;"
                                            value="0"
                                            aria-label="Quantity">
                                        <button class="vendor_vehicle_quantity__plus disabled btn btn-sm vendor-vehicle-basic_info_input_plus_button"
                                                data-vendor-vehicle-id="' . htmlspecialchars($vehicle_type_id, ENT_QUOTES, 'UTF-8') . '"
                                                aria-label="Increase quantity">
                                            <span>+</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                <div id="error_container"></div>';

            endwhile;
            $btn_attr = '';
        else:
            $collect_vendor_vehicle_type_date .= '
            <div class="d-flex flex-column">
            <div class="col-12 d-flex justify-content-center">
            No Vehicle Type Found
            </div>
            </div>';
            $btn_attr = 'disabled';

        endif;
?>

        <style>
            .vendor-vehicle-basic_info_input_group_plus_minus {
                border: 1px solid #dbdade;
                padding-bottom: 3px !important;
                padding-top: 3px !important;
                border-radius: 5px; /* Added border-radius for rounded corners */
                overflow: hidden; /* Ensure child elements don't overflow */
                background: #dee0ee;

            }

            .vendor-vehicle-basic_info_input_plus_minus,
            .vendor-vehicle-basic_info_input_minus_button,
            .vendor-vehicle-basic_info_input_plus_button {
                border: none !important;
                background-color: transparent !important;
                -moz-appearance: none !important;
                /* Firefox */
                appearance: none !important;
                /* Other browsers */
                -webkit-appearance: none !important;
            }

            .vendor-vehicle-basic_info_input_plus_minus:focus {
                border: none;
                outline: none;
            }

            .vendor-vehicle-basic-info-input-field-button {
                background-color: #fff !important;
                border-radius: 30.375rem !important;
            }

            input.parsley-error .vendor-vehicle-basic_info_input_group_plus_minus:focus {
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
                border-color: #dc3545;
                padding-right: calc(1.5em + 0.9375rem);
                background-repeat: no-repeat;
                background-position: right calc(0.375em + 0.23438rem) center;
                background-size: calc(0.75em + 0.46875rem) calc(0.75em + 0.46875rem);
            }

            .vendor_vehicle_quantity {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding: 0;
            }

            .vendor_vehicle_quantity__minus,
            .vendor_vehicle_quantity__plus {
                display: block;
                width: 30px;
                height: 30px;
                margin: 0;
                background: #dee0ee;
                text-decoration: none;
                text-align: center;
                line-height: 30px;
                font-size: 23px;
                cursor: pointer;
                border-radius: 0; /* Remove border-radius for flat buttons */
            }

            .vendor_vehicle_quantity__minus {
                border-radius: 3px 0 0 3px;
            }

            .vendor_vehicle_quantity__plus {
                border-radius: 0 3px 3px 0;
            }

            .vendor_vehicle_quantity__input {
                width: 35px !important;
                height: 30px;
                margin: 0;
                padding: 0;
                text-align: center !important;
                background: #fff !important;
                color: #8184a1;
                border-radius: 0; /* Remove border-radius for flat input */
            }

            .vendor_vehicle_quantity__minus:link,
            .vendor_vehicle_quantity__plus:link {
                color: #8184a1;
            }
        </style>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Add Vehicle Types</strong>
                </h5>
            </div>

            <form id="ajax_add_new_vendor_vehicle_type_form" action="" data-parsley-validate method="post">

                <input type="hidden" name="itinerary_plan_id" value="<?= $itinerary_plan_ID ?>">

                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">

                    <div id="room_details" class="col-12 mb-2">
                        <?= $collect_vendor_vehicle_type_date; ?>
                    </div>

                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                         <span id="showVEHICLEINFO"></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4" id="vendor_vehicle_type">
                    <div class="col-12">
                        <button id="vendor_vehicle_type_form_cancel_btn" type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button id="vendor_vehicle_type_form_submit_btn" type="submit" class="btn btn-success" <?= $btn_attr; ?>>Confirm </button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {

                // Prevent the label from toggling the checkbox when clicking inside the container (d-flex)
                $(document).off('click', 'label[for^="vendor_vehicle_type_"]').on('click', 'label[for^="vendor_vehicle_type_"]', function(e) {
                    // If the target is not the actual checkbox, do not toggle the checkbox.
                    if (!$(e.target).is('input.vendor_vehicle_checkbox')) {
                        e.preventDefault();
                    }
                });

                // Stop propagation on plus, minus buttons, and the quantity input to prevent toggling via parent clicks
                $(document).off('click', '.vendor_vehicle_quantity__plus, .vendor_vehicle_quantity__minus, .vendor_vehicle_quantity__input').on('click', '.vendor_vehicle_quantity__plus, .vendor_vehicle_quantity__minus, .vendor_vehicle_quantity__input', function(e) {
                    e.stopPropagation();
                });

                // Handle checkbox click event
                $(document).off('click', '.vendor_vehicle_checkbox').on('click', '.vendor_vehicle_checkbox', function(e) {
                    var vehicleId = $(this).data('vendor-vehicle-id');
                    var $quantityInput = $('input.vendor_vehicle_quantity__input[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var $minusBtn = $('button.vendor_vehicle_quantity__minus[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var $plusBtn = $('button.vendor_vehicle_quantity__plus[data-vendor-vehicle-id="' + vehicleId + '"]');

                    if ($(this).is(':checked')) {
                        // Set to 1 if currently 0 and enable input
                        if (parseInt($quantityInput.val(), 10) === 0) {
                            $quantityInput.val(1);
                        }
                        $quantityInput.prop('disabled', false);
                        $minusBtn.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                        $plusBtn.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                    } else {
                        // Reset and disable input so it won't be submitted
                        $quantityInput.val(0).prop('disabled', true);
                        $minusBtn.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                        $plusBtn.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                    }
                });

                // Increment the vehicle quantity when the plus button is clicked
                $(document).off('click', '.vendor_vehicle_quantity__plus').on('click', '.vendor_vehicle_quantity__plus', function(e) {
                    e.preventDefault();
                    var vehicleId = $(this).data('vendor-vehicle-id');
                    var $quantityInput = $('input.vendor_vehicle_quantity__input[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var $checkbox = $('.vendor_vehicle_checkbox[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var currentVal = parseInt($quantityInput.val(), 10);

                    if ($checkbox.is(':checked')) {
                        $quantityInput.val(currentVal + 1);
                    } else {
                        console.log("Checkbox is not checked. Increment ignored.");
                    }
                });

                // Decrement the vehicle quantity when the minus button is clicked
                $(document).off('click', '.vendor_vehicle_quantity__minus').on('click', '.vendor_vehicle_quantity__minus', function(e) {
                    e.preventDefault();
                    var vehicleId = $(this).data('vendor-vehicle-id');
                    var $quantityInput = $('input.vendor_vehicle_quantity__input[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var $checkbox = $('.vendor_vehicle_checkbox[data-vendor-vehicle-id="' + vehicleId + '"]');
                    var currentVal = parseInt($quantityInput.val(), 10);

                    if ($checkbox.is(':checked') && currentVal > 1) {
                        $quantityInput.val(currentVal - 1);
                    } else {
                        console.log("Cannot decrement further, or checkbox is unchecked.");
                    }
                });

                $('#ajax_add_new_vendor_vehicle_type_form').on('submit', function (e) {
                        e.preventDefault(); // Prevent default form submission
                        var spinner = $('#spinner');
                        spinner.show();

                        var form = $('#ajax_add_new_vendor_vehicle_type_form')[0];
                        var formData = new FormData(form);

                        // Disable submit button immediately to prevent multiple submissions
                        $('#vendor_vehicle_type_form_submit_btn').prop('disabled', true);
                        $('#vendor_vehicle_type_form_cancel_btn').prop('disabled', true);

                        $.ajax({
                            url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_new_vendor_vehicles',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            cache: false,
                            timeout: 80000,
                            dataType: 'json',
                            encode: true,
                        }).done(function (response) {
                            spinner.hide();

                            if (!response.success) {
                                if (response.errors?.choosen_room_type_required) { // Use optional chaining
                                    TOAST_NOTIFICATION('warning', 'Room Type is Required', 'Warning !!!');
                                } else if (response.errors?.choosen_hotel_required) {
                                    TOAST_NOTIFICATION('warning', 'Hotel is Required', 'Warning !!!');
                                }
                            } else {
                            if (response.i_result === true) {
                        // SUCCESS
                        showDAYWISE_VEHICLE_DETAILS(response.itinerary_plan_ID);

                        // Disable the checkbox
                        $('.vendor_vehicle_checkbox').prop('disabled', true);
                        $('#vendor_vehicle_type').addClass('d-none');

                        // Select the quantity input and buttons
                        var $quantityInput_val = $('input.vendor_vehicle_quantity__input');
                        var $minusBtn_val = $('a.vendor_vehicle_quantity__minus');
                        var $plusBtn_val = $('a.vendor_vehicle_quantity__plus');

                        // Disable the quantity input and set its value to 0
                        $quantityInput_val.prop('disabled', true);

                        // Disable the minus button
                        $minusBtn_val.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });

                        // Disable the plus button
                        $plusBtn_val.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                    }
                    else {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            }
                        }
                    });

                });
            });

            function showDAYWISE_VEHICLE_DETAILS(itinerary_plan_ID) {
                console.log("Fetching vehicle details for Itinerary Plan ID:", itinerary_plan_ID);
                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_confirmed_itineary_vehicle_amedment_details.php?type=show_form",
                    data: {
                        _itinerary_plan_ID: itinerary_plan_ID,
                    },
                    success: function(response) {
                        $('#showVEHICLEINFO').html('');
                        $('#showVEHICLEINFO').html(response);
                    }
                });
            }
        </script>

    <?php
    elseif ($_GET['type'] == 'confirm_modify_itineary_plan_vehicle_vendor') :

        $errors = [];
        $response = [];

        $itinerary_plan_vendor_eligible_ID = $_POST['itinerary_plan_vendor_eligible_ID'];
        $vendor_ID = $_POST['vendor_ID'];
        $itinerary_plan_id = $_POST['itinerary_plan_id'];
        $vehicleType = $_POST['vehicleType'];

        if (!empty($errors)) :
            //error call
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;

            //RESET ALL THE VENDOR SELECTION
            $update_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `vehicle_type_id` = '$vehicleType'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

            $update_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `vehicle_type_id` = '$vehicleType'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

            //MODIFY THE VENDOR SELECTION
            $update_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '1' WHERE `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `vendor_id` = '$vendor_ID' AND `vehicle_type_id` = '$vehicleType'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

               $update_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '1' WHERE `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `vendor_id` = '$vendor_ID' AND `vehicle_type_id` = '$vehicleType'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

            if ($update_vehicle_vendor_selection) :
                //success call		
                $response['update_vehicle_vendor_success'] = true;
            else :
                $response['update_vehicle_vendor_success'] = false;
            endif;
        endif;

        echo json_encode($response);
    elseif ($_GET['type'] == 'delete_itinerary_plan_vendor_vehicle') :

        $errors = [];
        $response = [];

      
        $itinerary_plan_id = $_POST['itinerary_plan_id'];

        if (!empty($errors)) :
            //error call
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;

            //RESET ALL THE VENDOR SELECTION
            $update_confirm_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `deleted` = '1' AND `status` = '0' WHERE `itinerary_plan_id` = '$itinerary_plan_id'  AND `added_via_amendment` = '1' AND `itineary_plan_assigned_status` = '0'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

            $update_cancel_vehicle_vendor_selection = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `deleted` = '1' AND `status` = '0' WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `added_via_amendment` = '1' AND `itineary_plan_assigned_status` = '0'") or die("#3-UNABLE_TO_UPDATE_DETAILS:" . sqlERROR_LABEL());

            if ($update_confirm_vehicle_vendor_selection && $update_cancel_vehicle_vendor_selection) :
                //success call		
                $response['update_vehicle_vendor_success'] = true;
            else :
                $response['update_vehicle_vendor_success'] = false;
            endif;
        endif;

        echo json_encode($response);
    elseif ($_GET['type'] == 'add_new_vendor_vehicles') :

        $response = [];
        $errors = [];

        $itinerary_plan_ID = $_POST['itinerary_plan_id'];
        // $vendor_id = $_POST['vendor_id'];
        $vehicle_type = $_POST['vendor_vehicle_type'];
        $vehicle_count = $_POST['vendor_vehicle_quantity'];

        //updating the cnf iti for vehicle type and count
        if (isset($vehicle_type) && isset($vehicle_count)) :

            foreach ($vehicle_type as $key => $val) :
                $selected_VEHICLE_TYPE = $_POST['vendor_vehicle_type'][$key];
                $selected_VEHICLE_COUNT = $_POST['vendor_vehicle_quantity'][$key];

                // Only proceed if the vehicle quantity is not zero
                if ($selected_VEHICLE_COUNT != 0) {

                    $vehicle_type_id[] = $selected_VEHICLE_TYPE;
                    $vehicle_arrFields = array('`itinerary_plan_id`', '`vehicle_type_id`', '`vehicle_count`','`added_via_amendment`',  '`createdby`', '`status`');
                    $vehicle_arrValues = array("$itinerary_plan_ID", "$selected_VEHICLE_TYPE", "$selected_VEHICLE_COUNT","1", "$logged_user_id", "1");
                    /* use table */
                    if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vehicle_details", $vehicle_arrFields, $vehicle_arrValues, '')) :
                    endif;
                }
            endforeach;
        endif;

        //get inserted vehicle type with count
        $select_itineary_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id`, SUM(`vehicle_count`) AS vehicle_count FROM `dvi_confirmed_itinerary_plan_vehicle_details`  WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' AND `vehicle_type_id` IN (" . implode(",", $vehicle_type_id) . ") and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
        $total_no_of_vehicle_count = sqlNUMOFROW_LABEL($select_itineary_vehicle_details);
        if ($total_no_of_vehicle_count > 0) :
            // while ($fetch_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_vehicle_details)) :
            //     $vehicle_type_id[] = $fetch_vehicle_data['vehicle_type_id'];
            //     $vehicle_count[] = $fetch_vehicle_data['vehicle_count'];
            // endwhile;

            $array_of_location_name = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_location_name', '');
            $array_of_next_visiting_location = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_next_visiting_location', '');

            $eligible_vehicle_location = array_merge($array_of_location_name, $array_of_next_visiting_location);

            $get_eligible_location_citys = getSTOREDLOCATIONDETAILS($eligible_vehicle_location, 'get_location_city_from_location_name');

            $get_implode_eligible_location_CITYS = implode("','", $get_eligible_location_citys);

            // INITIALIZE AN ARRAY TO STORE AVAILABLE VEHICLE COUNT FOR EACH VEHICLE TYPE
            $available_vehicle_counts = [];

            for ($i = 0; $i < count($vehicle_type_id); $i++) :
                $current_vehicle_type_id = $vehicle_type_id[$i];
                //QUERY TO GET AVAILABLE VEHICLE COUNT DATA
                $check_vehicle_type_wise_vehicle_count_availability = sqlQUERY_LABEL("SELECT COUNT(VEHICLE.`vehicle_type_id`) AS available_vehicle_count FROM `dvi_vehicle` AS VEHICLE LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id` = VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`status` = '1' AND VEHICLE.`deleted` = '0' AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` = '$current_vehicle_type_id' AND VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') GROUP BY VEHICLE.`vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                //FETCH AVAILABLE VEHICLE COUNT DATA
                $fetch_available_vehicle_count_data = sqlNUMOFROW_LABEL($check_vehicle_type_wise_vehicle_count_availability);

                //CHECK IF ANY AVILABLE VEHICLE COUNT DATA FOR THE CURRENT VEHICLE TYPE
                if ($fetch_available_vehicle_count_data) :
                    //STORE THE AVAILABLE VEHICLE COUNT FOR THE CURRENT VEHICLE TYPE
                    $available_vehicle_counts[$current_vehicle_type_id] = $fetch_available_vehicle_count_data;
                else :
                    //IF NO DATA AVAILABLE SET TO 0 FOR THIS VEHICLE TYPE
                    $available_vehicle_counts[$current_vehicle_type_id] = 0;
                endif;
            endfor;

            # CHECKING THE SHORTAGES OF VEHICLE TYPE
            for ($i = 0; $i < count($vehicle_type_id); $i++) :
                // Get the vehicle type ID
                $current_vehicle_type_id = $vehicle_type_id[$i];

                if ($fetch_available_vehicle_count_data == 0) :
                    //CHECK IF THERE IS A SHORTAGE OF VEHICLE FOR THE CURRENT VEHICLE TYPE
                    $selected_vehicle_type_ID = $current_vehicle_type_id;
                    $vehicle_type_title = getVEHICLETYPE($selected_vehicle_type_ID, 'get_vehicle_type_title');

                    //CALCULTE THE DIFFERENCE BETWEEN AVAILABLE AND REQUIRED VEHICLES
                    $shortage = $vehicle_count[$i] - $available_vehicle_counts[$current_vehicle_type_id];

                    //CONSTRUCT THE ERROR MESSAGE WITH AVAILABLE AND REQUIRED COUNTS
                    $errors['vehicle_type_not_found'] = "Vehicle type $vehicle_type_title not found.";
                endif;

            endfor;

            if (!empty($errors)) :
                //error call
                $response['success'] = false;
                $response['errors'] = $errors;
            else :

                # CHECK VECHILE ELIGIBILITY BETWEEN THE ITINEARY ROUTE

                $select_itineary_route_plan_locations_wise_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_margin`, VENDOR_DETAILS.`vendor_margin_gst_type`, VENDOR_DETAILS.`vendor_margin_gst_percentage`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst_type`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst`, VENDOR_DETAILS.`vendor_name`, VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID`, VENDOR_VEHICLE_TYPES.`vehicle_type_id`, VENDOR_VEHICLE_TYPES.`driver_batta`, VENDOR_VEHICLE_TYPES.`food_cost`, VENDOR_VEHICLE_TYPES.`accomodation_cost`, VENDOR_VEHICLE_TYPES.`extra_cost`, VENDOR_VEHICLE_TYPES.`driver_early_morning_charges`, VENDOR_VEHICLE_TYPES.`driver_evening_charges`, VEHICLE.`vehicle_location_id`, VEHICLE.`registration_number`, VEHICLE.`vendor_id`, VEHICLE.`vehicle_id`, VEHICLE.`vendor_branch_id`, VEHICLE.`vehicle_fc_expiry_date`, VEHICLE.`insurance_end_date`, VEHICLE.`owner_city`,VEHICLE.`extra_km_charge`, STORED_LOCATION.`source_location_lattitude`, STORED_LOCATION.`source_location_longitude`, STORED_LOCATION.`destination_location_lattitude`, STORED_LOCATION.`destination_location_longitude`, VEHICLE.`early_morning_charges`, VEHICLE.`evening_charges` FROM `dvi_stored_locations` AS STORED_LOCATION LEFT JOIN `dvi_vehicle` AS VEHICLE ON VEHICLE.`vehicle_location_id` = STORED_LOCATION.`location_ID` LEFT JOIN `dvi_stored_locations` AS VEHICLE_LOCATION ON VEHICLE_LOCATION.`location_ID` = VEHICLE.`vehicle_location_id` LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id`= VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VEHICLE.`status` = '1' and VEHICLE.`deleted` = '0' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` IN (" . implode(",", $vehicle_type_id) . ") GROUP BY VEHICLE.`vehicle_type_id` ORDER BY VENDOR_DETAILS.`vendor_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL()); //VENDOR_BRANCH_DETAILS.`vendor_branch_id`,
                $total_no_of_available_vehicle_count_for_itineary_route_plan = sqlNUMOFROW_LABEL($select_itineary_route_plan_locations_wise_vehicle_details);

                if ($total_no_of_available_vehicle_count_for_itineary_route_plan > 0) :

                    $permit_cost_sqlwhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' ";
                    /* use table */
                    if (sqlACTIONS("DELETE", "dvi_confirmed_itinerary_plan_route_permit_charge", '', '', $permit_cost_sqlwhere)) :
                    endif;

                    while ($fetch_available_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_locations_wise_vehicle_details)) :
                        $vendor_name = $fetch_available_vehicle_data['vendor_name'];
                        $vendor_margin = $fetch_available_vehicle_data['vendor_margin'];
                        $vendor_margin_gst_type = $fetch_available_vehicle_data['vendor_margin_gst_type'];
                        $vendor_margin_gst_percentage = $fetch_available_vehicle_data['vendor_margin_gst_percentage'];
                        $vendor_branch_gst_type = $fetch_available_vehicle_data['vendor_branch_gst_type'];
                        $vendor_branch_gst = $fetch_available_vehicle_data['vendor_branch_gst'];
                        $vendor_branch_name = $fetch_available_vehicle_data['vendor_branch_name'];
                        $vendor_vehicle_type_ID = $fetch_available_vehicle_data['vendor_vehicle_type_ID'];
                        $vehicle_type_id = $fetch_available_vehicle_data['vehicle_type_id'];
                        $driver_batta = $fetch_available_vehicle_data['driver_batta'];
                        $food_cost = $fetch_available_vehicle_data['food_cost'];
                        $accomodation_cost = $fetch_available_vehicle_data['accomodation_cost'];
                        $extra_cost = $fetch_available_vehicle_data['extra_cost'];
                        $driver_early_morning_charges = $fetch_available_vehicle_data['driver_early_morning_charges'];
                        $driver_evening_charges = $fetch_available_vehicle_data['driver_evening_charges'];
                        $early_morning_charges = $fetch_available_vehicle_data['early_morning_charges'];
                        $evening_charges = $fetch_available_vehicle_data['evening_charges'];
                        $vehicle_location_id = $fetch_available_vehicle_data['vehicle_location_id'];
                        $registration_number = $fetch_available_vehicle_data['registration_number'];
                        $state_code = substr($registration_number, 0, 2);
                        $vendor_id = $fetch_available_vehicle_data['vendor_id'];
                        $vehicle_id = $fetch_available_vehicle_data['vehicle_id'];
                        $vendor_branch_id = $fetch_available_vehicle_data['vendor_branch_id'];
                        $vehicle_fc_expiry_date = $fetch_available_vehicle_data['vehicle_fc_expiry_date'];
                        $insurance_end_date = $fetch_available_vehicle_data['insurance_end_date'];
                        $owner_city = $fetch_available_vehicle_data['owner_city'];
                        $extra_km_charge = $fetch_available_vehicle_data['extra_km_charge'];
                        $location_id = $fetch_available_vehicle_data['location_id'];
                        $source_location_lattitude = $fetch_available_vehicle_data['source_location_lattitude'];
                        $source_location_longitude = $fetch_available_vehicle_data['source_location_longitude'];
                        $destination_location_lattitude = $fetch_available_vehicle_data['destination_location_lattitude'];
                        $destination_location_longitude = $fetch_available_vehicle_data['destination_location_longitude'];
                        $via_route_location_lattitude = $fetch_available_vehicle_data['via_route_location_lattitude'];
                        $via_route_location_longitude = $fetch_available_vehicle_data['via_route_location_longitude'];
                        $distance_from_source = $fetch_available_vehicle_data['distance_from_source'];
                        $distance_from_destination = $fetch_available_vehicle_data['distance_from_destination'];
                        $distance_from_via_route = $fetch_available_vehicle_data['distance_from_via_route'];
                        $get_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
                        $get_vehicle_type_count = getCNFITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');

                        for ($vh_count = 1; $vh_count <= $get_vehicle_type_count; $vh_count++):

                            $TOTAL_DRIVER_CHARGES = ($driver_batta +  $food_cost + $accomodation_cost + $extra_cost);

                            $get_title = getKMLIMIT($vendor_vehicle_type_ID, 'get_title_from_vehicle_type', $vendor_id);
                            $get_kms_limit = getKMLIMIT($vendor_vehicle_type_ID, 'get_kms_limit', $vendor_id);
                            $kms_limit_id = getKMLIMIT($vendor_vehicle_type_ID, 'get_kms_limit_id', $vendor_id);

                            if ($current_DATE > $vehicle_fc_expiry_date) :
                                $errors['vehicle_fc_expiry_date_reached'] = "Sorry, Don't have a Valid FC for [$vendor_name => $vendor_branch_name - $registration_number] !!!";
                            endif;

                            if ($current_DATE > $insurance_end_date) :
                                $errors['insurance_end_date_reached'] = "Sorry, Don't have a Valid Insurance for [$vendor_name => $vendor_branch_name - $registration_number] !!!";
                            endif;

                            if (empty($get_kms_limit)) :
                                $errors['vendor_vehicle_outstaion_kms_limit_not_found'] = "Sorry, Don't have a Outstaion KM Limit Details for [$vendor_name] !!!";
                            endif;

                            if (!empty($errors)) :
                                //error call
                                $response['success'] = false;
                                $response['errors'] = $errors;
                            else :
                                $vehicle_origin = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'SOURCE_LOCATION');
                                $vehicle_origin_city = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'SOURCE_CITY');
                                $vehicle_origin_location_latitude = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'location_latitude');
                                $vehicle_origin_location_longtitude = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'location_longtitude');
                                $driver_charges = $driver_batta +  $food_cost + $accomodation_cost + $extra_cost;
                                $vehicle_permit_state_id = getSTATE_DETAILS($state_code, 'vehicle_permit_state_id');

                                $select_itineary_route_plan_details = sqlQUERY_LABEL("SELECT `itinerary_route_ID`, `location_id`, `location_name`, `itinerary_route_date`, `no_of_km`, `next_visiting_location`, `direct_to_next_visiting_place`, `route_start_time`, `route_end_time` FROM `dvi_confirmed_itinerary_route_details` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' and `status` = '1' and `deleted` = '0' ORDER BY `itinerary_route_ID` ASC") or die("#1-UNABLE_TO_COLLECT_ROUTE_LIST:" . sqlERROR_LABEL());
                                $total_no_of_itineary_plan_route_details = sqlNUMOFROW_LABEL($select_itineary_route_plan_details);
                                if ($total_no_of_itineary_plan_route_details > 0) :
                                    $route_count = 0;

                                    /* echo "<table border='1'>";
                                echo "<tr style='background-color:yellow'>";
                                echo "<th>Day's</th>";
                                echo "<th>Location Name</th>";
                                echo "<th>Total Running KM / Time</th>";
                                echo "<th>Total Siteseeing KM / Time</th>";
                                echo "<th>Total KM/Time</th>";
                                echo "<th>Amount</th>";
                                echo "</tr>";

                                echo "<tr>";
                                echo "<td colspan='6'>VENDOR : <b>$vendor_name</b> | BRANCH : <b>$vendor_branch_name</b> | VEHICLE TYPE : <b>$get_vehicle_type_title</b> | Vehicle Origin : <b>$vehicle_origin <br> VEHICLE NO : $registration_number</b></td>";
                                echo "</tr>"; */

                                    $OVERALL_TOTAL_TIME = NULL;
                                    $OVERALL_TOTAL_KM = NULL;
                                    $OVERALL_RENDAL_CHARGES = NULL;
                                    $OVERALL_VEHICLE_TOLL_CHARGE = NULL;
                                    $OVERALL_VEHICLE_PARKING_CHARGE = NULL;
                                    $OVERALL_TOTAL_DRIVER_CHARGES = NULL;
                                    $OVERALL_PERMIT_CHARGES = NULL;
                                    $OVERALL_BEFORE_6AM_EXTRA_TIME = NULL;
                                    $OVERALL_AFTER_8PM_EXTRA_TIME = NULL;
                                    $OVERALL_DRIVER_MORINING_CHARGES = NULL;
                                    $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES = NULL;
                                    $OVERALL_DRIVER_EVEINING_CHARGES = NULL;
                                    $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES = NULL;
                                    $OVERALL_TOTAL_VEHICLE_AMOUNT = NULL;
                                    $OVERALL_TOTAL_HOURS_n_MINS = NULL;
                                    $OVERALL_OUTSTATION_KM = NULL;
                                    $OVERALL_LOCAL_KM = NULL;
                                    $OVERALL_LOCAL_EXTRA_KM = NULL;
                                    $OVERALL_LOCAL_EXTRA_KM_CHARGES = NULL;
                                    $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE = NULL;
                                    $TOTAL_ITINEARY_ALLOWED_KM = NULL;
                                    $get_extra_kms = NULL;
                                    $TOTAL_EXTRA_KM = NULL;
                                    $TOTAL_EXTRA_KM_CHARGE = NULL;
                                    $new_total_vehicle_cost = NULL;
                                    $new_total_vehicle_tax_amt = NULL;
                                    $new_total_margin_amount = NULL;
                                    $new_total_margin_service_tax_amt = NULL;
                                    $VEHICLE_GRAND_TOTAL_AMOUNT = NULL;

                                    while ($fetch_itineary_route_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_details)) :
                                        $route_count++;
                                        $itinerary_route_ID = $fetch_itineary_route_data['itinerary_route_ID'];
                                        $location_id = $fetch_itineary_route_data['location_id'];
                                        $location_name = $fetch_itineary_route_data['location_name'];
                                        $itinerary_route_date = $fetch_itineary_route_data['itinerary_route_date'];
                                        $no_of_km = $fetch_itineary_route_data['no_of_km'];
                                        $route_start_time = $fetch_itineary_route_data['route_start_time'];
                                        $route_end_time = $fetch_itineary_route_data['route_end_time'];
                                        $next_visiting_location = $fetch_itineary_route_data['next_visiting_location'];
                                        $direct_to_next_visiting_place = $fetch_itineary_route_data['direct_to_next_visiting_place'];
                                        $day = date('j', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $year = date('Y', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $month = date('F', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $location_latitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'location_latitude', $location_id);
                                        $location_longtitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'location_longtitude', $location_id);
                                        $next_visiting_location_latitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'next_visiting_location_latitude', $location_id);
                                        $next_visiting_location_longitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'next_visiting_location_longitude', $location_id);

                                        $vehicle_cost_for_the_day = getVEHICLE_OUTSTATION_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $kms_limit_id);

                                        /* $source_location_state = getSTOREDLOCATIONDETAILS($location_id, 'SOURCE_LOCATION_STATE');
                                    $destination_location_state = getSTOREDLOCATIONDETAILS($location_id, 'DESTINATION_LOCATION_STATE');
                                    $source_state_id = getVEHICLE_PERMIT_DETAILS($source_location_state, 'GET_PERMIT_STATE_ID');
                                    $destination_state_id = getVEHICLE_PERMIT_DETAILS($destination_location_state, 'GET_PERMIT_STATE_ID'); */

                                        $source_location_city = getSTOREDLOCATIONDETAILS($location_id, 'SOURCE_CITY');
                                        $destination_location_city = getSTOREDLOCATIONDETAILS($location_id, 'DESTINATION_CITY');

                                        $get_via_route_IDs = get_ITINEARY_VIA_ROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'get_via_route_IDs');

                                        #CALCULATE PERMIT CHARGES
                                        // Step 1: Vehicle Origin and Source
                                        $permit_source_location = $location_name;  // The first location (source)

                                        if ($get_via_route_IDs):
                                            // Step 2: VIA Route Location IDs (if any)
                                            $get_via_route_location_IDs = implode(',', $get_via_route_IDs); // VIA route IDs as a string

                                            // Step 3: Fetch VIA Route Location Names (if applicable)
                                            $permit_via_locations = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                            $via_locations_city = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_CITY');
                                        else:
                                            $get_via_route_location_IDs = NULL;
                                            $via_locations_city = NULL;
                                            $permit_via_locations = NULL;
                                        endif;

                                        // Step 4: Destination Location
                                        $permit_destination_location = $next_visiting_location;  // Final destination

                                        if ($route_count == 1):
                                            // Step 5: Prepare the array - Merge Origin, Source, VIA, and Destination locations
                                            $locations = array_merge(
                                                [$vehicle_origin],
                                                [$permit_source_location],   // Vehicle Origin to Source
                                                !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations (if any)
                                                [$permit_destination_location]  // Destination
                                            );
                                        else:
                                            // Prepare the array without the Vehicle Origin (for intermediate routes)
                                            $locations = array_merge(
                                                [$permit_source_location],   // Source (no Vehicle Origin)
                                                !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations (if any)
                                                [$permit_destination_location]  // Destination
                                            );

                                            // Check if it's the last route
                                            if ($total_no_of_itineary_plan_route_details == $route_count):
                                                // Add Vehicle Origin at the end
                                                $locations = array_merge(
                                                    [$permit_source_location],   // Source
                                                    !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations
                                                    [$permit_destination_location],  // Destination
                                                    [$vehicle_origin]  // Vehicle Origin at the end
                                                );
                                            endif;
                                        endif;

                                        /* echo "itinerary_route_date => $itinerary_route_date";
                                        print_r($locations);
                                        echo "<br>";
                                        echo "<br>"; */

                                        $location_states = [];
                                        foreach ($locations as $location) :
                                            $get_location_state_name_query = sqlQUERY_LABEL("SELECT `source_location_state` FROM `dvi_stored_locations` WHERE `source_location` = '$location' AND `status` = '1' AND `deleted` = '0' ORDER BY `location_ID` DESC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $source_location_row = sqlFETCHARRAY_LABEL($get_location_state_name_query);
                                            if ($source_location_row) :
                                                $location_states[] = $source_location_row['source_location_state'];
                                            endif;
                                        endforeach;

                                        /* echo "<br>";
                                        echo "<br>";
                                        print_r($location_states);
                                        echo "<br>";
                                        echo "<br>"; */

                                        // Step 2: Retrieve the state IDs for each state name
                                        $state_ids = [];
                                        foreach ($location_states as $state_name) :
                                            $get_location_permit_state_data_query = sqlQUERY_LABEL("SELECT `permit_state_id` FROM `dvi_permit_state` WHERE `state_name` = '$state_name' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_state_id` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $state_row = sqlFETCHARRAY_LABEL($get_location_permit_state_data_query);
                                            if ($state_row) :
                                                $state_ids[] = $state_row['permit_state_id'];
                                            endif;
                                        endforeach;

                                        // Step 3: Loop through each state and calculate permit charges
                                        $seven_days_ago = date('Y-m-d', strtotime($itinerary_route_date . ' - 6 days'));
                                        $permit_charges = 0;

                                        foreach ($state_ids as $state_id) :
                                            /* echo "SELECT `route_permit_charge_ID` FROM `dvi_itinerary_plan_route_permit_charge` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_branch_id` = '$vendor_branch_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `itinerary_route_date` >= '$seven_days_ago' AND `status` = '1' AND `deleted` = '0' ORDER BY `route_permit_charge_ID` ASC LIMIT 1";
                                            echo "<br>";
                                            echo "<br>"; */
                                            // Check if permit cost was calculated within the last 7 days for this state
                                            $check_permit_charge_already_calcualted_within_7_days = sqlQUERY_LABEL("SELECT `route_permit_charge_ID` FROM `dvi_confirmed_itinerary_plan_route_permit_charge` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_branch_id` = '$vendor_branch_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `itinerary_route_date` >= '$seven_days_ago' AND `status` = '1' AND `deleted` = '0' ORDER BY `route_permit_charge_ID` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $check_permit_charge_already_calcualted_within_7_days_count = sqlNUMOFROW_LABEL($check_permit_charge_already_calcualted_within_7_days);

                                            // If not calculated, calculate permit charge
                                            if ($check_permit_charge_already_calcualted_within_7_days_count == 0) :
                                                // Get permit cost between source state and destination state

                                                /* echo "SELECT `permit_cost` FROM `dvi_permit_cost` WHERE `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vendor_vehicle_type_ID' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_cost_id` ASC LIMIT 1";
                                                echo "<br>";
                                                echo "<br>"; */

                                                $get_permit_cost_for_the_destination_state = sqlQUERY_LABEL("SELECT `permit_cost` FROM `dvi_permit_cost` WHERE `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vendor_vehicle_type_ID' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_cost_id` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                                $row_permit_cost = sqlFETCHARRAY_LABEL($get_permit_cost_for_the_destination_state);

                                                if ($row_permit_cost) :
                                                    // Add the permit cost to the total
                                                    $permit_cost = $row_permit_cost['permit_cost'];
                                                    $permit_charges += $permit_cost;

                                                    $permit_charge_arrFields = array('`itinerary_plan_ID`', '`itinerary_route_ID`', '`itinerary_route_date`', '`vendor_id`', '`vendor_branch_id`', '`vendor_vehicle_type_id`', '`source_state_id`', '`destination_state_id`', '`permit_cost`', '`createdby`', '`status`');

                                                    $permit_charges_arrValues = array("$itinerary_plan_ID", "$itinerary_route_ID", "$itinerary_route_date", "$vendor_id", "$vendor_branch_id", "$vendor_vehicle_type_ID", "$vehicle_permit_state_id", "$state_id", "$permit_cost", "$logged_user_id", "1");
                                                    /* use table */
                                                    if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_route_permit_charge", $permit_charge_arrFields, $permit_charges_arrValues, '')) :
                                                    /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | VENDOR_ID => $vendor_id | BRANCH_ID => $vendor_branch_id | VEHICLE_TYPE => $vendor_vehicle_type_ID |SOURCE => $vehicle_permit_state_id | DESTINATION => $state_id | Permit_Cost => $permit_cost Inserted <br><br>"; */
                                                    else:
                                                    /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | VENDOR_ID => $vendor_id | BRANCH_ID => $vendor_branch_id | VEHICLE_TYPE => $vendor_vehicle_type_ID |SOURCE => $vehicle_permit_state_id | DESTINATION => $state_id ==> Permit Cose Not Inserted <br><br>"; */
                                                    endif;
                                                endif;
                                            endif;
                                        endforeach;

                                        /* echo "<br>";
                                        echo "<br>"; */

                                        // Initialize variables for morning and evening charges
                                        $morning_extra_time = 0;
                                        $evening_extra_time = 0;
                                        $DRIVER_MORINING_CHARGES = 0;
                                        $DRIVER_EVEINING_CHARGES = 0;
                                        $VENDOR_VEHICLE_MORNING_CHARGES = 0;
                                        $VENDOR_VEHICLE_EVENING_CHARGES = 0;
                                        $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE = 0;

                                        $TOTAL_PICKUP_KM = 0;
                                        $TOTAL_PICKUP_DURATION = "00:00:00";
                                        $TOTAL_DROP_KM = 0;
                                        $TOTAL_DROP_DURATION = "00:00:00";

                                        // Convert route start and end times to Unix timestamps
                                        $route_start_timestamp = strtotime($route_start_time);
                                        $route_end_timestamp = strtotime($route_end_time);

                                        // Calculate Unix timestamps for 6 AM and 8 PM
                                        $six_am_timestamp = strtotime('06:00:00');
                                        $eight_pm_timestamp = strtotime('20:00:00');

                                        // Check if route start time is before 6 AM and route end time is after 8 PM
                                        if ($route_start_timestamp < $six_am_timestamp && $route_end_timestamp > $eight_pm_timestamp) {
                                            // Calculate morning charges for the time before 6 AM
                                            $morning_difference_seconds = $six_am_timestamp - $route_start_timestamp;
                                            $morning_hours = floor($morning_difference_seconds / 3600); // 3600 seconds in an hour
                                            $morning_minutes = floor(($morning_difference_seconds % 3600) / 60); // remaining minutes
                                            $morning_extra_time = $morning_hours + ($morning_minutes / 60);

                                            // Calculate extra time charges for the time after 8 PM
                                            $extra_time_difference_seconds = $route_end_timestamp - $eight_pm_timestamp;
                                            $extra_time_hours = floor($extra_time_difference_seconds / 3600); // 3600 seconds in an hour
                                            $extra_time_minutes = floor(($extra_time_difference_seconds % 3600) / 60); // remaining minutes
                                            $evening_extra_time = $extra_time_hours + ($extra_time_minutes / 60);
                                        } elseif ($route_start_timestamp < $six_am_timestamp) {
                                            // Calculate morning charges if the route starts before 6 AM but ends before 8 PM
                                            $morning_difference_seconds = $six_am_timestamp - $route_start_timestamp;
                                            $morning_hours = floor($morning_difference_seconds / 3600); // 3600 seconds in an hour
                                            $morning_minutes = floor(($morning_difference_seconds % 3600) / 60); // remaining minutes
                                            $morning_extra_time = $morning_hours + ($morning_minutes / 60);
                                        } elseif ($route_end_timestamp > $eight_pm_timestamp) {
                                            // Calculate extra time charges if the route ends after 8 PM but starts after 6 AM
                                            $extra_time_difference_seconds = $route_end_timestamp - $eight_pm_timestamp;
                                            $extra_time_hours = floor($extra_time_difference_seconds / 3600); // 3600 seconds in an hour
                                            $extra_time_minutes = floor(($extra_time_difference_seconds % 3600) / 60); // remaining minutes
                                            $evening_extra_time = $extra_time_hours + ($extra_time_minutes / 60);
                                        }

                                        $DRIVER_MORINING_CHARGES = ($driver_early_morning_charges * $morning_extra_time);
                                        $DRIVER_EVEINING_CHARGES = ($driver_evening_charges * $evening_extra_time);
                                        $VENDOR_VEHICLE_MORNING_CHARGES = ($early_morning_charges * $morning_extra_time);
                                        $VENDOR_VEHICLE_EVENING_CHARGES = ($evening_charges * $evening_extra_time);

                                        $check_local_via_route_city = false;

                                        if ($via_locations_city):
                                            /* echo "#1 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                            // Check if all elements in $via_locations_city match $vehicle_origin_city
                                            $all_via_match = !empty($via_locations_city) && array_reduce($via_locations_city, function ($carry, $city) use ($vehicle_origin_city) {
                                                /* echo "$city == $vehicle_origin_city<br>"; */
                                                return $carry && ($city == $vehicle_origin_city);
                                            }, true);

                                            if ($all_via_match):
                                                /* echo "#2 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                                $check_local_via_route_city = true;
                                            endif;
                                        else:
                                            /* echo "#3 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                            $check_local_via_route_city = true;
                                        endif;

                                        /* echo "$source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_location_city == $source_location_city && $previous_destination_location_city == $destination_location_city)) && $check_local_via_route_city == true";
                                    echo "<br>"; */

                                        /* echo "$source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_destination_location_city == $source_location_city)) && $check_local_via_route_city == true";
                                    echo "<br>"; */

                                        /* $previous_location_city == $source_location_city &&  */
                                        if ($source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_destination_location_city == $source_location_city)) && $check_local_via_route_city == true) :
                                            //LOCAL TRIP
                                            $travel_type = 1;
                                            if ($route_count == 1) : //DAY 1 TRIP PLAN FOR LOCAL
                                                if ($vehicle_origin_city != $source_location_city) :

                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($vehicle_origin_city, $source_location_city);
                                                    $distance_from_vehicle_orign_to_pickup_point = calculateDistanceAndDuration($vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $location_latitude, $location_longtitude, $travel_location_type);

                                                    $pickup_distance = $distance_from_vehicle_orign_to_pickup_point['distance'];
                                                    $pickup_duration_time = $distance_from_vehicle_orign_to_pickup_point['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_PICKUP_KM = $pickup_distance;
                                                    $TOTAL_PICKUP_DURATION = $formated_pickup_duration;
                                                else :
                                                    $TOTAL_PICKUP_KM = 0;
                                                    $TOTAL_PICKUP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $GET_RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_KM = $TOTAL_PICKUP_KM + $GET_RUNNING_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $PICKUP_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_pickup_duration UTC");

                                                // Add the seconds
                                                $total_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $total_travelling_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                $time_parts = explode(':', $TOTAL_TIME);
                                                $TOTAL_TIME_hours = intval($time_parts[0]);
                                                $TOTAL_TIME_minutes = intval($time_parts[1]);

                                                /* echo "TOTAL_RUNNING_TRAVEL_TIME => $TOTAL_RUNNING_TRAVEL_TIME";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_TIME => $SIGHT_SEEING_TRAVELLING_TIME";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_KM => $SIGHT_SEEING_TRAVELLING_KM";
                                            echo "<br>";
                                            echo "GET_RUNNING_KM => $GET_RUNNING_KM";
                                            echo "<br>";
                                            echo "TOTAL_RUNNING_KM => $TOTAL_RUNNING_KM";
                                            echo "<br>";
                                            echo "TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS => $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS => $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "PICKUP_TIME_IN_SECONDS => $PICKUP_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "total_times_in_Seconds => $total_times_in_Seconds";
                                            echo "<br>";
                                            echo "TOTAL_TIME => $TOTAL_TIME";
                                            echo "<br>";
                                            echo "total_travelling_times_in_Seconds => $total_travelling_times_in_Seconds";
                                            echo "<br>";
                                            echo "TOTAL_TRAVELLING_TIME => $TOTAL_TRAVELLING_TIME";
                                            echo "<br>";
                                            echo "TOTAL_KM => $TOTAL_KM";
                                            echo "<br>";
                                            echo "TOTAL_TIME_hours => $TOTAL_TIME_hours";
                                            echo "<br>";
                                            echo "TOTAL_TIME_minutes => $TOTAL_TIME_minutes";
                                            echo "<br>"; */

                                                // Round the total time based on minutes
                                                if ($TOTAL_TIME_minutes < 30) :
                                                    $TOTAL_HOURS =  $TOTAL_TIME_hours;
                                                else :
                                                    $TOTAL_HOURS = $TOTAL_TIME_hours + 1;
                                                endif;

                                                $hours_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_hour_limit', $vendor_id, $TOTAL_HOURS);

                                                $km_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_km_limit', $vendor_id, $TOTAL_HOURS, $TOTAL_KM);

                                                /* echo "TOTAL_KM => $TOTAL_KM | km_time_limit_id => $km_time_limit_id";
                                            echo "<br>";
                                            echo "TOTAL_HOURS => $TOTAL_HOURS | hours_time_limit_id => $hours_time_limit_id";
                                            echo "<br>"; */

                                                // Determine which time limit ID to use
                                                if ($km_time_limit_id == $hours_time_limit_id) :
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id > $hours_time_limit_id) :
                                                    // If KM limit is greater
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id < $hours_time_limit_id) :
                                                    // If hour limit is greater
                                                    $time_limit_id = $hours_time_limit_id;
                                                    $getTIMELIMITID = $hours_time_limit_id;
                                                endif;

                                                /* echo "DAY 1 => final_time_limit_id => $time_limit_id";
                                            echo "<br>"; */

                                                $TOTAL_ALLOWED_LOCAL_KM = getTIMELIMIT($time_limit_id, 'km_limit', '', '', '');

                                                if ($TOTAL_KM > $TOTAL_ALLOWED_LOCAL_KM):
                                                    $TOTAL_LOCAL_EXTRA_KM = ($TOTAL_KM - $TOTAL_ALLOWED_LOCAL_KM);
                                                else:
                                                    $TOTAL_LOCAL_EXTRA_KM = 0;
                                                endif;

                                                /* echo "TOTAL_KM => $TOTAL_KM | TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM | TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                            echo "<br>";
                                            echo "<br>"; */

                                                $vehicle_cost_for_the_day = getVEHICLE_LOCAL_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $time_limit_id);

                                                # LOCAL TRIP TOLL CHARGES FOR DAY 1
                                                // TOLL CHARGE CALCULATION WITH VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                if ($get_via_route_IDs):

                                                    $toll_source_location = $location_name;
                                                    $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                    // VIA ROUTE LOCATION NAME
                                                    $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Check if $via_route_names is valid and is an array
                                                    if (!is_array($via_route_names)) :
                                                        $via_route_names = []; // Ensure it is an array even if empty
                                                    endif;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to the first VIA route (if available)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                    endif;

                                                    // Step 3: Via to Via for multiple VIA routes
                                                    for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                        $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                    endfor;

                                                    // Step 4: Last VIA route to Destination (or Source to Destination if no VIA routes)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                    else :
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                    endif;

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // LOCAL TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;

                                                else:
                                                    $toll_source_location = $location_name;
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to Destination
                                                    $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // LOCAL TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;

                                                    endforeach;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (LOC) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */
                                            else :
                                                $TOTAL_PICKUP_KM = 0;
                                                $TOTAL_PICKUP_DURATION = "00:00:00";

                                                /* $RUNNINGTIME = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_TRAVEL_TIME');

                                            // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                            preg_match('/(\d+) hour/', $RUNNINGTIME, $hoursMatch);
                                            preg_match('/(\d+) mins/', $RUNNINGTIME, $minutesMatch);

                                            // INITIALIZE HOURS AND MINUTES TO ZERO
                                            $runningtime_hours = 0;
                                            $runningtime_minutes = 0;

                                            $runningtime_hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                            $runningtime_minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                            // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                            $extraHours = floor($runningtime_minutes / 60);
                                            $runningtime_hours += $extraHours;
                                            $runningtime_minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                            // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                            $runningtime_formattedHours = str_pad($runningtime_hours, 2, '0', STR_PAD_LEFT);
                                            $runningtime_formattedMinutes = str_pad($runningtime_minutes, 2, '0', STR_PAD_LEFT);

                                            // FORMAT THE TIME AS H:i:s
                                            $formated_runningtime_duration = sprintf('%02d:%02d:00', $runningtime_formattedHours, $runningtime_formattedMinutes);

                                            $RUNNING_DISTANCE = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_DISTANCE'); */

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = '00:00:00';

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($destination_location_city, $vehicle_origin_city);
                                                    $distance_from_droping_point_to_vehicle_orign =  calculateDistanceAndDuration($next_visiting_location_latitude, $next_visiting_location_longitude, $vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $travel_location_type);

                                                    $return_pickup_distance = $distance_from_droping_point_to_vehicle_orign['distance'];
                                                    $return_pickup_duration_time = $distance_from_droping_point_to_vehicle_orign['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $return_pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $return_pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_return_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME');

                                                    $TOTAL_DROP_KM = $return_pickup_distance;
                                                    $TOTAL_DROP_DURATION = $formated_return_pickup_duration;
                                                else :
                                                    $TOTAL_DROP_KM = 0;
                                                    $TOTAL_DROP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_KM = $RUNNING_KM + $TOTAL_DROP_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $RUNNING_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_runningtime_duration UTC");
                                                $formated_return_pickup_duration = strtotime("1970-01-01 $formated_return_pickup_duration UTC");
                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME UTC");

                                                $total_travelling_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                // Add the seconds
                                                $total_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                $time_parts = explode(':', $TOTAL_TIME);
                                                $TOTAL_TIME_hours = intval($time_parts[0]);
                                                $TOTAL_TIME_minutes = intval($time_parts[1]);

                                                // Round the total time based on minutes
                                                if ($TOTAL_TIME_minutes < 30) :
                                                    $TOTAL_HOURS =  $TOTAL_TIME_hours;
                                                else :
                                                    $TOTAL_HOURS = $TOTAL_TIME_hours + 1;
                                                endif;

                                                $hours_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_hour_limit', $vendor_id, $TOTAL_HOURS);

                                                $km_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_km_limit', $vendor_id, $TOTAL_HOURS, $TOTAL_KM);

                                                /* echo "TOTAL_KM => $TOTAL_KM | km_time_limit_id => $km_time_limit_id";
                                            echo "<br>";
                                            echo "TOTAL_HOURS => $TOTAL_HOURS | hours_time_limit_id => $hours_time_limit_id";
                                            echo "<br>"; */

                                                // Determine which time limit ID to use
                                                if ($km_time_limit_id == $hours_time_limit_id) :
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id > $hours_time_limit_id) :
                                                    // If KM limit is greater
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id < $hours_time_limit_id) :
                                                    // If hour limit is greater
                                                    $time_limit_id = $hours_time_limit_id;
                                                    $getTIMELIMITID = $hours_time_limit_id;
                                                endif;

                                                /* echo "final_time_limit_id => $time_limit_id";
                                            echo "<br>"; */

                                                $TOTAL_ALLOWED_LOCAL_KM = getTIMELIMIT($time_limit_id, 'km_limit', '', '', '');

                                                if ($TOTAL_KM > $TOTAL_ALLOWED_LOCAL_KM):
                                                    $TOTAL_LOCAL_EXTRA_KM = ($TOTAL_KM - $TOTAL_ALLOWED_LOCAL_KM);
                                                else:
                                                    $TOTAL_LOCAL_EXTRA_KM = 0;
                                                endif;

                                                /* echo "TOTAL_KM => $TOTAL_KM | TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM | TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                            echo "<br>";
                                            echo "<br>"; */

                                                $vehicle_cost_for_the_day = getVEHICLE_LOCAL_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $time_limit_id);

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    # LOCAL TRIP LAST DAY TOLL CHAREGS
                                                    if ($get_via_route_IDs):
                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to the first VIA route (if available)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Step 2: Via to Via (for multiple via routes)
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Step 3: Last VIA route to Destination
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Step 4: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGIN
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Step 2: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                else:
                                                    # LOCAL TRIP IN BETWEEN DAYS TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Set the first location pair (source and first VIA route location)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Loop through the VIA route names to create subsequent location pairs
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Set the last location pair (last VIA route location and destination)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');
                                            endif;

                                        /* echo "<tr>";
                                        echo "<td>$itinerary_route_date <br> Day $route_count (LOC) <br> $route_start_time - $route_end_time</td>";
                                        echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                        echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                        echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                        echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                        echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                        echo "</tr>"; */

                                        else :
                                            //OUTSTATION TRIP
                                            $travel_type = 2;
                                            if ($route_count == 1) : //DAY 1 TRIP PLAN FOR OUTSTATION
                                                if ($vehicle_origin_city != $source_location_city) :

                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($vehicle_origin_city, $source_location_city);
                                                    $distance_from_vehicle_orign_to_pickup_point = calculateDistanceAndDuration($vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $location_latitude, $location_longtitude, $travel_location_type);

                                                    $pickup_distance = $distance_from_vehicle_orign_to_pickup_point['distance'];
                                                    $pickup_duration_time = $distance_from_vehicle_orign_to_pickup_point['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_PICKUP_KM = $pickup_distance;
                                                    $TOTAL_PICKUP_DURATION = $formated_pickup_duration;
                                                else :
                                                    $TOTAL_PICKUP_KM = 0;
                                                    $TOTAL_PICKUP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $GET_RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_KM = $TOTAL_PICKUP_KM + $GET_RUNNING_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $PICKUP_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_pickup_duration UTC");

                                                // Add the seconds
                                                $total_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $total_travelling_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                # OUTSTATION TRIP TOLL CHARGES FOR DAY 1
                                                // TOLL CHARGE CALCULATION WITH VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                if ($get_via_route_IDs):

                                                    $toll_source_location = $location_name;
                                                    $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                    // VIA ROUTE LOCATION NAME
                                                    $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Check if $via_route_names is valid and is an array
                                                    if (!is_array($via_route_names)) :
                                                        $via_route_names = []; // Ensure it is an array even if empty
                                                    endif;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to the first VIA route (if available)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                    endif;

                                                    // Step 3: Via to Via for multiple VIA routes
                                                    for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                        $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                    endfor;

                                                    // Step 4: Last VIA route to Destination (or Source to Destination if no VIA routes)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                    else :
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                    endif;

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;

                                                else:

                                                    $toll_source_location = $location_name;
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to Destination
                                                    $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (OUT) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */
                                            else :
                                                $TOTAL_PICKUP_KM = 0;
                                                $TOTAL_PICKUP_DURATION = "00:00:00";

                                                /* $RUNNINGTIME = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_TRAVEL_TIME');

                                            // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                            preg_match('/(\d+) hour/', $RUNNINGTIME, $hoursMatch);
                                            preg_match('/(\d+) mins/', $RUNNINGTIME, $minutesMatch);

                                            // INITIALIZE HOURS AND MINUTES TO ZERO
                                            $runningtime_hours = 0;
                                            $runningtime_minutes = 0;

                                            $runningtime_hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                            $runningtime_minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                            // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                            $extraHours = floor($runningtime_minutes / 60);
                                            $runningtime_hours += $extraHours;
                                            $runningtime_minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                            // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                            $runningtime_formattedHours = str_pad($runningtime_hours, 2, '0', STR_PAD_LEFT);
                                            $runningtime_formattedMinutes = str_pad($runningtime_minutes, 2, '0', STR_PAD_LEFT);

                                            // FORMAT THE TIME AS H:i:s
                                            $formated_runningtime_duration = sprintf('%02d:%02d:00', $runningtime_formattedHours, $runningtime_formattedMinutes);

                                            $RUNNING_DISTANCE = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_DISTANCE'); */

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = '00:00:00';

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    $travel_location_type = getTravelLocationType($destination_location_city, $vehicle_origin_city);
                                                    $distance_from_droping_point_to_vehicle_orign =  calculateDistanceAndDuration($next_visiting_location_latitude, $next_visiting_location_longitude, $vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $travel_location_type);

                                                    $return_pickup_distance = $distance_from_droping_point_to_vehicle_orign['distance'];
                                                    $return_pickup_duration_time = $distance_from_droping_point_to_vehicle_orign['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $return_pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $return_pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_return_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME');

                                                    $TOTAL_DROP_KM = $return_pickup_distance;
                                                    $TOTAL_DROP_DURATION = $formated_return_pickup_duration;

                                                else :
                                                    $TOTAL_DROP_KM = 0;
                                                    $TOTAL_DROP_DURATION = "00:00:00";
                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_KM = $RUNNING_KM + $TOTAL_DROP_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $RUNNING_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_runningtime_duration UTC");
                                                $formated_return_pickup_duration_in_seconds = strtotime("1970-01-01 $formated_return_pickup_duration UTC");
                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME UTC");

                                                $total_travelling_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration_in_seconds) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                // Add the seconds
                                                $total_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration_in_seconds) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    # OUTSTATION TRIP LAST DAY TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to the first VIA route (if available)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Step 2: Via to Via (for multiple via routes)
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Step 3: Last VIA route to Destination
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Step 4: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges

                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:

                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Step 2: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                else:
                                                    # OUTSTATION TRIP IN BETWEEN DAYS TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Set the first location pair (source and first VIA route location)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Loop through the VIA route names to create subsequent location pairs
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Set the last location pair (last VIA route location and destination)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (OUT) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */

                                            endif;
                                        endif;

                                        $TOTAL_VEHICLE_AMOUNT = ($vehicle_cost_for_the_day + $VEHICLE_TOLL_CHARGE + $VEHICLE_PARKING_CHARGE + $TOTAL_DRIVER_CHARGES + $permit_charges + $DRIVER_MORINING_CHARGES + $VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_EVEINING_CHARGES + $VENDOR_VEHICLE_EVENING_CHARGES);

                                        $OVERALL_TOTAL_KM += $TOTAL_KM;
                                        $OVERALL_TOTAL_TIME[] = $TOTAL_TIME;
                                        $OVERALL_RENDAL_CHARGES += $vehicle_cost_for_the_day;
                                        $array_of_vehicle_cost_for_the_day[] = $vehicle_cost_for_the_day;
                                        $OVERALL_VEHICLE_TOLL_CHARGE += $VEHICLE_TOLL_CHARGE;
                                        $OVERALL_VEHICLE_PARKING_CHARGE += $VEHICLE_PARKING_CHARGE;
                                        $OVERALL_TOTAL_DRIVER_CHARGES += $TOTAL_DRIVER_CHARGES;
                                        $OVERALL_PERMIT_CHARGES += $permit_charges;
                                        $OVERALL_BEFORE_6AM_EXTRA_TIME += $morning_extra_time;
                                        $OVERALL_AFTER_8PM_EXTRA_TIME += $evening_extra_time;
                                        $OVERALL_DRIVER_MORINING_CHARGES += $DRIVER_MORINING_CHARGES;
                                        $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES += $VENDOR_VEHICLE_MORNING_CHARGES;
                                        $OVERALL_DRIVER_EVEINING_CHARGES += $DRIVER_EVEINING_CHARGES;
                                        $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES += $VENDOR_VEHICLE_EVENING_CHARGES;
                                        $OVERALL_TOTAL_VEHICLE_AMOUNT += $TOTAL_VEHICLE_AMOUNT;

                                        if ($travel_type == 2) :
                                            $getTIMELIMITID = 0;
                                            $TOTAL_LOCAL_EXTRA_KM = 0;
                                            $TOTAL_LOCAL_EXTRA_KM_CHARGES = 0;
                                            $OVERALL_OUTSTATION_KM += $TOTAL_KM;
                                            $TOTAL_ALLOWED_LOCAL_KM = 0;
                                        else :
                                            $getTIMELIMITID = $getTIMELIMITID;
                                            $TOTAL_LOCAL_EXTRA_KM = $TOTAL_LOCAL_EXTRA_KM;
                                            if ($TOTAL_LOCAL_EXTRA_KM > 0):
                                                $TOTAL_LOCAL_EXTRA_KM_CHARGES = ($TOTAL_LOCAL_EXTRA_KM * $extra_km_charge);
                                            else:
                                                $TOTAL_LOCAL_EXTRA_KM_CHARGES = 0;
                                            endif;
                                            $OVERALL_OUTSTATION_KM += 0;
                                            $TOTAL_ALLOWED_LOCAL_KM = $TOTAL_ALLOWED_LOCAL_KM;
                                        endif;

                                        /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | vehicle_type_id => $vehicle_type_id | vendor_id => $vendor_id | vehicle_id => $vehicle_id <br>";
                                    echo "TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                    echo "TOTAL_LOCAL_EXTRA_KM_CHARGES => $TOTAL_LOCAL_EXTRA_KM_CHARGES <br>";
                                    echo "OVERALL_OUTSTATION_KM => $OVERALL_OUTSTATION_KM <br>";
                                    echo "TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM <br>";
                                    echo "getTIMELIMITID => $getTIMELIMITID <br><br>"; */

                                        $OVERALL_LOCAL_KM += $TOTAL_ALLOWED_LOCAL_KM;
                                        $OVERALL_LOCAL_EXTRA_KM += $TOTAL_LOCAL_EXTRA_KM;
                                        $OVERALL_LOCAL_EXTRA_KM_CHARGES += $TOTAL_LOCAL_EXTRA_KM_CHARGES;

                                        $TOTAL_RUNNING_KM = $TOTAL_RUNNING_KM ?? 0;
                                        $TOTAL_TRAVELLING_TIME = $TOTAL_TRAVELLING_TIME ?? "00:00:00";
                                        $SIGHT_SEEING_TRAVELLING_KM = $SIGHT_SEEING_TRAVELLING_KM ?? 0;
                                        $SIGHT_SEEING_TRAVELLING_TIME = $SIGHT_SEEING_TRAVELLING_TIME ?? "00:00:00";
                                        $TOTAL_KM = $TOTAL_KM ?? 0;
                                        $TOTAL_TIME = $TOTAL_TIME ?? "00:00:00";
                                        $vehicle_cost_for_the_day = $vehicle_cost_for_the_day ?? 0;
                                        $VEHICLE_TOLL_CHARGE = $VEHICLE_TOLL_CHARGE ?? 0;
                                        $VEHICLE_PARKING_CHARGE = $VEHICLE_PARKING_CHARGE ?? 0;
                                        $TOTAL_DRIVER_CHARGES = $TOTAL_DRIVER_CHARGES ?? 0;
                                        $permit_charges = $permit_charges ?? 0;
                                        $morning_extra_time = $morning_extra_time ?? "00:00:00";
                                        $evening_extra_time = $evening_extra_time ?? "00:00:00";
                                        $DRIVER_MORINING_CHARGES = $DRIVER_MORINING_CHARGES ?? 0;
                                        $VENDOR_VEHICLE_MORNING_CHARGES = $VENDOR_VEHICLE_MORNING_CHARGES ?? 0;
                                        $DRIVER_EVEINING_CHARGES = $DRIVER_EVEINING_CHARGES ?? 0;
                                        $VENDOR_VEHICLE_EVENING_CHARGES = $VENDOR_VEHICLE_EVENING_CHARGES ?? 0;
                                        $TOTAL_VEHICLE_AMOUNT = $TOTAL_VEHICLE_AMOUNT ?? 0;

                                        //INSERT ALL THE ELIGIBLE VENDOR WISE VEHICLE LIST 
                                        $vendor_vehicle_details_arrFields = array('`itinerary_plan_id`', '`itinerary_route_id`', '`vehicle_type_id`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_qty`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_date`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`added_via_amendment`', '`createdby`', '`status`');

                                        if ($getTIMELIMITID):
                                            $getTIMELIMITID = $getTIMELIMITID;
                                        else:
                                            $getTIMELIMITID = "0";
                                        endif;

                                        $vendor_vehicle_details_arrValues = array("$itinerary_plan_ID", "$itinerary_route_ID", "$vehicle_type_id", "$vendor_id", "$vendor_vehicle_type_ID", "1", "$vehicle_id", "$vendor_branch_id", "$getTIMELIMITID", "$travel_type", "$itinerary_route_date", "$location_name", "$next_visiting_location", "$TOTAL_RUNNING_KM", "$TOTAL_TRAVELLING_TIME", "$SIGHT_SEEING_TRAVELLING_KM", "$SIGHT_SEEING_TRAVELLING_TIME", "$TOTAL_PICKUP_KM", "$TOTAL_PICKUP_DURATION", "$TOTAL_DROP_KM", "$TOTAL_DROP_DURATION", "$TOTAL_LOCAL_EXTRA_KM", "$extra_km_charge", "$TOTAL_LOCAL_EXTRA_KM_CHARGES", "$TOTAL_KM", "$TOTAL_TIME", "$vehicle_cost_for_the_day", "$VEHICLE_TOLL_CHARGE", "$VEHICLE_PARKING_CHARGE", "$TOTAL_DRIVER_CHARGES", "$permit_charges", "$morning_extra_time", "$evening_extra_time", "$DRIVER_MORINING_CHARGES", "$VENDOR_VEHICLE_MORNING_CHARGES", "$DRIVER_EVEINING_CHARGES", "$VENDOR_VEHICLE_EVENING_CHARGES", "$TOTAL_VEHICLE_AMOUNT", "1", "$logged_user_id", "1");

                                        if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, '')) :
                                            $confirmed_itinerary_plan_vendor_vehicle_details_ID = sqlINSERTID_LABEL();
                                            $arrFields_vehicle_vendor_details = array('`confirmed_itinerary_plan_vendor_vehicle_details_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`vehicle_type_id`', '`vehicle_qty`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`','`added_via_amendment`', '`createdby`', '`status`');

                                            $arrValues_vehicle_vendor_details = array("$confirmed_itinerary_plan_vendor_vehicle_details_ID", "$itinerary_plan_ID", "$itinerary_route_ID", "$itinerary_route_date", "$vehicle_type_id", "1", "$vendor_id", "$vendor_vehicle_type_ID", "$vehicle_id", "$vendor_branch_id", "$getTIMELIMITID", "$travel_type", "$location_name", "$next_visiting_location", "$TOTAL_RUNNING_KM", "$TOTAL_TRAVELLING_TIME", "$SIGHT_SEEING_TRAVELLING_KM", "$SIGHT_SEEING_TRAVELLING_TIME", "$TOTAL_PICKUP_KM", "$TOTAL_PICKUP_DURATION", "$TOTAL_DROP_KM", "$TOTAL_DROP_DURATION", "$TOTAL_LOCAL_EXTRA_KM", "$extra_km_charge", "$TOTAL_LOCAL_EXTRA_KM_CHARGES", "$TOTAL_KM", "$TOTAL_TIME", "$vehicle_cost_for_the_day", "$VEHICLE_TOLL_CHARGE", "$VEHICLE_PARKING_CHARGE", "$TOTAL_DRIVER_CHARGES", "$permit_charges", "$morning_extra_time", "$evening_extra_time", "$DRIVER_MORINING_CHARGES", "$VENDOR_VEHICLE_MORNING_CHARGES", "$DRIVER_EVEINING_CHARGES", "$VENDOR_VEHICLE_EVENING_CHARGES", "$TOTAL_VEHICLE_AMOUNT", "1","$logged_user_id", "1");
                                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_vehicle_details", $arrFields_vehicle_vendor_details, $arrValues_vehicle_vendor_details, '')) :
                                                $inserted_cancelled_itinerary_plan_vendor_vehicle_id = sqlINSERTID_LABEL();
                                            endif;
                                        endif;
                                        // if ($vehicle_qty < $get_vehicle_type_count) :
                                        //     if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, '')) :
                                        //     endif;
                                        // else :
                                        //     $vendor_vehicle_details_sqlwhere = " `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ";

                                        //     if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, $vendor_vehicle_details_sqlwhere)) :
                                        //     endif;
                                        // endif;
                                        $previous_location_city = $source_location_city;
                                        $previous_destination_location_city = $destination_location_city;
                                    endwhile;
                                /* echo "</table>";
                                echo "<br>"; */
                                else :
                                    $errors['no_more_route_details_found'] = "No more route details found !!!";
                                endif;
                            endif;

                            $overall_time_total_hours = NULL;
                            $overall_time_total_minutes = NULL;

                            // Loop through each time and calculate total hours and minutes
                            /* foreach ($OVERALL_TOTAL_TIME as $time) :
                            list($hours, $minutes, $seconds) = explode(":", $time);

                            // Convert time to total minutes
                            $overall_time_total_minutes += $hours * 60 + $minutes;
                            endforeach; */

                            if (isset($OVERALL_TOTAL_TIME) && is_iterable($OVERALL_TOTAL_TIME)) :
                                foreach ($OVERALL_TOTAL_TIME as $time) :
                                    list($hours, $minutes, $seconds) = explode(":", $time);

                                    // Convert time to total minutes
                                    $overall_time_total_minutes += $hours * 60 + $minutes;
                                endforeach;
                            endif;

                            // Calculate total hours from total minutes
                            $overall_time_total_hours += floor($overall_time_total_minutes / 60);
                            $overall_time_total_minutes %= 60; // Remaining minutes after converting to hours

                            $OVERALL_TOTAL_HOURS_n_MINS = $overall_time_total_hours . '.' . $overall_time_total_minutes;

                            $PER_DAY_KM_LIMIT = $get_kms_limit;

                            $select_total_outstaion_day_data = sqlQUERY_LABEL("SELECT COUNT(*) AS count FROM ( SELECT `confirmed_itinerary_plan_vendor_vehicle_details_ID`, `travel_type` FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `confirmed_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details) AS limited_rows WHERE `travel_type` = '2'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            /* $total_outstation_day_available_count = sqlNUMOFROW_LABEL($select_total_outstaion_day_data); */
                            while ($fetch_total_outstaion_day_data = sqlFETCHARRAY_LABEL($select_total_outstaion_day_data)) :
                                $total_outstation_day_available_count = $fetch_total_outstaion_day_data['count'];
                            endwhile;

                            $TOTAL_ITINEARY_ALLOWED_KM = ($PER_DAY_KM_LIMIT * $total_outstation_day_available_count);
                            $PER_EXTRA_KM_CHARGE = $extra_km_charge;

                            /* echo "OVERALL_OUTSTATION_KM => $OVERALL_OUTSTATION_KM | TOTAL_ITINEARY_ALLOWED_KM => $TOTAL_ITINEARY_ALLOWED_KM | PER_EXTRA_KM_CHARGE => $PER_EXTRA_KM_CHARGE | TOTAL_EXTRA_KM => $TOTAL_EXTRA_KM <br>"; */

                            $get_extra_kms = ($OVERALL_OUTSTATION_KM - $TOTAL_ITINEARY_ALLOWED_KM);

                            if ($get_extra_kms > 0) :
                                $TOTAL_EXTRA_KM = $get_extra_kms;
                                $TOTAL_EXTRA_KM_CHARGE = ($TOTAL_EXTRA_KM * $PER_EXTRA_KM_CHARGE);
                            else :
                                $TOTAL_EXTRA_KM = 0;
                                $TOTAL_EXTRA_KM_CHARGE = 0;
                            endif;

                            $OVERALL_TOTAL_VEHICLE_AMOUNT = $OVERALL_TOTAL_VEHICLE_AMOUNT + $TOTAL_EXTRA_KM_CHARGE + $OVERALL_LOCAL_EXTRA_KM_CHARGES;

                            if ($vendor_branch_gst > 0) :
                                if ($vendor_branch_gst_type == 1) :
                                    // For Inclusive GST
                                    $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT / (1 + ($vendor_branch_gst / 100));
                                    $new_total_vehicle_tax_amt = ($OVERALL_TOTAL_VEHICLE_AMOUNT - $new_total_vehicle_cost);
                                elseif ($vendor_branch_gst_type == 2) :
                                    // For Exclusive GST
                                    $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT;
                                    $new_total_vehicle_tax_amt = ($OVERALL_TOTAL_VEHICLE_AMOUNT * $vendor_branch_gst / 100);
                                endif;
                            else :
                                $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT;
                                $new_total_vehicle_tax_amt = 0;
                            endif;

                            $TOTAL_VENDOR_MARGIN_AMOUNT = (($OVERALL_TOTAL_VEHICLE_AMOUNT * $vendor_margin) / 100);

                            if ($vendor_margin_gst_percentage > 0) :
                                if ($vendor_margin_gst_type == 1) :
                                    // For Inclusive GST
                                    $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT / (1 + ($vendor_margin_gst_percentage / 100));
                                    $new_total_margin_service_tax_amt = ($TOTAL_VENDOR_MARGIN_AMOUNT - $new_total_margin_amount);
                                elseif ($vendor_margin_gst_type == 2) :
                                    // For Exclusive GST
                                    $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT;
                                    $new_total_margin_service_tax_amt = ($TOTAL_VENDOR_MARGIN_AMOUNT * $vendor_margin_gst_percentage / 100);
                                endif;
                            else :
                                $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT;
                                $new_total_margin_service_tax_amt = 0;
                            endif;

                            $VEHICLE_GRAND_TOTAL_AMOUNT = ($new_total_vehicle_cost + $new_total_vehicle_tax_amt + $new_total_margin_amount + $new_total_margin_service_tax_amt);

                            $array_of_vehicle_cost_for_the_day = $array_of_vehicle_cost_for_the_day ?? [];

                            $OVERALL_TOTAL_KM = $OVERALL_TOTAL_KM ?? 0;
                            $OVERALL_OUTSTATION_KM = $OVERALL_OUTSTATION_KM ?? 0;
                            $OVERALL_TOTAL_HOURS_n_MINS = $OVERALL_TOTAL_HOURS_n_MINS ?? "00:00:00";
                            $OVERALL_RENDAL_CHARGES = $OVERALL_RENDAL_CHARGES ?? 0;
                            $OVERALL_VEHICLE_TOLL_CHARGE = $OVERALL_VEHICLE_TOLL_CHARGE ?? 0;
                            $OVERALL_VEHICLE_PARKING_CHARGE = $OVERALL_VEHICLE_PARKING_CHARGE ?? 0;
                            $OVERALL_TOTAL_DRIVER_CHARGES = $OVERALL_TOTAL_DRIVER_CHARGES ?? 0;
                            $OVERALL_PERMIT_CHARGES = $OVERALL_PERMIT_CHARGES ?? 0;
                            $OVERALL_BEFORE_6AM_EXTRA_TIME = $OVERALL_BEFORE_6AM_EXTRA_TIME ?? "00:00:00";
                            $OVERALL_AFTER_8PM_EXTRA_TIME = $OVERALL_AFTER_8PM_EXTRA_TIME ?? "00:00:00";
                            $OVERALL_DRIVER_MORINING_CHARGES = $OVERALL_DRIVER_MORINING_CHARGES ?? 0;
                            $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES = $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES ?? 0;
                            $OVERALL_DRIVER_EVEINING_CHARGES = $OVERALL_DRIVER_EVEINING_CHARGES ?? 0;
                            $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES = $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES ?? 0;
                            $PER_EXTRA_KM_CHARGE = $PER_EXTRA_KM_CHARGE ?? 0;
                            $TOTAL_ITINEARY_ALLOWED_KM = $TOTAL_ITINEARY_ALLOWED_KM ?? 0;
                            $TOTAL_EXTRA_KM = $TOTAL_EXTRA_KM ?? 0;
                            $TOTAL_EXTRA_KM_CHARGE = $TOTAL_EXTRA_KM_CHARGE ?? 0;
                            $vendor_branch_gst = $vendor_branch_gst ?? 0;
                            $new_total_vehicle_tax_amt = $new_total_vehicle_tax_amt ?? 0;
                            $new_total_vehicle_cost = $new_total_vehicle_cost ?? 0;
                            $vendor_margin = $vendor_margin ?? 0;
                            $vendor_margin_gst_percentage = $vendor_margin_gst_percentage ?? 0;
                            $new_total_margin_amount = $new_total_margin_amount ?? 0;
                            $new_total_margin_service_tax_amt = $new_total_margin_service_tax_amt ?? 0;
                            $VEHICLE_GRAND_TOTAL_AMOUNT = $VEHICLE_GRAND_TOTAL_AMOUNT ?? 0;

                            /* $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_itinerary_plan_vendor_vehicle_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` != '$vendor_id' AND `vehicle_type_id` != '$vehicle_type_id' AND `vendor_branch_id` != '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                            $delete_itinerary_plan_vendor_eligible_list = sqlQUERY_LABEL("DELETE FROM `dvi_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` != '$vendor_id' AND `vehicle_type_id` != '$vehicle_type_id' AND `vendor_branch_id` != '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL()); */

                            /* $check_vehicle_eligible_list_already_available = sqlQUERY_LABEL("SELECT `itinerary_plan_vendor_eligible_ID` FROM `dvi_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            $total_vehicle_eligible_list_available_count = sqlNUMOFROW_LABEL($check_vehicle_eligible_list_already_available); */

                            // $check_vehicle_eligible_list_already_available = sqlQUERY_LABEL("SELECT COALESCE(SUM(CASE WHEN total_vehicle_qty = 0 THEN 1 ELSE total_vehicle_qty END), 0) AS total_vehicle_qty FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            // while ($fetch_vehicle_vendor_eligible_data = sqlFETCHARRAY_LABEL($check_vehicle_eligible_list_already_available)) :
                            //     $total_vehicle_qty = $fetch_vehicle_vendor_eligible_data['total_vehicle_qty'];
                            // endwhile;


                            //INSERT ALL THE ELIGIBLE VENDOR WISE VEHICLE LIST 
                            $vendor_eligible_list_arrFields = array('`itinerary_plan_id`', '`vehicle_type_id`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`',  '`total_vehicle_qty`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`',  '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`','`added_via_amendment`', '`createdby`', '`status`');

                            $vendor_eligible_list_arrValues = array("$itinerary_plan_ID", "$vehicle_type_id", "$vendor_id", "$get_kms_limit", "$vendor_vehicle_type_ID", "1", "$vehicle_id", "$vendor_branch_id", "$vehicle_origin", "1", "$OVERALL_TOTAL_KM", "$OVERALL_OUTSTATION_KM", "$OVERALL_TOTAL_HOURS_n_MINS", "$OVERALL_RENDAL_CHARGES", "$OVERALL_VEHICLE_TOLL_CHARGE", "$OVERALL_VEHICLE_PARKING_CHARGE", "$OVERALL_TOTAL_DRIVER_CHARGES", "$OVERALL_PERMIT_CHARGES", "$OVERALL_BEFORE_6AM_EXTRA_TIME", "$OVERALL_AFTER_8PM_EXTRA_TIME",  "$OVERALL_DRIVER_MORINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_MORNING_CHARGES", "$OVERALL_DRIVER_EVEINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_EVENING_CHARGES", "$PER_EXTRA_KM_CHARGE", "$TOTAL_ITINEARY_ALLOWED_KM", "$TOTAL_EXTRA_KM", "$TOTAL_EXTRA_KM_CHARGE", "$OVERALL_LOCAL_KM", "$OVERALL_LOCAL_EXTRA_KM", "$OVERALL_LOCAL_EXTRA_KM_CHARGES", "$vendor_branch_gst_type", "$vendor_branch_gst", "$new_total_vehicle_tax_amt", "$new_total_vehicle_cost", "$vendor_margin", "$vendor_margin_gst_type", "$vendor_margin_gst_percentage", "$new_total_margin_amount", "$new_total_margin_service_tax_amt", "$VEHICLE_GRAND_TOTAL_AMOUNT", "1", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $vendor_eligible_list_arrFields, $vendor_eligible_list_arrValues, '')) :
                                $confirmed_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();

                                $arrFields_vehicle_details = array('`confirmed_itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_id`', '`vehicle_type_id`', '`total_vehicle_qty`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`', '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`','`added_via_amendment`', '`createdby`', '`status`');

                                $arrValues_vehicle_details = array("$confirmed_itinerary_plan_vendor_eligible_ID", "$itinerary_plan_ID", "$vehicle_type_id", "1", "$vendor_id", "$get_kms_limit", "$vendor_vehicle_type_ID", "$vehicle_id", "$vendor_branch_id", "$vehicle_origin", "1",  "$OVERALL_TOTAL_KM", "$OVERALL_OUTSTATION_KM", "$OVERALL_TOTAL_HOURS_n_MINS", "$OVERALL_RENDAL_CHARGES", "$OVERALL_VEHICLE_TOLL_CHARGE", "$OVERALL_VEHICLE_PARKING_CHARGE", "$OVERALL_TOTAL_DRIVER_CHARGES", "$OVERALL_PERMIT_CHARGES", "$OVERALL_BEFORE_6AM_EXTRA_TIME", "$OVERALL_AFTER_8PM_EXTRA_TIME", "$OVERALL_DRIVER_MORINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_MORNING_CHARGES", "$OVERALL_DRIVER_EVEINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_EVENING_CHARGES", "$PER_EXTRA_KM_CHARGE", "$TOTAL_ITINEARY_ALLOWED_KM", "$TOTAL_EXTRA_KM", "$TOTAL_EXTRA_KM_CHARGE", "$OVERALL_LOCAL_KM", "$OVERALL_LOCAL_EXTRA_KM", "$OVERALL_LOCAL_EXTRA_KM_CHARGES", "$vendor_branch_gst_type", "$vendor_branch_gst", "$new_total_vehicle_tax_amt", "$new_total_vehicle_cost", "$vendor_margin", "$vendor_margin_gst_type", "$vendor_margin_gst_percentage", "$new_total_margin_amount", "$new_total_margin_service_tax_amt", "$VEHICLE_GRAND_TOTAL_AMOUNT", "1", "$logged_user_id", "1");
                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $arrFields_vehicle_details, $arrValues_vehicle_details, '')) :
                                    $cancelled_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();
                                endif;

                                $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_vehicle_details` SET `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `confirmed_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                                $update_cancelled_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_vehicle_details` SET `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' , `cancelled_itinerary_plan_vendor_eligible_ID` = '$cancelled_itinerary_plan_vendor_eligible_ID' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `cancelled_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            endif;

                        endfor;
                    endwhile;

                    $selected_vehicle_type = $_POST['vendor_vehicle_type'];
                    $selected_vehicle_count = $_POST['vendor_vehicle_quantity'];

                    $select_itineary_required_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id` FROM `dvi_confirmed_itinerary_plan_vehicle_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' AND `vehicle_type_id` IN (" . implode(",", $selected_vehicle_type) . ") and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                    $total_no_of_vehicle_required_count = sqlNUMOFROW_LABEL($select_itineary_required_vehicle_details);
                    if ($total_no_of_vehicle_required_count > 0) :

                        $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY `confirmed_itinerary_plan_vendor_eligible_ID` ASC") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                        $update_confirmed_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY `cancelled_itinerary_plan_vendor_eligible_ID` ASC") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                        while ($fetch_vehicle_eligible_data = sqlFETCHARRAY_LABEL($select_itineary_required_vehicle_details)) :
                            $vehicle_type_id = $fetch_vehicle_eligible_data['vehicle_type_id'];
                            $total_required_count = getCNFITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');
                            $array_of_vehicle_type_id[] = $fetch_vehicle_eligible_data['vehicle_type_id'];
                            $confirmed_itinerary_plan_vendor_eligible_ID = $fetch_vehicle_eligible_data['confirmed_itinerary_plan_vendor_eligible_ID'];

                            $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' AND `vehicle_grand_total` > '0' ORDER BY `vehicle_grand_total` ASC LIMIT $total_required_count") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                            $update_confirmed_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' AND `vehicle_grand_total` > '0' ORDER BY `vehicle_grand_total` ASC LIMIT $total_required_count") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                        endwhile;

                    // $required_vehicle_types = implode(',', $array_of_vehicle_type_id);

                    // $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` NOT IN ($selected_vehicle_type)") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                    // $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` NOT IN ($selected_vehicle_type) AND `confirmed_itinerary_plan_vendor_eligible_ID` != '0'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                    endif;
                else :
                    $errors['no_more_vehicle_found_this_route'] = "No more vehicle found between these routes !!!";
                endif;
            endif;
        else :
            $errors['no_more_vehicle_records'] = "No more vehicle records found !!!";
        endif;

        if (!empty($errors)) :
            //error call
            $response['success'] = false;
            $response['i_result'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;
            $response['i_result'] = true;
            $response['itinerary_plan_ID'] = $itinerary_plan_ID;

            //if itinerary is already being cancelled and we add a new vendor to the same, then we need to revert the cancellation status
            $select_itineary_details = sqlQUERY_LABEL("SELECT `itinerary_plan_ID` FROM `dvi_confirmed_itinerary_plan_details`  WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND  `itinerary_cancellation_status` = '1' AND  `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            $itinerary_count = sqlNUMOFROW_LABEL($select_itineary_details);
            if ($itinerary_count > 0) :
                $confirmed_arrFields = array('`itinerary_cancellation_status`');
                $confirmed_arrValues = array("0");
                $confirmed_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' ";
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_details", $confirmed_arrFields, $confirmed_arrValues, $confirmed_sqlWhere)) :
                    $cancelled_arrFields = array('`itinerary_cancellation_status`');
                    $cancelled_arrValues = array("0");
                    $cancelled_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_arrFields, $cancelled_arrValues, $cancelled_sqlWhere)) :
                    endif;
                endif;
            endif;

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'add_new_vehicle_type') :

        $response = [];
        $errors = [];

        $itinerary_plan_ID = $_POST['itinerary_plan_id'];
        $vendor_id = $_POST['vendor_id'];
        $vehicle_type = $_POST['vehicle_type'];
        $vehicle_count = $_POST['vehicle_quantity'];
        $vehicle_type_id = $_POST['vehicle_type'];

        if (empty($vehicle_type_id) || empty($vehicle_count)):
          
            $errors['vehicle_type_with_qty_required'] = true;
                    endif;


                    $array_of_location_name = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_location_name', '');
                        $array_of_next_visiting_location = getITINEARYROUTE_DETAILS($itinerary_plan_ID, '', 'array_of_next_visiting_location', '');

                        $eligible_vehicle_location = array_merge($array_of_location_name, $array_of_next_visiting_location);

                        $get_eligible_location_citys = getSTOREDLOCATIONDETAILS($eligible_vehicle_location, 'get_location_city_from_location_name');

                        $get_implode_eligible_location_CITYS = implode("','", $get_eligible_location_citys);

                        // INITIALIZE AN ARRAY TO STORE AVAILABLE VEHICLE COUNT FOR EACH VEHICLE TYPE
                        $available_vehicle_counts = [];

                    for ($i = 0; $i < count($vehicle_type_id); $i++) :
                            $current_vehicle_type_id = $vehicle_type_id[$i];
                            //QUERY TO GET AVAILABLE VEHICLE COUNT DATA
                            $check_vehicle_type_wise_vehicle_count_availability = sqlQUERY_LABEL("SELECT COUNT(VEHICLE.`vehicle_type_id`) AS available_vehicle_count FROM `dvi_vehicle` AS VEHICLE LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id` = VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`status` = '1' AND VEHICLE.`deleted` = '0' AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` = '$current_vehicle_type_id' AND VENDOR_DETAILS.`vendor_id` = '$vendor_id' AND VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') GROUP BY VEHICLE.`vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                            //FETCH AVAILABLE VEHICLE COUNT DATA
                            $fetch_available_vehicle_count_data = sqlNUMOFROW_LABEL($check_vehicle_type_wise_vehicle_count_availability);

                            //CHECK IF ANY AVILABLE VEHICLE COUNT DATA FOR THE CURRENT VEHICLE TYPE
                            if ($fetch_available_vehicle_count_data) :
                                //STORE THE AVAILABLE VEHICLE COUNT FOR THE CURRENT VEHICLE TYPE
                                $available_vehicle_counts[$current_vehicle_type_id] = $fetch_available_vehicle_count_data;
                            else :
                                //IF NO DATA AVAILABLE SET TO 0 FOR THIS VEHICLE TYPE
                                $available_vehicle_counts[$current_vehicle_type_id] = 0;
                            endif;
                        endfor;

            # CHECKING THE SHORTAGES OF VEHICLE TYPE
                        for ($i = 0; $i < count($vehicle_type_id); $i++) :
                            // Get the vehicle type ID
                            $current_vehicle_type_id = $vehicle_type_id[$i];

                            if ($fetch_available_vehicle_count_data == 0) :
                                //CHECK IF THERE IS A SHORTAGE OF VEHICLE FOR THE CURRENT VEHICLE TYPE
                                $selected_vehicle_type_ID = $current_vehicle_type_id;
                                $vehicle_type_title = getVEHICLETYPE($selected_vehicle_type_ID, 'get_vehicle_type_title');

                                //CALCULTE THE DIFFERENCE BETWEEN AVAILABLE AND REQUIRED VEHICLES
                                $shortage = $vehicle_count[$i] - $available_vehicle_counts[$current_vehicle_type_id];

                                //CONSTRUCT THE ERROR MESSAGE WITH AVAILABLE AND REQUIRED COUNTS
                                $errors['vehicle_type_not_found'] = "Vehicle type $vehicle_type_title not found.";
                            endif;

                        endfor;

                        if (!empty($errors)) :
                            //error call
                            $response['success'] = false;
                            $response['errors'] = $errors;
                        else :

            //updating the cnf iti for vehicle type and count
                    if (isset($vehicle_type_id) && isset($vehicle_count)) :

                        foreach ($vehicle_type as $key => $val) :
                            $selected_VEHICLE_TYPE = $_POST['vehicle_type'][$key];
                            $selected_VEHICLE_COUNT = $_POST['vehicle_quantity'][$key];

                            // Only proceed if the vehicle quantity is not zero
                            if ($selected_VEHICLE_COUNT != 0) {

                                $vehicle_type_id[] = $selected_VEHICLE_TYPE;
                                $vehicle_arrFields = array('`itinerary_plan_id`', '`vehicle_type_id`', '`vehicle_count`', '`createdby`', '`status`');
                                $vehicle_arrValues = array("$itinerary_plan_ID", "$selected_VEHICLE_TYPE", "$selected_VEHICLE_COUNT", "$logged_user_id", "1");
                                /* use table */
                                if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vehicle_details", $vehicle_arrFields, $vehicle_arrValues, '')) :
                                endif;
                            }
                        endforeach;
                    endif;
            //get inserted vehicle type with count
            $select_itineary_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id`, SUM(`vehicle_count`) AS vehicle_count FROM `dvi_confirmed_itinerary_plan_vehicle_details`  WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' AND `vehicle_type_id` IN (" . implode(",", $vehicle_type_id) . ") and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            $total_no_of_vehicle_count = sqlNUMOFROW_LABEL($select_itineary_vehicle_details);
            if ($total_no_of_vehicle_count > 0) :
                // while ($fetch_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_vehicle_details)) :
                //     $vehicle_type_id[] = $fetch_vehicle_data['vehicle_type_id'];
                //     $vehicle_count[] = $fetch_vehicle_data['vehicle_count'];
                // endwhile;
                # CHECK VECHILE ELIGIBILITY BETWEEN THE ITINEARY ROUTE

                $select_itineary_route_plan_locations_wise_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_margin`, VENDOR_DETAILS.`vendor_margin_gst_type`, VENDOR_DETAILS.`vendor_margin_gst_percentage`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst_type`, VENDOR_BRANCH_DETAILS.`vendor_branch_gst`, VENDOR_DETAILS.`vendor_name`, VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID`, VENDOR_VEHICLE_TYPES.`vehicle_type_id`, VENDOR_VEHICLE_TYPES.`driver_batta`, VENDOR_VEHICLE_TYPES.`food_cost`, VENDOR_VEHICLE_TYPES.`accomodation_cost`, VENDOR_VEHICLE_TYPES.`extra_cost`, VENDOR_VEHICLE_TYPES.`driver_early_morning_charges`, VENDOR_VEHICLE_TYPES.`driver_evening_charges`, VEHICLE.`vehicle_location_id`, VEHICLE.`registration_number`, VEHICLE.`vendor_id`, VEHICLE.`vehicle_id`, VEHICLE.`vendor_branch_id`, VEHICLE.`vehicle_fc_expiry_date`, VEHICLE.`insurance_end_date`, VEHICLE.`owner_city`,VEHICLE.`extra_km_charge`, STORED_LOCATION.`source_location_lattitude`, STORED_LOCATION.`source_location_longitude`, STORED_LOCATION.`destination_location_lattitude`, STORED_LOCATION.`destination_location_longitude`, VEHICLE.`early_morning_charges`, VEHICLE.`evening_charges` FROM `dvi_stored_locations` AS STORED_LOCATION LEFT JOIN `dvi_vehicle` AS VEHICLE ON VEHICLE.`vehicle_location_id` = STORED_LOCATION.`location_ID` LEFT JOIN `dvi_stored_locations` AS VEHICLE_LOCATION ON VEHICLE_LOCATION.`location_ID` = VEHICLE.`vehicle_location_id` LEFT JOIN `dvi_vendor_vehicle_types` VENDOR_VEHICLE_TYPES ON VEHICLE.`vehicle_type_id` = VENDOR_VEHICLE_TYPES.`vendor_vehicle_type_ID` AND VEHICLE.`vendor_id`= VENDOR_VEHICLE_TYPES.`vendor_id` LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = VEHICLE.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = VEHICLE.`vendor_branch_id` WHERE VEHICLE.`owner_city` IN ('$get_implode_eligible_location_CITYS') AND VENDOR_DETAILS.`vendor_id` = '$vendor_id' AND VENDOR_DETAILS.`status` = '1' AND VENDOR_DETAILS.`deleted` = '0' AND VENDOR_BRANCH_DETAILS.`status` = '1' AND VENDOR_BRANCH_DETAILS.`deleted` = '0' AND VEHICLE.`status` = '1' and VEHICLE.`deleted` = '0' AND VENDOR_VEHICLE_TYPES.`vehicle_type_id` IN (" . implode(",", $vehicle_type_id) . ") GROUP BY VEHICLE.`vehicle_type_id` ORDER BY VENDOR_DETAILS.`vendor_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL()); //VENDOR_BRANCH_DETAILS.`vendor_branch_id`,
                $total_no_of_available_vehicle_count_for_itineary_route_plan = sqlNUMOFROW_LABEL($select_itineary_route_plan_locations_wise_vehicle_details);

                if ($total_no_of_available_vehicle_count_for_itineary_route_plan > 0) :

                    $permit_cost_sqlwhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' ";
                    /* use table */
                    if (sqlACTIONS("DELETE", "dvi_confirmed_itinerary_plan_route_permit_charge", '', '', $permit_cost_sqlwhere)) :
                    endif;

                    while ($fetch_available_vehicle_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_locations_wise_vehicle_details)) :
                        $vendor_name = $fetch_available_vehicle_data['vendor_name'];
                        $vendor_margin = $fetch_available_vehicle_data['vendor_margin'];
                        $vendor_margin_gst_type = $fetch_available_vehicle_data['vendor_margin_gst_type'];
                        $vendor_margin_gst_percentage = $fetch_available_vehicle_data['vendor_margin_gst_percentage'];
                        $vendor_branch_gst_type = $fetch_available_vehicle_data['vendor_branch_gst_type'];
                        $vendor_branch_gst = $fetch_available_vehicle_data['vendor_branch_gst'];
                        $vendor_branch_name = $fetch_available_vehicle_data['vendor_branch_name'];
                        $vendor_vehicle_type_ID = $fetch_available_vehicle_data['vendor_vehicle_type_ID'];
                        $vehicle_type_id = $fetch_available_vehicle_data['vehicle_type_id'];
                        $driver_batta = $fetch_available_vehicle_data['driver_batta'];
                        $food_cost = $fetch_available_vehicle_data['food_cost'];
                        $accomodation_cost = $fetch_available_vehicle_data['accomodation_cost'];
                        $extra_cost = $fetch_available_vehicle_data['extra_cost'];
                        $driver_early_morning_charges = $fetch_available_vehicle_data['driver_early_morning_charges'];
                        $driver_evening_charges = $fetch_available_vehicle_data['driver_evening_charges'];
                        $early_morning_charges = $fetch_available_vehicle_data['early_morning_charges'];
                        $evening_charges = $fetch_available_vehicle_data['evening_charges'];
                        $vehicle_location_id = $fetch_available_vehicle_data['vehicle_location_id'];
                        $registration_number = $fetch_available_vehicle_data['registration_number'];
                        $state_code = substr($registration_number, 0, 2);
                        $vendor_id = $fetch_available_vehicle_data['vendor_id'];
                        $vehicle_id = $fetch_available_vehicle_data['vehicle_id'];
                        $vendor_branch_id = $fetch_available_vehicle_data['vendor_branch_id'];
                        $vehicle_fc_expiry_date = $fetch_available_vehicle_data['vehicle_fc_expiry_date'];
                        $insurance_end_date = $fetch_available_vehicle_data['insurance_end_date'];
                        $owner_city = $fetch_available_vehicle_data['owner_city'];
                        $extra_km_charge = $fetch_available_vehicle_data['extra_km_charge'];
                        $location_id = $fetch_available_vehicle_data['location_id'];
                        $source_location_lattitude = $fetch_available_vehicle_data['source_location_lattitude'];
                        $source_location_longitude = $fetch_available_vehicle_data['source_location_longitude'];
                        $destination_location_lattitude = $fetch_available_vehicle_data['destination_location_lattitude'];
                        $destination_location_longitude = $fetch_available_vehicle_data['destination_location_longitude'];
                        $via_route_location_lattitude = $fetch_available_vehicle_data['via_route_location_lattitude'];
                        $via_route_location_longitude = $fetch_available_vehicle_data['via_route_location_longitude'];
                        $distance_from_source = $fetch_available_vehicle_data['distance_from_source'];
                        $distance_from_destination = $fetch_available_vehicle_data['distance_from_destination'];
                        $distance_from_via_route = $fetch_available_vehicle_data['distance_from_via_route'];
                        $get_vehicle_type_title = getVEHICLETYPE($vehicle_type_id, 'get_vehicle_type_title');
                        $get_vehicle_type_count = getCNFITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');

                        for ($vh_count = 1; $vh_count <= $get_vehicle_type_count; $vh_count++):

                            $TOTAL_DRIVER_CHARGES = ($driver_batta +  $food_cost + $accomodation_cost + $extra_cost);

                            $get_title = getKMLIMIT($vendor_vehicle_type_ID, 'get_title_from_vehicle_type', $vendor_id);
                            $get_kms_limit = getKMLIMIT($vendor_vehicle_type_ID, 'get_kms_limit', $vendor_id);
                            $kms_limit_id = getKMLIMIT($vendor_vehicle_type_ID, 'get_kms_limit_id', $vendor_id);

                            if ($current_DATE > $vehicle_fc_expiry_date) :
                                $errors['vehicle_fc_expiry_date_reached'] = "Sorry, Don't have a Valid FC for [$vendor_name => $vendor_branch_name - $registration_number] !!!";
                            endif;

                            if ($current_DATE > $insurance_end_date) :
                                $errors['insurance_end_date_reached'] = "Sorry, Don't have a Valid Insurance for [$vendor_name => $vendor_branch_name - $registration_number] !!!";
                            endif;

                            if (empty($get_kms_limit)) :
                                $errors['vendor_vehicle_outstaion_kms_limit_not_found'] = "Sorry, Don't have a Outstaion KM Limit Details for [$vendor_name] !!!";
                            endif;

                            if (!empty($errors)) :
                                //error call
                                $response['success'] = false;
                                $response['errors'] = $errors;
                            else :
                                $vehicle_origin = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'SOURCE_LOCATION');
                                $vehicle_origin_city = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'SOURCE_CITY');
                                $vehicle_origin_location_latitude = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'location_latitude');
                                $vehicle_origin_location_longtitude = getSTOREDLOCATIONDETAILS($vehicle_location_id, 'location_longtitude');
                                $driver_charges = $driver_batta +  $food_cost + $accomodation_cost + $extra_cost;
                                $vehicle_permit_state_id = getSTATE_DETAILS($state_code, 'vehicle_permit_state_id');

                                $select_itineary_route_plan_details = sqlQUERY_LABEL("SELECT `itinerary_route_ID`, `location_id`, `location_name`, `itinerary_route_date`, `no_of_km`, `next_visiting_location`, `direct_to_next_visiting_place`, `route_start_time`, `route_end_time` FROM `dvi_confirmed_itinerary_route_details` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' and `status` = '1' and `deleted` = '0' ORDER BY `itinerary_route_ID` ASC") or die("#1-UNABLE_TO_COLLECT_ROUTE_LIST:" . sqlERROR_LABEL());
                                $total_no_of_itineary_plan_route_details = sqlNUMOFROW_LABEL($select_itineary_route_plan_details);
                                if ($total_no_of_itineary_plan_route_details > 0) :
                                    $route_count = 0;

                                    /* echo "<table border='1'>";
                                echo "<tr style='background-color:yellow'>";
                                echo "<th>Day's</th>";
                                echo "<th>Location Name</th>";
                                echo "<th>Total Running KM / Time</th>";
                                echo "<th>Total Siteseeing KM / Time</th>";
                                echo "<th>Total KM/Time</th>";
                                echo "<th>Amount</th>";
                                echo "</tr>";

                                echo "<tr>";
                                echo "<td colspan='6'>VENDOR : <b>$vendor_name</b> | BRANCH : <b>$vendor_branch_name</b> | VEHICLE TYPE : <b>$get_vehicle_type_title</b> | Vehicle Origin : <b>$vehicle_origin <br> VEHICLE NO : $registration_number</b></td>";
                                echo "</tr>"; */

                                    $OVERALL_TOTAL_TIME = NULL;
                                    $OVERALL_TOTAL_KM = NULL;
                                    $OVERALL_RENDAL_CHARGES = NULL;
                                    $OVERALL_VEHICLE_TOLL_CHARGE = NULL;
                                    $OVERALL_VEHICLE_PARKING_CHARGE = NULL;
                                    $OVERALL_TOTAL_DRIVER_CHARGES = NULL;
                                    $OVERALL_PERMIT_CHARGES = NULL;
                                    $OVERALL_BEFORE_6AM_EXTRA_TIME = NULL;
                                    $OVERALL_AFTER_8PM_EXTRA_TIME = NULL;
                                    $OVERALL_DRIVER_MORINING_CHARGES = NULL;
                                    $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES = NULL;
                                    $OVERALL_DRIVER_EVEINING_CHARGES = NULL;
                                    $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES = NULL;
                                    $OVERALL_TOTAL_VEHICLE_AMOUNT = NULL;
                                    $OVERALL_TOTAL_HOURS_n_MINS = NULL;
                                    $OVERALL_OUTSTATION_KM = NULL;
                                    $OVERALL_LOCAL_KM = NULL;
                                    $OVERALL_LOCAL_EXTRA_KM = NULL;
                                    $OVERALL_LOCAL_EXTRA_KM_CHARGES = NULL;
                                    $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE = NULL;
                                    $TOTAL_ITINEARY_ALLOWED_KM = NULL;
                                    $get_extra_kms = NULL;
                                    $TOTAL_EXTRA_KM = NULL;
                                    $TOTAL_EXTRA_KM_CHARGE = NULL;
                                    $new_total_vehicle_cost = NULL;
                                    $new_total_vehicle_tax_amt = NULL;
                                    $new_total_margin_amount = NULL;
                                    $new_total_margin_service_tax_amt = NULL;
                                    $VEHICLE_GRAND_TOTAL_AMOUNT = NULL;

                                    while ($fetch_itineary_route_data = sqlFETCHARRAY_LABEL($select_itineary_route_plan_details)) :
                                        $route_count++;
                                        $itinerary_route_ID = $fetch_itineary_route_data['itinerary_route_ID'];
                                        $location_id = $fetch_itineary_route_data['location_id'];
                                        $location_name = $fetch_itineary_route_data['location_name'];
                                        $itinerary_route_date = $fetch_itineary_route_data['itinerary_route_date'];
                                        $no_of_km = $fetch_itineary_route_data['no_of_km'];
                                        $route_start_time = $fetch_itineary_route_data['route_start_time'];
                                        $route_end_time = $fetch_itineary_route_data['route_end_time'];
                                        $next_visiting_location = $fetch_itineary_route_data['next_visiting_location'];
                                        $direct_to_next_visiting_place = $fetch_itineary_route_data['direct_to_next_visiting_place'];
                                        $day = date('j', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $year = date('Y', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $month = date('F', strtotime($fetch_itineary_route_data['itinerary_route_date']));
                                        $location_latitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'location_latitude', $location_id);
                                        $location_longtitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'location_longtitude', $location_id);
                                        $next_visiting_location_latitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'next_visiting_location_latitude', $location_id);
                                        $next_visiting_location_longitude = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'next_visiting_location_longitude', $location_id);

                                        $vehicle_cost_for_the_day = getVEHICLE_OUTSTATION_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $kms_limit_id);

                                        /* $source_location_state = getSTOREDLOCATIONDETAILS($location_id, 'SOURCE_LOCATION_STATE');
                                    $destination_location_state = getSTOREDLOCATIONDETAILS($location_id, 'DESTINATION_LOCATION_STATE');
                                    $source_state_id = getVEHICLE_PERMIT_DETAILS($source_location_state, 'GET_PERMIT_STATE_ID');
                                    $destination_state_id = getVEHICLE_PERMIT_DETAILS($destination_location_state, 'GET_PERMIT_STATE_ID'); */

                                        $source_location_city = getSTOREDLOCATIONDETAILS($location_id, 'SOURCE_CITY');
                                        $destination_location_city = getSTOREDLOCATIONDETAILS($location_id, 'DESTINATION_CITY');

                                        $get_via_route_IDs = get_ITINEARY_VIA_ROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_ID, 'get_via_route_IDs');

                                        #CALCULATE PERMIT CHARGES
                                        // Step 1: Vehicle Origin and Source
                                        $permit_source_location = $location_name;  // The first location (source)

                                        if ($get_via_route_IDs):
                                            // Step 2: VIA Route Location IDs (if any)
                                            $get_via_route_location_IDs = implode(',', $get_via_route_IDs); // VIA route IDs as a string

                                            // Step 3: Fetch VIA Route Location Names (if applicable)
                                            $permit_via_locations = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                            $via_locations_city = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_CITY');
                                        else:
                                            $get_via_route_location_IDs = NULL;
                                            $via_locations_city = NULL;
                                            $permit_via_locations = NULL;
                                        endif;

                                        // Step 4: Destination Location
                                        $permit_destination_location = $next_visiting_location;  // Final destination

                                        if ($route_count == 1):
                                            // Step 5: Prepare the array - Merge Origin, Source, VIA, and Destination locations
                                            $locations = array_merge(
                                                [$vehicle_origin],
                                                [$permit_source_location],   // Vehicle Origin to Source
                                                !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations (if any)
                                                [$permit_destination_location]  // Destination
                                            );
                                        else:
                                            // Prepare the array without the Vehicle Origin (for intermediate routes)
                                            $locations = array_merge(
                                                [$permit_source_location],   // Source (no Vehicle Origin)
                                                !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations (if any)
                                                [$permit_destination_location]  // Destination
                                            );

                                            // Check if it's the last route
                                            if ($total_no_of_itineary_plan_route_details == $route_count):
                                                // Add Vehicle Origin at the end
                                                $locations = array_merge(
                                                    [$permit_source_location],   // Source
                                                    !empty($permit_via_locations) ? $permit_via_locations : [], // VIA Locations
                                                    [$permit_destination_location],  // Destination
                                                    [$vehicle_origin]  // Vehicle Origin at the end
                                                );
                                            endif;
                                        endif;

                                        /* echo "itinerary_route_date => $itinerary_route_date";
                                        print_r($locations);
                                        echo "<br>";
                                        echo "<br>"; */

                                        $location_states = [];
                                        foreach ($locations as $location) :
                                            $get_location_state_name_query = sqlQUERY_LABEL("SELECT `source_location_state` FROM `dvi_stored_locations` WHERE `source_location` = '$location' AND `status` = '1' AND `deleted` = '0' ORDER BY `location_ID` DESC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $source_location_row = sqlFETCHARRAY_LABEL($get_location_state_name_query);
                                            if ($source_location_row) :
                                                $location_states[] = $source_location_row['source_location_state'];
                                            endif;
                                        endforeach;

                                        /* echo "<br>";
                                        echo "<br>";
                                        print_r($location_states);
                                        echo "<br>";
                                        echo "<br>"; */

                                        // Step 2: Retrieve the state IDs for each state name
                                        $state_ids = [];
                                        foreach ($location_states as $state_name) :
                                            $get_location_permit_state_data_query = sqlQUERY_LABEL("SELECT `permit_state_id` FROM `dvi_permit_state` WHERE `state_name` = '$state_name' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_state_id` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $state_row = sqlFETCHARRAY_LABEL($get_location_permit_state_data_query);
                                            if ($state_row) :
                                                $state_ids[] = $state_row['permit_state_id'];
                                            endif;
                                        endforeach;

                                        // Step 3: Loop through each state and calculate permit charges
                                        $seven_days_ago = date('Y-m-d', strtotime($itinerary_route_date . ' - 6 days'));
                                        $permit_charges = 0;

                                        foreach ($state_ids as $state_id) :
                                            /* echo "SELECT `route_permit_charge_ID` FROM `dvi_itinerary_plan_route_permit_charge` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_branch_id` = '$vendor_branch_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `itinerary_route_date` >= '$seven_days_ago' AND `status` = '1' AND `deleted` = '0' ORDER BY `route_permit_charge_ID` ASC LIMIT 1";
                                            echo "<br>";
                                            echo "<br>"; */
                                            // Check if permit cost was calculated within the last 7 days for this state
                                            $check_permit_charge_already_calcualted_within_7_days = sqlQUERY_LABEL("SELECT `route_permit_charge_ID` FROM `dvi_confirmed_itinerary_plan_route_permit_charge` WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_branch_id` = '$vendor_branch_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `itinerary_route_date` >= '$seven_days_ago' AND `status` = '1' AND `deleted` = '0' ORDER BY `route_permit_charge_ID` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                            $check_permit_charge_already_calcualted_within_7_days_count = sqlNUMOFROW_LABEL($check_permit_charge_already_calcualted_within_7_days);

                                            // If not calculated, calculate permit charge
                                            if ($check_permit_charge_already_calcualted_within_7_days_count == 0) :
                                                // Get permit cost between source state and destination state

                                                /* echo "SELECT `permit_cost` FROM `dvi_permit_cost` WHERE `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vendor_vehicle_type_ID' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_cost_id` ASC LIMIT 1";
                                                echo "<br>";
                                                echo "<br>"; */

                                                $get_permit_cost_for_the_destination_state = sqlQUERY_LABEL("SELECT `permit_cost` FROM `dvi_permit_cost` WHERE `source_state_id` = '$vehicle_permit_state_id' AND `destination_state_id` = '$state_id' AND `vendor_id` = '$vendor_id' AND `vehicle_type_id` = '$vendor_vehicle_type_ID' AND `status` = '1' AND `deleted` = '0' ORDER BY `permit_cost_id` ASC LIMIT 1") or die("#STATELABEL-LABEL: getPERMIT_COST_DETAILS: " . sqlERROR_LABEL());
                                                $row_permit_cost = sqlFETCHARRAY_LABEL($get_permit_cost_for_the_destination_state);

                                                if ($row_permit_cost) :
                                                    // Add the permit cost to the total
                                                    $permit_cost = $row_permit_cost['permit_cost'];
                                                    $permit_charges += $permit_cost;

                                                    $permit_charge_arrFields = array('`itinerary_plan_ID`', '`itinerary_route_ID`', '`itinerary_route_date`', '`vendor_id`', '`vendor_branch_id`', '`vendor_vehicle_type_id`', '`source_state_id`', '`destination_state_id`', '`permit_cost`', '`createdby`', '`status`');

                                                    $permit_charges_arrValues = array("$itinerary_plan_ID", "$itinerary_route_ID", "$itinerary_route_date", "$vendor_id", "$vendor_branch_id", "$vendor_vehicle_type_ID", "$vehicle_permit_state_id", "$state_id", "$permit_cost", "$logged_user_id", "1");
                                                    /* use table */
                                                    if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_route_permit_charge", $permit_charge_arrFields, $permit_charges_arrValues, '')) :
                                                    /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | VENDOR_ID => $vendor_id | BRANCH_ID => $vendor_branch_id | VEHICLE_TYPE => $vendor_vehicle_type_ID |SOURCE => $vehicle_permit_state_id | DESTINATION => $state_id | Permit_Cost => $permit_cost Inserted <br><br>"; */
                                                    else:
                                                    /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | VENDOR_ID => $vendor_id | BRANCH_ID => $vendor_branch_id | VEHICLE_TYPE => $vendor_vehicle_type_ID |SOURCE => $vehicle_permit_state_id | DESTINATION => $state_id ==> Permit Cose Not Inserted <br><br>"; */
                                                    endif;
                                                endif;
                                            endif;
                                        endforeach;

                                        /* echo "<br>";
                                        echo "<br>"; */

                                        // Initialize variables for morning and evening charges
                                        $morning_extra_time = 0;
                                        $evening_extra_time = 0;
                                        $DRIVER_MORINING_CHARGES = 0;
                                        $DRIVER_EVEINING_CHARGES = 0;
                                        $VENDOR_VEHICLE_MORNING_CHARGES = 0;
                                        $VENDOR_VEHICLE_EVENING_CHARGES = 0;
                                        $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE = 0;

                                        $TOTAL_PICKUP_KM = 0;
                                        $TOTAL_PICKUP_DURATION = "00:00:00";
                                        $TOTAL_DROP_KM = 0;
                                        $TOTAL_DROP_DURATION = "00:00:00";

                                        // Convert route start and end times to Unix timestamps
                                        $route_start_timestamp = strtotime($route_start_time);
                                        $route_end_timestamp = strtotime($route_end_time);

                                        // Calculate Unix timestamps for 6 AM and 8 PM
                                        $six_am_timestamp = strtotime('06:00:00');
                                        $eight_pm_timestamp = strtotime('20:00:00');

                                        // Check if route start time is before 6 AM and route end time is after 8 PM
                                        if ($route_start_timestamp < $six_am_timestamp && $route_end_timestamp > $eight_pm_timestamp) {
                                            // Calculate morning charges for the time before 6 AM
                                            $morning_difference_seconds = $six_am_timestamp - $route_start_timestamp;
                                            $morning_hours = floor($morning_difference_seconds / 3600); // 3600 seconds in an hour
                                            $morning_minutes = floor(($morning_difference_seconds % 3600) / 60); // remaining minutes
                                            $morning_extra_time = $morning_hours + ($morning_minutes / 60);

                                            // Calculate extra time charges for the time after 8 PM
                                            $extra_time_difference_seconds = $route_end_timestamp - $eight_pm_timestamp;
                                            $extra_time_hours = floor($extra_time_difference_seconds / 3600); // 3600 seconds in an hour
                                            $extra_time_minutes = floor(($extra_time_difference_seconds % 3600) / 60); // remaining minutes
                                            $evening_extra_time = $extra_time_hours + ($extra_time_minutes / 60);
                                        } elseif ($route_start_timestamp < $six_am_timestamp) {
                                            // Calculate morning charges if the route starts before 6 AM but ends before 8 PM
                                            $morning_difference_seconds = $six_am_timestamp - $route_start_timestamp;
                                            $morning_hours = floor($morning_difference_seconds / 3600); // 3600 seconds in an hour
                                            $morning_minutes = floor(($morning_difference_seconds % 3600) / 60); // remaining minutes
                                            $morning_extra_time = $morning_hours + ($morning_minutes / 60);
                                        } elseif ($route_end_timestamp > $eight_pm_timestamp) {
                                            // Calculate extra time charges if the route ends after 8 PM but starts after 6 AM
                                            $extra_time_difference_seconds = $route_end_timestamp - $eight_pm_timestamp;
                                            $extra_time_hours = floor($extra_time_difference_seconds / 3600); // 3600 seconds in an hour
                                            $extra_time_minutes = floor(($extra_time_difference_seconds % 3600) / 60); // remaining minutes
                                            $evening_extra_time = $extra_time_hours + ($extra_time_minutes / 60);
                                        }

                                        $DRIVER_MORINING_CHARGES = ($driver_early_morning_charges * $morning_extra_time);
                                        $DRIVER_EVEINING_CHARGES = ($driver_evening_charges * $evening_extra_time);
                                        $VENDOR_VEHICLE_MORNING_CHARGES = ($early_morning_charges * $morning_extra_time);
                                        $VENDOR_VEHICLE_EVENING_CHARGES = ($evening_charges * $evening_extra_time);

                                        $check_local_via_route_city = false;

                                        if ($via_locations_city):
                                            /* echo "#1 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                            // Check if all elements in $via_locations_city match $vehicle_origin_city
                                            $all_via_match = !empty($via_locations_city) && array_reduce($via_locations_city, function ($carry, $city) use ($vehicle_origin_city) {
                                                /* echo "$city == $vehicle_origin_city<br>"; */
                                                return $carry && ($city == $vehicle_origin_city);
                                            }, true);

                                            if ($all_via_match):
                                                /* echo "#2 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                                $check_local_via_route_city = true;
                                            endif;
                                        else:
                                            /* echo "#3 check_local_via_route_city => $check_local_via_route_city <br>"; */
                                            $check_local_via_route_city = true;
                                        endif;

                                        /* echo "$source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_location_city == $source_location_city && $previous_destination_location_city == $destination_location_city)) && $check_local_via_route_city == true";
                                    echo "<br>"; */

                                        /* echo "$source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_destination_location_city == $source_location_city)) && $check_local_via_route_city == true";
                                    echo "<br>"; */

                                        /* $previous_location_city == $source_location_city &&  */
                                        if ($source_location_city == $destination_location_city && $source_location_city == $vehicle_origin_city && ($route_count == 1 || $route_count == $total_no_of_itineary_plan_route_details || ($previous_destination_location_city == $source_location_city)) && $check_local_via_route_city == true) :
                                            //LOCAL TRIP
                                            $travel_type = 1;
                                            if ($route_count == 1) : //DAY 1 TRIP PLAN FOR LOCAL
                                                if ($vehicle_origin_city != $source_location_city) :

                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($vehicle_origin_city, $source_location_city);
                                                    $distance_from_vehicle_orign_to_pickup_point = calculateDistanceAndDuration($vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $location_latitude, $location_longtitude, $travel_location_type);

                                                    $pickup_distance = $distance_from_vehicle_orign_to_pickup_point['distance'];
                                                    $pickup_duration_time = $distance_from_vehicle_orign_to_pickup_point['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_PICKUP_KM = $pickup_distance;
                                                    $TOTAL_PICKUP_DURATION = $formated_pickup_duration;
                                                else :
                                                    $TOTAL_PICKUP_KM = 0;
                                                    $TOTAL_PICKUP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $GET_RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_KM = $TOTAL_PICKUP_KM + $GET_RUNNING_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $PICKUP_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_pickup_duration UTC");

                                                // Add the seconds
                                                $total_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $total_travelling_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                $time_parts = explode(':', $TOTAL_TIME);
                                                $TOTAL_TIME_hours = intval($time_parts[0]);
                                                $TOTAL_TIME_minutes = intval($time_parts[1]);

                                                /* echo "TOTAL_RUNNING_TRAVEL_TIME => $TOTAL_RUNNING_TRAVEL_TIME";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_TIME => $SIGHT_SEEING_TRAVELLING_TIME";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_KM => $SIGHT_SEEING_TRAVELLING_KM";
                                            echo "<br>";
                                            echo "GET_RUNNING_KM => $GET_RUNNING_KM";
                                            echo "<br>";
                                            echo "TOTAL_RUNNING_KM => $TOTAL_RUNNING_KM";
                                            echo "<br>";
                                            echo "TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS => $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS => $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "PICKUP_TIME_IN_SECONDS => $PICKUP_TIME_IN_SECONDS";
                                            echo "<br>";
                                            echo "total_times_in_Seconds => $total_times_in_Seconds";
                                            echo "<br>";
                                            echo "TOTAL_TIME => $TOTAL_TIME";
                                            echo "<br>";
                                            echo "total_travelling_times_in_Seconds => $total_travelling_times_in_Seconds";
                                            echo "<br>";
                                            echo "TOTAL_TRAVELLING_TIME => $TOTAL_TRAVELLING_TIME";
                                            echo "<br>";
                                            echo "TOTAL_KM => $TOTAL_KM";
                                            echo "<br>";
                                            echo "TOTAL_TIME_hours => $TOTAL_TIME_hours";
                                            echo "<br>";
                                            echo "TOTAL_TIME_minutes => $TOTAL_TIME_minutes";
                                            echo "<br>"; */

                                                // Round the total time based on minutes
                                                if ($TOTAL_TIME_minutes < 30) :
                                                    $TOTAL_HOURS =  $TOTAL_TIME_hours;
                                                else :
                                                    $TOTAL_HOURS = $TOTAL_TIME_hours + 1;
                                                endif;

                                                $hours_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_hour_limit', $vendor_id, $TOTAL_HOURS);

                                                $km_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_km_limit', $vendor_id, $TOTAL_HOURS, $TOTAL_KM);

                                                /* echo "TOTAL_KM => $TOTAL_KM | km_time_limit_id => $km_time_limit_id";
                                            echo "<br>";
                                            echo "TOTAL_HOURS => $TOTAL_HOURS | hours_time_limit_id => $hours_time_limit_id";
                                            echo "<br>"; */

                                                // Determine which time limit ID to use
                                                if ($km_time_limit_id == $hours_time_limit_id) :
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id > $hours_time_limit_id) :
                                                    // If KM limit is greater
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id < $hours_time_limit_id) :
                                                    // If hour limit is greater
                                                    $time_limit_id = $hours_time_limit_id;
                                                    $getTIMELIMITID = $hours_time_limit_id;
                                                endif;

                                                /* echo "DAY 1 => final_time_limit_id => $time_limit_id";
                                            echo "<br>"; */

                                                $TOTAL_ALLOWED_LOCAL_KM = getTIMELIMIT($time_limit_id, 'km_limit', '', '', '');

                                                if ($TOTAL_KM > $TOTAL_ALLOWED_LOCAL_KM):
                                                    $TOTAL_LOCAL_EXTRA_KM = ($TOTAL_KM - $TOTAL_ALLOWED_LOCAL_KM);
                                                else:
                                                    $TOTAL_LOCAL_EXTRA_KM = 0;
                                                endif;

                                                /* echo "TOTAL_KM => $TOTAL_KM | TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM | TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                            echo "<br>";
                                            echo "<br>"; */

                                                $vehicle_cost_for_the_day = getVEHICLE_LOCAL_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $time_limit_id);

                                                # LOCAL TRIP TOLL CHARGES FOR DAY 1
                                                // TOLL CHARGE CALCULATION WITH VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                if ($get_via_route_IDs):

                                                    $toll_source_location = $location_name;
                                                    $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                    // VIA ROUTE LOCATION NAME
                                                    $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Check if $via_route_names is valid and is an array
                                                    if (!is_array($via_route_names)) :
                                                        $via_route_names = []; // Ensure it is an array even if empty
                                                    endif;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to the first VIA route (if available)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                    endif;

                                                    // Step 3: Via to Via for multiple VIA routes
                                                    for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                        $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                    endfor;

                                                    // Step 4: Last VIA route to Destination (or Source to Destination if no VIA routes)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                    else :
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                    endif;

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // LOCAL TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;

                                                else:
                                                    $toll_source_location = $location_name;
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to Destination
                                                    $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // LOCAL TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;

                                                    endforeach;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (LOC) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */
                                            else :
                                                $TOTAL_PICKUP_KM = 0;
                                                $TOTAL_PICKUP_DURATION = "00:00:00";

                                                /* $RUNNINGTIME = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_TRAVEL_TIME');

                                            // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                            preg_match('/(\d+) hour/', $RUNNINGTIME, $hoursMatch);
                                            preg_match('/(\d+) mins/', $RUNNINGTIME, $minutesMatch);

                                            // INITIALIZE HOURS AND MINUTES TO ZERO
                                            $runningtime_hours = 0;
                                            $runningtime_minutes = 0;

                                            $runningtime_hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                            $runningtime_minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                            // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                            $extraHours = floor($runningtime_minutes / 60);
                                            $runningtime_hours += $extraHours;
                                            $runningtime_minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                            // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                            $runningtime_formattedHours = str_pad($runningtime_hours, 2, '0', STR_PAD_LEFT);
                                            $runningtime_formattedMinutes = str_pad($runningtime_minutes, 2, '0', STR_PAD_LEFT);

                                            // FORMAT THE TIME AS H:i:s
                                            $formated_runningtime_duration = sprintf('%02d:%02d:00', $runningtime_formattedHours, $runningtime_formattedMinutes);

                                            $RUNNING_DISTANCE = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_DISTANCE'); */

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = '00:00:00';

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($destination_location_city, $vehicle_origin_city);
                                                    $distance_from_droping_point_to_vehicle_orign =  calculateDistanceAndDuration($next_visiting_location_latitude, $next_visiting_location_longitude, $vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $travel_location_type);

                                                    $return_pickup_distance = $distance_from_droping_point_to_vehicle_orign['distance'];
                                                    $return_pickup_duration_time = $distance_from_droping_point_to_vehicle_orign['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $return_pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $return_pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_return_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME');

                                                    $TOTAL_DROP_KM = $return_pickup_distance;
                                                    $TOTAL_DROP_DURATION = $formated_return_pickup_duration;
                                                else :
                                                    $TOTAL_DROP_KM = 0;
                                                    $TOTAL_DROP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_KM = $RUNNING_KM + $TOTAL_DROP_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $RUNNING_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_runningtime_duration UTC");
                                                $formated_return_pickup_duration = strtotime("1970-01-01 $formated_return_pickup_duration UTC");
                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME UTC");

                                                $total_travelling_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                // Add the seconds
                                                $total_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                $time_parts = explode(':', $TOTAL_TIME);
                                                $TOTAL_TIME_hours = intval($time_parts[0]);
                                                $TOTAL_TIME_minutes = intval($time_parts[1]);

                                                // Round the total time based on minutes
                                                if ($TOTAL_TIME_minutes < 30) :
                                                    $TOTAL_HOURS =  $TOTAL_TIME_hours;
                                                else :
                                                    $TOTAL_HOURS = $TOTAL_TIME_hours + 1;
                                                endif;

                                                $hours_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_hour_limit', $vendor_id, $TOTAL_HOURS);

                                                $km_time_limit_id = getTIMELIMIT($vendor_vehicle_type_ID, 'get_time_limit_id_from_km_limit', $vendor_id, $TOTAL_HOURS, $TOTAL_KM);

                                                /* echo "TOTAL_KM => $TOTAL_KM | km_time_limit_id => $km_time_limit_id";
                                            echo "<br>";
                                            echo "TOTAL_HOURS => $TOTAL_HOURS | hours_time_limit_id => $hours_time_limit_id";
                                            echo "<br>"; */

                                                // Determine which time limit ID to use
                                                if ($km_time_limit_id == $hours_time_limit_id) :
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id > $hours_time_limit_id) :
                                                    // If KM limit is greater
                                                    $time_limit_id = $km_time_limit_id;
                                                    $getTIMELIMITID = $km_time_limit_id;
                                                elseif ($km_time_limit_id < $hours_time_limit_id) :
                                                    // If hour limit is greater
                                                    $time_limit_id = $hours_time_limit_id;
                                                    $getTIMELIMITID = $hours_time_limit_id;
                                                endif;

                                                /* echo "final_time_limit_id => $time_limit_id";
                                            echo "<br>"; */

                                                $TOTAL_ALLOWED_LOCAL_KM = getTIMELIMIT($time_limit_id, 'km_limit', '', '', '');

                                                if ($TOTAL_KM > $TOTAL_ALLOWED_LOCAL_KM):
                                                    $TOTAL_LOCAL_EXTRA_KM = ($TOTAL_KM - $TOTAL_ALLOWED_LOCAL_KM);
                                                else:
                                                    $TOTAL_LOCAL_EXTRA_KM = 0;
                                                endif;

                                                /* echo "TOTAL_KM => $TOTAL_KM | TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM | TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                            echo "<br>";
                                            echo "<br>"; */

                                                $vehicle_cost_for_the_day = getVEHICLE_LOCAL_PRICEBOOK_COST($day, $year, $month, $vendor_id, $vendor_branch_id, $vendor_vehicle_type_ID, $time_limit_id);

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    # LOCAL TRIP LAST DAY TOLL CHAREGS
                                                    if ($get_via_route_IDs):
                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to the first VIA route (if available)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Step 2: Via to Via (for multiple via routes)
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Step 3: Last VIA route to Destination
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Step 4: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGIN
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Step 2: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                else:
                                                    # LOCAL TRIP IN BETWEEN DAYS TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Set the first location pair (source and first VIA route location)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Loop through the VIA route names to create subsequent location pairs
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Set the last location pair (last VIA route location and destination)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // LOCAL TRIP TOLL CHARGE CALCULATION FOR SOURCE & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');
                                            endif;

                                        /* echo "<tr>";
                                        echo "<td>$itinerary_route_date <br> Day $route_count (LOC) <br> $route_start_time - $route_end_time</td>";
                                        echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                        echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                        echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                        echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                        echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                        echo "</tr>"; */

                                        else :
                                            //OUTSTATION TRIP
                                            $travel_type = 2;
                                            if ($route_count == 1) : //DAY 1 TRIP PLAN FOR OUTSTATION
                                                if ($vehicle_origin_city != $source_location_city) :

                                                    // Determine the travel location type
                                                    $travel_location_type = getTravelLocationType($vehicle_origin_city, $source_location_city);
                                                    $distance_from_vehicle_orign_to_pickup_point = calculateDistanceAndDuration($vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $location_latitude, $location_longtitude, $travel_location_type);

                                                    $pickup_distance = $distance_from_vehicle_orign_to_pickup_point['distance'];
                                                    $pickup_duration_time = $distance_from_vehicle_orign_to_pickup_point['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_PICKUP_KM = $pickup_distance;
                                                    $TOTAL_PICKUP_DURATION = $formated_pickup_duration;
                                                else :
                                                    $TOTAL_PICKUP_KM = 0;
                                                    $TOTAL_PICKUP_DURATION = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $GET_RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_KM = $TOTAL_PICKUP_KM + $GET_RUNNING_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $PICKUP_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_pickup_duration UTC");

                                                // Add the seconds
                                                $total_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $total_travelling_times_in_Seconds = $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $PICKUP_TIME_IN_SECONDS;

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                # OUTSTATION TRIP TOLL CHARGES FOR DAY 1
                                                // TOLL CHARGE CALCULATION WITH VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                if ($get_via_route_IDs):

                                                    $toll_source_location = $location_name;
                                                    $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                    // VIA ROUTE LOCATION NAME
                                                    $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Check if $via_route_names is valid and is an array
                                                    if (!is_array($via_route_names)) :
                                                        $via_route_names = []; // Ensure it is an array even if empty
                                                    endif;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to the first VIA route (if available)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                    endif;

                                                    // Step 3: Via to Via for multiple VIA routes
                                                    for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                        $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                    endfor;

                                                    // Step 4: Last VIA route to Destination (or Source to Destination if no VIA routes)
                                                    if (!empty($via_route_names)) :
                                                        $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                    else :
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                    endif;

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & VIA & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;

                                                else:

                                                    $toll_source_location = $location_name;
                                                    $toll_destination_location = $next_visiting_location;

                                                    // Initialize an array to store locations
                                                    $toll_charge_locations = [];

                                                    // Step 1: Vehicle Origin to Source
                                                    $toll_charge_locations[] = [$vehicle_origin, $toll_source_location];

                                                    // Step 2: Source to Destination
                                                    $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                    // Dynamically assign variables for each location pair and calculate toll charges
                                                    foreach ($toll_charge_locations as $index => $location_pair) :
                                                        $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                        // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR VEHICLE ORIGIN & SOURCE & DESTINATION
                                                        if ($get_location_id):
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                        else:
                                                            $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                        endif;
                                                    endforeach;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (OUT) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */
                                            else :
                                                $TOTAL_PICKUP_KM = 0;
                                                $TOTAL_PICKUP_DURATION = "00:00:00";

                                                /* $RUNNINGTIME = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_TRAVEL_TIME');

                                            // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                            preg_match('/(\d+) hour/', $RUNNINGTIME, $hoursMatch);
                                            preg_match('/(\d+) mins/', $RUNNINGTIME, $minutesMatch);

                                            // INITIALIZE HOURS AND MINUTES TO ZERO
                                            $runningtime_hours = 0;
                                            $runningtime_minutes = 0;

                                            $runningtime_hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                            $runningtime_minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                            // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                            $extraHours = floor($runningtime_minutes / 60);
                                            $runningtime_hours += $extraHours;
                                            $runningtime_minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                            // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                            $runningtime_formattedHours = str_pad($runningtime_hours, 2, '0', STR_PAD_LEFT);
                                            $runningtime_formattedMinutes = str_pad($runningtime_minutes, 2, '0', STR_PAD_LEFT);

                                            // FORMAT THE TIME AS H:i:s
                                            $formated_runningtime_duration = sprintf('%02d:%02d:00', $runningtime_formattedHours, $runningtime_formattedMinutes);

                                            $RUNNING_DISTANCE = getSTOREDLOCATIONDETAILS($location_id, 'TOTAL_DISTANCE'); */

                                                $TOTAL_RUNNING_TRAVEL_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_TIME');

                                                $SIGHT_SEEING_TRAVELLING_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_TIME');

                                                $SIGHT_SEEING_TRAVELLING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'SIGHT_SEEING_TRAVELLING_DISTANCE');

                                                $RUNNING_KM = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_KM');

                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = '00:00:00';

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    $travel_location_type = getTravelLocationType($destination_location_city, $vehicle_origin_city);
                                                    $distance_from_droping_point_to_vehicle_orign =  calculateDistanceAndDuration($next_visiting_location_latitude, $next_visiting_location_longitude, $vehicle_origin_location_latitude, $vehicle_origin_location_longtitude, $travel_location_type);

                                                    $return_pickup_distance = $distance_from_droping_point_to_vehicle_orign['distance'];
                                                    $return_pickup_duration_time = $distance_from_droping_point_to_vehicle_orign['duration'];

                                                    // EXTRACT THE HOURS AND MINUTES FROM THE DURATION STRING
                                                    preg_match('/(\d+) hour/', $return_pickup_duration_time, $hoursMatch);
                                                    preg_match('/(\d+) mins/', $return_pickup_duration_time, $minutesMatch);

                                                    // INITIALIZE HOURS AND MINUTES TO ZERO
                                                    $hours = 0;
                                                    $minutes = 0;

                                                    $hours = isset($hoursMatch[1]) ? intval($hoursMatch[1]) : 0;
                                                    $minutes = isset($minutesMatch[1]) ? intval($minutesMatch[1]) : 0;

                                                    // CALCULATE EXTRA HOURS IF MINUTES EXCEED 59
                                                    $extraHours = floor($minutes / 60);
                                                    $hours += $extraHours;
                                                    $minutes %= 60; // REMAINING MINUTES AFTER ADDING TO HOURS

                                                    // FORMAT HOURS AND MINUTES WITH LEADING ZEROS
                                                    $formattedHours = str_pad($hours, 2, '0', STR_PAD_LEFT);
                                                    $formattedMinutes = str_pad($minutes, 2, '0', STR_PAD_LEFT);

                                                    // FORMAT THE TIME AS H:i:s
                                                    $formated_return_pickup_duration = sprintf('%02d:%02d:00', $formattedHours, $formattedMinutes);

                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = getITINEARY_ROUTE_HOTSPOT_DETAILS('', $itinerary_plan_ID, $itinerary_route_ID, 'TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME');

                                                    $TOTAL_DROP_KM = $return_pickup_distance;
                                                    $TOTAL_DROP_DURATION = $formated_return_pickup_duration;

                                                else :
                                                    $TOTAL_DROP_KM = 0;
                                                    $TOTAL_DROP_DURATION = "00:00:00";
                                                    $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = "00:00:00";
                                                endif;

                                                $TOTAL_RUNNING_KM = $RUNNING_KM + $TOTAL_DROP_KM;

                                                $TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_TIME UTC");
                                                $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS = strtotime("1970-01-01 $SIGHT_SEEING_TRAVELLING_TIME UTC");
                                                $RUNNING_TIME_IN_SECONDS = strtotime("1970-01-01 $formated_runningtime_duration UTC");
                                                $formated_return_pickup_duration_in_seconds = strtotime("1970-01-01 $formated_return_pickup_duration UTC");
                                                $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME = strtotime("1970-01-01 $TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME UTC");

                                                $total_travelling_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration_in_seconds) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                $TOTAL_TRAVELLING_TIME = gmdate('H:i:s', $total_travelling_times_in_Seconds);

                                                // Add the seconds
                                                $total_times_in_Seconds = (($TOTAL_RUNNING_TRAVEL_TIME_IN_SECONDS + $SIGHT_SEEING_TRAVELLING_TIME_IN_SECONDS + $RUNNING_TIME_IN_SECONDS + $formated_return_pickup_duration_in_seconds) - ($TOTAL_RUNNING_TRAVEL_LAST_DAY_BUFFER_TIME));

                                                // Convert total seconds back to time format
                                                $TOTAL_TIME = gmdate('H:i:s', $total_times_in_Seconds);

                                                $TOTAL_KM = $TOTAL_RUNNING_KM + $SIGHT_SEEING_TRAVELLING_KM;

                                                if ($total_no_of_itineary_plan_route_details == $route_count) :
                                                    # OUTSTATION TRIP LAST DAY TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to the first VIA route (if available)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Step 2: Via to Via (for multiple via routes)
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Step 3: Last VIA route to Destination
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Step 4: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges

                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:

                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Step 2: Destination to Vehicle Origin
                                                        $toll_charge_locations[] = [$toll_destination_location, $vehicle_origin];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION & BACK TO ORIGI
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                else:
                                                    # OUTSTATION TRIP IN BETWEEN DAYS TOLL CHARGES
                                                    if ($get_via_route_IDs):

                                                        $toll_source_location = $location_name;
                                                        $get_via_route_location_IDs = implode(',', $get_via_route_IDs);

                                                        // VIA ROUTE LOCATION NAME
                                                        $via_route_names = getSTOREDLOCATION_VIAROUTE_DETAILS($location_id, $get_via_route_location_IDs, 'MULTIPLE_VIAROUTE_LOCATION');
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Check if $via_route_names is valid and is an array
                                                        if (!is_array($via_route_names)) :
                                                            $via_route_names = []; // Ensure it is an array even if empty
                                                        endif;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Set the first location pair (source and first VIA route location)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$toll_source_location, $via_route_names[0]];
                                                        endif;

                                                        // Loop through the VIA route names to create subsequent location pairs
                                                        for ($i = 0; $i < count($via_route_names) - 1; $i++) :
                                                            $toll_charge_locations[] = [$via_route_names[$i], $via_route_names[$i + 1]];
                                                        endfor;

                                                        // Set the last location pair (last VIA route location and destination)
                                                        if (!empty($via_route_names)) :
                                                            $toll_charge_locations[] = [$via_route_names[count($via_route_names) - 1], $toll_destination_location];
                                                        else :
                                                            $toll_charge_locations[] = [$toll_source_location, $toll_destination_location]; // Direct route if no via routes
                                                        endif;

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & VIA & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;

                                                    else:
                                                        $toll_source_location = $location_name;
                                                        $toll_destination_location = $next_visiting_location;

                                                        // Initialize an array to store locations
                                                        $toll_charge_locations = [];

                                                        // Step 1: Source to Destination
                                                        $toll_charge_locations[] = [$toll_source_location, $toll_destination_location];

                                                        // Dynamically assign variables for each location pair and calculate toll charges
                                                        foreach ($toll_charge_locations as $index => $location_pair) :
                                                            $get_location_id = getSTOREDLOCATION_SOURCE_AND_DESTINATION_DETAILS($location_pair[0], $location_pair[1], 'get_location_id');

                                                            // OUTSTATION TRIP TOLL CHARGE CALCULATION FOR SOURCE & DESTINATION
                                                            if ($get_location_id):
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += getVEHICLE_TOLL_CHARGES($vehicle_type_id, $get_location_id);
                                                            else:
                                                                $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE += 0;
                                                            endif;
                                                        endforeach;
                                                    endif;
                                                endif;

                                                // TOLL CHARGE CALCULATION
                                                $VEHICLE_TOLL_CHARGE = $COLLECT_VEHICLE_TOLL_CHARGE_WITH_VIA_ROUTE;

                                                //PARKING CHARGE CALCULATION
                                                $VEHICLE_PARKING_CHARGE = getITINERARY_HOTSPOT_VEHICLE_PARKING_CHARGES_DETAILS($vehicle_type_id, $itinerary_plan_ID, $itinerary_route_ID, 'total_hotspot_parking_charges');

                                            /* echo "<tr>";
                                            echo "<td>$itinerary_route_date <br> Day $route_count (OUT) <br> $route_start_time - $route_end_time</td>";
                                            echo "<td>From : $location_name <br> To: $next_visiting_location</td>";
                                            echo "<td>$TOTAL_RUNNING_KM / $TOTAL_TRAVELLING_TIME</td>";
                                            echo "<td>$SIGHT_SEEING_TRAVELLING_KM / $SIGHT_SEEING_TRAVELLING_TIME </td>";
                                            echo "<td>$TOTAL_KM / $TOTAL_TIME</td>";
                                            echo "<td>RENTAL : $vehicle_cost_for_the_day <br> TOLL_CHARGE : $VEHICLE_TOLL_CHARGE <br> PARKING_CHARGE : $VEHICLE_PARKING_CHARGE <br> DRIVER_CHARGES : $TOTAL_DRIVER_CHARGES <br> PERMIT_CHARGES : $permit_charges <br> BEFORE_6AM_AFTER_8PM_CHARGES : $morning_extra_time [$VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_MORINING_CHARGES] | $evening_extra_time [$VENDOR_VEHICLE_EVENING_CHARGES + $DRIVER_EVEINING_CHARGES] </td>";
                                            echo "</tr>"; */

                                            endif;
                                        endif;

                                        $TOTAL_VEHICLE_AMOUNT = ($vehicle_cost_for_the_day + $VEHICLE_TOLL_CHARGE + $VEHICLE_PARKING_CHARGE + $TOTAL_DRIVER_CHARGES + $permit_charges + $DRIVER_MORINING_CHARGES + $VENDOR_VEHICLE_MORNING_CHARGES + $DRIVER_EVEINING_CHARGES + $VENDOR_VEHICLE_EVENING_CHARGES);

                                        $OVERALL_TOTAL_KM += $TOTAL_KM;
                                        $OVERALL_TOTAL_TIME[] = $TOTAL_TIME;
                                        $OVERALL_RENDAL_CHARGES += $vehicle_cost_for_the_day;
                                        $array_of_vehicle_cost_for_the_day[] = $vehicle_cost_for_the_day;
                                        $OVERALL_VEHICLE_TOLL_CHARGE += $VEHICLE_TOLL_CHARGE;
                                        $OVERALL_VEHICLE_PARKING_CHARGE += $VEHICLE_PARKING_CHARGE;
                                        $OVERALL_TOTAL_DRIVER_CHARGES += $TOTAL_DRIVER_CHARGES;
                                        $OVERALL_PERMIT_CHARGES += $permit_charges;
                                        $OVERALL_BEFORE_6AM_EXTRA_TIME += $morning_extra_time;
                                        $OVERALL_AFTER_8PM_EXTRA_TIME += $evening_extra_time;
                                        $OVERALL_DRIVER_MORINING_CHARGES += $DRIVER_MORINING_CHARGES;
                                        $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES += $VENDOR_VEHICLE_MORNING_CHARGES;
                                        $OVERALL_DRIVER_EVEINING_CHARGES += $DRIVER_EVEINING_CHARGES;
                                        $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES += $VENDOR_VEHICLE_EVENING_CHARGES;
                                        $OVERALL_TOTAL_VEHICLE_AMOUNT += $TOTAL_VEHICLE_AMOUNT;

                                        if ($travel_type == 2) :
                                            $getTIMELIMITID = 0;
                                            $TOTAL_LOCAL_EXTRA_KM = 0;
                                            $TOTAL_LOCAL_EXTRA_KM_CHARGES = 0;
                                            $OVERALL_OUTSTATION_KM += $TOTAL_KM;
                                            $TOTAL_ALLOWED_LOCAL_KM = 0;
                                        else :
                                            $getTIMELIMITID = $getTIMELIMITID;
                                            $TOTAL_LOCAL_EXTRA_KM = $TOTAL_LOCAL_EXTRA_KM;
                                            if ($TOTAL_LOCAL_EXTRA_KM > 0):
                                                $TOTAL_LOCAL_EXTRA_KM_CHARGES = ($TOTAL_LOCAL_EXTRA_KM * $extra_km_charge);
                                            else:
                                                $TOTAL_LOCAL_EXTRA_KM_CHARGES = 0;
                                            endif;
                                            $OVERALL_OUTSTATION_KM += 0;
                                            $TOTAL_ALLOWED_LOCAL_KM = $TOTAL_ALLOWED_LOCAL_KM;
                                        endif;

                                        /* echo "itinerary_plan_ID => $itinerary_plan_ID | itinerary_route_ID => $itinerary_route_ID | vehicle_type_id => $vehicle_type_id | vendor_id => $vendor_id | vehicle_id => $vehicle_id <br>";
                                    echo "TOTAL_LOCAL_EXTRA_KM => $TOTAL_LOCAL_EXTRA_KM <br>";
                                    echo "TOTAL_LOCAL_EXTRA_KM_CHARGES => $TOTAL_LOCAL_EXTRA_KM_CHARGES <br>";
                                    echo "OVERALL_OUTSTATION_KM => $OVERALL_OUTSTATION_KM <br>";
                                    echo "TOTAL_ALLOWED_LOCAL_KM => $TOTAL_ALLOWED_LOCAL_KM <br>";
                                    echo "getTIMELIMITID => $getTIMELIMITID <br><br>"; */

                                        $OVERALL_LOCAL_KM += $TOTAL_ALLOWED_LOCAL_KM;
                                        $OVERALL_LOCAL_EXTRA_KM += $TOTAL_LOCAL_EXTRA_KM;
                                        $OVERALL_LOCAL_EXTRA_KM_CHARGES += $TOTAL_LOCAL_EXTRA_KM_CHARGES;

                                        $TOTAL_RUNNING_KM = $TOTAL_RUNNING_KM ?? 0;
                                        $TOTAL_TRAVELLING_TIME = $TOTAL_TRAVELLING_TIME ?? "00:00:00";
                                        $SIGHT_SEEING_TRAVELLING_KM = $SIGHT_SEEING_TRAVELLING_KM ?? 0;
                                        $SIGHT_SEEING_TRAVELLING_TIME = $SIGHT_SEEING_TRAVELLING_TIME ?? "00:00:00";
                                        $TOTAL_KM = $TOTAL_KM ?? 0;
                                        $TOTAL_TIME = $TOTAL_TIME ?? "00:00:00";
                                        $vehicle_cost_for_the_day = $vehicle_cost_for_the_day ?? 0;
                                        $VEHICLE_TOLL_CHARGE = $VEHICLE_TOLL_CHARGE ?? 0;
                                        $VEHICLE_PARKING_CHARGE = $VEHICLE_PARKING_CHARGE ?? 0;
                                        $TOTAL_DRIVER_CHARGES = $TOTAL_DRIVER_CHARGES ?? 0;
                                        $permit_charges = $permit_charges ?? 0;
                                        $morning_extra_time = $morning_extra_time ?? "00:00:00";
                                        $evening_extra_time = $evening_extra_time ?? "00:00:00";
                                        $DRIVER_MORINING_CHARGES = $DRIVER_MORINING_CHARGES ?? 0;
                                        $VENDOR_VEHICLE_MORNING_CHARGES = $VENDOR_VEHICLE_MORNING_CHARGES ?? 0;
                                        $DRIVER_EVEINING_CHARGES = $DRIVER_EVEINING_CHARGES ?? 0;
                                        $VENDOR_VEHICLE_EVENING_CHARGES = $VENDOR_VEHICLE_EVENING_CHARGES ?? 0;
                                        $TOTAL_VEHICLE_AMOUNT = $TOTAL_VEHICLE_AMOUNT ?? 0;

                                        //INSERT ALL THE ELIGIBLE VENDOR WISE VEHICLE LIST 
                                        $vendor_vehicle_details_arrFields = array('`itinerary_plan_id`', '`itinerary_route_id`', '`vehicle_type_id`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_qty`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_date`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`createdby`', '`status`');

                                        if ($getTIMELIMITID):
                                            $getTIMELIMITID = $getTIMELIMITID;
                                        else:
                                            $getTIMELIMITID = "0";
                                        endif;

                                        $vendor_vehicle_details_arrValues = array("$itinerary_plan_ID", "$itinerary_route_ID", "$vehicle_type_id", "$vendor_id", "$vendor_vehicle_type_ID", "1", "$vehicle_id", "$vendor_branch_id", "$getTIMELIMITID", "$travel_type", "$itinerary_route_date", "$location_name", "$next_visiting_location", "$TOTAL_RUNNING_KM", "$TOTAL_TRAVELLING_TIME", "$SIGHT_SEEING_TRAVELLING_KM", "$SIGHT_SEEING_TRAVELLING_TIME", "$TOTAL_PICKUP_KM", "$TOTAL_PICKUP_DURATION", "$TOTAL_DROP_KM", "$TOTAL_DROP_DURATION", "$TOTAL_LOCAL_EXTRA_KM", "$extra_km_charge", "$TOTAL_LOCAL_EXTRA_KM_CHARGES", "$TOTAL_KM", "$TOTAL_TIME", "$vehicle_cost_for_the_day", "$VEHICLE_TOLL_CHARGE", "$VEHICLE_PARKING_CHARGE", "$TOTAL_DRIVER_CHARGES", "$permit_charges", "$morning_extra_time", "$evening_extra_time", "$DRIVER_MORINING_CHARGES", "$VENDOR_VEHICLE_MORNING_CHARGES", "$DRIVER_EVEINING_CHARGES", "$VENDOR_VEHICLE_EVENING_CHARGES", "$TOTAL_VEHICLE_AMOUNT", "$logged_user_id", "1");

                                        if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, '')) :
                                            $confirmed_itinerary_plan_vendor_vehicle_details_ID = sqlINSERTID_LABEL();
                                            $arrFields_vehicle_vendor_details = array('`confirmed_itinerary_plan_vendor_vehicle_details_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`vehicle_type_id`', '`vehicle_qty`', '`vendor_id`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`time_limit_id`', '`travel_type`', '`itinerary_route_location_from`', '`itinerary_route_location_to`', '`total_running_km`', '`total_running_time`', '`total_siteseeing_km`', '`total_siteseeing_time`', '`total_pickup_km`', '`total_pickup_duration`', '`total_drop_km`', '`total_drop_duration`', '`total_extra_km`', '`extra_km_rate`', '`total_extra_km_charges`', '`total_travelled_km`', '`total_travelled_time`', '`vehicle_rental_charges`', '`vehicle_toll_charges`', '`vehicle_parking_charges`', '`vehicle_driver_charges`', '`vehicle_permit_charges`', '`before_6_am_extra_time`', '`after_8_pm_extra_time`', '`before_6_am_charges_for_driver`', '`before_6_am_charges_for_vehicle`', '`after_8_pm_charges_for_driver`', '`after_8_pm_charges_for_vehicle`', '`total_vehicle_amount`', '`createdby`', '`status`');

                                            $arrValues_vehicle_vendor_details = array("$confirmed_itinerary_plan_vendor_vehicle_details_ID", "$itinerary_plan_ID", "$itinerary_route_ID", "$itinerary_route_date", "$vehicle_type_id", "1", "$vendor_id", "$vendor_vehicle_type_ID", "$vehicle_id", "$vendor_branch_id", "$getTIMELIMITID", "$travel_type", "$location_name", "$next_visiting_location", "$TOTAL_RUNNING_KM", "$TOTAL_TRAVELLING_TIME", "$SIGHT_SEEING_TRAVELLING_KM", "$SIGHT_SEEING_TRAVELLING_TIME", "$TOTAL_PICKUP_KM", "$TOTAL_PICKUP_DURATION", "$TOTAL_DROP_KM", "$TOTAL_DROP_DURATION", "$TOTAL_LOCAL_EXTRA_KM", "$extra_km_charge", "$TOTAL_LOCAL_EXTRA_KM_CHARGES", "$TOTAL_KM", "$TOTAL_TIME", "$vehicle_cost_for_the_day", "$VEHICLE_TOLL_CHARGE", "$VEHICLE_PARKING_CHARGE", "$TOTAL_DRIVER_CHARGES", "$permit_charges", "$morning_extra_time", "$evening_extra_time", "$DRIVER_MORINING_CHARGES", "$VENDOR_VEHICLE_MORNING_CHARGES", "$DRIVER_EVEINING_CHARGES", "$VENDOR_VEHICLE_EVENING_CHARGES", "$TOTAL_VEHICLE_AMOUNT", "$logged_user_id", "1");
                                            if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_vehicle_details", $arrFields_vehicle_vendor_details, $arrValues_vehicle_vendor_details, '')) :
                                                $inserted_cancelled_itinerary_plan_vendor_vehicle_id = sqlINSERTID_LABEL();
                                            endif;
                                        endif;
                                        // if ($vehicle_qty < $get_vehicle_type_count) :
                                        //     if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, '')) :
                                        //     endif;
                                        // else :
                                        //     $vendor_vehicle_details_sqlwhere = " `itinerary_plan_id` = '$itinerary_plan_ID' AND `itinerary_route_id` = '$itinerary_route_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ";

                                        //     if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $vendor_vehicle_details_arrFields, $vendor_vehicle_details_arrValues, $vendor_vehicle_details_sqlwhere)) :
                                        //     endif;
                                        // endif;
                                        $previous_location_city = $source_location_city;
                                        $previous_destination_location_city = $destination_location_city;
                                    endwhile;
                                /* echo "</table>";
                                echo "<br>"; */
                                else :
                                    $errors['no_more_route_details_found'] = "No more route details found !!!";
                                endif;
                            endif;

                            $overall_time_total_hours = NULL;
                            $overall_time_total_minutes = NULL;

                            // Loop through each time and calculate total hours and minutes
                            /* foreach ($OVERALL_TOTAL_TIME as $time) :
                            list($hours, $minutes, $seconds) = explode(":", $time);

                            // Convert time to total minutes
                            $overall_time_total_minutes += $hours * 60 + $minutes;
                            endforeach; */

                            if (isset($OVERALL_TOTAL_TIME) && is_iterable($OVERALL_TOTAL_TIME)) :
                                foreach ($OVERALL_TOTAL_TIME as $time) :
                                    list($hours, $minutes, $seconds) = explode(":", $time);

                                    // Convert time to total minutes
                                    $overall_time_total_minutes += $hours * 60 + $minutes;
                                endforeach;
                            endif;

                            // Calculate total hours from total minutes
                            $overall_time_total_hours += floor($overall_time_total_minutes / 60);
                            $overall_time_total_minutes %= 60; // Remaining minutes after converting to hours

                            $OVERALL_TOTAL_HOURS_n_MINS = $overall_time_total_hours . '.' . $overall_time_total_minutes;

                            $PER_DAY_KM_LIMIT = $get_kms_limit;

                            $select_total_outstaion_day_data = sqlQUERY_LABEL("SELECT COUNT(*) AS count FROM ( SELECT `confirmed_itinerary_plan_vendor_vehicle_details_ID`, `travel_type` FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `confirmed_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details) AS limited_rows WHERE `travel_type` = '2'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            /* $total_outstation_day_available_count = sqlNUMOFROW_LABEL($select_total_outstaion_day_data); */
                            while ($fetch_total_outstaion_day_data = sqlFETCHARRAY_LABEL($select_total_outstaion_day_data)) :
                                $total_outstation_day_available_count = $fetch_total_outstaion_day_data['count'];
                            endwhile;

                            $TOTAL_ITINEARY_ALLOWED_KM = ($PER_DAY_KM_LIMIT * $total_outstation_day_available_count);
                            $PER_EXTRA_KM_CHARGE = $extra_km_charge;

                            /* echo "OVERALL_OUTSTATION_KM => $OVERALL_OUTSTATION_KM | TOTAL_ITINEARY_ALLOWED_KM => $TOTAL_ITINEARY_ALLOWED_KM | PER_EXTRA_KM_CHARGE => $PER_EXTRA_KM_CHARGE | TOTAL_EXTRA_KM => $TOTAL_EXTRA_KM <br>"; */

                            $get_extra_kms = ($OVERALL_OUTSTATION_KM - $TOTAL_ITINEARY_ALLOWED_KM);

                            if ($get_extra_kms > 0) :
                                $TOTAL_EXTRA_KM = $get_extra_kms;
                                $TOTAL_EXTRA_KM_CHARGE = ($TOTAL_EXTRA_KM * $PER_EXTRA_KM_CHARGE);
                            else :
                                $TOTAL_EXTRA_KM = 0;
                                $TOTAL_EXTRA_KM_CHARGE = 0;
                            endif;

                            $OVERALL_TOTAL_VEHICLE_AMOUNT = $OVERALL_TOTAL_VEHICLE_AMOUNT + $TOTAL_EXTRA_KM_CHARGE + $OVERALL_LOCAL_EXTRA_KM_CHARGES;

                            if ($vendor_branch_gst > 0) :
                                if ($vendor_branch_gst_type == 1) :
                                    // For Inclusive GST
                                    $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT / (1 + ($vendor_branch_gst / 100));
                                    $new_total_vehicle_tax_amt = ($OVERALL_TOTAL_VEHICLE_AMOUNT - $new_total_vehicle_cost);
                                elseif ($vendor_branch_gst_type == 2) :
                                    // For Exclusive GST
                                    $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT;
                                    $new_total_vehicle_tax_amt = ($OVERALL_TOTAL_VEHICLE_AMOUNT * $vendor_branch_gst / 100);
                                endif;
                            else :
                                $new_total_vehicle_cost = $OVERALL_TOTAL_VEHICLE_AMOUNT;
                                $new_total_vehicle_tax_amt = 0;
                            endif;

                            $TOTAL_VENDOR_MARGIN_AMOUNT = (($OVERALL_TOTAL_VEHICLE_AMOUNT * $vendor_margin) / 100);

                            if ($vendor_margin_gst_percentage > 0) :
                                if ($vendor_margin_gst_type == 1) :
                                    // For Inclusive GST
                                    $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT / (1 + ($vendor_margin_gst_percentage / 100));
                                    $new_total_margin_service_tax_amt = ($TOTAL_VENDOR_MARGIN_AMOUNT - $new_total_margin_amount);
                                elseif ($vendor_margin_gst_type == 2) :
                                    // For Exclusive GST
                                    $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT;
                                    $new_total_margin_service_tax_amt = ($TOTAL_VENDOR_MARGIN_AMOUNT * $vendor_margin_gst_percentage / 100);
                                endif;
                            else :
                                $new_total_margin_amount = $TOTAL_VENDOR_MARGIN_AMOUNT;
                                $new_total_margin_service_tax_amt = 0;
                            endif;

                            $VEHICLE_GRAND_TOTAL_AMOUNT = ($new_total_vehicle_cost + $new_total_vehicle_tax_amt + $new_total_margin_amount + $new_total_margin_service_tax_amt);

                            $array_of_vehicle_cost_for_the_day = $array_of_vehicle_cost_for_the_day ?? [];

                            $OVERALL_TOTAL_KM = $OVERALL_TOTAL_KM ?? 0;
                            $OVERALL_OUTSTATION_KM = $OVERALL_OUTSTATION_KM ?? 0;
                            $OVERALL_TOTAL_HOURS_n_MINS = $OVERALL_TOTAL_HOURS_n_MINS ?? "00:00:00";
                            $OVERALL_RENDAL_CHARGES = $OVERALL_RENDAL_CHARGES ?? 0;
                            $OVERALL_VEHICLE_TOLL_CHARGE = $OVERALL_VEHICLE_TOLL_CHARGE ?? 0;
                            $OVERALL_VEHICLE_PARKING_CHARGE = $OVERALL_VEHICLE_PARKING_CHARGE ?? 0;
                            $OVERALL_TOTAL_DRIVER_CHARGES = $OVERALL_TOTAL_DRIVER_CHARGES ?? 0;
                            $OVERALL_PERMIT_CHARGES = $OVERALL_PERMIT_CHARGES ?? 0;
                            $OVERALL_BEFORE_6AM_EXTRA_TIME = $OVERALL_BEFORE_6AM_EXTRA_TIME ?? "00:00:00";
                            $OVERALL_AFTER_8PM_EXTRA_TIME = $OVERALL_AFTER_8PM_EXTRA_TIME ?? "00:00:00";
                            $OVERALL_DRIVER_MORINING_CHARGES = $OVERALL_DRIVER_MORINING_CHARGES ?? 0;
                            $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES = $OVERALL_VENDOR_VEHICLE_MORNING_CHARGES ?? 0;
                            $OVERALL_DRIVER_EVEINING_CHARGES = $OVERALL_DRIVER_EVEINING_CHARGES ?? 0;
                            $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES = $OVERALL_VENDOR_VEHICLE_EVENING_CHARGES ?? 0;
                            $PER_EXTRA_KM_CHARGE = $PER_EXTRA_KM_CHARGE ?? 0;
                            $TOTAL_ITINEARY_ALLOWED_KM = $TOTAL_ITINEARY_ALLOWED_KM ?? 0;
                            $TOTAL_EXTRA_KM = $TOTAL_EXTRA_KM ?? 0;
                            $TOTAL_EXTRA_KM_CHARGE = $TOTAL_EXTRA_KM_CHARGE ?? 0;
                            $vendor_branch_gst = $vendor_branch_gst ?? 0;
                            $new_total_vehicle_tax_amt = $new_total_vehicle_tax_amt ?? 0;
                            $new_total_vehicle_cost = $new_total_vehicle_cost ?? 0;
                            $vendor_margin = $vendor_margin ?? 0;
                            $vendor_margin_gst_percentage = $vendor_margin_gst_percentage ?? 0;
                            $new_total_margin_amount = $new_total_margin_amount ?? 0;
                            $new_total_margin_service_tax_amt = $new_total_margin_service_tax_amt ?? 0;
                            $VEHICLE_GRAND_TOTAL_AMOUNT = $VEHICLE_GRAND_TOTAL_AMOUNT ?? 0;

                            /* $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_itinerary_plan_vendor_vehicle_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` != '$vendor_id' AND `vehicle_type_id` != '$vehicle_type_id' AND `vendor_branch_id` != '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                            $delete_itinerary_plan_vendor_eligible_list = sqlQUERY_LABEL("DELETE FROM `dvi_itinerary_plan_vendor_eligible_list` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` != '$vendor_id' AND `vehicle_type_id` != '$vehicle_type_id' AND `vendor_branch_id` != '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL()); */

                            /* $check_vehicle_eligible_list_already_available = sqlQUERY_LABEL("SELECT `itinerary_plan_vendor_eligible_ID` FROM `dvi_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            $total_vehicle_eligible_list_available_count = sqlNUMOFROW_LABEL($check_vehicle_eligible_list_already_available); */

                            // $check_vehicle_eligible_list_already_available = sqlQUERY_LABEL("SELECT COALESCE(SUM(CASE WHEN total_vehicle_qty = 0 THEN 1 ELSE total_vehicle_qty END), 0) AS total_vehicle_qty FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            // while ($fetch_vehicle_vendor_eligible_data = sqlFETCHARRAY_LABEL($check_vehicle_eligible_list_already_available)) :
                            //     $total_vehicle_qty = $fetch_vehicle_vendor_eligible_data['total_vehicle_qty'];
                            // endwhile;


                            //INSERT ALL THE ELIGIBLE VENDOR WISE VEHICLE LIST 
                            $vendor_eligible_list_arrFields = array('`itinerary_plan_id`', '`vehicle_type_id`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`',  '`total_vehicle_qty`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`',  '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`', '`createdby`', '`status`');

                            $vendor_eligible_list_arrValues = array("$itinerary_plan_ID", "$vehicle_type_id", "$vendor_id", "$get_kms_limit", "$vendor_vehicle_type_ID", "1", "$vehicle_id", "$vendor_branch_id", "$vehicle_origin", "1", "$OVERALL_TOTAL_KM", "$OVERALL_OUTSTATION_KM", "$OVERALL_TOTAL_HOURS_n_MINS", "$OVERALL_RENDAL_CHARGES", "$OVERALL_VEHICLE_TOLL_CHARGE", "$OVERALL_VEHICLE_PARKING_CHARGE", "$OVERALL_TOTAL_DRIVER_CHARGES", "$OVERALL_PERMIT_CHARGES", "$OVERALL_BEFORE_6AM_EXTRA_TIME", "$OVERALL_AFTER_8PM_EXTRA_TIME",  "$OVERALL_DRIVER_MORINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_MORNING_CHARGES", "$OVERALL_DRIVER_EVEINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_EVENING_CHARGES", "$PER_EXTRA_KM_CHARGE", "$TOTAL_ITINEARY_ALLOWED_KM", "$TOTAL_EXTRA_KM", "$TOTAL_EXTRA_KM_CHARGE", "$OVERALL_LOCAL_KM", "$OVERALL_LOCAL_EXTRA_KM", "$OVERALL_LOCAL_EXTRA_KM_CHARGES", "$vendor_branch_gst_type", "$vendor_branch_gst", "$new_total_vehicle_tax_amt", "$new_total_vehicle_cost", "$vendor_margin", "$vendor_margin_gst_type", "$vendor_margin_gst_percentage", "$new_total_margin_amount", "$new_total_margin_service_tax_amt", "$VEHICLE_GRAND_TOTAL_AMOUNT", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $vendor_eligible_list_arrFields, $vendor_eligible_list_arrValues, '')) :
                                $confirmed_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();

                                $arrFields_vehicle_details = array('`confirmed_itinerary_plan_vendor_eligible_ID`', '`itinerary_plan_id`', '`vehicle_type_id`', '`total_vehicle_qty`', '`vendor_id`', '`outstation_allowed_km_per_day`', '`vendor_vehicle_type_id`', '`vehicle_id`', '`vendor_branch_id`', '`vehicle_orign`', '`vehicle_count`', '`total_kms`', '`total_outstation_km`', '`total_time`', '`total_rental_charges`', '`total_toll_charges`', '`total_parking_charges`', '`total_driver_charges`', '`total_permit_charges`', '`total_before_6_am_extra_time`', '`total_after_8_pm_extra_time`', '`total_before_6_am_charges_for_driver`', '`total_before_6_am_charges_for_vehicle`', '`total_after_8_pm_charges_for_driver`', '`total_after_8_pm_charges_for_vehicle`', '`extra_km_rate`', '`total_allowed_kms`', '`total_extra_kms`', '`total_extra_kms_charge`', '`total_allowed_local_kms`', '`total_extra_local_kms`', '`total_extra_local_kms_charge`', '`vehicle_gst_type`', '`vehicle_gst_percentage`', '`vehicle_gst_amount`', '`vehicle_total_amount`', '`vendor_margin_percentage`', '`vendor_margin_gst_type`', '`vendor_margin_gst_percentage`', '`vendor_margin_amount`', '`vendor_margin_gst_amount`', '`vehicle_grand_total`', '`createdby`', '`status`');

                                $arrValues_vehicle_details = array("$confirmed_itinerary_plan_vendor_eligible_ID", "$itinerary_plan_ID", "$vehicle_type_id", "1", "$vendor_id", "$get_kms_limit", "$vendor_vehicle_type_ID", "$vehicle_id", "$vendor_branch_id", "$vehicle_origin", "1",  "$OVERALL_TOTAL_KM", "$OVERALL_OUTSTATION_KM", "$OVERALL_TOTAL_HOURS_n_MINS", "$OVERALL_RENDAL_CHARGES", "$OVERALL_VEHICLE_TOLL_CHARGE", "$OVERALL_VEHICLE_PARKING_CHARGE", "$OVERALL_TOTAL_DRIVER_CHARGES", "$OVERALL_PERMIT_CHARGES", "$OVERALL_BEFORE_6AM_EXTRA_TIME", "$OVERALL_AFTER_8PM_EXTRA_TIME", "$OVERALL_DRIVER_MORINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_MORNING_CHARGES", "$OVERALL_DRIVER_EVEINING_CHARGES", "$OVERALL_VENDOR_VEHICLE_EVENING_CHARGES", "$PER_EXTRA_KM_CHARGE", "$TOTAL_ITINEARY_ALLOWED_KM", "$TOTAL_EXTRA_KM", "$TOTAL_EXTRA_KM_CHARGE", "$OVERALL_LOCAL_KM", "$OVERALL_LOCAL_EXTRA_KM", "$OVERALL_LOCAL_EXTRA_KM_CHARGES", "$vendor_branch_gst_type", "$vendor_branch_gst", "$new_total_vehicle_tax_amt", "$new_total_vehicle_cost", "$vendor_margin", "$vendor_margin_gst_type", "$vendor_margin_gst_percentage", "$new_total_margin_amount", "$new_total_margin_service_tax_amt", "$VEHICLE_GRAND_TOTAL_AMOUNT", "$logged_user_id", "1");
                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $arrFields_vehicle_details, $arrValues_vehicle_details, '')) :
                                    $cancelled_itinerary_plan_vendor_eligible_ID = sqlINSERTID_LABEL();
                                endif;

                                $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_vehicle_details` SET `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `confirmed_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                                $update_cancelled_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_vehicle_details` SET `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' , `cancelled_itinerary_plan_vendor_eligible_ID` = '$cancelled_itinerary_plan_vendor_eligible_ID' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vendor_id` = '$vendor_id' AND `vendor_vehicle_type_id` = '$vendor_vehicle_type_ID' AND `vendor_branch_id` = '$vendor_branch_id' ORDER BY `cancelled_itinerary_plan_vendor_vehicle_details_ID` DESC LIMIT $total_no_of_itineary_plan_route_details") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            endif;

                        endfor;
                    endwhile;

                    $selected_vehicle_type = $_POST['vehicle_type'];
                    $selected_vehicle_count = $_POST['vehicle_quantity'];
                    $selected_vendor_id = $_POST['vendor_id'];

                    $select_itineary_required_vehicle_details = sqlQUERY_LABEL("SELECT `vehicle_type_id` FROM `dvi_confirmed_itinerary_plan_vehicle_details` WHERE `itinerary_plan_id` = '$itinerary_plan_ID' AND  `cancellation_status` = '0' AND  `status` = '1' AND `vehicle_type_id` IN (" . implode(",", $selected_vehicle_type) . ") and `deleted` = '0' GROUP BY `vehicle_type_id`") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                    $total_no_of_vehicle_required_count = sqlNUMOFROW_LABEL($select_itineary_required_vehicle_details);
                    if ($total_no_of_vehicle_required_count > 0) :

                        // $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY `confirmed_itinerary_plan_vendor_eligible_ID` ASC") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                        // $update_confirmed_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '0' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY `cancelled_itinerary_plan_vendor_eligible_ID` ASC") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                        while ($fetch_vehicle_eligible_data = sqlFETCHARRAY_LABEL($select_itineary_required_vehicle_details)) :
                            $vehicle_type_id = $fetch_vehicle_eligible_data['vehicle_type_id'];
                            $total_required_count = getCNFITINEARY_PLAN_VEHICLE_DETAILS($itinerary_plan_ID, $vehicle_type_id, 'get_vehicle_type_count');
                            $array_of_vehicle_type_id[] = $fetch_vehicle_eligible_data['vehicle_type_id'];
                            $confirmed_itinerary_plan_vendor_eligible_ID = $fetch_vehicle_eligible_data['confirmed_itinerary_plan_vendor_eligible_ID'];

                            $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '1' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' AND `vehicle_grand_total` > '0' ORDER BY `vehicle_grand_total` ASC LIMIT $total_required_count") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                            $update_confirmed_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_cancelled_itinerary_plan_vendor_eligible_list` SET `itineary_plan_assigned_status` = '1' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` = '$vehicle_type_id' AND `vehicle_grand_total` > '0' ORDER BY `vehicle_grand_total` ASC LIMIT $total_required_count") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                        endwhile;

                    // $required_vehicle_types = implode(',', $array_of_vehicle_type_id);

                    // $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_confirmed_itinerary_plan_vendor_eligible_list` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` NOT IN ($required_vehicle_types)") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                    // $delete_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("DELETE FROM `dvi_confirmed_itinerary_plan_vendor_vehicle_details` WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$itinerary_plan_ID' AND `vehicle_type_id` NOT IN ($required_vehicle_types) AND `confirmed_itinerary_plan_vendor_eligible_ID` != '0'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

                    endif;
                else :
                    $errors['no_more_vehicle_found_this_route'] = "No more vehicle found between these routes !!!";
                endif;
                else :
                $errors['no_more_vehicle_records'] = "No more vehicle records found !!!";
            endif;
        endif;

        if (!empty($errors)) :
            //error call
            $response['success'] = false;
            $response['i_result'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;
            $response['i_result'] = true;
        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'confirm_vendor_vehicles_cancellation'):

        $response = [];
        $errors = [];

        // Validate required fields
        if ($_POST['_cancellation_percentage'] == '') :
            $errors['itinerary_cancellation_percentage_required'] = true;
        endif;

        if ($_POST['_defect_type'] == "") :
            $errors['defect_type_required'] = true;
        endif;

        $_itinerary_plan_ID = $_POST['_itinerary_plan_ID'];
        $_vendor_id = $_POST['_vendor_id'];
        $_cancellation_percentage = $_POST['_cancellation_percentage'];
        $_defect_type = $_POST['_defect_type'];

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else : // If validation is successful
            $response['success'] = true;

            //CANCELLED VEHICLE DETAILS 
            $cancelled_on = date('Y-m-d H:i:s');

            $select_confirmed_itinerary_vehicle_details = sqlQUERY_LABEL("SELECT VENDOR_DETAILS.`vendor_name`, VENDOR_BRANCH_DETAILS.`vendor_branch_name`, VEHICLE_TYPE.`vehicle_type_title`, ITINEARY_PLAN_VEHICLE_DETAILS.`total_vehicle_qty`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_grand_total`, ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id`, ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_vendor_eligible_ID`, ITINEARY_PLAN_VEHICLE_DETAILS.`confirmed_itinerary_plan_vendor_eligible_ID` FROM `dvi_cancelled_itinerary_plan_vendor_eligible_list` ITINEARY_PLAN_VEHICLE_DETAILS LEFT JOIN `dvi_vendor_details` VENDOR_DETAILS ON VENDOR_DETAILS.`vendor_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` LEFT JOIN `dvi_vendor_branches` VENDOR_BRANCH_DETAILS ON VENDOR_BRANCH_DETAILS.`vendor_branch_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_branch_id` LEFT JOIN `dvi_vehicle_type` VEHICLE_TYPE ON VEHICLE_TYPE.`vehicle_type_id` = ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_type_id` WHERE ITINEARY_PLAN_VEHICLE_DETAILS.`itinerary_plan_id` = '$_itinerary_plan_ID' AND ITINEARY_PLAN_VEHICLE_DETAILS.`itineary_plan_assigned_status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vehicle_cancellation_status` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`status` = '1' AND ITINEARY_PLAN_VEHICLE_DETAILS.`deleted` = '0' AND ITINEARY_PLAN_VEHICLE_DETAILS.`vendor_id` = '$_vendor_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
            while ($fetch_confirmed_itinerary_vehicle_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_vehicle_details)) :
                $vendor_name = $fetch_confirmed_itinerary_vehicle_data['vendor_name'];
                $vendor_branch_name = $fetch_confirmed_itinerary_vehicle_data['vendor_branch_name'];
                $vehicle_type_title = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_title'];
                $vehicle_type_id = $fetch_confirmed_itinerary_vehicle_data['vehicle_type_id'];
                $total_vehicle_qty = $fetch_confirmed_itinerary_vehicle_data['total_vehicle_qty'];
                $vehicle_grand_total = round($fetch_confirmed_itinerary_vehicle_data['vehicle_grand_total']);
                $itinerary_plan_vendor_eligible_ID = $fetch_confirmed_itinerary_vehicle_data['itinerary_plan_vendor_eligible_ID'];
                $confirmed_itinerary_plan_vendor_eligible_ID = $fetch_confirmed_itinerary_vehicle_data['confirmed_itinerary_plan_vendor_eligible_ID'];

                $total_vehicle_type_cancellation_service_cost = ($vehicle_grand_total);
                $total_vehicle_type_cancellation_charges = (($total_vehicle_type_cancellation_service_cost * $_cancellation_percentage) / 100);
                $total_vehicle_type_refund_amt = ($total_vehicle_type_cancellation_service_cost - $total_vehicle_type_cancellation_charges);

                //CANCELLATION MAIN TABLE
                $select_cancelled_itinerary = sqlQUERY_LABEL("SELECT `cancelled_itinerary_ID`, `total_cancelled_service_amount`, `total_cancellation_charge`, `total_refund_amount` FROM `dvi_cancelled_itineraries` WHERE `deleted` = '0' and `status` = '1' and `itinerary_plan_id` = '$_itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_GUIDE_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_cancelled_itinerary) > 0) :
                    //UPDATE
                    while ($fetch_cancelled_itinerary_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary)) :
                        $cancelled_itinerary_ID  =  $fetch_cancelled_itinerary_data['cancelled_itinerary_ID'];
                        $existing_total_cancelled_service_amount = $fetch_cancelled_itinerary_data['total_cancelled_service_amount'];
                        $existing_total_cancellation_charge = $fetch_cancelled_itinerary_data['total_cancellation_charge'];
                        $existing_total_refund_amount = $fetch_cancelled_itinerary_data['total_refund_amount'];
                    endwhile;

                    $total_cancelled_service_amount = $total_vehicle_type_cancellation_service_cost + $existing_total_cancelled_service_amount;
                    $total_cancellation_charge = $total_vehicle_type_cancellation_charges + $existing_total_cancellation_charge;
                    $total_refund_amount = $total_vehicle_type_refund_amt + $existing_total_refund_amount;

                    $cancelled_itineraries_arrFields = array('`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`');

                    $cancelled_itineraries_arrValues = array("$total_cancelled_service_amount", "$total_cancellation_charge", "$total_refund_amount");

                    $cancelled_itineraries_sqlWhere = " `itinerary_plan_id` = '$_itinerary_plan_ID' ";

                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, $cancelled_itineraries_sqlWhere)) :
                    endif;

                    $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`', '`deleted`');
                    $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$_itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1","1");

                    //CANCELLATION LOG
                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                    endif;

                    //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY VEHICLE TYPE IN VENDOR VEHICLE ELIGIBILITY DETAILS TABLE
                    $cancelled_vehicle_type_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`', '`deleted`');
                    $cancelled_vehicle_type_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1","1");

                    $cancelled_vehicle_type_sqlWhere = " `itinerary_plan_vendor_eligible_ID` = '$itinerary_plan_vendor_eligible_ID' ";

                    //CANCELLATION LOG
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_vehicle_type_arrFields, $cancelled_vehicle_type_arrValues, $cancelled_vehicle_type_sqlWhere)) :
                    endif;

                else:

                    $total_cancelled_service_amount = $total_vehicle_type_cancellation_service_cost;
                    $total_cancellation_charge = $total_vehicle_type_cancellation_charges;
                    $total_refund_amount = $total_vehicle_type_refund_amt;

                    //INSERT
                    $cancelled_itineraries_arrFields = array('`itinerary_plan_id`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');

                    $cancelled_itineraries_arrValues = array("$_itinerary_plan_ID", "$total_cancelled_service_amount",  "$total_cancellation_charge", "$total_refund_amount", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itineraries", $cancelled_itineraries_arrFields, $cancelled_itineraries_arrValues, '')) :

                        $cancelled_itinerary_ID  = sqlINSERTID_LABEL();

                        $cancellationID_arrFields = array('`cancelled_itinerary_id`', '`itinerary_plan_id`', '`itinerary_vehicle_cancellation_status`', '`cancellation_date`', '`cancelled_by`', '`total_cancelled_service_amount`', '`total_cancellation_charge`', '`total_refund_amount`', '`createdby`', '`status`');
                        $cancellationID_arrValues = array("$cancelled_itinerary_ID", "$_itinerary_plan_ID", "1", "$cancelled_on", "$logged_user_id", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                        //CANCELLATION LOG
                        if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_details", $cancellationID_arrFields, $cancellationID_arrValues, '')) :
                        endif;

                        //UPDATE CANCELLATION LOG FOR CANCELLED ITINEARY VEHICLE TYPE IN VENDOR VEHICLE ELIGIBILITY DETAILS TABLE
                        $cancelled_vehicle_type_arrFields = array('`cancelled_itinerary_ID`', '`vehicle_cancellation_status`', '`cancelled_on`', '`vehicle_defect_type`', '`vehicle_cancellation_percentage`', '`total_vehicle_cancelled_service_amount`', '`total_vehicle_cancellation_charge`', '`total_vehicle_refund_amount`', '`createdby`', '`status`');
                        $cancelled_vehicle_type_arrValues = array("$cancelled_itinerary_ID", "1", "$cancelled_on",  "$_defect_type", "$_cancellation_percentage", "$total_vehicle_type_cancellation_service_cost", "$total_vehicle_type_cancellation_charges", "$total_vehicle_type_refund_amt", "$logged_user_id", "1");

                        $cancelled_vehicle_type_sqlWhere = " `itinerary_plan_vendor_eligible_ID` = '$itinerary_plan_vendor_eligible_ID' ";

                        //CANCELLATION LOG
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_vendor_eligible_list", $cancelled_vehicle_type_arrFields, $cancelled_vehicle_type_arrValues, $cancelled_vehicle_type_sqlWhere)) :
                        endif;

                    endif;
                endif;

                //UPDATE CANCELLATION STATUS IN ITINEARY PLAN VEHICLE DETAILS TABLE
                $update_itinerary_plan_vendor_vehicle_details = sqlQUERY_LABEL("UPDATE `dvi_confirmed_itinerary_plan_vehicle_details` SET `cancellation_status` = '1' WHERE `status` = '1' AND `deleted` = '0' AND `itinerary_plan_id` = '$_itinerary_plan_ID' AND `cancellation_status` = '0' AND `vehicle_type_id` = '$vehicle_type_id' ORDER BY  confirmed_vehicle_details_ID  DESC LIMIT 1") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());

               //UPDATE CANCELLATION STATUS FOR CONFIRMED ITINEARY VENDOR ELIGIBLE TABLE
                $confirmed_room_service_arrFields = array('`cancellation_status`', '`vehicle_defect_type`');
                $confirmed_room_service_arrValues = array("1", "$_defect_type");
                $confirmed_room_service_sqlwhere = " `confirmed_itinerary_plan_vendor_eligible_ID` = '$confirmed_itinerary_plan_vendor_eligible_ID' ";
                
                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_eligible_list", $confirmed_room_service_arrFields, $confirmed_room_service_arrValues, $confirmed_room_service_sqlwhere)) :
                    
                    //UPDATE CANCELLATION STATUS IN ITINEARY PLAN VENDOR VEHICLE DETAILS TABLE
                    $vendor_vehicle_type_id = getVENDOR_VEHICLE_TYPES($_vendor_id, $vehicle_type_id, 'get_vehicle_type_id');
                    $itineary_vehicle_arrFields = array('`cancellation_status`','`defect_type`');
                    $itineary_vehicle_arrValues = array("1", "$_defect_type");
                    $itineary_vehicle_sqlwhere = "  `vendor_id` = '$_vendor_id' AND `vehicle_type_id` = '$vehicle_type_id' AND `itinerary_plan_id` ='$_itinerary_plan_ID' ";   
                    
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vendor_vehicle_details", $itineary_vehicle_arrFields, $itineary_vehicle_arrValues, $itineary_vehicle_sqlwhere)) :

                        $voucher_created_query = sqlQUERY_LABEL("SELECT `cnf_itinerary_plan_vehicle_voucher_details_ID`, `itinerary_plan_vendor_eligible_ID`, `itinerary_plan_id`, `vehicle_type_id`, `vendor_id`, `vehicle_id`, `vendor_branch_id`, `vehicle_confirmed_by`, `vehicle_confirmed_email_id`, `vehicle_confirmed_mobile_no`, `invoice_to`, `vehicle_booking_status`, `vehicle_voucher_terms_condition`, `vehicle_confirmed_reservation`, `vehicle_confirmation_verified_by`, `vehicle_confirmation_verified_mobile_no`, `vehicle_confirmation_verified_email_id`, `vehicle_confirmation_status_remarks` FROM dvi_confirmed_itinerary_plan_vehicle_voucher_details WHERE `status` = '1' AND `deleted` = '0' 
                        AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` = '$_itinerary_plan_ID' AND `confirmed_itinerary_plan_vendor_eligible_ID` ='$confirmed_itinerary_plan_vendor_eligible_ID' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                        // If the Voucher is already created
                        if (sqlNUMOFROW_LABEL($voucher_created_query) > 0):
                            while ($voucher_created = sqlFETCHARRAY_LABEL($voucher_created_query)) :
                                $cnf_itinerary_plan_vehicle_voucher_details_ID = $voucher_created['cnf_itinerary_plan_vehicle_voucher_details_ID'];
                                $vendor_id_val = $voucher_created['vendor_id'];
                                $vehicle_id = $voucher_created['vehicle_id'];
                                $vendor_branch_id_val = $voucher_created['vendor_branch_id'];
                                $vehicle_type_id_val = $voucher_created['vehicle_type_id'];

                                $confirmed_by_val = $voucher_created['vehicle_confirmed_by'];
                                $email_id_val = $voucher_created['vehicle_confirmed_email_id'];
                                $mobile_number_val = $voucher_created['vehicle_confirmed_mobile_no'];
                                $invoice_to = $voucher_created['invoice_to'];
                                $vehicle_voucher_terms_condition_val = $voucher_created['vehicle_voucher_terms_condition'];
                                
                                $total_vehicle_qty_val = $total_vehicle_qty;
                                $vehicle_grand_total_val = $vehicle_grand_total;
                                $cancellation_percentage_val = $_cancellation_percentage;
                                $cancellation_charge_val = $total_vehicle_type_cancellation_charges;
                                $GRAND_TOTAL_val = $total_vehicle_type_refund_amt;

                                $vehicle_type_title = getVENDOR_VEHICLE_TYPES($vendor_id_val, $vehicle_type_id_val, 'label');
                                $vendor_name = getVENDOR_DETAILS($vendor_id_val, 'label');
                                $vendor_branch = getBranchLIST($vendor_branch_id_val, 'branch_label');
                                $vendor_address = getVENDORNAMEDETAIL($vendor_id_val, 'get_vendor_address');
                                $vendor_email = $email_id_val;

                                $primary_customer_name = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($_itinerary_plan_ID, 'primary_customer_name');
                                $agent_id = get_CONFIRMED_ITINEARY_CUSTOMER_DETAILS($_itinerary_plan_ID, 'agent_id');
                                $travel_expert_id = getAGENT_details($agent_id, '', 'travel_expert_id');
                                $travel_expert_name = getTRAVEL_EXPERT($travel_expert_id, 'label');
                                $travel_expert_staff_email = getTRAVEL_EXPERT($travel_expert_id, 'staff_email');
                                $agent_email = getAGENT_details($agent_id, '', 'get_agent_email_address');
                                $agent_company_name = get_AGENT_CONFIG_DETAILS($agent_id, 'company_name');
                                $agent_invoice_address = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_address');
                                $agent_invoice_gstin_no = get_AGENT_CONFIG_DETAILS($agent_id, 'invoice_gstin_no');

                                $total_adult = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_adult');
                                $total_children = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_children');
                                $total_infants = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'total_infants');
                                $vehicle_status = getHOTEL_CONFIRM_STATUS('6', 'label');
                                $confirmed_itinerary_quote_ID = get_ITINEARY_CONFIRMED_PLAN_DETAILS($_itinerary_plan_ID, 'itinerary_quote_ID');
                                $billing_type = $invoice_to;
                                $defect_type_label =getCNCELLATION_DEFECT_TYPE($_defect_type, 'label');

                                //UPDATE CANCELLATION STATUS FOR VOUCHER CREATED
                                $itineary_vehicle_voucher_arrFields = array('`vehicle_booking_status`','`status`');
                                $itineary_vehicle_voucher_arrValues = array("6","2");//cancelled
                                $itineary_vehicle_voucher_sqlwhere = " `cnf_itinerary_plan_vehicle_voucher_details_ID` = '$cnf_itinerary_plan_vehicle_voucher_details_ID' ";   
                                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_vehicle_voucher_details", $itineary_vehicle_voucher_arrFields, $itineary_vehicle_voucher_arrValues, $itineary_vehicle_voucher_sqlwhere)) :
                                endif;

                                //SEND CANCELLATION EMAIL NOTIFICATION TO VENDOR 
                                // Set global variables      
                                global $confirmed_by_val, $confirmed_itinerary_quote_ID, $primary_customer_name, $vendor_name, $vendor_address, $vehicle_type_title, $vendor_branch, $total_adult, $total_children, $total_infants, $travel_expert_name, $travel_expert_staff_email,  $billing_type, $vehicle_status, $agent_company_name, $agent_invoice_address, $agent_invoice_gstin_no, $_itinerary_plan_ID, $itinerary_plan_vendor_eligible_ID_val, $vendor_email, $agent_email, $status_val, $total_vehicle_qty_val, $vehicle_grand_total_val, $GRAND_TOTAL_val,$cancellation_percentage_val,$cancellation_charge_val, $defect_type_label;

                                // Assign values to global variables
                                $_SESSION['global_defect_type_label'] = $defect_type_label;
                                $_SESSION['global_total_vehicle_qty_val'] = $total_vehicle_qty_val;
                                $_SESSION['global_vehicle_grand_total_val'] = $total_vehicle_qty_val . ' X ' . general_currency_symbol . ' ' . number_format($vehicle_grand_total_val, 2);
                                $_SESSION['global_cancellation_percentage_val'] = $cancellation_percentage_val;
                                $_SESSION['global_cancellation_charge_val'] = $cancellation_charge_val;
                                $_SESSION['global_GRAND_TOTAL_val'] = general_currency_symbol . ' ' . number_format($GRAND_TOTAL_val, 2);
                                $_SESSION['global_hidden_itinerary_plan_id'] = $_itinerary_plan_ID;
                                $_SESSION['global_confirmed_by_val'] = $confirmed_by_val;
                                $_SESSION['global_confirmed_itinerary_quote_ID'] = $confirmed_itinerary_quote_ID;
                                $_SESSION['global_primary_customer_name'] = $primary_customer_name;
                                $_SESSION['global_vendor_name'] = $vendor_name;
                                $_SESSION['global_vehicle_status'] = $vehicle_status;
                                $_SESSION['global_status_val'] = $status_val;
                                $_SESSION['global_vendor_address'] = $vendor_address;
                                $_SESSION['global_vendor_email'] = $vendor_email;
                                $_SESSION['global_vehicle_type_title'] = $vehicle_type_title;
                                $_SESSION['global_vendor_branch'] = $vendor_branch;
                                $_SESSION['global_total_adult'] = $total_adult;
                                $_SESSION['global_total_children'] = $total_children;
                                $_SESSION['global_total_infants'] = $total_infants;
                                $_SESSION['global_travel_expert_name'] = $travel_expert_name;
                                $_SESSION['global_travel_expert_staff_email'] = $travel_expert_staff_email;
                                $_SESSION['global_billing_type'] = $billing_type;
                                $_SESSION['global_agent_company_name'] = $agent_company_name;
                                $_SESSION['global_agent_invoice_address'] = $agent_invoice_address;
                                $_SESSION['global_agent_invoice_gstin_no'] = $agent_invoice_gstin_no;
                                $_SESSION['global_itinerary_plan_vendor_eligible_ID_val'] = $itinerary_plan_vendor_eligible_ID_val;
                                $_SESSION['global_agent_email'] = $agent_email;

                                // Include the email notification script
                                include('ajax_vehicle_voucher_cancellation_email_notification.php');

                                // Assign values to global variables
                                unset($_SESSION['global_defect_type_label']);
                                unset($_SESSION['global_vehicle_grand_total_val']);
                                unset($_SESSION['global_vehicle_status']);
                                unset($_SESSION['global_confirmed_by_val']);
                                unset($_SESSION['global_confirmed_itinerary_quote_ID']);
                                unset($_SESSION['global_primary_customer_name']);
                                unset($_SESSION['global_vendor_name']);
                                unset($_SESSION['global_vendor_address']);
                                unset($_SESSION['global_total_adult']);
                                unset($_SESSION['global_total_children']);
                                unset($_SESSION['global_total_infants']);
                                unset($_SESSION['global_travel_expert_name']);
                                unset($_SESSION['global_travel_expert_staff_email']);
                                unset($_SESSION['global_billing_type']);
                                unset($_SESSION['global_hidden_itinerary_plan_id']);
                                unset($_SESSION['global_itinerary_plan_vendor_eligible_ID_val']);
                                unset($_SESSION['global_vendor_email']);
                                unset($_SESSION['global_status_val']);
                                unset($_SESSION['global_total_vehicle_qty_val']);
                                unset($_SESSION['global_GRAND_TOTAL_val']);
                                unset($_SESSION['global_total_vehicle_qty_val']);
                                unset($_SESSION['global_vehicle_status']);
                                unset($_SESSION['global_status_val']);
                                unset($_SESSION['global_vehicle_type_title']);
                                unset($_SESSION['global_vendor_branch']);
                                unset($_SESSION['global_agent_email']);
                                unset($_SESSION['global_cancellation_percentage_val']);
                                unset($_SESSION['global_cancellation_charge_val']);
                               
                            endwhile;
                        endif;

                        //CHECK IF VEHICLE IS ASSIGNED OR NOT FOR THIS ITINEARY PLAN
                        $assigned_vehicle_query = sqlQUERY_LABEL("SELECT vendor_vehicle_assigned_ID, vehicle_id FROM dvi_confirmed_itinerary_vendor_vehicle_assigned WHERE `status` = '1' AND `deleted` = '0' 
                        AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` = '$_itinerary_plan_ID'
                        ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                        // If the vehicle is assigned
                        if (sqlNUMOFROW_LABEL($assigned_vehicle_query) > 0) {
                            while ($assigned_vehicle = sqlFETCHARRAY_LABEL($assigned_vehicle_query)) {
                                $assigned_vehicle_id = $assigned_vehicle['vendor_vehicle_assigned_ID'];
                                // Update the vehicle assignment status to inactive (0)
                                $update_assignment_fields = array('`assigned_vehicle_status`','`status`');
                                $update_assignment_values = array("0","2");
                                $update_assignment_where = " `vendor_vehicle_assigned_ID` = '$assigned_vehicle_id' ";
                                sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_vehicle_assigned", $update_assignment_fields, $update_assignment_values, $update_assignment_where);

                                //check if driver is assigned, if yes then release the driver
                                $check_driver_assignment = sqlQUERY_LABEL("SELECT driver_assigned_ID, driver_id FROM dvi_confirmed_itinerary_vendor_driver_assigned WHERE `status` = '1' AND `deleted` = '0' 
                                AND `vendor_id` = '$_vendor_id' AND `itinerary_plan_id` ='$_itinerary_plan_ID' ") or die("#3-assignCHECK: UNABLE_TO_GET_DATA: " . sqlERROR_LABEL());
                                if (sqlNUMOFROW_LABEL($check_driver_assignment) > 0) {
                                    while ($assigned_driver = sqlFETCHARRAY_LABEL($check_driver_assignment)) {
                                        $assigned_driver_id = $assigned_driver['driver_assigned_ID'];
                                        // Update the driver assignment status to inactive (0)
                                        $update_driver_assignment_fields = array('`assigned_driver_status`','`status`');
                                        $update_driver_assignment_values = array("0","2");
                                        $update_driver_assignment_where = " `driver_assigned_ID` = '$assigned_driver_id' ";
                                        sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_vendor_driver_assigned", $update_driver_assignment_fields, $update_driver_assignment_values, $update_driver_assignment_where);
                                    }
                                }
                            }
                        }
                    endif;
                endif;

                //CHECK IF ALL SERVICES ARE CANCELLED THEN CANCEL THE ITINEARY PLAN
                cancel_EntireItineraryPlan($_itinerary_plan_ID);

                $response['confirmed_itinerary_plan_vendor_eligible_ID'][] = $confirmed_itinerary_plan_vendor_eligible_ID;
                $response['vehicle_type_id'][] = $vehicle_type_id;
                $response['itinerary_plan_vendor_eligible_ID'] = $itinerary_plan_vendor_eligible_ID;

                $response['html_vehicle_response_' . $_itinerary_plan_ID . '_' . $_vendor_id . '_' . $vehicle_type_id] = '<span class="btn btn-sm rounded-pill bg-label-danger me-2">Vehicle Cancelled</span><button type="button" onclick="vehicletypeCANCELLATIONDETAILS(' . $_itinerary_plan_ID . ',' . $_vendor_id . ',' . $vehicle_type_id . ')" class="btn btn-sm rounded-pill btn-label-github waves-effect">View Details</button>';

                $response['html_response_' . $confirmed_itinerary_plan_vendor_eligible_ID] = '<div class="d-flex justify-content-between align-items-center p-3" style="background-color: #ffeaea; border-left: 5px solid #dc3545; border-radius: 5px;">
                <!-- Left Side: Ticket Details -->
                <div>
                    <p class="m-0 fw-bold text-danger" style="font-size: 0.9rem; color: #495057;">' . $vehicle_type_title . ' (Cancelled)</p>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Cancelled on: ' . date("D M, Y \a\t h:i A", strtotime($cancelled_on)) . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Defect Type: ' . getCNCELLATION_DEFECT_TYPE($_defect_type, "label") . '</small>
                    <small class="d-block" style="font-size: 0.75rem;color:#6c757d;">Original Amount: ' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_cancellation_service_cost), 2) . '</small>
                    <p class="m-0 fw-bold" style="font-size: 0.85rem; color: #212529;">Refund Amount: ' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_refund_amt), 2) . ' (' . $_cancellation_percentage . '% Deduction)</p>
                </div>
                <!-- Right Side: Refunded Amount -->
                <div class="text-center">
                    <span class="text-danger" style="font-size: 0.85rem; font-weight: 500;">Refund</span>
                    <p class="fw-bold text-danger m-0" style="font-size: 0.85rem;">' . general_currency_symbol . ' ' . number_format(($total_vehicle_type_refund_amt), 2) . '</p>
                </div>
                </div>';
            endwhile;

            $TOTAL_CANCELLATION_REFUND_COST = get_ITINEARY_VEHICLE_CANCELLED_SUMMARY_DETAILS($_itinerary_plan_ID, $_vendor_id, 'TOTAL_CANCELLATION_REFUND_COST');

            $response['response_all_vendor_vehicle_cancel_check'] = true;
            $response['response_according_header'] = '<button class="accordion-button bg-label-danger text-black collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendor_details_' . $_vendor_id . '" aria-expanded="false" aria-controls="vendor_details_' . $_vendor_id . '" style="background-color: #ffffff;">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span><strong>' . $vendor_name . '</strong> | ' . $vendor_branch_name . '</span>
                                                    <div class="text-end"><strong class="text-black"> Refund Amount - ' . general_currency_symbol . ' ' . number_format($TOTAL_CANCELLATION_REFUND_COST, 2) . '</strong>
                                                    </div>
                                                </div>
                                            </button>';

        endif;

        echo json_encode($response);

    elseif ($_GET['type'] == 'show_add_new_hotel_form'):

        $itinerary_route_date = $_GET['itinerary_route_date'];
        $itinerary_plan_hotel_details_id = $_GET['itinerary_plan_hotel_details_id'];
        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $cancelled_hotel_id = $_GET['hotel_id'];

        $select_confirmed_itinerary_hotel_details = sqlQUERY_LABEL("SELECT 
            ITINEARY_ROUTE_DETAILS.`itinerary_route_ID`, 
            ITINEARY_ROUTE_DETAILS.`location_id`, 
            ITINEARY_ROUTE_DETAILS.`next_visiting_location`, 
            ITINEARY_ROUTE_DETAILS.`itinerary_route_date`, 
            STORED_LOCATION.`destination_location_lattitude`, 
            STORED_LOCATION.`destination_location_longitude`,
            HOTEL.`hotel_id`, 
            HOTEL.`hotel_name`, 
            HOTEL.`hotel_category` AS hotel_category_id,
            HOTEL_CATEGORY.`hotel_category_title` AS hotel_category,
            HOTEL.`hotel_latitude`, 
            HOTEL.`hotel_longitude`,
            MONTHNAME(ITINEARY_ROUTE_DETAILS.itinerary_route_date) as month,
            YEAR(ITINEARY_ROUTE_DETAILS.itinerary_route_date) as year,
            CASE 
                WHEN DAY(ITINEARY_ROUTE_DETAILS.itinerary_route_date) < 10 THEN CONCAT('day_', CAST(DAY(ITINEARY_ROUTE_DETAILS.itinerary_route_date) AS CHAR))
                ELSE CONCAT('day_', CAST(DAY(ITINEARY_ROUTE_DETAILS.itinerary_route_date) AS CHAR))
            END as formatted_day,
            (6371 * acos(cos(radians(STORED_LOCATION.`destination_location_lattitude`)) * cos(radians(HOTEL.`hotel_latitude`)) * cos(radians(HOTEL.`hotel_longitude`) - radians(STORED_LOCATION.`destination_location_longitude`)) + sin(radians(STORED_LOCATION.`destination_location_lattitude`)) * sin(radians(HOTEL.`hotel_latitude`)))) AS distance_in_km
        FROM 
            `dvi_itinerary_route_details` ITINEARY_ROUTE_DETAILS
        LEFT JOIN 
            `dvi_stored_locations` STORED_LOCATION 
        ON 
            STORED_LOCATION.`location_ID` = ITINEARY_ROUTE_DETAILS.`location_id` 
        LEFT JOIN 
            `dvi_hotel` HOTEL
        ON 
            1=1
        LEFT JOIN
            `dvi_hotel_category` HOTEL_CATEGORY
        ON 
            HOTEL.`hotel_category` = HOTEL_CATEGORY.`hotel_category_id`
        WHERE 
            ITINEARY_ROUTE_DETAILS.`deleted` = '0' 
            AND ITINEARY_ROUTE_DETAILS.`status` = '1' 
            AND ITINEARY_ROUTE_DETAILS.`itinerary_plan_ID` = '$itinerary_plan_id'
            AND ITINEARY_ROUTE_DETAILS.`itinerary_route_ID` = '$itinerary_route_id'
            AND ITINEARY_ROUTE_DETAILS.`itinerary_route_date` = '$itinerary_route_date'
            AND HOTEL.`hotel_latitude` IS NOT NULL
            AND HOTEL.`hotel_longitude` IS NOT NULL
            AND HOTEL.`status` = '1'
            AND HOTEL.`deleted` = '0'
            AND (6371 * acos(cos(radians(STORED_LOCATION.`destination_location_lattitude`)) * cos(radians(HOTEL.`hotel_latitude`)) * cos(radians(HOTEL.`hotel_longitude`) - radians(STORED_LOCATION.`destination_location_longitude`)) + sin(radians(STORED_LOCATION.`destination_location_lattitude`)) * sin(radians(HOTEL.`hotel_latitude`)))) <= 20
            GROUP BY HOTEL.`hotel_id`
        ORDER BY 
            ITINEARY_ROUTE_DETAILS.`itinerary_route_date` ASC, distance_in_km ASC") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
    ?>
        <style>
            .room-quantity-group {
                border: 1px solid #dbdade;
                padding-bottom: 3px !important;
                padding-top: 3px !important;
                border-radius: 5px; /* Added border-radius for rounded corners */
                overflow: hidden; /* Ensure child elements don't overflow */
                background: #dee0ee;
            }

            .room-quantity-input-field,
            .room-quantity-button-minus,
            .room-quantity-button-plus {
                border: none !important;
                background-color: transparent !important;
                -moz-appearance: none !important;
                /* Firefox */
                appearance: none !important;
                /* Other browsers */
                -webkit-appearance: none !important;
            }

            .room-quantity-input-field:focus {
                border: none;
                outline: none;
            }

            .room-quantity-button {
                background-color: #fff !important;
                border-radius: 30.375rem !important;
            }

            input.parsley-error .room-quantity-group:focus {
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
                border-color: #dc3545;
                padding-right: calc(1.5em + 0.9375rem);
                background-repeat: no-repeat;
                background-position: right calc(0.375em + 0.23438rem) center;
                background-size: calc(0.75em + 0.46875rem) calc(0.75em + 0.46875rem);
            }

            .room-quantity-control {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding: 0;
            }

            .room-quantity-minus,
            .room-quantity-plus {
                display: block;
                width: 30px;
                height: 30px;
                margin: 0;
                background: #dee0ee;
                text-decoration: none;
                text-align: center;
                line-height: 30px;
                font-size: 23px;
                cursor: pointer;
                border-radius: 0; /* Remove border-radius for flat buttons */
            }

            .room-quantity-minus {
                border-radius: 3px 0 0 3px;
            }

            .room-quantity-plus {
                border-radius: 0 3px 3px 0;
            }

            .room-quantity-input {
                width: 35px !important;
                height: 30px;
                margin: 0;
                padding: 0;
                text-align: center !important;
                background: #fff !important;
                color: #8184a1;
                border-radius: 0; /* Remove border-radius for flat input */
            }

            .room-quantity-minus:link,
            .room-quantity-plus:link {
                color: #8184a1;
            }
        </style>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Add New Hotel</strong>
                </h5>
            </div>


            <form id="ajax_add_new_hotel_form" action="" data-parsley-validate method="post">

                <input type="hidden" name="hid_itinerary_plan_id" value="<?= $itinerary_plan_id ?>">
                <input type="hidden" name="hid_itinerary_route_id" value="<?= $itinerary_route_id ?>">
                <input type="hidden" name="hid_itinerary_route_date" value="<?= $itinerary_route_date ?>">
                <input type="hidden" name="hid_itinerary_plan_hotel_details_id" value="<?= $itinerary_plan_hotel_details_id ?>">
                <input type="hidden" name="hid_cancelled_hotel_id" value="<?= $cancelled_hotel_id ?>">

                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">

                    <!-- Room Type -->
                    <div class="col-md-12 mt-3">
                        <label for="hotel_id" class="form-label"><strong>Hotel:</strong></label>
                        <select id="hotel_id" name="hotel_id" data-parsley-trigger="keyup" required class="form-select" onchange="updateROOMTYPEDETAILS(this.value,'<?= $itinerary_plan_id ?>','<?= $itinerary_route_id ?>','<?= $itinerary_route_date ?>')">
                            <?php while ($fetch_confirmed_itinerary_hotel_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_hotel_details)) :
                                $hotel_id = $fetch_confirmed_itinerary_hotel_data['hotel_id'];
                                $hotel_name = $fetch_confirmed_itinerary_hotel_data['hotel_name']; ?>
                                <option value="<?= $hotel_id; ?>"><?= $hotel_name; ?></option>
                            <?php endwhile; ?>
                        </select>
                    </div>

                    <div id="room_details" class="col-12 mb-2">
                    </div>


                    <hr class="my-3">

                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <div id="total_room_charge"><strong><?= general_currency_symbol . ' ' . number_format(0, 2); ?></strong></div>

                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button id="hotel_with_room_form_submit_btn" type="submit" class="btn btn-success">Confirm </button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            function updateRoomServiceTotal() {
                let total_room_service = 0;

                $('.room-service-checkbox:checked').each(function() {
                    let roomId = $(this).data('room-id');

                    let quantityInput = $('input.itinerary_quantity__input[data-room-id="' + roomId + '"]');
                    let priceElement = $(this).closest('.d-flex.align-items-center').find('strong');

                    let quantity = parseInt(quantityInput.val()) || 1;
                    let amount = parseFloat(priceElement.text().replace(/[^\d.]/g, '')) || 0;

                    total_room_service += amount * quantity;
                });

                // Format the total price properly
                const formattedTotalRoomRate = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: '<?= $general_currency_symbol; ?>',
                }).format(total_room_service);

                const formattedTotalRoomRateWithSpace = formattedTotalRoomRate.replace(/(\D+)(\d)/, '$1 $2');

                $('#total_room_charge').text(formattedTotalRoomRateWithSpace);
            }

            function updateROOMTYPEDETAILS(HOTEL_ID, ITINERARY_ID, ROUTE_ID, ROUTE_DATE) {
                $('#total_room_charge').text('<?= $general_currency_symbol ?> 0.00');

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=show_hotel_room_type_details",
                    data: {
                        _HOTEL_ID: HOTEL_ID,
                        _ITINERARY_ID: ITINERARY_ID,
                        _ROUTE_ID: ROUTE_ID,
                        _ROUTE_DATE: ROUTE_DATE,
                    },
                    dataType: 'json',
                    success: function(response) {
                        console.log("AJAX Response:", response); // Log the response for debugging

                        if (!response.success) {
                            if (response.errors && response.errors.choosen_hotel_required) {
                                TOAST_NOTIFICATION('warning', 'Hotel is Required', 'Warning !!!');
                            }
                        } else {
                            if (response.response_room_details) {
                                $('#room_details').html(response.response_room_details);
                            } else {
                                console.error("Room details not found in the response.");
                            }

                            if (response.total_room_rate) {
                                const formattedTotalRoomRate = new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: '<?= $general_currency_symbol; ?>',
                                }).format(response.total_room_rate);

                                const formattedTotalRoomRateWithSpace = formattedTotalRoomRate.replace(/(\D+)(\d)/, '$1 $2');
                                $('#total_room_rate').text(formattedTotalRoomRateWithSpace);
                                $('#total_room_charge').text(formattedTotalRoomRateWithSpace);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", status, error);
                        TOAST_NOTIFICATION('error', 'Unable to fetch room details. Please try again.', 'Error !!!');
                    }
                });
            }

            $(document).ready(function() {
                $('#hotel_id').selectize();
                $('#room_type').selectize();
                var HOTEL_DETAILS_ID = $("#hotel_id").val();
                updateROOMTYPEDETAILS(HOTEL_DETAILS_ID, '<?= $itinerary_plan_id ?>', '<?= $itinerary_route_id ?>', '<?= $itinerary_route_date ?>');
                // Prevent the label from toggling the checkbox when clicking inside the container (d-flex)
                $(document).off('click', 'label[for^="room_type_"]').on('click', 'label[for^="room_type_"]', function(e) {
                    // If the target is not the actual checkbox, do not toggle the checkbox.
                    if (!$(e.target).is('input.room-service-checkbox')) {
                        e.preventDefault();
                    }
                });

                // Stop propagation on plus, minus buttons, and the quantity input to prevent toggling via parent clicks
                $(document).off('click', '.room-quantity-plus, .room-quantity-minus, .room-quantity-input').on('click', '.room-quantity-plus, .room-quantity-minus, .room-quantity-input', function(e) {
                    e.stopPropagation();
                });

                // Handle checkbox click event
                $(document).off('click', '.room-service-checkbox').on('click', '.room-service-checkbox', function(e) {
                    var roomId = $(this).data('room-id');
                    var $quantityInput = $('input.room-quantity-input[data-room-id="' + roomId + '"]');
                    var $minusBtn = $('button.room-quantity-minus[data-room-id="' + roomId + '"]');
                    var $plusBtn = $('button.room-quantity-plus[data-room-id="' + roomId + '"]');

                    if ($(this).is(':checked')) {
                        // Set to 1 if currently 0 and enable input
                        if (parseInt($quantityInput.val(), 10) === 0) {
                            $quantityInput.val(1);
                        }
                        $quantityInput.prop('disabled', false);
                        $minusBtn.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                        $plusBtn.removeClass('disabled').css({
                            'cursor': 'pointer',
                            'pointer-events': 'auto',
                            'opacity': '1'
                        });
                    } else {
                        // Reset and disable input so it won't be submitted
                        $quantityInput.val(0).prop('disabled', true);
                        $minusBtn.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                        $plusBtn.addClass('disabled').css({
                            'cursor': 'not-allowed',
                            'pointer-events': 'none',
                            'opacity': '0.5'
                        });
                    }
                });

                // Increment the room quantity when the plus button is clicked
                $(document).off('click', '.room-quantity-plus').on('click', '.room-quantity-plus', function(e) {
                    e.preventDefault();
                    var roomId = $(this).data('room-id');
                    var $quantityInput = $('input.room-quantity-input[data-room-id="' + roomId + '"]');
                    var $checkbox = $('.room-service-checkbox[data-room-id="' + roomId + '"]');
                    var currentVal = parseInt($quantityInput.val(), 10);

                    if ($checkbox.is(':checked')) {
                        $quantityInput.val(currentVal + 1);
                    } else {
                        console.log("Checkbox is not checked. Increment ignored.");
                    }
                });

                // Decrement the room quantity when the minus button is clicked
                $(document).off('click', '.room-quantity-minus').on('click', '.room-quantity-minus', function(e) {
                    e.preventDefault();
                    var roomId = $(this).data('room-id');
                    var $quantityInput = $('input.room-quantity-input[data-room-id="' + roomId + '"]');
                    var $checkbox = $('.room-service-checkbox[data-room-id="' + roomId + '"]');
                    var currentVal = parseInt($quantityInput.val(), 10);

                    if ($checkbox.is(':checked') && currentVal > 1) {
                        $quantityInput.val(currentVal - 1);
                    } else {
                        console.log("Cannot decrement further, or checkbox is unchecked.");
                    }
                });

                $('#ajax_add_new_hotel_form').on('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission

                    var form = $('#ajax_add_new_hotel_form')[0];
                    var formData = new FormData(form);
                    //$(this).find("button[id='hotel_with_room_form_submit_btn']").prop('disabled', true);
                    //let formData = $(this).serialize();
                    $.ajax({
                        url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_new_hotel_with_room',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 80000,
                        dataType: 'json',
                        encode: true,
                    }).done(function(response) {
                        if (!response.success) {
                            if (response.errors.choosen_room_type_required) {
                                TOAST_NOTIFICATION('warning', 'Room Type is Required', 'Warning !!!');
                            } else if (response.errors.choosen_hotel_required) {
                                TOAST_NOTIFICATION('warning', 'Hotel is Required', 'Warning !!!');
                            }
                        } else {
                            if (response.i_result == true) {
                                //SUCCESS
                                TOAST_NOTIFICATION('success', 'Confirmed Hotel Successfully', 'Success !!!');
                                $("#showADDNEWHOTELFORMDATA").modal('hide'); // For Bootstrap
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            } else if (response.i_result == false) {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            } else {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            }
                        }
                        if (response == "OK") {
                            return true;
                        } else {
                            return false;
                        }
                    });



                });
            });
        </script>
    <?php
    elseif ($_GET['type'] == 'show_hotel_room_type_details'):
        $response = [];
        $errors = [];

        // Sanitize input
        $hotel_id = isset($_POST['_HOTEL_ID']) ? trim($_POST['_HOTEL_ID']) : '';
        $itinerary_plan_id = isset($_POST['_ITINERARY_ID']) ? trim($_POST['_ITINERARY_ID']) : '';
        $itinerary_route_date = isset($_POST['_ROUTE_DATE']) ? trim($_POST['_ROUTE_DATE']) : '';
        $itinerary_route_id = isset($_POST['_ROUTE_ID']) ? trim($_POST['_ROUTE_ID']) : '';

        if ($hotel_id == '') {
            $errors['choosen_hotel_required'] = true;
        }

        if (!empty($errors)) { // If validation fails
            $response['success'] = false;
            $response['errors'] = $errors;
        } else {
            $response['success'] = true;
            $collect_room_date = '';
            $has_room_with_price = false;

            // SQL Query
            $query = "SELECT 
            ITINEARY_ROUTE_DETAILS.itinerary_route_ID, 
            ITINEARY_ROUTE_DETAILS.location_id, 
            ITINEARY_ROUTE_DETAILS.next_visiting_location, 
            ITINEARY_ROUTE_DETAILS.itinerary_route_date, 
            STORED_LOCATION.destination_location_lattitude, 
            STORED_LOCATION.destination_location_longitude,
            HOTEL.hotel_id, 
            HOTEL.hotel_name, 
            HOTEL.hotel_category AS hotel_category_id,
            HOTEL_CATEGORY.hotel_category_title AS hotel_category,
            HOTEL.hotel_latitude, 
            HOTEL.hotel_longitude,
            ROOMS.room_id,
            ROOMS.room_type_id,
            ROOMS.gst_type,
            ROOMS.gst_percentage,
            ROOMS.hotel_id,
            MONTHNAME(ITINEARY_ROUTE_DETAILS.itinerary_route_date) as month,
            YEAR(ITINEARY_ROUTE_DETAILS.itinerary_route_date) as year,
            CONCAT('day_', CAST(DAY(ITINEARY_ROUTE_DETAILS.itinerary_route_date) AS CHAR)) AS formatted_day,
            (6371 * acos(cos(radians(STORED_LOCATION.destination_location_lattitude)) * cos(radians(HOTEL.hotel_latitude)) * 
            cos(radians(HOTEL.hotel_longitude) - radians(STORED_LOCATION.destination_location_longitude)) + 
            sin(radians(STORED_LOCATION.destination_location_lattitude)) * sin(radians(HOTEL.hotel_latitude)))) AS distance_in_km
            FROM 
                dvi_itinerary_route_details ITINEARY_ROUTE_DETAILS
            LEFT JOIN 
                dvi_stored_locations STORED_LOCATION ON STORED_LOCATION.location_ID = ITINEARY_ROUTE_DETAILS.location_id 
            LEFT JOIN 
                dvi_hotel HOTEL ON HOTEL.hotel_id = '$hotel_id'
            LEFT JOIN
                dvi_hotel_rooms ROOMS ON ROOMS.hotel_id = HOTEL.hotel_id
            LEFT JOIN
                dvi_hotel_category HOTEL_CATEGORY ON HOTEL.hotel_category = HOTEL_CATEGORY.hotel_category_id
            WHERE 
                ITINEARY_ROUTE_DETAILS.deleted = '0' 
                AND ITINEARY_ROUTE_DETAILS.status = '1' 
                AND ITINEARY_ROUTE_DETAILS.itinerary_plan_ID = '$itinerary_plan_id' 
                AND ITINEARY_ROUTE_DETAILS.itinerary_route_date = '$itinerary_route_date' 
                AND ITINEARY_ROUTE_DETAILS.itinerary_route_ID = '$itinerary_route_id' 
                AND HOTEL.hotel_latitude IS NOT NULL
                AND HOTEL.hotel_longitude IS NOT NULL
                AND ROOMS.room_id IS NOT NULL
                AND ROOMS.room_type_id IS NOT NULL
                AND HOTEL.status = '1'
                AND HOTEL.deleted = '0'
                AND ROOMS.status = '1'
                AND ROOMS.deleted = '0'
                AND (6371 * acos(cos(radians(STORED_LOCATION.destination_location_lattitude)) * cos(radians(HOTEL.hotel_latitude)) 
                * cos(radians(HOTEL.hotel_longitude) - radians(STORED_LOCATION.destination_location_longitude)) + 
                sin(radians(STORED_LOCATION.destination_location_lattitude)) * sin(radians(HOTEL.hotel_latitude)))) <= 20
            ORDER BY 
                ITINEARY_ROUTE_DETAILS.itinerary_route_date ASC, distance_in_km ASC";

            $select_hotel_room_data = sqlQUERY_LABEL($query) or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            $collect_room_date .= '<h6 class="mt-4 mb-0"><strong>Add Room:</strong><h6>';
            while ($fetch_hotel_room_data = sqlFETCHARRAY_LABEL($select_hotel_room_data)) {
                $room_ID = $fetch_hotel_room_data['room_id'];
                $choosen_room_type = $fetch_hotel_room_data['room_type_id'];
                $choosen_room_type_title = getROOM_DETAILS($choosen_room_type, 'ROOM_TYPE_TITLE');

                $pricebook_year = date('Y', strtotime($itinerary_route_date));
                $pricebook_month = date('F', strtotime($itinerary_route_date));
                $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));

                $total_room_rate = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '0');
                if ($total_room_rate > 0):
                    $has_room_with_price = true;
                    $collect_room_date .= '
                        <div class="room-service-container d-flex flex-column">
                            <br>
                            <div class="room-service-item d-flex align-items-center mb-2">
                                <input type="hidden" name="room_type[]" value="' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '_' . htmlspecialchars($choosen_room_type, ENT_QUOTES, 'UTF-8') . '">

                                <input type="checkbox" id="room_type_' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '"
                                    class="form-check-input me-2 room-service-checkbox"
                                    data-room-id="' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '">

                                <label class="pt-2 form-label w-100 d-flex align-items-center" for="room_type_' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '">
                                    <div class="row w-100 align-items-center">
                                        <div class="col-4">
                                            <span>' . htmlspecialchars($choosen_room_type_title, ENT_QUOTES, 'UTF-8') . '</span>
                                        </div>
                                        <div class="col-4 d-flex justify-content-center">
                                            <div class="room-quantity-control room-quantity-group d-flex align-items-center">
                                                <button class="room-quantity-minus room-quantity-button-minus disabled btn btn-sm"
                                                        data-room-id="' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '">
                                                    <span>-</span>
                                                </button>
                                                <input name="room_quantity[]"
                                                    readonly
                                                    type="text"
                                                    class="room-quantity-input room-quantity-input-field form-control text-center"
                                                    data-room-id="' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '"
                                                    style="width: 40px;"
                                                    value="0">
                                                <button class="room-quantity-plus room-quantity-button-plus disabled btn btn-sm"
                                                        data-room-id="' . htmlspecialchars($room_ID, ENT_QUOTES, 'UTF-8') . '">
                                                    <span>+</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span><strong>' . general_currency_symbol . ' ' . number_format($total_room_rate, 2) . '</strong></span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div id="error_container"></div>';
                endif;
            }

            if (!$has_room_with_price) {
                $collect_room_date .= '<div class="alert mt-3 text-center alert-warning">No rooms with price available.</div>';
            }

            $response['response_room_details'] = $collect_room_date;
        }
        echo json_encode($response);

    elseif ($_GET['type'] == 'show_add_new_room_form'):

        $itinerary_route_date = $_GET['itinerary_route_date'];
        $itinerary_plan_hotel_details_id = $_GET['itinerary_plan_hotel_details_id'];
        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $hotel_id = $_GET['hotel_id'];

        $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_location` FROM `dvi_confirmed_itinerary_plan_hotel_details` ITINEARY_PLAN_HOTEL_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_PLAN_HOTEL_DETAILS.`hotel_id`  WHERE  ITINEARY_PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = '$itinerary_plan_hotel_details_id' AND ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_id` = '$itinerary_route_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
            $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
            $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
        endwhile;
    ?>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Add New Room</strong>
                </h5>
            </div>

            <!-- Hotel Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel :</strong>
                    <span><?= htmlspecialchars($hotel_name); ?> </span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <form id="ajax_add_new_room_form" action="" data-parsley-validate method="post">
                <input type="hidden" name="hid_itinerary_plan_hotel_details_id" value="<?= $itinerary_plan_hotel_details_id ?>">
                <input type="hidden" name="hid_itinerary_plan_id" value="<?= $itinerary_plan_id ?>">
                <input type="hidden" name="hid_itinerary_route_id" value="<?= $itinerary_route_id ?>">
                <input type="hidden" name="hid_hotel_id" value="<?= $hotel_id ?>">
                <input type="hidden" name="hid_itinerary_route_date" value="<?= $itinerary_route_date ?>">

                <!-- Total Cost and Cancellation Details -->
                <div class="row mb-3">

                    <!-- Room Type -->
                    <div class="col-md-6 mt-3">
                        <label for="room_type" class="form-label"><strong>Room Type:</strong></label>
                        <select id="room_type" name="room_type" required class="form-select" onchange="updateROOMDETAILS('<?= $hotel_id ?>','<?= $itinerary_route_date ?>','<?= $itinerary_plan_id ?>')">
                            <?= getHOTEL_ROOM_TYPE_DETAIL($hotel_id, '', '', 'select'); ?>
                        </select>
                    </div>
                    <div class="col-md-2 mt-3">
                    </div>

                    <div class="col-md-4 mt-3 text-end">
                        <label for="total_room_rate" class="form-label"><strong>Room Rate:</strong></label>
                        <div id="total_room_rate">
                            <strong><?= general_currency_symbol . ' ' . number_format(0, 2); ?></strong>
                        </div>
                    </div>

                    <div id="room_details" class="col-12 mb-2">
                        <div class="d-flex flex-column">
                            <br>
                            <div class="d-flex align-items-center mb-2" id="row_extra_bed">
                                <input type="checkbox" id="add_extra_bed" name="add_extra_bed" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_extra_bed">
                                    <span>Extra Bed</span>
                                    <span><strong><?= general_currency_symbol . ' ' . number_format(0, 2); ?></strong></span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="row_child_with_bed">
                                <input type="checkbox" id="add_child_without_bed" name="add_child_without_bed" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_child_without_bed">
                                    <span>Child Without Bed</span>
                                    <span><strong><?= general_currency_symbol . ' ' . number_format($child_without_bed_rate, 2); ?></strong></span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="row_child_without_bed">
                                <input type="checkbox" id="add_child_with_bed" name="add_child_with_bed" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_child_with_bed">
                                    <span>Child With Bed</span>
                                    <span><strong><?= general_currency_symbol . ' ' . number_format($child_with_bed_rate, 2); ?></strong></span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="add_breakfast" name="add_breakfast" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_breakfast">
                                    <span>Breakfast</span>
                                    <span><strong><?= general_currency_symbol . ' ' . number_format($breakfast_rate, 2); ?></strong></span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="add_lunch" name="add_lunch" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_lunch">
                                    <span>Lunch</span>
                                    <span><strong><?= general_currency_symbol . ' ' . number_format($lunch_rate, 2); ?></strong></span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="add_dinner" name="add_dinner" class="form-check-input me-2 room_service" value="1">
                                <label class="form-label w-100 d-flex justify-content-between" for="add_dinner">
                                    <span>Dinner</span>
                                    <span id="dinner_price"><strong><?= general_currency_symbol . ' ' . number_format($dinner_rate, 2); ?></strong></span>
                                </label>
                            </div>
                        </div>
                        <div id="error_container"></div>
                    </div>


                    <hr class="my-3">

                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <div id="total_room_charge"><strong><?= general_currency_symbol . ' ' . number_format(0, 2); ?></strong></div>

                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button id="room_form_submit_btn" type="submit" class="btn btn-success">Confirm </button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {

                $(document).on('change', '.room_service', function() {
                    let total_room_service = 0; // Initialize total

                    // Loop through all checked room service checkboxes
                    $('.room_service:checked').each(function() {
                        // Extract the amount from the label's strong tag (i.e., the price)
                        let amount = $(this).siblings('label').find('strong').text().replace(/[^\d.]/g, '');
                        
                        // Convert amount to float
                        amount = parseFloat(amount);

                        // Add the valid amount to the total
                        if (!isNaN(amount)) {
                            total_room_service += amount;
                        } else {
                            console.log('Invalid amount found:', amount);
                        }
                    });

                    // Extract the room amount from the #total_room_rate (base room cost)
                    let room_amount = parseFloat($('#total_room_rate').text().replace(/[^\d.]/g, ''));

                    // If room amount is invalid (NaN), set to 0
                    if (isNaN(room_amount)) {
                        room_amount = 0;
                    }

                    // Calculate the total cost: room rate + room service
                    let total = total_room_service + room_amount;

                    // Format the total room charge
                    const formattedtotalroomrate = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: '<?= $general_currency_symbol; ?>',
                    }).format(total);

                    // Formatting the result to add space between currency and number (if necessary)
                    const formattedtotalroomrateWithSpace = formattedtotalroomrate.replace(/(\D+)(\d)/, '$1 $2');

                    // Set the formatted total into the DOM
                    document.getElementById('total_room_charge').innerText = formattedtotalroomrateWithSpace;
                });

                $('#ajax_add_new_room_form').on('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission

                    var form = $('#ajax_add_new_room_form')[0];
                    var formData = new FormData(form);
                    //$(this).find("button[id='room_form_submit_btn']").prop('disabled', true);
                    //let formData = $(this).serialize();
                    $.ajax({
                        url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_new_hotel_room',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 80000,
                        dataType: 'json',
                        encode: true,
                    }).done(function(response) {
                        if (!response.success) {
                            if (response.errors.choosen_room_type_required) {
                                TOAST_NOTIFICATION('warning', 'Room Type is Required', 'Warning !!!');
                            }
                        } else {
                            if (response.i_result == true) {
                                //SUCCESS
                                TOAST_NOTIFICATION('success', 'Confirmed Cancellation Successfully', 'Success !!!');
                                $("#showADDNEWROOMFORMDATA").modal('hide'); // For Bootstrap
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            } else if (response.i_result == false) {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            } else {
                                TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                            }
                        }
                        if (response == "OK") {
                            return true;
                        } else {
                            return false;
                        }
                    });



                });

            });


            function updateROOMDETAILS(HOTEL_ID, ROUTE_DATE, ITINERARY_PLAN_ID) {
                let ROOM_TYPE = $('#room_type').val();

                $.ajax({
                    type: "POST",
                    url: "engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=show_hotel_room_details",
                    data: {
                        _HOTEL_ID: HOTEL_ID,
                        _ROUTE_DATE: ROUTE_DATE,
                        _ROOM_TYPE: ROOM_TYPE,
                         _ITINERARY_PLAN_ID: ITINERARY_PLAN_ID,
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            if (response.errors.choosen_room_type_required) {
                                TOAST_NOTIFICATION('warning', 'Room Type is Required', 'Warning !!!');
                            }
                        } else {

                            if (response.response_room_details) {
                                $('#room_details').html(response.response_room_details);
                                applyCheckboxRestrictions();
                            }
                            if (response.total_room_rate) {
                                //$('#total_room_rate').html(response.total_room_rate);
                                const formattedtotalroomrate = new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: '<?= $general_currency_symbol; ?>',
                                }).format(response.total_room_rate);

                                const formattedtotalroomrateWithSpace = formattedtotalroomrate.replace(/(\D+)(\d)/, '$1 $2');
                                document.getElementById('total_room_rate').innerText = formattedtotalroomrateWithSpace;
                                document.getElementById('total_room_charge').innerText = formattedtotalroomrateWithSpace;

                            }

                        }
                    }
                });
            }

            function applyCheckboxRestrictions() {
                const ebCheckbox = document.getElementById('add_extra_bed');
                const cwbCheckbox = document.getElementById('add_child_with_bed');
                const cwobCheckbox = document.getElementById('add_child_without_bed');

                const ebRow = document.getElementById('row_extra_bed');
                const cwbRow = document.getElementById('row_child_with_bed');
                const cwobRow = document.getElementById('row_child_without_bed');

                const checkboxes = [ebCheckbox, cwbCheckbox, cwobCheckbox];
                const rows = [ebRow, cwbRow, cwobRow];
                const labels = ['Extra Bed', 'Child With Bed', 'Child Without Bed'];

                function updateRestrictions() {
                    console.log('--- updateRestrictions() triggered ---');

                    const checked = checkboxes
                        .map((cb, index) => ({ cb, index }))
                        .filter(obj => obj.cb && obj.cb.checked);

                    console.log('Checked items:', checked.map(c => labels[c.index]));

                    // Check if all three checkboxes are present
                    const allCheckboxesPresent = checkboxes.every(cb => cb !== null);
                    
                    if (allCheckboxesPresent && checked.length >= 2) {
                        // If two or more options are checked, hide the others
                        checkboxes.forEach((cb, i) => {
                            if (cb && !cb.checked) {
                                console.log(`Hiding unchecked option: ${labels[i]}`);
                                if (rows[i]) {
                                    rows[i].classList.add('d-none');
                                }
                                cb.checked = false; // Just to be sure
                            }
                        });
                    } else {
                        // If less than two checkboxes are selected, show everything
                        rows.forEach((row, i) => {
                            if (row) {
                                console.log(`Unhiding option: ${labels[i]}`);
                                row.classList.remove('d-none');
                            }
                        });
                    }

                    console.log('--- End of updateRestrictions ---');
                }

                checkboxes.forEach((cb, i) => {
                    if (cb) {
                        console.log(`Binding change event to: ${labels[i]}`);
                        cb.addEventListener('change', updateRestrictions);
                    } else {
                        console.warn(`Checkbox not found: ${labels[i]}`);
                    }
                });

                // Initial run to set up the restriction state
                updateRestrictions();
            }

        </script>
    <?php
    elseif ($_GET['type'] == 'show_hotel_room_details'):

        $response = [];
        $errors = [];

        $hotel_id = $_POST['_HOTEL_ID'];
        $itinerary_route_date = $_POST['_ROUTE_DATE'];
        $choosen_room_type = $_POST['_ROOM_TYPE'];
        $itinerary_plan_id = $_POST['_ITINERARY_PLAN_ID'];

        if ($_POST['_ROOM_TYPE'] == '') :
            $errors['choosen_room_type_required'] = true;
        endif;


        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;
            $select_hotel_room_data = sqlQUERY_LABEL("SELECT HOTEL.`hotel_category`, HOTEL.`hotel_margin`, HOTEL.`hotel_margin_gst_type`, HOTEL.`hotel_margin_gst_percentage`, HOTEL_ROOM.`room_ID`, HOTEL_ROOM.`gst_type`, HOTEL_ROOM.`gst_percentage` FROM `dvi_hotel_rooms` HOTEL_ROOM LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = HOTEL_ROOM.`hotel_id`  WHERE HOTEL_ROOM.`deleted` = '0' AND HOTEL_ROOM.`room_type_id` = '$choosen_room_type' AND HOTEL_ROOM.`hotel_id` = '$hotel_id' LIMIT 1") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            while ($fetch_hotel_room_data = sqlFETCHARRAY_LABEL($select_hotel_room_data)) :
                $room_ID = $fetch_hotel_room_data['room_ID'];
            endwhile;

            $pricebook_year = date('Y', strtotime($itinerary_route_date));
            $pricebook_month = date('F', strtotime($itinerary_route_date));
            $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));
            $itinerary_person_count=get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id,'total_person_count');
            $hotel_breafast_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '1');
            $hotel_lunch_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '2');
            $hotel_dinner_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '3');

             $overall_breakfast_cost=$itinerary_person_count*$hotel_breafast_cost;
            $overall_lunch_cost=$itinerary_person_count*$hotel_lunch_cost;
            $overall_dinner_cost=$itinerary_person_count*$hotel_dinner_cost;

            $total_room_rate = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '0');
            $extra_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '1');
            $child_with_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '2');
            $child_without_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '3');
            $response['total_room_rate'] = $total_room_rate;
         $response['response_room_details'] = '<div class="d-flex flex-column"><br>';

            // Extra Bed
            if ($extra_bed_charge > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2" id="row_extra_bed">
                        <input type="checkbox" id="add_extra_bed" name="add_extra_bed" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_extra_bed">
                            <span>Extra Bed</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($extra_bed_charge, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            // Child Without Bed
            if ($child_without_bed_charge > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2" id="row_child_without_bed">
                        <input type="checkbox" id="add_child_without_bed" name="add_child_without_bed" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_child_without_bed">
                            <span>Child Without Bed</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($child_without_bed_charge, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            // Child With Bed
            if ($child_with_bed_charge > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2" id="row_child_with_bed">
                        <input type="checkbox" id="add_child_with_bed" name="add_child_with_bed" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_child_with_bed">
                            <span>Child With Bed</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($child_with_bed_charge, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            // Breakfast
            if ($hotel_breafast_cost > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" id="add_breakfast" name="add_breakfast" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_breakfast">
                            <span>Breakfast ('.$itinerary_person_count.'*'.$hotel_breafast_cost.')</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($overall_breakfast_cost, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            // Lunch
            if ($hotel_lunch_cost > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" id="add_lunch" name="add_lunch" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_lunch">
                            <span>Lunch ('.$itinerary_person_count.'*'.$hotel_lunch_cost.')</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($overall_lunch_cost, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            // Dinner
            if ($hotel_dinner_cost > 0) {
                $response['response_room_details'] .= '
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" id="add_dinner" name="add_dinner" class="form-check-input me-2 room_service" value="1">
                        <label class="form-label w-100 d-flex justify-content-between" for="add_dinner">
                            <span>Dinner ('.$itinerary_person_count.'*'.$hotel_dinner_cost.')</span>
                            <span><strong>' . general_currency_symbol . ' ' . number_format($overall_dinner_cost, 2) . '</strong></span>
                        </label>
                    </div>';
            }

            $response['response_room_details'] .= '</div><div id="error_container"></div>';

        endif;
        echo json_encode($response);


    elseif ($_GET['type'] == 'add_new_hotel_room'):
        $response = [];
        $errors = [];

        $itinerary_plan_ID = $_POST['hid_itinerary_plan_id'];
        $itinerary_route_id = $_POST['hid_itinerary_route_id'];
        $confirmed_itinerary_plan_hotel_details_id = $_POST['hid_itinerary_plan_hotel_details_id'];
        $hotel_id = $_POST['hid_hotel_id'];
        $itinerary_route_date = $_POST['hid_itinerary_route_date'];
        $choosen_room_type = $_POST['room_type'];

        $total_extra_bed =  ($_POST['add_extra_bed']) ? 1 : 0;
        $total_child_without_bed = $_POST['add_child_without_bed'] ? 1 : 0;
        $total_child_with_bed = $_POST['add_child_with_bed'] ? 1 : 0;

        $breakfast_meal_plan = ($_POST['add_breakfast']) ? 1 : 0;
        $lunch_meal_plan = ($_POST['add_lunch']) ? 1 : 0;
        $dinner_meal_plan = ($_POST['add_dinner']) ? 1 : 0;

        if ($_POST['room_type'] == '') :
            $errors['choosen_room_type_required'] = true;
        endif;

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;

            //FETCH ROOM DETAILS FOR THE SELECTED ROOM TYPE
            $select_hotel_room_data = sqlQUERY_LABEL("SELECT HOTEL.`hotel_category`, HOTEL.`hotel_margin`, HOTEL.`hotel_margin_gst_type`, HOTEL.`hotel_margin_gst_percentage`, HOTEL_ROOM.`room_ID`, HOTEL_ROOM.`gst_type`, HOTEL_ROOM.`gst_percentage` FROM `dvi_hotel_rooms` HOTEL_ROOM LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = HOTEL_ROOM.`hotel_id`  WHERE HOTEL_ROOM.`deleted` = '0' AND HOTEL_ROOM.`room_type_id` = '$choosen_room_type' AND HOTEL_ROOM.`hotel_id` = '$hotel_id' LIMIT 1") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            while ($fetch_hotel_room_data = sqlFETCHARRAY_LABEL($select_hotel_room_data)) :
                $room_ID = $fetch_hotel_room_data['room_ID'];
                $gst_type = $fetch_hotel_room_data['gst_type'];
                $gst_percentage = $fetch_hotel_room_data['gst_percentage'];
            endwhile;

            $itinerary_plan_query = sqlQUERY_LABEL("SELECT  `meal_plan_breakfast`, `meal_plan_lunch`, `meal_plan_dinner` FROM `dvi_itinerary_plan_details` WHERE  `deleted` = '0' AND `itinerary_plan_ID` = '$itinerary_plan_ID'") or die("#1-UNABLE_TO_COLLECT_ITINERARY_PLAN_DETAILS:" . sqlERROR_LABEL());
            $itinerary_plan = sqlFETCHARRAY_LABEL($itinerary_plan_query);
            $default_meal_plan_breakfast = $itinerary_plan['meal_plan_breakfast'];
            $default_meal_plan_lunch = $itinerary_plan['meal_plan_lunch'];
            $default_meal_plan_dinner = $itinerary_plan['meal_plan_dinner'];

            $select_confirmed_itinerary_plan_hotel_room_details = sqlQUERY_LABEL("SELECT `itinerary_plan_hotel_details_id`, `group_type`, `itinerary_plan_id`, `itinerary_route_id`, `itinerary_route_date`, `hotel_id`, `room_type_id`, `room_id`, `room_qty`, `room_rate`, `gst_type`, `gst_percentage`, `extra_bed_count`, `extra_bed_rate`, `child_without_bed_count`, `child_without_bed_charges`, `child_with_bed_count`, `child_with_bed_charges`, `breakfast_required`, `lunch_required`, `dinner_required`, `breakfast_cost_per_person`, `lunch_cost_per_person`, `dinner_cost_per_person`, `total_breafast_cost`, `total_lunch_cost`, `total_dinner_cost`, `total_room_cost`, `total_room_gst_amount` FROM  `dvi_confirmed_itinerary_plan_hotel_room_details` WHERE `deleted` = '0' AND `hotel_id` = '$hotel_id' AND `confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' ") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            while ($fetch_confirmed_itinerary_hotel_room_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_hotel_room_details)) :
                $group_type = $fetch_confirmed_itinerary_hotel_room_data['group_type'];
                $gst_type = $fetch_confirmed_itinerary_hotel_room_data['gst_type'];
                $gst_percentage = $fetch_confirmed_itinerary_hotel_room_data['gst_percentage'];
                $itinerary_plan_hotel_details_id = $fetch_confirmed_itinerary_hotel_room_data['itinerary_plan_hotel_details_id'];
            endwhile;

            $pricebook_year = date('Y', strtotime($itinerary_route_date));
            $pricebook_month = date('F', strtotime($itinerary_route_date));
            $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));

            $hotel_breafast_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '1');
            $hotel_lunch_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '2');
            $hotel_dinner_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '3');

            $extra_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '1');
            $child_with_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '2');
            $child_without_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '3');

            $price_per_night = getROOM_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $pricebook_year, $pricebook_month, $formatted_day, $choosen_room_type, 'room_rate_for_the_day');


            //BY DEFAULT WE ARE CALCULATING FOOD FOR 2 PERSONS IN A ROOM
            $food_required_count = 2;
            $room_qty = 1;

            //MEAL COST CALCULATION
            if (($breakfast_meal_plan != "0") || ($lunch_meal_plan != "0") || ($dinner_meal_plan != "0")):

                $total_breafast_cost = ($breakfast_meal_plan) ? (($food_required_count * $hotel_breafast_cost) * $room_qty) : (($default_meal_plan_breakfast == 1) ? (($food_required_count * $hotel_breafast_cost) * $room_qty) : 0);

                $total_lunch_cost = ($lunch_meal_plan) ? (($food_required_count * $hotel_lunch_cost) * $room_qty) : 0;

                $total_dinner_cost = ($dinner_meal_plan) ? (($food_required_count * $hotel_dinner_cost) * $room_qty) : 0;

                $breakfast_meal_plan = ($breakfast_meal_plan) ? 1 : 0;
                $lunch_meal_plan = ($lunch_meal_plan) ? 1 : 0;
                $dinner_meal_plan = ($dinner_meal_plan) ? 1 : 0;
            else:

                $total_breafast_cost = ($breakfast_meal_plan) ? (($food_required_count * $hotel_breafast_cost) * $room_qty) : 0;
                $total_lunch_cost = ($lunch_meal_plan) ? (($food_required_count * $hotel_lunch_cost) * $room_qty) : 0;
                $total_dinner_cost = ($dinner_meal_plan) ? (($food_required_count * $hotel_dinner_cost) * $room_qty) : 0;
                $breakfast_meal_plan = ($breakfast_meal_plan) ? 1 : 0;
                $lunch_meal_plan = ($lunch_meal_plan) ? 1 : 0;
                $dinner_meal_plan = ($dinner_meal_plan) ? 1 : 0;
            endif;

            if ($total_extra_bed > 0) :
                $extra_bed_charge = $extra_bed_charge * $total_extra_bed;
            else :
                $extra_bed_charge = 0;
            endif;

            if ($total_child_without_bed > 0) :
                $child_without_bed_charge = $child_without_bed_charge * $total_child_without_bed;
            else :
                $child_without_bed_charge = 0;
            endif;

            if ($total_child_with_bed > 0) :
                $child_with_bed_charge = $child_with_bed_charge * $total_child_with_bed;
            else :
                $child_with_bed_charge = 0;
            endif;

            $total_room_cost = ($price_per_night * $room_qty);

            if ($gst_type == 1) :
                // For Inclusive GST
                $new_room_tax_amt = ($total_room_cost * $gst_percentage / 100);
                $new_room_amount = ($total_room_cost - $new_room_tax_amt);
            elseif ($gst_type == 2) :
                // For Exclusive GST
                $new_room_tax_amt = ($total_room_cost * $gst_percentage / 100);
                $new_room_amount = $total_room_cost;
            endif;

            $hotel_room_arrFields = array('`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_qty`', '`room_rate`', '`gst_type`', '`gst_percentage`', '`extra_bed_count`', '`extra_bed_rate`', '`child_without_bed_count`', '`child_without_bed_charges`', '`child_with_bed_count`', '`child_with_bed_charges`', '`breakfast_required`', '`lunch_required`', '`dinner_required`', '`total_breafast_cost`', '`total_lunch_cost`', '`total_dinner_cost`', '`breakfast_cost_per_person`', '`lunch_cost_per_person`', '`dinner_cost_per_person`', '`total_room_cost`', '`total_room_gst_amount`', '`createdby`', '`status`');

            $hotel_room_arrValues = array("$itinerary_plan_hotel_details_id", "$confirmed_itinerary_plan_hotel_details_id", "$itinerary_plan_ID", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$choosen_room_type", "$room_ID", "1", "$price_per_night", "$gst_type", "$gst_percentage", "$total_extra_bed", "$extra_bed_charge", "$total_child_without_bed", "$child_without_bed_charge", "$total_child_with_bed", "$child_with_bed_charge", "$breakfast_meal_plan", "$lunch_meal_plan", "$dinner_meal_plan", "$total_breafast_cost", "$total_lunch_cost", "$total_dinner_cost", "$hotel_breafast_cost", "$hotel_lunch_cost", "$hotel_dinner_cost", "$new_room_amount", "$new_room_tax_amt", "$logged_user_id", "1");

            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, '')):
                $confirmed_itinerary_plan_hotel_room_details_ID = sqlINSERTID_LABEL();

                $cancelled_hotel_room_arrFields = array('`confirmed_itinerary_plan_hotel_room_details_ID`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_qty`', '`room_rate`', '`gst_type`', '`gst_percentage`', '`extra_bed_count`', '`extra_bed_rate`', '`child_without_bed_count`', '`child_without_bed_charges`', '`child_with_bed_count`', '`child_with_bed_charges`', '`breakfast_required`', '`lunch_required`', '`dinner_required`', '`total_breafast_cost`', '`total_lunch_cost`', '`total_dinner_cost`', '`breakfast_cost_per_person`', '`lunch_cost_per_person`', '`dinner_cost_per_person`', '`total_room_cost`', '`total_room_gst_amount`', '`createdby`', '`status`');

                $cancelled_hotel_room_arrValues = array("$confirmed_itinerary_plan_hotel_room_details_ID", "$itinerary_plan_hotel_details_id", "$confirmed_itinerary_plan_hotel_details_id", "$itinerary_plan_ID", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$choosen_room_type", "$room_ID", "1", "$price_per_night", "$gst_type", "$gst_percentage", "$total_extra_bed", "$extra_bed_charge", "$total_child_without_bed", "$child_without_bed_charge", "$total_child_with_bed", "$child_with_bed_charge", "$breakfast_meal_plan", "$lunch_meal_plan", "$dinner_meal_plan", "$total_breafast_cost", "$total_lunch_cost", "$total_dinner_cost", "$hotel_breafast_cost", "$hotel_lunch_cost", "$hotel_dinner_cost", "$new_room_amount", "$new_room_tax_amt", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_details", $cancelled_hotel_room_arrFields, $cancelled_hotel_room_arrValues, '')):
                    $cancelled_itinerary_plan_hotel_room_details_ID = sqlINSERTID_LABEL();
                endif;

                //UPDATE ROOM SERVICES TABLE (in confirmed itinerary)

                // Calculate per person cost for services with a count greater than zero
                $extra_bed_cost_per_person = ($total_extra_bed > 0) ? $extra_bed_charge / $total_extra_bed : 0;
                $cnb_per_person = ($total_child_without_bed > 0) ? $child_without_bed_charge / $total_child_without_bed : 0;
                $cwb_per_person = ($total_child_with_bed > 0) ? $child_with_bed_charge / $total_child_with_bed : 0;

                // Ensure count values are numeric
                $breakfast_required = isset($breakfast_meal_plan) ? (int)$breakfast_meal_plan : 0;
                $lunch_required = isset($lunch_meal_plan) ? (int)$lunch_meal_plan : 0;
                $dinner_required = isset($dinner_meal_plan) ? (int)$dinner_meal_plan : 0;


                $arrFields_hotel_room_services = array('confirmed_itinerary_plan_hotel_room_details_ID',  'itinerary_plan_hotel_details_id', 'confirmed_itinerary_plan_hotel_details_id', 'group_type', 'itinerary_plan_id', 'itinerary_route_id', 'itinerary_route_date', 'hotel_id', 'room_type_id', 'room_id', 'room_service_type', 'room_service_count', 'service_cost_per_person', 'total_room_service_rate', 'createdby', 'status');

                $arrFields_hotel_room_services_cancelled = array('confirmed_itinerary_plan_hotel_room_service_details_ID', 'cancelled_itinerary_plan_hotel_room_details_ID', 'confirmed_itinerary_plan_hotel_room_details_ID',  'itinerary_plan_hotel_details_id', 'confirmed_itinerary_plan_hotel_details_id', 'group_type', 'itinerary_plan_id', 'itinerary_route_id', 'itinerary_route_date', 'hotel_id', 'room_type_id', 'room_id', 'room_service_type', 'room_service_count', 'service_cost_per_person', 'total_room_service_rate', 'createdby', 'status');

                // Array of service types and their details
                $service_types = [
                    1 => ['label' => 'EB', 'count' => $total_extra_bed, 'cost_per_person' => $extra_bed_cost_per_person, 'total_cost' => $extra_bed_charge],
                    2 => ['label' => 'CNB', 'count' => $total_child_without_bed, 'cost_per_person' => $cnb_per_person, 'total_cost' => $child_without_bed_charge],
                    3 => ['label' => 'CWB', 'count' => $total_child_with_bed, 'cost_per_person' => $cwb_per_person, 'total_cost' => $child_with_bed_charge],
                    4 => ['label' => 'BF', 'count' => $breakfast_required, 'cost_per_person' => $total_breafast_cost, 'total_cost' => $total_breafast_cost],
                    5 => ['label' => 'LUN', 'count' => $lunch_required, 'cost_per_person' => $total_lunch_cost, 'total_cost' => $total_lunch_cost],
                    6 => ['label' => 'DIN', 'count' => $dinner_required, 'cost_per_person' => $total_dinner_cost, 'total_cost' => $total_dinner_cost],
                ];

                // Loop through each service type
                foreach ($service_types as $type => $details) :
                    $count = $details['count'];
                    $cost_per_person = $details['cost_per_person'];
                    $total_cost = $details['total_cost'];
                    $label = $details['label'];

                    /* echo "Processing: $label, Count: $count, Cost Per Person: $cost_per_person, Total Cost: $total_cost<br>"; */

                    // Proceed if count is greater than 0
                    if ($count > 0) :
                        for ($i = 0; $i < $count; $i++) :
                            if ($cost_per_person > 0 && $total_cost > 0) :
                                $arrValues_hotel_room_services = [
                                    $confirmed_itinerary_plan_hotel_room_details_ID,
                                    $itinerary_plan_hotel_details_id,
                                    $confirmed_itinerary_plan_hotel_details_id,
                                    $group_type,
                                    $itinerary_plan_ID,
                                    $itinerary_route_id,
                                    $itinerary_route_date,
                                    $hotel_id,
                                    $choosen_room_type,
                                    $room_ID,
                                    $type, // room_service_type
                                    1, // room_service_count (each service as single unit)
                                    $cost_per_person, // service_cost_per_person
                                    $total_cost, // total_room_service_rate
                                    $logged_user_id,
                                    "1" // Status
                                ];

                                // Insert into database
                                if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $arrFields_hotel_room_services, $arrValues_hotel_room_services, '')) :
                                    $confirmed_itinerary_plan_hotel_room_service_details_ID = sqlINSERTID_LABEL();

                                    $arrValues_hotel_room_services_cancelled = [
                                        $confirmed_itinerary_plan_hotel_room_service_details_ID,
                                        $cancelled_itinerary_plan_hotel_room_details_ID,
                                        $confirmed_itinerary_plan_hotel_room_details_ID,
                                        $itinerary_plan_hotel_details_id,
                                        $confirmed_itinerary_plan_hotel_details_id,
                                        $group_type,
                                        $itinerary_plan_ID,
                                        $itinerary_route_id,
                                        $itinerary_route_date,
                                        $hotel_id,
                                        $choosen_room_type,
                                        $room_ID,
                                        $type, // room_service_type
                                        1, // room_service_count (each service as single unit)
                                        $cost_per_person, // service_cost_per_person
                                        $total_cost, // total_room_service_rate
                                        $logged_user_id,
                                        "1" // Status
                                    ];

                                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $arrFields_hotel_room_services_cancelled, $arrValues_hotel_room_services_cancelled, '')) :
                                    endif;
                                else :
                                /* echo "Failed to insert service type: $label<br>"; */
                                endif;
                            else :
                            /* echo "Skipping insertion for $label due to invalid cost values<br>"; */
                            endif;
                        endfor;
                    else :
                    /* echo "Skipping $label as count is zero<br>"; */
                    endif;
                endforeach;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT `hotel_breakfast_cost`, `hotel_breakfast_cost_gst_amount`, `hotel_lunch_cost`, `hotel_lunch_cost_gst_amount`, `hotel_dinner_cost`, `hotel_dinner_cost_gst_amount`, `total_no_of_persons`, `total_hotel_meal_plan_cost`, `total_hotel_meal_plan_cost_gst_amount`, `total_extra_bed_cost`, `total_extra_bed_cost_gst_amount`, `total_childwith_bed_cost`, `total_childwith_bed_cost_gst_amount`, `total_childwithout_bed_cost`, `total_childwithout_bed_cost_gst_amount`, `total_no_of_rooms`, `total_room_cost`, `total_room_gst_amount`, `total_hotel_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $hotel_breakfast_cost_existing = $fetch_itinerary_plan_hotel_details_data['hotel_breakfast_cost'];
                        $hotel_lunch_cost_existing = $fetch_itinerary_plan_hotel_details_data['hotel_lunch_cost'];
                        $hotel_dinner_cost_existing = $fetch_itinerary_plan_hotel_details_data['hotel_dinner_cost'];
                        $total_hotel_meal_plan_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_meal_plan_cost'];
                        $total_extra_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_extra_bed_cost'];
                        $total_childwith_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_childwith_bed_cost'];
                        $total_childwithout_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_childwithout_bed_cost'];
                        $total_no_of_rooms_existing = $fetch_itinerary_plan_hotel_details_data['total_no_of_rooms'];
                        $total_room_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_room_cost'];
                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];

                        $hotel_breakfast_cost_updated = $hotel_breakfast_cost_existing + $total_breafast_cost;
                        $hotel_lunch_cost_updated =  $hotel_lunch_cost_existing + $total_lunch_cost;
                        $hotel_dinner_cost_updated =  $hotel_dinner_cost_existing + $total_dinner_cost;
                        $total_hotel_meal_plan_cost_updated = $total_hotel_meal_plan_cost_existing + $total_breafast_cost + $total_lunch_cost + $total_dinner_cost;

                        $total_extra_bed_cost_updated = $total_extra_bed_cost_existing + $extra_bed_charge;
                        $total_childwithout_bed_cost_updated = $total_childwithout_bed_cost_existing + $child_without_bed_charge;
                        $total_childwith_bed_cost_updated = $total_childwith_bed_cost_existing + $child_with_bed_charge;
                        $total_no_of_rooms_updated = $total_no_of_rooms_existing + 1;

                        $total_room_cost_updated = $total_room_cost_existing + $new_room_amount;
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $new_room_amount;


                        $arrFields_hotel = array('`hotel_breakfast_cost`',  '`hotel_lunch_cost`',  '`hotel_dinner_cost`',  '`total_hotel_meal_plan_cost`',  '`total_extra_bed_cost`', '`total_childwith_bed_cost`',  '`total_childwithout_bed_cost`', '`total_no_of_rooms`', '`total_room_cost`', '`total_hotel_cost`');

                        $arrValues_hotel = array("$hotel_breakfast_cost_updated",  "$hotel_lunch_cost_updated",  "$hotel_dinner_cost_updated",  "$total_hotel_meal_plan_cost_updated",  "$total_extra_bed_cost_updated",  "$total_childwith_bed_cost_updated",  "$total_childwithout_bed_cost_updated",  "$total_no_of_rooms_updated", "$total_room_cost_updated", "$total_hotel_cost_updated");

                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                        endif;
                    endwhile;
                endif;

                //UPDATE CANCELLED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details1 = sqlQUERY_LABEL("SELECT `hotel_breakfast_cost`, `hotel_breakfast_cost_gst_amount`, `hotel_lunch_cost`, `hotel_lunch_cost_gst_amount`, `hotel_dinner_cost`, `hotel_dinner_cost_gst_amount`, `total_no_of_persons`, `total_hotel_meal_plan_cost`, `total_hotel_meal_plan_cost_gst_amount`, `total_extra_bed_cost`, `total_extra_bed_cost_gst_amount`, `total_childwith_bed_cost`, `total_childwith_bed_cost_gst_amount`, `total_childwithout_bed_cost`, `total_childwithout_bed_cost_gst_amount`, `total_no_of_rooms`, `total_room_cost`, `total_room_gst_amount`, `total_hotel_cost` FROM `dvi_cancelled_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details1) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data1 = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details1)) :

                        $hotel_breakfast_cost_existing = $fetch_itinerary_plan_hotel_details_data1['hotel_breakfast_cost'];
                        $hotel_lunch_cost_existing = $fetch_itinerary_plan_hotel_details_data1['hotel_lunch_cost'];
                        $hotel_dinner_cost_existing = $fetch_itinerary_plan_hotel_details_data1['hotel_dinner_cost'];
                        $total_hotel_meal_plan_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_hotel_meal_plan_cost'];
                        $total_extra_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_extra_bed_cost'];
                        $total_childwith_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_childwith_bed_cost'];
                        $total_childwithout_bed_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_childwithout_bed_cost'];
                        $total_no_of_rooms_existing = $fetch_itinerary_plan_hotel_details_data1['total_no_of_rooms'];
                        $total_room_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_room_cost'];
                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data1['total_hotel_cost'];

                        $hotel_breakfast_cost_updated = $hotel_breakfast_cost_existing + $total_breafast_cost;
                        $hotel_lunch_cost_updated =  $hotel_lunch_cost_existing + $total_lunch_cost;
                        $hotel_dinner_cost_updated =  $hotel_dinner_cost_existing + $total_dinner_cost;
                        $total_hotel_meal_plan_cost_updated = $total_hotel_meal_plan_cost_existing + $total_breafast_cost + $total_lunch_cost + $total_dinner_cost;

                        $total_extra_bed_cost_updated = $total_extra_bed_cost_existing + $extra_bed_charge;
                        $total_childwithout_bed_cost_updated = $total_childwithout_bed_cost_existing + $child_without_bed_charge;
                        $total_childwith_bed_cost_updated = $total_childwith_bed_cost_existing + $child_with_bed_charge;
                        $total_no_of_rooms_updated = $total_no_of_rooms_existing + 1;

                        $total_room_cost_updated = $total_room_cost_existing + $new_room_amount;
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $new_room_amount;


                        $arrFields_hotel_cancelled = array('`hotel_breakfast_cost`',  '`hotel_lunch_cost`',  '`hotel_dinner_cost`',  '`total_hotel_meal_plan_cost`',  '`total_extra_bed_cost`', '`total_childwith_bed_cost`',  '`total_childwithout_bed_cost`', '`total_no_of_rooms`', '`total_room_cost`', '`total_hotel_cost`');

                        $arrValues_hotel_cancelled = array("$hotel_breakfast_cost_updated",  "$hotel_lunch_cost_updated",  "$hotel_dinner_cost_updated",  "$total_hotel_meal_plan_cost_updated",  "$total_extra_bed_cost_updated",  "$total_childwith_bed_cost_updated",  "$total_childwithout_bed_cost_updated",  "$total_no_of_rooms_updated", "$total_room_cost_updated", "$total_hotel_cost_updated");

                        $sql_where_hotel_cancelled = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel_cancelled, $arrValues_hotel_cancelled, $sql_where_hotel_cancelled)) :
                        endif;

                    endwhile;
                endif;

                $response['i_result'] = true;

            endif;

        endif;
        echo json_encode($response);

    elseif ($_GET['type'] == 'add_new_hotel_with_room'):

        // ini_set('display_errors', 1);
        // ini_set('log_errors', 1);
        $response = [];
        $errors = [];

        $cancelled_hotel_id = $_POST['hid_cancelled_hotel_id'];
        $itinerary_plan_hotel_details_id = $_POST['hid_itinerary_plan_hotel_details_id'];
        $itinerary_plan_ID = $_POST['hid_itinerary_plan_id'];
        $itinerary_route_id = $_POST['hid_itinerary_route_id'];
        $hotel_id = $_POST['hotel_id'];
        $itinerary_route_date = $_POST['hid_itinerary_route_date'];
        $room_types = $_POST['room_type'];
        $room_quantities = $_POST['room_quantity'];

        if (empty($hotel_id)) {
            $errors['choosen_hotel_required'] = true;
        }
        if (empty($_POST['room_type'])) {
            $errors['choosen_room_type_required'] = true;
        }

        if (!empty($errors)) {
            $response['success'] = false;
            $response['errors'] = $errors;
        } else {

            $response['success'] = true;
            // Fetch hotel details
            $selected_hotel_query = sqlQUERY_LABEL("SELECT `hotel_category`, `hotel_margin`, `hotel_margin_gst_type`, `hotel_margin_gst_percentage` FROM `dvi_hotel` WHERE `hotel_id` = '$hotel_id'") or die("#STATELABEL-LABEL: getHOTEL_DETAIL: " . sqlERROR_LABEL());

            $fetch_hotel_data = sqlFETCHARRAY_LABEL($selected_hotel_query);
            $hotel_category_id = $fetch_hotel_data['hotel_category'];
            $hotel_margin_percentage = $fetch_hotel_data['hotel_margin'];
            $hotel_margin_gst_type = $fetch_hotel_data['hotel_margin_gst_type'];
            $hotel_margin_gst_percentage = $fetch_hotel_data['hotel_margin_gst_percentage'];
            $next_visiting_location = getITINEARYROUTE_DETAILS($itinerary_plan_ID, $itinerary_route_id, 'next_visiting_location');
            // Insert into hotel details table
            $arrFields_hotel = array('`group_type`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`itinerary_route_location`', '`hotel_required`', '`hotel_category_id`', '`hotel_id`', '`hotel_margin_percentage`', '`hotel_margin_gst_type`', '`hotel_margin_gst_percentage`', '`added_via_amendment`', '`createdby`', '`status`');

            $arrValues_hotel = array("1", "$itinerary_plan_ID", "$itinerary_route_id", "$itinerary_route_date", "$next_visiting_location", "1", "$hotel_category_id", "$hotel_id", "$hotel_margin_percentage", "$hotel_margin_gst_type", "$hotel_margin_gst_percentage", "1", "$logged_user_id", "1");

            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, '')) {
                // Insert rooms data
                $confirmed_itinerary_plan_hotel_details_ID = sqlINSERTID_LABEL();

                // $arrFields_itinerary_plan_hotel_details = array('`confirmed_itinerary_plan_hotel_details_ID`');
                // $arrValues_itinerary_plan_hotel_details = array("$confirmed_itinerary_plan_hotel_details_ID");

                // $arrFields_added_hotel = array_merge($arrFields_hotel, $arrFields_itinerary_plan_hotel_details);
                // $arrValues_added_hotel = array_merge($arrValues_hotel, $arrValues_itinerary_plan_hotel_details);

                // sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_added_hotel, $arrValues_added_hotel, '');
                $overall_room_cost = 0;
                $total_hotel_cost = 0;
                $total_room_gst_amount = 0;
                $total_hotel_tax_amount = 0;
                $total_no_of_rooms = 0;

                if (isset($_POST['room_type']) && isset($_POST['room_quantity'])) {
                    $room_types = $_POST['room_type'];
                    $room_quantities = $_POST['room_quantity'];

                    foreach ($room_types as $index => $room_type):
                        $room_id = explode('_', $room_type)[0];
                        $room_type_id = explode('_', $room_type)[1];
                        $room_qty = $room_quantities[$index];
                        $total_no_of_rooms += $room_qty; // Add to total count
                        for ($i = 0; $i < $room_qty; $i++): // Insert a row for each quantity

                            //FETCH ROOM DETAILS FOR THE SELECTED ROOM TYPE
                            $select_hotel_room_data = sqlQUERY_LABEL("SELECT HOTEL.`hotel_category`, HOTEL.`hotel_margin`, HOTEL.`hotel_margin_gst_type`, HOTEL.`hotel_margin_gst_percentage`, HOTEL_ROOM.`room_ID`, HOTEL_ROOM.`gst_type`, HOTEL_ROOM.`gst_percentage` FROM `dvi_hotel_rooms` HOTEL_ROOM LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = HOTEL_ROOM.`hotel_id`  WHERE HOTEL_ROOM.`deleted` = '0' AND HOTEL_ROOM.`room_type_id` = '$room_type_id'AND HOTEL_ROOM.`room_ID` = '$room_id' AND HOTEL_ROOM.`hotel_id` = '$hotel_id' LIMIT 1") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                            while ($fetch_hotel_room_data = sqlFETCHARRAY_LABEL($select_hotel_room_data)) :
                                $gst_type = $fetch_hotel_room_data['gst_type'];
                                $gst_percentage = $fetch_hotel_room_data['gst_percentage'];
                            endwhile;

                            $pricebook_year = date('Y', strtotime($itinerary_route_date));
                            $pricebook_month = date('F', strtotime($itinerary_route_date));
                            $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));

                            $price_per_night = getROOM_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_id, $pricebook_year, $pricebook_month, $formatted_day, $room_type_id, 'room_rate_for_the_day');

                            $total_room_cost = ($price_per_night * $room_qty);

                            if ($gst_type == 1) :
                                // For Inclusive GST
                                $new_room_tax_amt = ($total_room_cost * $gst_percentage / 100);
                                $new_room_amount = ($total_room_cost - $new_room_tax_amt);
                                $overall_room_cost += $new_room_amount;
                                $total_hotel_cost += $new_room_amount;
                                $total_room_gst_amount += $new_room_tax_amt;
                                $total_hotel_tax_amount += $new_room_tax_amt;

                            elseif ($gst_type == 2) :
                                // For Exclusive GST
                                $new_room_tax_amt = ($total_room_cost * $gst_percentage / 100);
                                $new_room_amount = $total_room_cost;
                                $overall_room_cost += $new_room_amount;
                                $total_hotel_cost += $new_room_amount;
                                $total_room_gst_amount += $new_room_tax_amt;
                                $total_hotel_tax_amount += $new_room_tax_amt;

                            endif;

                            $hotel_room_arrFields = array('`group_type`', '`itinerary_plan_id`', '`confirmed_itinerary_plan_hotel_details_ID`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_qty`', '`room_rate`', '`gst_type`', '`gst_percentage`', '`total_room_cost`', '`total_room_gst_amount`', '`added_via_amendment`', '`createdby`', '`status`');

                            $hotel_room_arrValues = array("1", "$itinerary_plan_ID", "$confirmed_itinerary_plan_hotel_details_ID", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$room_type_id", "$room_id", "$room_qty", "$price_per_night", "$gst_type", "$gst_percentage", "$new_room_amount", "$new_room_tax_amt", "1", "$logged_user_id", "1");

                            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, '')):
                                $confirmed_itinerary_plan_hotel_room_details_ID = sqlINSERTID_LABEL();

                                $arrFields_hotel_room_details = array('`confirmed_itinerary_plan_hotel_room_details_ID`', '`confirmed_itinerary_plan_hotel_details_ID`', '`group_type`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`room_type_id`', '`room_id`', '`room_qty`', '`room_rate`', '`gst_type`', '`gst_percentage`', '`total_room_cost`', '`total_room_gst_amount`', '`added_via_amendment`', '`createdby`', '`status`');

                                $arrValues_hotel_room_details = array("$confirmed_itinerary_plan_hotel_room_details_ID", "$confirmed_itinerary_plan_hotel_details_ID", "1", "$itinerary_plan_ID", "$itinerary_route_id", "$itinerary_route_date", "$hotel_id", "$room_type_id", "$room_id", "$room_qty", "$price_per_night", "$gst_type", "$gst_percentage", "$new_room_amount", "$new_room_tax_amt", "1", "$logged_user_id", "1");

                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_details", $arrFields_hotel_room_details, $arrValues_hotel_room_details, '')):
                                endif;
                            endif;
                        endfor;
                    endforeach;
                }

                $arrFields_hotel_details = array('`total_no_of_rooms`','`total_room_cost`', '`total_hotel_cost`', '`total_room_gst_amount`', '`total_hotel_tax_amount`');
                $arrValues_hotel_details = array("$total_no_of_rooms","$overall_room_cost", "$total_hotel_cost", "$total_room_gst_amount", "$total_hotel_tax_amount");
                $sqlwhere_hotel_details = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel_details, $arrValues_hotel_details, $sqlwhere_hotel_details)):
                    // sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel_details, $arrValues_hotel_details, $sqlwhere_hotel_details);
                    $arrFields_hotel = array('`group_type`', '`confirmed_itinerary_plan_hotel_details_ID`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`itinerary_route_location`', '`hotel_required`', '`hotel_category_id`', '`hotel_id`', '`hotel_margin_percentage`', '`hotel_margin_gst_type`', '`hotel_margin_gst_percentage`', '`added_via_amendment`', '`createdby`', '`status`');

                    $arrValues_hotel = array("1", "$confirmed_itinerary_plan_hotel_details_ID", "$itinerary_plan_ID", "$itinerary_route_id", "$itinerary_route_date", "$next_visiting_location", "1", "$hotel_category_id", "$hotel_id", "$hotel_margin_percentage", "$hotel_margin_gst_type", "$hotel_margin_gst_percentage", "1", "$logged_user_id", "1");
                    $arrFields_hotel = array_merge($arrFields_hotel, $arrFields_hotel_details);
                    $arrValues_hotel = array_merge($arrValues_hotel, $arrValues_hotel_details);
                    sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, '');
                endif;

                // Assign values to global variables
                $_SESSION['global_confirmed_itinerary_plan_hotel_details_ID'] = $confirmed_itinerary_plan_hotel_details_ID;
                $_SESSION['global_itinerary_plan_ID'] = $itinerary_plan_ID;
                $_SESSION['global_itinerary_route_id'] = $itinerary_route_id;
                $_SESSION['global_itinerary_route_date'] = $itinerary_route_date;
                $_SESSION['global_hotel_category_id'] = $hotel_category_id;
                $_SESSION['global_hotel_id'] = $hotel_id;
                $_SESSION['global_room_types'] = $room_types;
                $_SESSION['global_room_quantities'] = $room_quantities;

                // Include the email notification script
                include('ajax_itinerary_hotel_amendment_email_notification.php');

                // Unset the global variables
                unset($_SESSION['global_confirmed_itinerary_plan_hotel_details_ID']);
                unset($_SESSION['global_itinerary_plan_ID']);
                unset($_SESSION['global_itinerary_route_id']);
                unset($_SESSION['global_itinerary_route_date']);
                unset($_SESSION['global_hotel_category_id']);
                unset($_SESSION['global_hotel_id']);
                unset($_SESSION['global_room_types']);
                unset($_SESSION['global_room_quantities']);

                $response['i_result'] = true;

                 //if itinerary is already being cancelled and we add a new Hotel to the same, then we need to revert the cancellation status
                $select_itineary_details = sqlQUERY_LABEL("SELECT `itinerary_plan_ID` FROM `dvi_confirmed_itinerary_plan_details`  WHERE `itinerary_plan_ID` = '$itinerary_plan_ID' AND  `itinerary_cancellation_status` = '1' AND  `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
                $itinerary_count = sqlNUMOFROW_LABEL($select_itineary_details);
                if ($itinerary_count > 0) :
                    $confirmed_arrFields = array('`itinerary_cancellation_status`');
                    $confirmed_arrValues = array("0");
                    $confirmed_sqlWhere = " `itinerary_plan_ID` = '$itinerary_plan_ID' ";
                    if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_details", $confirmed_arrFields, $confirmed_arrValues, $confirmed_sqlWhere)) :
                        $cancelled_arrFields = array('`itinerary_cancellation_status`');
                        $cancelled_arrValues = array("0");
                        $cancelled_sqlWhere = " `itinerary_plan_id` = '$itinerary_plan_ID' ";
                        if (sqlACTIONS("UPDATE", "dvi_cancelled_itineraries", $cancelled_arrFields, $cancelled_arrValues, $cancelled_sqlWhere)) :
                        endif;
                    endif;
                endif;
            }
        }
        echo json_encode($response);
    elseif ($_GET['type'] == 'show_add_new_room_service_form'):

        $itinerary_route_date = $_GET['itinerary_route_date'];
        $confirmed_itinerary_plan_hotel_room_details_ID = $_GET['confirmed_itinerary_plan_hotel_room_details_ID'];
        $confirmed_itinerary_plan_hotel_details_id = $_GET['itinerary_plan_hotel_details_id'];
        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $hotel_id = $_GET['hotel_id'];
        $room_id = $_GET['room_id'];
        $room_title = getROOM_DETAILS($room_id, 'room_title');

        $select_no_of_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_rooms_confirmed = sqlNUMOFROW_LABEL($select_no_of_confirmed_itinerary_room_details);

        $select_no_of_remaining_non_cancelled_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `room_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        $total_no_of_non_cancelled_rooms_count = sqlNUMOFROW_LABEL($select_no_of_remaining_non_cancelled_room_details);

        $select_confirmed_itinerary_room_details = sqlQUERY_LABEL("SELECT HOTEL.`hotel_name`, ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_plan_hotel_details_ID`,ITINEARY_PLAN_HOTEL_DETAILS.`itinerary_route_location`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_cost`, ITINEARY_HOTEL_ROOM_DETAILS.`total_room_gst_amount`, ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_date`,ITINEARY_HOTEL_ROOM_DETAILS.`room_type_id` FROM `dvi_confirmed_itinerary_plan_hotel_room_details` ITINEARY_HOTEL_ROOM_DETAILS LEFT JOIN `dvi_hotel` HOTEL ON HOTEL.`hotel_id` = ITINEARY_HOTEL_ROOM_DETAILS.`hotel_id` LEFT JOIN `dvi_confirmed_itinerary_plan_hotel_details` ITINEARY_PLAN_HOTEL_DETAILS ON ITINEARY_PLAN_HOTEL_DETAILS.`confirmed_itinerary_plan_hotel_details_ID` = ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` WHERE ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' AND ITINEARY_HOTEL_ROOM_DETAILS.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_HOTEL_ROOM_DETAILS.`itinerary_route_id` = '$itinerary_route_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_ROOM_COST_DETAILS_LIST:" . sqlERROR_LABEL());
        while ($fetch_confirmed_itinerary_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_room_details)) :
            $hotel_name = $fetch_confirmed_itinerary_data['hotel_name'];
            $itinerary_plan_hotel_details_id = $fetch_confirmed_itinerary_data['itinerary_plan_hotel_details_ID'];
            $itinerary_route_location = $fetch_confirmed_itinerary_data['itinerary_route_location'];
            $total_room_cost = $fetch_confirmed_itinerary_data['total_room_cost'];
            $total_room_gst_amount = $fetch_confirmed_itinerary_data['total_room_gst_amount'];
            $choosen_room_type  = $fetch_confirmed_itinerary_data['room_type_id'];
        endwhile;

        $pricebook_year = date('Y', strtotime($itinerary_route_date));
        $pricebook_month = date('F', strtotime($itinerary_route_date));
        $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));
        $itinerary_person_count=get_ITINEARY_CONFIRMED_PLAN_DETAILS($itinerary_plan_id,'total_person_count');
        $hotel_breafast_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '1');
        $hotel_lunch_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '2');
        $hotel_dinner_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '3');

        $overall_breakfast_cost=$itinerary_person_count*$hotel_breafast_cost;
        $overall_lunch_cost=$itinerary_person_count*$hotel_lunch_cost;
        $overall_dinner_cost=$itinerary_person_count*$hotel_dinner_cost;

        $total_room_rate = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_id, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '0');
        $extra_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_id, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '1');
        $child_with_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_id, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '2');
        $child_without_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_id, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '3');

    ?>

        <div class="modal-body">
            <!-- Modal Heading -->
            <div class="text-center mb-4">
                <h5 class="mt-4 mb-3 text-primary">
                    <strong>Add New Room Service</strong>
                </h5>
            </div>

            <!-- Hotel Information -->
            <div class="row mb-3">
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Hotel :</strong>
                    <span><?= htmlspecialchars($hotel_name); ?> </span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Date:</strong>
                    <span><?= date('D, M d, Y', strtotime($itinerary_route_date)); ?></span>
                </div>
                <div class="col-12 mb-2 d-flex justify-content-between">
                    <strong>Location:</strong>
                    <span><?= htmlspecialchars($itinerary_route_location); ?></span>
                </div>
            </div>

            <hr class="my-3">

            <form id="ajax_add_new_room_service_form" action="" data-parsley-validate method="post">
                <input type="hidden" name="hid_itinerary_plan_hotel_details_id" value="<?= $itinerary_plan_hotel_details_id ?>">
                <input type="hidden" name="hid_confirmed_itinerary_plan_hotel_details_id" value="<?= $confirmed_itinerary_plan_hotel_details_id ?>">
                <input type="hidden" name="hid_itinerary_plan_id" value="<?= $itinerary_plan_id ?>">
                <input type="hidden" name="hid_itinerary_route_id" value="<?= $itinerary_route_id ?>">
                <input type="hidden" name="hid_hotel_id" value="<?= $hotel_id ?>">
                <input type="hidden" name="hid_itinerary_route_date" value="<?= $itinerary_route_date ?>">
                <input type="hidden" name="hid_room_type_id" value="<?= $choosen_room_type ?>">
                <input type="hidden" name="hid_room_id" value="<?= $room_id ?>">
                <input type="hidden" name="hid_confirmed_itinerary_plan_hotel_room_details_ID" value="<?= $confirmed_itinerary_plan_hotel_room_details_ID ?>">

                <!-- Room Cost and Added Services -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6>Existing Room Services</h6>
                        <ul class="list-group rounded-lg border-0"> <!-- shadow-sm -->
                            <!-- Room Cost -->
                            <li class="list-group-item d-flex justify-content-between align-items-center p-3 text-dark list-group-item-light border rounded-top">
                                <span class="fw-semibold">Room Cost:</span>
                                <span class="btn btn-xs rounded-pill btn-label-success waves-effect">
                                    <?= general_currency_symbol . ' ' . number_format($total_room_cost + $total_room_gst_amount, 2); ?>
                                </span>
                            </li>

                            <!-- Added Services -->
                            <li class="list-group-item p-3 bg-white rounded-bottom">
                                <?php
                                // Fetch hotel room services details
                                $query = "SELECT `room_service_type`, `total_room_service_rate` FROM `dvi_confirmed_itinerary_plan_hotel_room_service_details` WHERE `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `hotel_id` = '$hotel_id' AND `service_cancellation_status` = '0' AND `status` = '1' AND `deleted` = '0'";
                                $result = sqlQUERY_LABEL($query) or die("#1-UNABLE_TO_FETCH_HOTEL_ROOM_SERVICES:" . sqlERROR_LABEL());
                                $total_services = sqlNUMOFROW_LABEL($result);
                                // Display hotel services if available
                                if ($total_services > 0):
                                    $room_service_types = [
                                        1 => 'Extra Bed',
                                        2 => 'Child Without Bed',
                                        3 => 'Child With Bed',
                                        4 => 'Breakfast',
                                        5 => 'Lunch',
                                        6 => 'Dinner'
                                    ];
                                ?>
                                    <ul class="list-group">
                                        <?php
                                        $overall_room_service_rate = 0; // Initialize the total for room services
                                        while ($service = sqlFETCHARRAY_LABEL($result)) :
                                            $room_service_type = $service['room_service_type'];
                                            $total_room_service_rate = $service['total_room_service_rate'];
                                            $room_service_label = $room_service_types[$room_service_type] ?? 'Unknown Service';
                                            $applied_room_services[] = $service['room_service_type'];

                                            // Display the service with an icon and rate
                                            echo '
                                                <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 border-0">
                                                    <div class="d-flex align-items-center">
                                                        <i class="bi bi-check-circle text-success me-2"></i>
                                                        <span>' . htmlspecialchars($room_service_label) . '</span>
                                                    </div>
                                                    <span class="btn btn-xs rounded-pill btn-label-success waves-effect">
                                                        ' . general_currency_symbol . ' ' . number_format($total_room_service_rate, 2) . '
                                                    </span>
                                                </li>';
                                            $overall_room_service_rate += $total_room_service_rate;
                                        endwhile;
                                        ?>
                                    </ul>

                                <?php else: ?>
                                    <div class="text-center text-muted mt-3">
                                        <i class="bi bi-emoji-frown"></i> No added services.
                                    </div>
                                <?php endif; ?>

                            </li>
                        </ul>

                    </div>
                </div>

                <!-- New Room Service Details -->
                <div class="row mb-3">
                    <div id="room_details" class="col-12 mb-2">
                        <h6>Add New Services</h6>
                        <div class="d-flex flex-column">
                            <br>
                            <?php if (($applied_room_services === null || !in_array(1, $applied_room_services)) && ($extra_bed_charge>0)): ?>
                                <div class="d-flex align-items-center mb-2" id="row_extra_bed">
                                    <input type="checkbox" id="add_extra_bed" name="add_extra_bed" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_extra_bed">
                                        <span>Extra Bed</span>
                                        <span><strong><?= general_currency_symbol . ' ' . number_format($extra_bed_charge, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>
                            <?php if (($applied_room_services === null || !in_array(2, $applied_room_services)) && ($child_without_bed_charge>0)): ?>
                                <div class="d-flex align-items-center mb-2" id="row_child_without_bed">
                                    <input type="checkbox" id="add_child_without_bed" name="add_child_without_bed" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_child_without_bed">
                                        <span>Child Without Bed</span>
                                        <span><strong><?= general_currency_symbol . ' ' . number_format($child_without_bed_charge, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>
                            <?php if (($applied_room_services === null || !in_array(3, $applied_room_services))): ?>
                                <div class="d-flex align-items-center mb-2" id="row_child_with_bed">
                                    <input type="checkbox" id="add_child_with_bed" name="add_child_with_bed" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_child_with_bed">
                                        <span>Child With Bed</span>
                                        <span><strong><?= general_currency_symbol . ' ' . number_format($child_with_bed_charge, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>
                            <?php if ($applied_room_services === null || !in_array(4, $applied_room_services)): ?>
                                <div class="d-flex align-items-center mb-2">
                                    <input type="checkbox" id="add_breakfast" name="add_breakfast" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_breakfast">
                                        <span>Breakfast(<?=$itinerary_person_count?>*<?=$hotel_breafast_cost?>)</span>
                                        <span><strong><?= general_currency_symbol . ' ' . number_format($overall_breakfast_cost, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>
                            <?php if ($applied_room_services === null || !in_array(5, $applied_room_services)): ?>
                                <div class="d-flex align-items-center mb-2">
                                    <input type="checkbox" id="add_lunch" name="add_lunch" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_lunch">
                                        <span>Lunch(<?=$itinerary_person_count?>*<?=$hotel_lunch_cost?>)</span>
                                        <span><strong><?= general_currency_symbol . ' ' . number_format($overall_lunch_cost, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>
                            <?php if ($applied_room_services === null || !in_array(6, $applied_room_services)): ?>
                                <div class="d-flex align-items-center mb-2">
                                    <input type="checkbox" id="add_dinner" name="add_dinner" class="form-check-input me-2 room_service" value="1">
                                    <label class="form-label w-100 d-flex justify-content-between" for="add_dinner">
                                        <span>Dinner(<?=$itinerary_person_count?>*<?=$hotel_dinner_cost?>)</span>
                                        <span id="dinner_price"><strong><?= general_currency_symbol . ' ' . number_format($overall_dinner_cost, 2); ?></strong></span>
                                    </label>
                                </div>
                            <?php endif; ?>

                        </div>
                        <div id="error_container"></div>
                    </div>


                    <hr class="my-3">

                    <div class="col-12 mb-2 d-flex justify-content-between">
                        <strong>Total Cost:</strong>
                        <div id="total_room_charge"><strong><?= general_currency_symbol . ' ' . number_format(0, 2); ?></strong></div>

                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row text-center mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button id="room_service_form_submit_btn" type="submit" class="btn btn-success">Confirm </button>
                    </div>
                </div>
            </form>
        </div>
        <script src="assets/js/parsley.min.js"></script>
        <script>
            $(document).ready(function() {
                applyCheckboxRestrictions();
                $(document).on('change', '.room_service', function() {
                    let total_room_service = 0; // Initialize total

                    $('.room_service:checked').each(function() {
                        let amount = parseFloat($(this).siblings('label').find('strong').text().replace(/[^\d.]/g, ''));
                        total_room_service += amount;
                    });

                    //let room_amount = parseFloat($('#total_room_rate').text().replace(/[^\d.]/g, ''));
                    //total = total_room_service + room_amount;

                    const formattedtotalroomrate = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: '<?= $general_currency_symbol; ?>',
                    }).format(total_room_service);

                    const formattedtotalroomrateWithSpace = formattedtotalroomrate.replace(/(\D+)(\d)/, '$1 $2');
                    document.getElementById('total_room_charge').innerText = formattedtotalroomrateWithSpace;
                });

                $('#ajax_add_new_room_service_form').on('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission
                    const isAnyCheckboxChecked = $('.room_service').is(':checked');

                    if (!isAnyCheckboxChecked) {
                        $('#error_container').html('<span id="validation_message" class="text-danger">Please select at least one option to proceed.</span>');
                        return;
                    } else {

                        var form = $('#ajax_add_new_room_service_form')[0];
                        var formData = new FormData(form);
                        //$(this).find("button[id='room_service_form_submit_btn']").prop('disabled', true);
                        //let formData = $(this).serialize();
                        $.ajax({
                            url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_new_hotel_room_service',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            cache: false,
                            timeout: 80000,
                            dataType: 'json',
                            encode: true,
                        }).done(function(response) {
                            if (!response.success) {
                                if (response.errors.room_service_required) {
                                    TOAST_NOTIFICATION('warning', 'Select Atleast one Room Service', 'Warning !!!');
                                }
                            } else {
                                if (response.i_result == true) {
                                    //SUCCESS
                                    TOAST_NOTIFICATION('success', 'New Room Service Added Successfully', 'Success !!!');
                                    $("#showADDNEWROOMSERVICEFORMDATA").modal('hide'); // For Bootstrap
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);
                                } else if (response.i_result == false) {
                                    TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                                } else {
                                    TOAST_NOTIFICATION('error', 'Unable to Proceed. Something went Wrong !!!', 'Error !!!');
                                }
                            }
                            if (response == "OK") {
                                return true;
                            } else {
                                return false;
                            }
                        });

                    }

                });

            });

            function applyCheckboxRestrictions() {
                const ebCheckbox = document.getElementById('add_extra_bed');
                const cwbCheckbox = document.getElementById('add_child_with_bed');
                const cwobCheckbox = document.getElementById('add_child_without_bed');

                const ebRow = document.getElementById('row_extra_bed');
                const cwbRow = document.getElementById('row_child_with_bed');
                const cwobRow = document.getElementById('row_child_without_bed');

                const checkboxes = [ebCheckbox, cwbCheckbox, cwobCheckbox];
                const rows = [ebRow, cwbRow, cwobRow];
                const labels = ['Extra Bed', 'Child With Bed', 'Child Without Bed'];

                function updateRestrictions() {
                    console.log('--- updateRestrictions() triggered ---');

                    const checked = checkboxes
                        .map((cb, index) => ({ cb, index }))
                        .filter(obj => obj.cb && obj.cb.checked);

                    console.log('Checked items:', checked.map(c => labels[c.index]));

                    // Check if all three checkboxes are present
                    const allCheckboxesPresent = checkboxes.every(cb => cb !== null);
                    
                    if (allCheckboxesPresent && checked.length >= 2) {
                        // If two or more options are checked, hide the others
                        checkboxes.forEach((cb, i) => {
                            if (cb && !cb.checked) {
                                console.log(`Hiding unchecked option: ${labels[i]}`);
                                if (rows[i]) {
                                    rows[i].classList.add('d-none');
                                }
                                cb.checked = false; // Just to be sure
                            }
                        });
                    } else {
                        // If less than two checkboxes are selected, show everything
                        rows.forEach((row, i) => {
                            if (row) {
                                console.log(`Unhiding option: ${labels[i]}`);
                                row.classList.remove('d-none');
                            }
                        });
                    }

                    console.log('--- End of updateRestrictions ---');
                }

                checkboxes.forEach((cb, i) => {
                    if (cb) {
                        console.log(`Binding change event to: ${labels[i]}`);
                        cb.addEventListener('change', updateRestrictions);
                    } else {
                        console.warn(`Checkbox not found: ${labels[i]}`);
                    }
                });

                // Initial run to set up the restriction state
                updateRestrictions();
            }

        </script>
    <?php
    elseif ($_GET['type'] == 'add_new_hotel_room_service'):
        $response = [];
        $errors = [];

        $itinerary_plan_ID = $_POST['hid_itinerary_plan_id'];
        $itinerary_route_id = $_POST['hid_itinerary_route_id'];
        $confirmed_itinerary_plan_hotel_details_id = $_POST['hid_confirmed_itinerary_plan_hotel_details_id'];
        $itinerary_plan_hotel_details_id = $_POST['hid_itinerary_plan_hotel_details_id'];
        $hotel_id = $_POST['hid_hotel_id'];
        $itinerary_route_date = $_POST['hid_itinerary_route_date'];
        $choosen_room_type = $_POST['hid_room_type_id'];
        $room_ID = $_POST['hid_room_id'];
        $confirmed_itinerary_plan_hotel_room_details_ID = $_POST['hid_confirmed_itinerary_plan_hotel_room_details_ID'];

        $total_extra_bed =  ($_POST['add_extra_bed']) ? 1 : 0;
        $total_child_without_bed = $_POST['add_child_without_bed'] ? 1 : 0;
        $total_child_with_bed = $_POST['add_child_with_bed'] ? 1 : 0;

        $breakfast_meal_plan = ($_POST['add_breakfast']) ? 1 : 0;
        $lunch_meal_plan = ($_POST['add_lunch']) ? 1 : 0;
        $dinner_meal_plan = ($_POST['add_dinner']) ? 1 : 0;


        if (($_POST['add_extra_bed'] == 0) && ($_POST['add_child_without_bed'] == 0) && ($_POST['add_child_with_bed'] == 0) && ($_POST['add_breakfast'] == 0) && ($_POST['add_lunch'] == 0) && ($_POST['add_dinner'] == 0)) :
            $errors['room_service_required'] = true;
        endif;

        if (!empty($errors)) : // If there are validation errors
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;

            $select_confirmed_itinerary_plan_hotel_room_details = sqlQUERY_LABEL("SELECT `itinerary_plan_hotel_room_details_ID`,`group_type`, `gst_type`, `gst_percentage`  FROM  `dvi_confirmed_itinerary_plan_hotel_room_details` WHERE `deleted` = '0' AND `hotel_id` = '$hotel_id' AND `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            while ($fetch_confirmed_itinerary_hotel_room_data = sqlFETCHARRAY_LABEL($select_confirmed_itinerary_plan_hotel_room_details)) :
                $itinerary_plan_hotel_room_details_ID = $fetch_confirmed_itinerary_hotel_room_data['itinerary_plan_hotel_room_details_ID'];
                $group_type = $fetch_confirmed_itinerary_hotel_room_data['group_type'];
                $gst_type = $fetch_confirmed_itinerary_hotel_room_data['gst_type'];
                $gst_percentage = $fetch_confirmed_itinerary_hotel_room_data['gst_percentage'];
            endwhile;

            $select_cancelled_itinerary_plan_hotel_room_details = sqlQUERY_LABEL("SELECT `cancelled_itinerary_plan_hotel_room_details_ID` FROM  `dvi_cancelled_itinerary_plan_hotel_room_details` WHERE `deleted` = '0' AND `hotel_id` = '$hotel_id' AND `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ") or die("#3-UNABLE_TO_COLLECT_DETAILS:" . sqlERROR_LABEL());
            while ($fetch_cancelled_itinerary_hotel_room_data = sqlFETCHARRAY_LABEL($select_cancelled_itinerary_plan_hotel_room_details)) :
                $cancelled_itinerary_plan_hotel_room_details_ID = $fetch_cancelled_itinerary_hotel_room_data['cancelled_itinerary_plan_hotel_room_details_ID'];
            endwhile;

            $pricebook_year = date('Y', strtotime($itinerary_route_date));
            $pricebook_month = date('F', strtotime($itinerary_route_date));
            $formatted_day = 'day_' . date('j', strtotime($itinerary_route_date));

            $hotel_breafast_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '1');
            $hotel_lunch_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '2');
            $hotel_dinner_cost = getHOTELMEAL_PRICEBOOK_DETAILS($hotel_id, $pricebook_year, $pricebook_month, $formatted_day, 'meal_rate_for_the_day', '3');

            $extra_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '1');
            $child_with_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '2');
            $child_without_bed_charge = getROOMBED_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $choosen_room_type, $pricebook_year, $pricebook_month, $formatted_day, 'room_bed_rate_for_the_day', '3');

            $price_per_night = getROOM_PRICEBOOK_DETAILS_WITH_ROOMTYPE($hotel_id, $room_ID, $pricebook_year, $pricebook_month, $formatted_day, $choosen_room_type, 'room_rate_for_the_day');

            $food_required_count = get_ITINERARY_PLAN_DETAILS($itinerary_plan_ID, 'total_adult_n_children_count');
            $preferred_room_count = get_ITINERARY_PLAN_DETAILS($itinerary_plan_ID, 'preferred_room_count');
            if ($preferred_room_count > 1) {
                $food_required_count = ($food_required_count / $preferred_room_count);
            } else {
                $food_required_count = $food_required_count;
            }
            $room_qty = 1;

            if ($total_extra_bed > 0) :
                $extra_bed_charge = $extra_bed_charge * $total_extra_bed;

                $hotel_room_arrFields = array('`extra_bed_count`', '`extra_bed_rate`');
                $hotel_room_arrValues = array("$total_extra_bed", "$extra_bed_charge");
                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $extra_bed_charge;

                        $arrFields_hotel = array('`total_extra_bed_cost`',  '`total_hotel_cost`');

                        $arrValues_hotel = array("$extra_bed_charge",  "$total_hotel_cost_updated");

                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $extra_bed_charge = 0;
            endif;

            if ($total_child_without_bed > 0) :
                $child_without_bed_charge = $child_without_bed_charge * $total_child_without_bed;

                $hotel_room_arrFields = array('`child_without_bed_count`', '`child_without_bed_charges`');
                $hotel_room_arrValues = array("$total_child_without_bed", "$child_without_bed_charge");
                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $child_without_bed_charge;

                        $arrFields_hotel = array('`total_childwithout_bed_cost`',  '`total_hotel_cost`');
                        $arrValues_hotel = array("$child_without_bed_charge",  "$total_hotel_cost_updated");
                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $child_without_bed_charge = 0;
            endif;

            if ($total_child_with_bed > 0) :
                $child_with_bed_charge = $child_with_bed_charge * $total_child_with_bed;
                $hotel_room_arrFields = array('`child_with_bed_count`', '`child_with_bed_charges`');
                $hotel_room_arrValues = array("$total_child_with_bed", "$child_with_bed_charge");
                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $child_with_bed_charge;

                        $arrFields_hotel = array('`total_childwith_bed_cost`',  '`total_hotel_cost`');
                        $arrValues_hotel = array("$child_without_bed_charge",  "$total_hotel_cost_updated");
                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $child_with_bed_charge = 0;
            endif;

            //MEAL COST CALCULATION
            if ($breakfast_meal_plan > 0) :
                $total_breafast_cost = ($breakfast_meal_plan) ? (($food_required_count * $hotel_breafast_cost) * $room_qty) : 0;

                $hotel_room_arrFields = array('`breakfast_required`', '`total_breafast_cost`',  '`breakfast_cost_per_person`');
                $hotel_room_arrValues = array("$breakfast_meal_plan", "$total_breafast_cost", "$hotel_breafast_cost");

               /*  print_r($hotel_room_arrFields);
                print_r($hotel_room_arrValues); */

                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost`,`total_hotel_meal_plan_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_meal_plan_cost_existing =  $fetch_itinerary_plan_hotel_details_data['total_hotel_meal_plan_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $total_breafast_cost;
                        $total_hotel_meal_plan_cost_updated = $total_hotel_meal_plan_cost_existing + $total_breafast_cost;

                        $arrFields_hotel = array('`hotel_breakfast_cost`',  '`total_hotel_meal_plan_cost`', '`total_hotel_cost`');
                        $arrValues_hotel = array("$total_breafast_cost", "$total_hotel_meal_plan_cost_updated", "$total_hotel_cost_updated");
                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $total_breafast_cost = 0;
            endif;

            if ($lunch_meal_plan > 0) :
                $total_lunch_cost = ($lunch_meal_plan) ? (($food_required_count * $hotel_lunch_cost) * $room_qty) : 0;

                $hotel_room_arrFields = array('`lunch_required`',  '`total_lunch_cost`',  '`lunch_cost_per_person`');
                $hotel_room_arrValues = array("$lunch_meal_plan",  "$total_lunch_cost", "$hotel_lunch_cost");
                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost`,`total_hotel_meal_plan_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_meal_plan_cost_existing =  $fetch_itinerary_plan_hotel_details_data['total_hotel_meal_plan_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $total_lunch_cost;
                        $total_hotel_meal_plan_cost_updated = $total_hotel_meal_plan_cost_existing + $total_lunch_cost;

                        $arrFields_hotel = array('`hotel_lunch_cost`',  '`total_hotel_meal_plan_cost`', '`total_hotel_cost`');
                        $arrValues_hotel = array("$total_lunch_cost", "$total_hotel_meal_plan_cost_updated", "$total_hotel_cost_updated");
                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $total_lunch_cost = 0;
            endif;

            if ($dinner_meal_plan > 0) :
                $total_dinner_cost = ($dinner_meal_plan) ? (($food_required_count * $hotel_dinner_cost) * $room_qty) : 0;

                $hotel_room_arrFields = array('`dinner_required`', '`total_dinner_cost`', '`dinner_cost_per_person`');
                $hotel_room_arrValues = array("$dinner_meal_plan",  "$total_dinner_cost",  "$hotel_dinner_cost");
                $hotel_room_where = " `confirmed_itinerary_plan_hotel_room_details_ID` = '$confirmed_itinerary_plan_hotel_room_details_ID' ";

                if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    //UPDATE CANCELLED TABLE
                    if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_room_details", $hotel_room_arrFields, $hotel_room_arrValues, $hotel_room_where)):
                    endif;
                endif;

                //UPDATE COMFIRMED ITINERARY HOTEL MAIN TABLE COST DETAILS
                $select_itinerary_plan_hotel_details = sqlQUERY_LABEL("SELECT  `total_room_cost`,  `total_hotel_cost`,`total_hotel_meal_plan_cost` FROM `dvi_confirmed_itinerary_plan_hotel_details` WHERE `deleted` = '0' and `itinerary_plan_id` = '$itinerary_plan_ID' AND `confirmed_itinerary_plan_hotel_details_ID`='$confirmed_itinerary_plan_hotel_details_id'") or die("#1-UNABLE_TO_COLLECT_ITINEARY_LIST:" . sqlERROR_LABEL());

                if (sqlNUMOFROW_LABEL($select_itinerary_plan_hotel_details) > 0) :
                    while ($fetch_itinerary_plan_hotel_details_data = sqlFETCHARRAY_LABEL($select_itinerary_plan_hotel_details)) :

                        $total_hotel_cost_existing = $fetch_itinerary_plan_hotel_details_data['total_hotel_cost'];
                        $total_hotel_meal_plan_cost_existing =  $fetch_itinerary_plan_hotel_details_data['total_hotel_meal_plan_cost'];
                        $total_hotel_cost_updated = $total_hotel_cost_existing + $total_dinner_cost;
                        $total_hotel_meal_plan_cost_updated = $total_hotel_meal_plan_cost_existing + $total_dinner_cost;

                        $arrFields_hotel = array('`hotel_dinner_cost`',  '`total_hotel_meal_plan_cost`', '`total_hotel_cost`');
                        $arrValues_hotel = array("$total_dinner_cost", "$total_hotel_meal_plan_cost_updated", "$total_hotel_cost_updated");
                        $sql_where_hotel = " `confirmed_itinerary_plan_hotel_details_ID` = '$confirmed_itinerary_plan_hotel_details_id' ";

                        if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $arrFields_hotel, $arrValues_hotel, $sql_where_hotel)) :
                            endif;
                        endif;
                    endwhile;
                endif;

            else :
                $total_dinner_cost = 0;
            endif;


            //UPDATE ROOM SERVICES TABLE (in confirmed itinerary)

            // Calculate per person cost for services with a count greater than zero
            $extra_bed_cost_per_person = ($total_extra_bed > 0) ? $extra_bed_charge / $total_extra_bed : 0;
            $cnb_per_person = ($total_child_without_bed > 0) ? $child_without_bed_charge / $total_child_without_bed : 0;
            $cwb_per_person = ($total_child_with_bed > 0) ? $child_with_bed_charge / $total_child_with_bed : 0;

            // Ensure count values are numeric
            $breakfast_required = (isset($breakfast_meal_plan) && ($breakfast_meal_plan > 0)) ? (int)$breakfast_meal_plan : 0;
            $lunch_required = (isset($lunch_meal_plan) && ($lunch_meal_plan > 0)) ? (int)$lunch_meal_plan : 0;
            $dinner_required = (isset($dinner_meal_plan) && ($dinner_meal_plan > 0)) ? (int)$dinner_meal_plan : 0;

            $confirmed_itinerary_plan_hotel_details_id = getCONFIRMED_ITINERARY_PLAN_DETAILS($itinerary_plan_ID, $itinerary_route_id, 'get_confirmed_itinerary_hotel_details_id');

            $arrFields_hotel_room_services = array('confirmed_itinerary_plan_hotel_room_details_ID', 'itinerary_plan_hotel_room_details_ID',  'itinerary_plan_hotel_details_id', 'confirmed_itinerary_plan_hotel_details_id', 'group_type', 'itinerary_plan_id', 'itinerary_route_id', 'itinerary_route_date', 'hotel_id', 'room_type_id', 'room_id', 'room_service_type', 'room_service_count', 'service_cost_per_person', 'total_room_service_rate', 'createdby', 'status');

            $arrFields_hotel_room_services_cancelled = array('confirmed_itinerary_plan_hotel_room_service_details_ID', 'cancelled_itinerary_plan_hotel_room_details_ID', 'confirmed_itinerary_plan_hotel_room_details_ID',  'itinerary_plan_hotel_room_details_ID', 'itinerary_plan_hotel_details_id', 'confirmed_itinerary_plan_hotel_details_id', 'group_type', 'itinerary_plan_id', 'itinerary_route_id', 'itinerary_route_date', 'hotel_id', 'room_type_id', 'room_id', 'room_service_type', 'room_service_count', 'service_cost_per_person', 'total_room_service_rate', 'createdby', 'status');

            // Array of service types and their details
            $service_types = [
                1 => ['label' => 'EB', 'count' => $total_extra_bed, 'cost_per_person' => $extra_bed_cost_per_person, 'total_cost' => $extra_bed_charge],
                2 => ['label' => 'CNB', 'count' => $total_child_without_bed, 'cost_per_person' => $cnb_per_person, 'total_cost' => $child_without_bed_charge],
                3 => ['label' => 'CWB', 'count' => $total_child_with_bed, 'cost_per_person' => $cwb_per_person, 'total_cost' => $child_with_bed_charge],
                4 => ['label' => 'BF', 'count' => $breakfast_required, 'cost_per_person' => $hotel_breafast_cost, 'total_cost' => ($hotel_breafast_cost*$food_required_count)],
                5 => ['label' => 'LUN', 'count' => $lunch_required, 'cost_per_person' => $hotel_lunch_cost, 'total_cost' => ($hotel_lunch_cost*$food_required_count)],
                6 => ['label' => 'DIN', 'count' => $dinner_required, 'cost_per_person' => $hotel_dinner_cost, 'total_cost' => ($hotel_dinner_cost*$food_required_count)],
            ];

            // Loop through each service type
            foreach ($service_types as $type => $details) :
                $count = $details['count'];
                $cost_per_person = $details['cost_per_person'];
                $total_cost = $details['total_cost'];
                $label = $details['label'];

                // echo "Processing: $label, Count: $count, Cost Per Person: $cost_per_person, Total Cost: $total_cost<br>";

                // Proceed if count is greater than 0
                if ($count > 0) :
                    for ($i = 0; $i < $count; $i++) :
                        if ($cost_per_person > 0 && $total_cost > 0) :
                            $arrValues_hotel_room_services = [
                                $confirmed_itinerary_plan_hotel_room_details_ID,
                                $itinerary_plan_hotel_room_details_ID,
                                $itinerary_plan_hotel_details_id,
                                $confirmed_itinerary_plan_hotel_details_id,
                                $group_type,
                                $itinerary_plan_ID,
                                $itinerary_route_id,
                                $itinerary_route_date,
                                $hotel_id,
                                $choosen_room_type,
                                $room_ID,
                                $type, // room_service_type
                                1, // room_service_count (each service as single unit)
                                $cost_per_person, // service_cost_per_person
                                $total_cost, // total_room_service_rate
                                $logged_user_id,
                                "1" // Status
                            ];

                            // Insert into database
                            if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_room_service_details", $arrFields_hotel_room_services, $arrValues_hotel_room_services, '')) :
                                $confirmed_itinerary_plan_hotel_room_service_details_ID = sqlINSERTID_LABEL();

                                $arrValues_hotel_room_services_cancelled = [
                                    $confirmed_itinerary_plan_hotel_room_service_details_ID,
                                    $cancelled_itinerary_plan_hotel_room_details_ID,
                                    $confirmed_itinerary_plan_hotel_room_details_ID,
                                    $itinerary_plan_hotel_room_details_ID,
                                    $itinerary_plan_hotel_details_id,
                                    $confirmed_itinerary_plan_hotel_details_id,
                                    $group_type,
                                    $itinerary_plan_ID,
                                    $itinerary_route_id,
                                    $itinerary_route_date,
                                    $hotel_id,
                                    $choosen_room_type,
                                    $room_ID,
                                    $type, // room_service_type
                                    1, // room_service_count (each service as single unit)
                                    $cost_per_person, // service_cost_per_person
                                    $total_cost, // total_room_service_rate
                                    $logged_user_id,
                                    "1" // Status
                                ];

                                if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_service_details", $arrFields_hotel_room_services_cancelled, $arrValues_hotel_room_services_cancelled, '')) :
                                endif;
                            else :
                            //echo "Failed to insert service type: $label<br>";
                            endif;
                        else :
                        //echo "Skipping insertion for $label due to invalid cost values<br>";
                        endif;
                    endfor;
                else :
                //echo "Skipping $label as count is zero<br>";
                endif;
            endforeach;

            $response['i_result'] = true;

        endif;
        echo json_encode($response);

    elseif ($_GET['type'] == 'show_add_amenities_form') :

        $hotel_ID = $_GET['hotel_ID'];
        $itinerary_route_date = $_GET['itinerary_route_date'];
        $itinerary_plan_id = $_GET['itinerary_plan_id'];
        $itinerary_route_id = $_GET['itinerary_route_id'];
        $confirmed_itinerary_plan_hotel_details_ID = $_GET['itinerary_plan_hotel_details_ID'];
        $year = date('Y', strtotime($itinerary_route_date));
        $month = date('F', strtotime($itinerary_route_date));
        $day = 'day_' . date('j', strtotime($itinerary_route_date));
    ?>
        <div class="modal-body p-0" style="max-height: 500px; overflow-y: auto;">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="right: 30px; top: 30px;"></button>
            <div class="p-4">
                <div class="col-lg-12 py-3">
                    <div class="col-lg-12">
                        <h5 class="card-header p-0 mb-2 text-uppercase"><strong>Amenities Details</strong></h5>
                    </div>
                </div>
                <?php
                $select_hotel_amenities_details = sqlQUERY_LABEL("SELECT HOTEL_AMENITIES.`hotel_amenities_id`, HOTEL_AMENITIES.`amenities_title`, COALESCE(SUM(ITINEARY_ROOM_AMENITIES.`total_qty`), 0) AS total_qty FROM `dvi_hotel_amenities` HOTEL_AMENITIES LEFT JOIN `dvi_cancelled_itinerary_plan_hotel_room_amenities` ITINEARY_ROOM_AMENITIES ON ITINEARY_ROOM_AMENITIES.`hotel_amenities_id` = HOTEL_AMENITIES.`hotel_amenities_id` AND ITINEARY_ROOM_AMENITIES.`itinerary_route_id` = '$itinerary_route_id' AND ITINEARY_ROOM_AMENITIES.`itinerary_plan_id` = '$itinerary_plan_id' AND ITINEARY_ROOM_AMENITIES.`confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_ID' WHERE HOTEL_AMENITIES.`hotel_id` = '$hotel_ID' AND HOTEL_AMENITIES.`status` = '1' AND HOTEL_AMENITIES.`deleted` = '0' GROUP BY HOTEL_AMENITIES.`hotel_amenities_id`, HOTEL_AMENITIES.`amenities_title`") or die("#1-UNABLE_TO_COLLECT_HOTEL_AMENITIES_DETAILS_LIST:" . sqlERROR_LABEL());
                $total_num_of_amentites_count = sqlNUMOFROW_LABEL($select_hotel_amenities_details);
                if ($total_num_of_amentites_count > 0) :
                ?>
                    <div class="row" style="max-height: 500px; overflow-y: auto;">
                        <?php
                        while ($row = sqlFETCHARRAY_LABEL($select_hotel_amenities_details)) :
                            $hotel_amenities_id = $row['hotel_amenities_id'];
                            $amenities_title = $row['amenities_title'];
                            $total_qty = $row['total_qty'];
                            $amenities_rate_for_the_day = getAMENITIES_PRICEBOOK_DETAILS($hotel_ID, $hotel_amenities_id, $year, $month, $day, 'amenities_rate_for_the_day');

                            if ($total_qty > 0) :
                                $highlight_card_class = 'highlight-card';
                                $total_qty = $total_qty;
                                $add_btn_class = 'd-none';
                                $add_incrementor_class = '';
                            else :
                                $highlight_card_class = '';
                                $total_qty = 0;
                                $add_btn_class = '';
                                $add_incrementor_class = 'd-none';
                            endif;
                        ?>
                            <div class="col-lg-3 d-flex px-2">
                                <div class="card mb-3 w-100 <?= $highlight_card_class; ?>" id="<?= $hotel_amenities_id; ?>">
                                    <div class="row g-0">
                                        <div class="card-body">
                                            <div class="col-12 d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0 cursor-pointer" data-toggle="tooltip" placement="top" title="<?= $amenities_title; ?>"><?= limit_words($amenities_title, 2); ?></h5>
                                                <i class="fa fa-check-circle text-success added-icon <?= $add_incrementor_class; ?>" aria-hidden="true"></i>
                                            </div>
                                            <div class="col-12 mt-3 d-flex justify-content-between align-items-center">
                                                <h5 class="card-text text-primary mb-0"><?= general_currency_symbol . ' ' . number_format($amenities_rate_for_the_day, 2); ?></h5>
                                                <?php if ($amenities_rate_for_the_day > 0) : ?>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-primary add-button <?= $add_btn_class; ?>" type="button" onclick="incrementQuantity('<?= $hotel_amenities_id; ?>','<?= $amenities_rate_for_the_day; ?>')"><span class="tf-icons ti ti-circle-plus ti-xs me-1"></span>Add</button>
                                                        <div class="quantity-controls <?= $add_incrementor_class; ?> btn-group" role="group">
                                                            <button class="btn btn-outline-primary" type="button"><i class="ti ti-minus ti-xs"></i></button>
                                                            <span readonly class="btn btn-outline-secondary quantity-text"><?= $total_qty; ?></span>
                                                            <button class="btn btn-outline-success" type="button" onclick="incrementQuantity('<?= $hotel_amenities_id; ?>','<?= $amenities_rate_for_the_day; ?>')"><i class="ti ti-plus ti-xs"></i></button>
                                                        </div>
                                                    </div>
                                                <?php else : ?>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-danger add-button" type="button"></span>Sold Out</button>
                                                    </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <?php
                        endwhile;
                        ?>
                    </div>
                <?php else : ?>
                    <div class="col-lg-12 text-center" style="max-height: 600px;">
                        <img src="assets/img/no_amentites_found_1.webp" alt="No Amenities" class="img-fluid mb-3" style="max-height: 300px;">
                        <h5 class="text-muted">No more amenities found.</h5>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <style>
            .quantity-controls .btn {
                padding: 0.2rem 0.5rem;
                /* Reduced padding */
                font-size: 0.875rem;
                /* Smaller font size */
            }

            .quantity-controls .quantity-text {
                width: 2rem;
                /* Reduced width */
                text-align: center;
                border-left: none;
                border-right: none;
                font-size: 0.875rem;
                /* Smaller font size */
            }

            .selected-hotelAmenitiesDetails-card {
                background-color: #d4edda !important;
                /* Green background for selected cards */
            }

            .highlight-card {
                border: 2px solid #28a745 !important;
                /* Green border to highlight the card */
                box-shadow: 0 0.5rem 1rem rgba(0, 123, 255, 0.2) !important;
                /* Slight shadow to emphasize the card */
            }

            .added-icon {
                font-size: 1.25rem;
                display: none;
                /* Initially hidden */
            }

            .card {
                background-clip: padding-box;
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                border: none;
                border-radius: 0.25rem;
            }
        </style>

        <!-- Add Font Awesome for icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

        <script>
            $(document).ready(function() {
                $('body').tooltip({
                    selector: '[data-toggle="tooltip"]'
                });
                $(function() {
                    $('[data-toggle="tooltip"]').tooltip()
                });
            });

            function incrementQuantity(hotel_amenities_id, amenitie_rate) {
                const card = document.getElementById(hotel_amenities_id);
                if (card) {
                    const addButton = card.querySelector('.add-button');
                    const quantityControls = card.querySelector('.quantity-controls');
                    const quantityText = card.querySelector('.quantity-text');
                    const addedIcon = card.querySelector('.added-icon');

                    let quantity = parseInt(quantityText.textContent, 10);
                    quantity += 1;
                    quantityText.textContent = quantity;
                    /* console.log(`Incrementing quantity for ${cardId}: ${quantity}`); */

                    addHOTELAMNITIESTOITINEARY('<?= $confirmed_itinerary_plan_hotel_details_ID; ?>', '<?= $hotel_ID; ?>', '<?= $itinerary_plan_id; ?>', '<?= $itinerary_route_id; ?>', '<?= $itinerary_route_date; ?>', 1, hotel_amenities_id, amenitie_rate);

                    if (quantity > 0) {
                        addButton.classList.add('d-none');
                        quantityControls.classList.remove('d-none');
                        card.classList.add('highlight-card'); // Highlight the card
                        addedIcon.classList.remove('d-none'); // Show the added icon
                    }
                }
            }


            function addHOTELAMNITIESTOITINEARY(itinerary_plan_hotel_details_ID, hotel_ID, itinerary_plan_id, itinerary_route_id, itinerary_route_date, quantity, hotel_amenities_id, amenitie_rate) {
                // Perform AJAX call only if the checkbox is checked
                $.ajax({
                    url: 'engine/ajax/ajax_manage_confirmed_itinerary_cancellation_details.php?type=add_amenities_to_itinerary',
                    method: 'POST',
                    data: {
                        hotel_ID: hotel_ID,
                        itinerary_plan_id: itinerary_plan_id,
                        itinerary_route_id: itinerary_route_id,
                        itinerary_plan_hotel_details_ID: itinerary_plan_hotel_details_ID,
                        itinerary_route_date: itinerary_route_date,
                        quantity: quantity,
                        hotel_amenities_id: hotel_amenities_id,
                        amenitie_rate: amenitie_rate
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (!response.success) {
                            TOAST_NOTIFICATION('error', 'Unable to add the Amenities !!!', 'Error !!!', '', '', '', '', '', '', '', '', '');
                        } else {
                            if (response.i_result) {
                                TOAST_NOTIFICATION('success', response.i_result, 'Success !!!', '', '', '', '', '', '', '', '', '');
                                $("#hotelADDAMENITIESMODALINFODATA").modal('hide'); // For Bootstrap
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            } else if (response.u_result) {
                                TOAST_NOTIFICATION('success', response.u_result, 'Success !!!', '', '', '', '', '', '', '', '', '');
                            } else if (response.r_result) {
                                TOAST_NOTIFICATION('success', response.r_result, 'Success !!!', '', '', '', '', '', '', '', '', '');
                            }

                        }
                    },
                    error: function(xhr, status, error) {
                        // Handle errors
                        console.error('Error updating database:', error);
                    }
                });
            }
        </script>
<?php
    elseif ($_GET['type'] == 'add_amenities_to_itinerary') :

        $errors = [];
        $response = [];

        $hotel_ID = $_POST['hotel_ID'];
        $itinerary_plan_id = $_POST['itinerary_plan_id'];
        $itinerary_route_id = $_POST['itinerary_route_id'];
        $confirmed_itinerary_plan_hotel_details_ID = $_POST['itinerary_plan_hotel_details_ID'];
        $itinerary_route_date = $_POST['itinerary_route_date'];
        $quantity = $_POST['quantity'];
        $hotel_amenities_id = $_POST['hotel_amenities_id'];
        $amenitie_rate = $_POST['amenitie_rate'];

        if (!empty($errors)) :
            //error call
            $response['success'] = false;
            $response['errors'] = $errors;
        else :
            $response['success'] = true;


            $selected_itinerary_plan_hotel_room_amenities = sqlQUERY_LABEL("SELECT `itinerary_plan_hotel_room_amenities_details_ID`,`itinerary_plan_hotel_details_id`,`group_type` FROM `dvi_confirmed_itinerary_plan_hotel_room_amenities` WHERE `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `confirmed_itinerary_plan_hotel_details_id` = '$confirmed_itinerary_plan_hotel_details_ID' AND `hotel_ID` = '$hotel_ID' AND `hotel_amenities_id` = '$hotel_amenities_id' ORDER BY `itinerary_plan_hotel_room_amenities_details_ID` DESC LIMIT 1") or die("#STATELABEL-LABEL: getHOTEL_DETAIL: " . sqlERROR_LABEL());
            $total_no_of_amenities_count = sqlNUMOFROW_LABEL($selected_itinerary_plan_hotel_room_amenities);
            $fetch_itinerary_plan_hotel_room_amenities_data = sqlFETCHARRAY_LABEL($selected_itinerary_plan_hotel_room_amenities);
            $itinerary_plan_hotel_room_amenities_details_ID = $fetch_itinerary_plan_hotel_room_amenities_data['itinerary_plan_hotel_room_amenities_details_ID'];
            $group_type = $fetch_itinerary_plan_hotel_room_amenities_data['group_type'];
            $itinerary_plan_hotel_details_ID = $fetch_itinerary_plan_hotel_room_amenities_data['itinerary_plan_hotel_details_id'];

            $get_gst_type = get_ITINEARY_PLAN_HOTEL_ROOM_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_ID, '', 'get_gst_type');
            $get_gst_percentage = get_ITINEARY_PLAN_HOTEL_ROOM_DETAILS($itinerary_plan_id, $itinerary_route_id, $hotel_ID, '', 'get_gst_percentage');

            if ($quantity > 0) :
                $quantity = 1;
                $total_amenitie_cost = $amenitie_rate * $quantity;

                if ($total_amenitie_cost > 0 && $get_gst_percentage > 0) :
                    // Calculate new margin amount and room tax amount based on GST type
                    if ($get_gst_type == 1) :
                        // For Inclusive GST
                        $new_amenitie_tax_amt = ((($total_amenitie_cost) * $get_gst_percentage) / 100);
                        $new_amenitie_amount = (($total_amenitie_cost) - ($new_amenitie_tax_amt));
                    elseif ($get_gst_type == 2) :
                        // For Exclusive GST
                        $new_amenitie_tax_amt = ($total_amenitie_cost * $get_gst_percentage / 100);
                        $new_amenitie_amount = $total_amenitie_cost;
                    endif;
                else :
                    $new_amenitie_amount = $total_amenitie_cost;
                    $new_amenitie_tax_amt = 0;
                endif;

                $confirmed_itinerary_plan_hotel_details_id = getCONFIRMED_ITINERARY_PLAN_DETAILS($itinerary_plan_ID, $itinerary_route_id, 'get_confirmed_itinerary_hotel_details_id');

                $amenities_arrFields = array('`group_type`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`hotel_amenities_id`', '`total_qty`', '`amenitie_rate`', '`total_amenitie_cost`', '`total_amenitie_gst_amount`', '`createdby`', '`status`');

                $amenities_arrValues = array("$group_type", "$itinerary_plan_hotel_details_ID", "$confirmed_itinerary_plan_hotel_details_id", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$hotel_ID", "$hotel_amenities_id", "$quantity", "$amenitie_rate", "$new_amenitie_amount", "$new_amenitie_tax_amt", "$logged_user_id", "1");

                if (sqlACTIONS("INSERT", "dvi_confirmed_itinerary_plan_hotel_room_amenities", $amenities_arrFields, $amenities_arrValues, '')) :
                    $confirmed_itinerary_plan_hotel_room_amenities_details_ID  = sqlINSERTID_LABEL();

                    $cancelled_amenities_arrFields = array('`confirmed_itinerary_plan_hotel_room_amenities_details_ID`', '`group_type`', '`itinerary_plan_hotel_details_id`', '`confirmed_itinerary_plan_hotel_details_id`', '`itinerary_plan_id`', '`itinerary_route_id`', '`itinerary_route_date`', '`hotel_id`', '`hotel_amenities_id`', '`total_qty`', '`amenitie_rate`', '`total_amenitie_cost`', '`total_amenitie_gst_amount`', '`createdby`', '`status`');

                    $cancelled_amenities_arrValues = array("$confirmed_itinerary_plan_hotel_room_amenities_details_ID", "$group_type", "$itinerary_plan_hotel_details_ID", "$confirmed_itinerary_plan_hotel_details_id", "$itinerary_plan_id", "$itinerary_route_id", "$itinerary_route_date", "$hotel_ID", "$hotel_amenities_id", "$quantity", "$amenitie_rate", "$new_amenitie_amount", "$new_amenitie_tax_amt", "$logged_user_id", "1");

                    if (sqlACTIONS("INSERT", "dvi_cancelled_itinerary_plan_hotel_room_amenities", $cancelled_amenities_arrFields, $cancelled_amenities_arrValues, '')) :
                        $cancelled_itinerary_plan_hotel_room_amenities_details_ID   = sqlINSERTID_LABEL();
                        $response['i_result'] = 'Successfully added the Amenities';
                    endif;
                endif;

            endif;

            $TOTAL_AMENITIES_COST = get_CONFIRMED_ITINEARYHOTEL_AMENITIES_DETAILS($group_type, $itinerary_plan_id, $itinerary_route_id, 'TOTAL_AMENITIES_COST');
            $TOTAL_AMENITIES_GST_COST = get_CONFIRMED_ITINEARYHOTEL_AMENITIES_DETAILS($group_type, $itinerary_plan_id, $itinerary_route_id, 'TOTAL_AMENITIES_GST_COST');

            $hotel_margin_percentage = get_ASSIGNED_HOTEL_FOR_ITINEARY_PLAN_DETAILS($group_type, $itinerary_plan_id, $itinerary_route_id, '', '', '', 'hotel_margin_percentage');
            $hotel_margin_gst_type = get_ASSIGNED_HOTEL_FOR_ITINEARY_PLAN_DETAILS($group_type, $itinerary_plan_id, $itinerary_route_id, '', '', '', 'hotel_margin_gst_type');
            $hotel_margin_gst_percentage = get_ASSIGNED_HOTEL_FOR_ITINEARY_PLAN_DETAILS($group_type, $itinerary_plan_id, $itinerary_route_id, '', '', '', 'hotel_margin_gst_percentage');

            $select_hotel_room_cost_details = sqlQUERY_LABEL("SELECT SUM(`hotel_breakfast_cost`) AS TOTAL_BREAKFAST_COST, SUM(`hotel_breakfast_cost_gst_amount`) AS TOTAL_BREAKFAST_GST_COST, SUM(`hotel_lunch_cost`) AS TOTAL_LUNCH_COST, SUM(`hotel_lunch_cost_gst_amount`) AS TOTAL_LUNCH_GST_COST, SUM(`hotel_dinner_cost`) AS TOTAL_DINNER_COST, SUM(`hotel_dinner_cost_gst_amount`) AS TOTAL_DINNER_GST_COST, SUM(`total_extra_bed_cost`) AS TOTAL_EXTRA_BED_CHARGES, SUM(`total_extra_bed_cost_gst_amount`) AS TOTAL_EXTRA_BED_GST_CHARGES, SUM(`total_childwith_bed_cost`) AS TOTAL_CHILD_WITH_BED_CHARGES, SUM(`total_childwith_bed_cost_gst_amount`) AS TOTAL_CHILD_WITH_BED_GST_CHARGES, SUM(`total_childwithout_bed_cost`) AS TOTAL_CHILD_WITHOUT_BED_CHARGES, SUM(`total_childwithout_bed_cost_gst_amount`) AS TOTAL_CHILD_WITHOUT_BED_GST_CHARGES, SUM(`total_room_cost`) AS TOTAL_ROOM_COST, SUM(`total_room_gst_amount`) AS TOTAL_ROOM_GST_COST FROM `dvi_confirmed_itinerary_plan_hotel_details` where `itinerary_plan_id`='$itinerary_plan_id' and `itinerary_route_id` = '$itinerary_route_id' AND `group_type` = '$group_type' and `status` = '1' and `deleted` ='0'") or die("#getROOMTYPE_DETAILS: get_ASSIGNED_HOTEL_FOR_ITINEARY_PLAN_DETAILS: " . sqlERROR_LABEL());

            while ($fetch_hotel_room_data = sqlFETCHARRAY_LABEL($select_hotel_room_cost_details)) :
                $TOTAL_BREAKFAST_COST = $fetch_hotel_room_data['TOTAL_BREAKFAST_COST'];
                $TOTAL_BREAKFAST_GST_COST = $fetch_hotel_room_data['TOTAL_BREAKFAST_GST_COST'];
                $TOTAL_LUNCH_COST = $fetch_hotel_room_data['TOTAL_LUNCH_COST'];
                $TOTAL_LUNCH_GST_COST = $fetch_hotel_room_data['TOTAL_LUNCH_GST_COST'];
                $TOTAL_DINNER_COST = $fetch_hotel_room_data['TOTAL_DINNER_COST'];
                $TOTAL_DINNER_GST_COST = $fetch_hotel_room_data['TOTAL_DINNER_GST_COST'];
                $TOTAL_EXTRA_BED_CHARGES = $fetch_hotel_room_data['TOTAL_EXTRA_BED_CHARGES'];
                $TOTAL_EXTRA_BED_GST_CHARGES = $fetch_hotel_room_data['TOTAL_EXTRA_BED_GST_CHARGES'];
                $TOTAL_CHILD_WITH_BED_CHARGES = $fetch_hotel_room_data['TOTAL_CHILD_WITH_BED_CHARGES'];
                $TOTAL_CHILD_WITH_BED_GST_CHARGES = $fetch_hotel_room_data['TOTAL_CHILD_WITH_BED_GST_CHARGES'];
                $TOTAL_CHILD_WITHOUT_BED_CHARGES = $fetch_hotel_room_data['TOTAL_CHILD_WITHOUT_BED_CHARGES'];
                $TOTAL_CHILD_WITHOUT_BED_GST_CHARGES = $fetch_hotel_room_data['TOTAL_CHILD_WITHOUT_BED_GST_CHARGES'];
                $TOTAL_ROOM_COST = $fetch_hotel_room_data['TOTAL_ROOM_COST'];
                $TOTAL_ROOM_GST_COST = $fetch_hotel_room_data['TOTAL_ROOM_GST_COST'];
            endwhile;

            $total_new_room_cost = $TOTAL_ROOM_COST + $TOTAL_BREAKFAST_COST + $TOTAL_LUNCH_COST + $TOTAL_DINNER_COST + $TOTAL_EXTRA_BED_CHARGES + $TOTAL_CHILD_WITHOUT_BED_CHARGES + $TOTAL_CHILD_WITH_BED_CHARGES + $TOTAL_AMENITIES_COST;

            if ($hotel_margin_percentage > 0 && $total_new_room_cost > 0) :
                // Calculate hotel margin rate
                $hotel_margin_rate = ($total_new_room_cost * $hotel_margin_percentage) / 100;
            else :
                $hotel_margin_rate = 0;
            endif;

            if ($hotel_margin_rate > 0 && $hotel_margin_gst_percentage > 0) :
                // Calculate new margin amount and room tax amount based on GST type
                if ($hotel_margin_gst_type == 1) :
                    // For Inclusive GST
                    $new_margin_tax_amt = (($hotel_margin_rate * $hotel_margin_gst_percentage) / 100);
                    $new_margin_amount = ($hotel_margin_rate - $new_margin_tax_amt);
                elseif ($hotel_margin_gst_type == 2) :
                    // For Exclusive GST
                    $new_margin_tax_amt = ($hotel_margin_rate * $hotel_margin_gst_percentage / 100);
                    $new_margin_amount = $hotel_margin_rate;
                endif;
            else :
                $new_margin_amount = $hotel_margin_rate;
                $new_margin_tax_amt = 0;
            endif;

            $total_hotel_cost = $TOTAL_ROOM_COST + $TOTAL_BREAKFAST_COST + $TOTAL_LUNCH_COST + $TOTAL_DINNER_COST + $TOTAL_EXTRA_BED_CHARGES + $TOTAL_CHILD_WITHOUT_BED_CHARGES + $TOTAL_CHILD_WITH_BED_CHARGES + $new_margin_amount + $new_amenities_amount;

            $total_hotel_tax_amount = $TOTAL_BREAKFAST_GST_COST + $TOTAL_LUNCH_GST_COST + $TOTAL_DINNER_GST_COST + $TOTAL_ROOM_GST_COST + $TOTAL_EXTRA_BED_GST_CHARGES + $TOTAL_CHILD_WITH_BED_GST_CHARGES + $TOTAL_CHILD_WITHOUT_BED_GST_CHARGES + $new_margin_tax_amt + $TOTAL_AMENITIES_GST_COST;

            $itineary_hotel_cost_details_arrFields = array('`total_amenities_cost`', '`total_amenities_gst_amount`', '`hotel_margin_rate`', '`hotel_margin_rate_tax_amt`', '`total_hotel_cost`', '`total_hotel_tax_amount`');

            $itineary_hotel_cost_details_arrValues = array("$new_amenities_amount", "$new_amenities_tax_amt", "$new_margin_amount", "$new_margin_tax_amt", "$total_hotel_cost", "$total_hotel_tax_amount");

            $itineary_hotel_cost_details_sqlwhere = " `deleted` = '0' AND `status` = '1' AND `itinerary_plan_id` = '$itinerary_plan_id' AND `itinerary_route_id` = '$itinerary_route_id' AND `group_type` = '$group_type' ";
            if (sqlACTIONS("UPDATE", "dvi_confirmed_itinerary_plan_hotel_details", $itineary_hotel_cost_details_arrFields, $itineary_hotel_cost_details_arrValues, $itineary_hotel_cost_details_sqlwhere)) :
                if (sqlACTIONS("UPDATE", "dvi_cancelled_itinerary_plan_hotel_details", $itineary_hotel_cost_details_arrFields, $itineary_hotel_cost_details_arrValues, $itineary_hotel_cost_details_sqlwhere)) :
                endif;
            endif;

        endif;

        echo json_encode($response);
    endif;
else:
    echo "Request Ignored";
endif;
